{"pageProps":{"post":{"mdxSource":"var Component=(()=>{var r=Object.create;var i=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var d=Object.getOwnPropertyNames;var p=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var c=a=>i(a,\"__esModule\",{value:!0});var m=(a,s)=>()=>(s||a((s={exports:{}}).exports,s),s.exports),u=(a,s)=>{c(a);for(var t in s)i(a,t,{get:s[t],enumerable:!0})},k=(a,s,t)=>{if(s&&typeof s==\"object\"||typeof s==\"function\")for(let n of d(s))!A.call(a,n)&&n!==\"default\"&&i(a,n,{get:()=>s[n],enumerable:!(t=h(s,n))||t.enumerable});return a},f=a=>k(c(i(a!=null?r(p(a)):{},\"default\",a&&a.__esModule&&\"default\"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);var o=m((v,l)=>{l.exports=_jsx_runtime});var w={};u(w,{default:()=>b,frontmatter:()=>N});var e=f(o()),N={title:\"UT CTF 2023 \\u2013 Zipper\",date:\"2023-03-12\",draft:!1,authors:[\"legoclones\"],tags:[\"UTCTF 2023\",\"Misc\",\"Zip\"],summary:\"Craft a malicious Zip file with identically-named files to bypass a filter and get RCE.\",canonical:\"https://justinapplegate.me/2023/utctf-zipper/\"};function g(a={}){let{wrapper:s}=a.components||{};return s?(0,e.jsx)(s,Object.assign({},a,{children:(0,e.jsx)(t,{})})):t();function t(){let n=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",blockquote:\"blockquote\",p:\"p\",code:\"code\",pre:\"pre\",h3:\"h3\",em:\"em\",strong:\"strong\"},a.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(n.h2,{id:\"zipper-misc-968-points\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#zipper-misc-968-points\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Zipper (Misc, 968 Points)\"]}),`\n`,(0,e.jsxs)(n.blockquote,{children:[`\n`,(0,e.jsx)(n.p,{children:\"One of our spies has stolen documentation relating to a new class of missiles. Can you figure out how to hack them?\"}),`\n`,(0,e.jsx)(n.p,{children:'\"We have developed a new protocol to allow reprogramming missiles in flight. We send a base64 encoded string representing a specifically formatted zip file to control these missiles. The missiles themselves verify each command before executing them to ensure that a hacker cannot manipulate them.\"'}),`\n`,(0,e.jsx)(n.p,{children:\"A sample message has also been stolen by our spy.\"}),`\n`,(0,e.jsx)(n.p,{children:\"By Aadhithya (@aadhi0319 on discord)\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"Attachments: \",(0,e.jsx)(n.a,{href:\"https://github.com/Legoclones/website/blob/main/source/static/utctf-zipper/verify_hash.py\",children:\"verify_hash.py\"}),\", \",(0,e.jsx)(n.a,{href:\"https://github.com/Legoclones/website/blob/main/source/static/utctf-zipper/commands.zip.b64\",children:\"commands.zip.b64\"}),\".\"]}),`\n`]}),`\n`,(0,e.jsxs)(n.p,{children:[\"When connecting to the port through netcat, the file run was \",(0,e.jsx)(n.code,{children:\"verify_hash.py\"}),\":\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),` hashlib\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),` os\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),` sys\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),` zipfile\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"get_file\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"name\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" archive\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token builtin\",children:\"file\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"file\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"in\"}),\" archive\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"infolist\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"file\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"filename \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" name\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"archive \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" zipfile\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"ZipFile\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"sys\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"argv\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token builtin\",children:\"file\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" get_file\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"commands/command.txt\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" archive\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"data \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" archive\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token builtin\",children:\"file\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"md5 \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" hashlib\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"md5\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"data\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"hexdigest\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" md5 \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"0e491b13e7ca6060189fd65938b0b5bc\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    archive\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"extractall\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    os\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"system\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"bash commands/command.txt\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    os\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"system\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"rm -r commands\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"else\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"print\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"Invalid Command\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"The script takes in a ZIP file (passed to the server through base64 encoding presumably), looks for, reads, and hashes the \",(0,e.jsx)(n.code,{children:\"commands/command.txt\"}),\" file, and if the MD5 hash of the file matches \",(0,e.jsx)(n.code,{children:\"0e491b13e7ca6060189fd65938b0b5bc\"}),\", the contents of that file are run in bash. There\\u2019s no mention of the flag anywhere, which means it must be on the filesystem and read through arbitrary file read or RCE. Based on the fact that user-supplied input was run through bash, it\\u2019s just a matter of bypassing the filter.\"]}),`\n`,(0,e.jsxs)(n.h3,{id:\"initial-thoughts\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#initial-thoughts\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Initial Thoughts\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"I had two ideas initially - Zip Slip vulnerability, and MD5 collision. It didn\\u2019t take very long for me to discover that \",(0,e.jsx)(n.a,{href:\"https://security.snyk.io/research/zip-slip-vulnerability\",children:\"Python\\u2019s ZIP-handling libraries aren\\u2019t vulnerable to Zip Slip\"}),\", and hasn\\u2019t since 2014. The \",(0,e.jsx)(n.a,{href:\"https://docs.python.org/3/library/zipfile.html#zipfile.ZipFile.extract\",children:\"official documentation\"}),\" even describes the measures it takes to prevent path traversal when extracting ZIP files. So there was no chance of me overwriting arbitrary files without popping a 0day.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"I already knew that MD5 collisions were pretty tough, and 30 extra seconds of research confirmed that. While research has been released on how to achieve MD5 collisions (\",(0,e.jsx)(n.a,{href:\"https://www.mscs.dal.ca/~selinger/md5collision/\",children:\"link 1\"}),\", \",(0,e.jsx)(n.a,{href:\"https://github.com/cr-marcstevens/hashclash\",children:\"link 2\"}),\", \",(0,e.jsx)(n.a,{href:\"https://marc-stevens.nl/research/md5-1block-collision/\",children:\"link 3\"}),\"), they all have certain prerequisites that couldn\\u2019t be fulfilled within the context of this problem. The most important idea is that it can be easy to generate two files with the same hash, but given a single hash it\\u2019s hard to generate another file with that same hash.\"]}),`\n`,(0,e.jsxs)(n.h3,{id:\"identical-files\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#identical-files\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Identical Files\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"While writing out my ideas/work so far in a Discord thread for my team, an idea popped into my head. I\\u2019ve spent a lot of time experimenting, researching, and playing with the ZIP file format, and nothing said you couldn\\u2019t have two files with the same name in it. I double checked how the MD5 hash check is made, and the \",(0,e.jsx)(n.code,{children:\"get_file()\"}),\" function that returns the content being hashed will only return the \",(0,e.jsx)(n.em,{children:\"first\"}),\" file with the desired name.\"]}),`\n`,(0,e.jsxs)(n.p,{children:['This means I could make a ZIP file with 2 identically-named files inside; the first one would have the \"approved\" content ',(0,e.jsx)(n.code,{children:\"a\"}),\" with the hash \",(0,e.jsx)(n.code,{children:\"0e491b13e7ca6060189fd65938b0b5bc\"}),\", while the second one would be my own malicious script. When the script ran \",(0,e.jsx)(n.code,{children:\"archive.extractall()\"}),\" on the ZIP file, it would first extract the good \",(0,e.jsx)(n.code,{children:\"commands.txt\"}),\" file, then it would extract the malicious \",(0,e.jsx)(n.code,{children:\"commands.txt\"}),\" file and overwrite the good one, giving us RCE.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"To create this ZIP file, I originally made 2 files, one called \",(0,e.jsx)(n.code,{children:\"commands.txt\"}),\" and the other called \",(0,e.jsx)(n.code,{children:\"commands.txk\"}),\". After zipping it up, I opened it in a hex editor and replaced both occurrences of \",(0,e.jsx)(n.code,{children:\"commands.txk\"}),\" with \",(0,e.jsx)(n.code,{children:\"commands.txt\"}),\", base64-encoded my file, and sent it through the netcat session. Using the command \",(0,e.jsx)(n.code,{children:\"cat flag.txt\"}),\" gave me the flag!\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"Final payload - \",(0,e.jsx)(n.code,{children:\"UEsDBAoAAAAAAHiralYAAAAAAAAAAAAAAAAJABwAY29tbWFuZHMvVVQJAANDAwxkQwMMZHV4CwABBOgDAAAE6AMAAFBLAwQKAAAAAAAth2FWWhLOtxMAAAATAAAAFAAcAGNvbW1hbmRzL2NvbW1hbmQudHh0VVQJAANm5v9jPwMMZHV4CwABBOgDAAAE6AMAAGVjaG8gJ0hlbGxvIFdvcmxkISdQSwMECgAAAAAAaqxqVnswo9kMAAAADAAAABQAHABjb21tYW5kcy9jb21tYW5kLnR4dFVUCQADCAUMZAgFDGR1eAsAAQToAwAABOgDAABjYXQgZmxhZy50eHRQSwECHgMKAAAAAAB4q2pWAAAAAAAAAAAAAAAACQAYAAAAAAAAABAA7UEAAAAAY29tbWFuZHMvVVQFAANDAwxkdXgLAAEE6AMAAAToAwAAUEsBAh4DCgAAAAAALYdhVloSzrcTAAAAEwAAABQAGAAAAAAAAQAAAICBQwAAAGNvbW1hbmRzL2NvbW1hbmQudHh0VVQFAANm5v9jdXgLAAEE6AMAAAToAwAAUEsBAh4DCgAAAAAAaqxqVnswo9kMAAAADAAAABQAGAAAAAAAAQAAAICBpAAAAGNvbW1hbmRzL2NvbW1hbmQudHh0VVQFAAMIBQxkdXgLAAEE6AMAAAToAwAAUEsFBgAAAAADAAMAAwEAAP4AAAAAAA==\"})]}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.strong,{children:\"Flag:\"}),\" \",(0,e.jsx)(n.code,{children:\"utflag{https://youtu.be/bZe5J8SVCYQ}\"})]})]})}}var b=g;return w;})();\n;return Component;","toc":[{"value":"Zipper (Misc, 968 Points)","url":"#zipper-misc-968-points","depth":2},{"value":"Initial Thoughts","url":"#initial-thoughts","depth":3},{"value":"Identical Files","url":"#identical-files","depth":3}],"frontMatter":{"readingTime":{"text":"4 min read","minutes":3.65,"time":219000,"words":730},"slug":"utctf-2023/zipper","fileName":"utctf-2023/zipper.md","title":"UT CTF 2023 – Zipper","date":"2023-03-12T00:00:00.000Z","draft":false,"authors":["legoclones"],"tags":["UTCTF 2023","Misc","Zip"],"summary":"Craft a malicious Zip file with identically-named files to bypass a filter and get RCE.","canonical":"https://justinapplegate.me/2023/utctf-zipper/"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.26,"time":15600,"words":52},"slug":["legoclones"],"fileName":"legoclones.md","name":"Legoclones","avatar":"https://www.gravatar.com/avatar/a6122f35bdc157fb5e76ef5f3de833a2?d=identicon&s=256","specialties":["Reverse","Web"],"twitter":"https://twitter.com/legoclones","github":"https://github.com/Legoclones","web":"https://justinapplegate.me","member":true,"description":"Just a simple man trying to make my way in the universe","order":16,"date":null}],"prev":{"title":"LA CTF 2023 – Pycjail","date":"2023-02-12T00:00:00.000Z","draft":false,"authors":["legoclones"],"tags":["LACTF 2023","Misc","Python","Pyjail","Sandbox","Opcode"],"summary":"Use bytecode manipulation to subvert jail restrictions.","canonical":"https://justinapplegate.me/2023/lactf-pycjail","slug":"lactf-2023/pycjail"},"next":{"title":"UT CTF 2023 – What Time Is It?","date":"2023-03-12T00:00:00.000Z","draft":false,"authors":["legoclones"],"tags":["UTCTF 2023","Forensics","Email"],"summary":"Decode a timestamp hidden in Gmail Content-Type boundary to determine the time the email was sent.","canonical":"https://justinapplegate.me/2023/utctf-whattimeisit/","slug":"utctf-2023/whattimeisit"}},"__N_SSG":true}